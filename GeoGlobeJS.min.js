window.Geo={singleFile:!0};
(function(){window.Geo=window.Geo||{};window.Geo.Service={};window.Geo.Query={};window.Geo.Tdt={};window.Geo.Math={};window.Geo.Analysis={};window.Geo.View2D={};window.Geo.View2D.Control=OpenLayers.Control;window.Geo.View3D={};window.Geo.View3D.Event={};window.Geo.Bounds=OpenLayers.Bounds;window.Geo.Class=OpenLayers.Class;window.Geo.LonLat=OpenLayers.LonLat;window.Geo.Pixel=OpenLayers.Pixel;window.Geo.Size=OpenLayers.Size;window.Geo.Element=OpenLayers.Element;window.Geo.Date=OpenLayers.Date;window.Geo.Feature=
OpenLayers.Feature;window.Geo.Filter=OpenLayers.Filter;window.Geo.Format=OpenLayers.Format;window.Geo.Geometry=OpenLayers.Geometry;window.Geo.View2D.Handler=OpenLayers.Handler;window.Geo.View2D.Layer=OpenLayers.Layer;window.Geo.View2D.Popup=OpenLayers.Popup;window.Geo.Protocol=OpenLayers.Protocol;window.Geo.Request=OpenLayers.Request;window.Geo.Strategy=OpenLayers.Strategy;window.Geo.Symbolizer=OpenLayers.Symbolizer;window.Geo.View2D.Tile=OpenLayers.Tile;window.Geo.View2D.Icon=OpenLayers.Icon;window.Geo.Projection=
OpenLayers.Projection;window.Geo.Rule=OpenLayers.Rule;window.Geo.Style=OpenLayers.Style;window.Geo.Style2=OpenLayers.Style2;window.Geo.StyleMap=OpenLayers.StyleMap;window.Geo.Marker=OpenLayers.Marker;window.Geo.Event=OpenLayers.Event;window.Geo.Events=OpenLayers.Events;window.Geo.Util=OpenLayers.Util;window.Geo.Console=OpenLayers.Console;window.Geo.Lang=OpenLayers.Lang;window.Geo.Kinetic=OpenLayers.Kinetic;window.Geo.View2D.Event=OpenLayers.Event;window.Geo.View2D.Events=OpenLayers.Events;window.Geo.String=
OpenLayers.String;window.Geo.Number=OpenLayers.Number;window.Geo.Function=OpenLayers.Function;window.Geo.Array=OpenLayers.Array;if(!Geo.singleFile){for(var a=["Animator.js","AnimateZoomer.js","Util.js","Pyramid.js","SymbolizerManager.js","GeoMarker.js","hotfix_ol2_13.js","Util/Uuid.js","Util/Heatmap.js","Util/Format/BusCapabilities.js","Util/Format/GlobeTileCapabilities.js","Util/Format/Pyramid.js","Util/Format/XML2JSON.js","Util/Format/VwmtsGetVersionInfo.js","Util/Format/VwmtsGetVersions.js","Util/Format/VWMTSCapabilities.v1_0_0.js",
"Util/Format/MapServiceQuery.js","Util/Format/GeoTextFeatures.js","Util/GeoAvoidObject.js","Util/GeoPreAvoidContainer.js","View2D/Map.js","View2D/Tile/TileFeature.js","View2D/Layer/CWMS.js","View2D/Layer/GlobeTile.js","View2D/Layer/GeoWMTS.js","View2D/Layer/DynamicMapService.js","View2D/Layer/TileMapService.js","View2D/Layer/GeoMarkers.js","View2D/Layer/ArcGISTileLayer.js","View2D/Layer/Buildings.js","View2D/Layer/GeoThematicLayer.js","View2D/Layer/HeatMapLayer.js","View2D/Layer/ThematicTile.js",
"View2D/Layer/GeoText.js","View2D/Layer/HotareaWMTS.js","View2D/BaseLayerGroup.js","View2D/LayerGroup.js","View2D/FeatureManager.js","View2D/MarkerTag.js","View2D/Control/DrawCircle.js","View2D/Control/DrawPath.js","View2D/Control/DrawPoint.js","View2D/Control/DrawPolygon.js","View2D/Control/DrawRectangle.js","View2D/Control/MagnifyingGlass.js","View2D/Control/GeoPanZoom.js","View2D/Control/PanZoomBarTitle.js","View2D/Control/GeoOverviewMap.js","View2D/Control/GeoSelectFeature.js","View2D/Control/ZoomBar.js",
"View2D/Control/Measure/AreaMeasure.js","View2D/Control/Measure/DistanceMeasure.js","View2D/Control/Measure/Angle.js","View2D/Control/Measure/AngleMeasure.js","View2D/Control/MapContextMenu.js","View2D/Control/TimeSlider.js","View2D/Control/PrintMap.js","View2D/MenuItem.js","View2D/TemporalRenderer.js","View2D/ChartContainer.js","View2D/Popup/GeoFrameCloud.js","View3D/Map.js","View3D/Layer.js","View3D/BaseLayerGroup.js","View3D/LayerGroup.js","View3D/Layer/GlobeTile.js","View3D/Layer/ArcgisRest.js",
"View3D/Layer/Shape.js","View3D/Layer/Terrain.js","View3D/Layer/Vector.js","View3D/Layer/WMS.js","View3D/Layer/WMTS.js","View3D/Layer/WFS.js","View3D/Layer/WTFS.js","View3D/Layer/Solid.js","View3D/Layer/WCS.js","View3D/Layer/Grid.js","View3D/Layer/Model.js","View3D/Event/MouseEvent.js","View3D/Event/KeyEvent.js","View3D/Handler.js","View3D/Handler/KeybordDefaults.js","View3D/Handler/Mouse.js","View3D/Handler/Point.js","View3D/Handler/Path.js","View3D/Handler/Polygon.js","View3D/Handler/Box.js","View3D/Handler/ModelChoose.js",
"View3D/Handler/Feature.js","View3D/Handler/Keyboard.js","View3D/Control.js","View3D/Control/KeyboardDefaults.js","View3D/Control/Measure.js","View3D/Control/DrawPath.js","View3D/Control/DrawPoint.js","View3D/Control/DrawPolygon.js","View3D/Control/DrawFeature.js","View3D/Control/SelectFeature.js","View3D/Control/Attribution.js","View3D/Control/Box.js","View3D/Control/Mouse.js","View3D/Control/ModelChoose.js","View3D/Control/Analysis.js","View3D/Control/Keyboard.js","View3D/Control/DrawBox.js","View3D/Fly.js",
"View3D/Popup.js","View3D/Popup/FramedCloud.js","View3D/FeatureManager.js","View3D/Control/Measure/PointInfo.js","View3D/Control/Measure/Distance.js","View3D/Control/Measure/Area.js","View3D/Control/Measure/Volume.js","View3D/Control/Measure/Excavate.js","View3D/Control/Measure/Flood.js","View3D/Control/Measure/Profile.js","View3D/Control/Measure/TwoPointThrough.js","CombineView.js","LayerManager.js","Request.js","Analysis/AreasAndLengthsParameters.js","Analysis/BufferAnalysis.js","Analysis/BufferParameters.js",
"Analysis/DensifyParameters.js","Analysis/DistanceParameters.js","Analysis/GeneralizeParameters.js","Analysis/GeometryService.js","Analysis/LengthsParameters.js","Analysis/OffsetParameters.js","Analysis/ProjectParameters.js","Analysis/RelationParameters.js","Analysis/SuperposeAnalysis.js","Analysis/TrimExtendParameters.js","Analysis/Util.js","Query/WFSQuery.js","Query/WFSQueryForPage.js","Query/CatalogQuery.js","Query/ModelQuery.js","Query/MapServiceQuery.js","Query/MapServiceQueryParameters.js",
"Query/MapServiceQueryResult.js","Query/MapServiceIdentify.js","Query/MapServiceIdentifyParameters.js","Query/MapServiceIdentifyResult.js","Query/MapServiceDataFeatures.js","Query/MapServiceDataFeaturesParameters.js","Query/MapServiceDataFeaturesResult.js","Query/MapServiceFind.js","Query/MapServiceFindParameters.js","Query/MapServiceFindResult.js","Query/GeoCodingQuery.js","Query/GeoCodingQuery/v1.js","Query/GeoCodingQuery/v1_0_0.js","Query/GeoCodingQuery/v1_1_0.js","Tdt/Busline.js","Tdt/BuslineQuery.js",
"Tdt/BuslineQueryResult.js","Tdt/BuslineSegment.js","Tdt/ChangeCity.js","Tdt/DriveQuery.js","Tdt/DriveQueryResult.js","Tdt/PlaceQuery.js","Tdt/PlaceQueryResultPios.js","Tdt/PlaceQueryResultStatistics.js","Tdt/Util.js","Tdt/Weather.js","Strategy/AttributeCluster.js","Strategy/GeoTextXYZ.js","Service.js","Service/GlobeTile.js","Service/Bus.js","Service/Plot.js","Service/ShortestPath.js","Service/Route.js","Service/TAS.js","Service/WPS.js","Service/WFS.js","Service/WFST.js","Service/WMS.js","Service/WMTS.js",
"Service/GeoWMTS.js","Service/WCS.js","Service/CSW.js","Service/CWMS.js","Service/MapService.js","Service/MapServiceLayerDetail.js","Service/GeoCoding.js","Service/GeoRoute.js","Service/GeoRouteInfoResult.js","Service/GeoRoutesResult.js","Service/GeoText.js","Service/Thematic.js"],b="",c=/(^|(.*?\/))(GeoGlobeJSAPI.js)(\?|$)/,d=document.getElementsByTagName("script"),e=0,f=d.length;e<f;e++){var g=d[e].getAttribute("src");if(g&&(g=g.match(c))){b=g[1];break}}e=navigator.userAgent;if(c=e.match("MSIE")||
e.match("Safari"))var h=Array(a.length);e=0;for(f=a.length;e<f;e++)c?h[e]="<script src='"+b+a[e]+"'><\/script>":(d=document.createElement("script"),d.src=b+a[e],(document.getElementsByTagName("head").length?document.getElementsByTagName("head")[0]:document.body).appendChild(d));c&&document.write(h.join(""))}Geo.scriptName=!Geo.singleFile?"GeoGlobeJSAPI/GeoGlobeJSAPI.js":"GeoGlobeJS.min.js";Geo.getScriptLocation=function(){for(var a="",b=RegExp("(^|(.*?\\/))("+Geo.scriptName+")(\\?|$)"),c=document.getElementsByTagName("script"),
d=0,e=c.length;d<e;d++){var f=c[d].getAttribute("src");if(f&&(f=f.match(b))){a=f[1];break}}return a};Geo.imagesPath="";Geo.createNS=function(a){for(var a=a.split("."),b=window,c=0;c<a.length;c++)b[a[c]]||(b[a[c]]={}),b=b[a[c]]};Geo.setProxyHost=function(a){OpenLayers.ProxyHost=a};Geo.getProxyHost=function(){return OpenLayers.ProxyHost};Geo.setDPI=function(a){if(a)OpenLayers.DOTS_PER_INCH=a};Geo.VERSION_NUMBER="GeoGlobeJSAPI 5.2 -- $Version: 1.20.66 build-20141022 $";OpenLayers.Layer.WMTS.prototype.buffer=
0;OpenLayers.Layer.WMS.prototype.buffer=0;OpenLayers.Kinetic.prototype.deceleration=0.0033;OpenLayers.INCHES_PER_UNIT["\u516c\u91cc"]=OpenLayers.INCHES_PER_UNIT.km;OpenLayers.INCHES_PER_UNIT["\u7c73"]=OpenLayers.INCHES_PER_UNIT.m;OpenLayers.INCHES_PER_UNIT["\u82f1\u91cc"]=OpenLayers.INCHES_PER_UNIT.mi;OpenLayers.INCHES_PER_UNIT["\u82f1\u5bf8"]=OpenLayers.INCHES_PER_UNIT.ft;OpenLayers.Lang.setCode("zh-CN")})();
Geo.Animator=Geo.Class({id:null,_queue:null,_currentIndex:0,feature:null,isRepeat:!0,frequence:5,initialize:function(){this.id=OpenLayers.Util.createUniqueID("Geo.Animater_");this._queue=[]},isPlaying:function(){return this._currentIndex==this._queue.length-1?!1:!0},isAtStart:function(){return this._currentIndex==0?!0:!1},isAtEnd:function(){return this._currentIndex==this._queue.length-1?!0:!1},setFeature:function(a){this.feature=a},start:function(){var a=this._queue[this._currentIndex];if(a){var b=
OpenLayers.Function.bind(function(){this._stepRun(a)},this);a.interval=window.setInterval(b,this.frequence)}},stop:function(){for(var a=this._currentIndex=0;a<this._queue.length;a++){var b=this._queue[a];window.clearInterval(b.interval);b.counter=0}},pause:function(){window.clearInterval(this._queue[this._currentIndex].interval)},_getQueueItem:function(){return{counter:0,isStop:!1,moveType:"velocity",doFn:function(){},checkStopFn:function(){return!1},interval:null,options:{}}},_addItem:function(a,
b,c){var d=this._getQueueItem();if(a)d.doFn=OpenLayers.Function.bind(a,this);if(b)d.checkStopFn=OpenLayers.Function.bind(b,this);d.options=c;this._queue.push(d)},_stepRun:function(a){if(a.checkStopFn()){window.clearInterval(a.interval);a.counter=0;var a=OpenLayers.Util.indexOf(this._queue,a)+1,b=this._queue[a];if(a!==0&&b){var c=OpenLayers.Function.bind(function(){this._stepRun(b)},this);b.interval=window.setInterval(c,5);this._currentIndex=a}else this._currentIndex=0,this.onStop()}else a.doFn(a),
a.counter++},onStop:function(){},onChange:function(){},moveTo:function(a,b){var c=this.feature;new Geo.LonLat(c.geometry.x,c.geometry.y);b=b||{};b={from:null,to:a,currentPosition:null,moveType:b.moveType||"velocity",step:b.ratio||0.01};this._addItem(function(a){var b=this.feature,a=this._queue[this._currentIndex];this._moveFeature(b,a);this.onChange(b,"move")},function(){var a=this._queue[this._currentIndex],b=new Geo.LonLat(c.geometry.x,c.geometry.y),a=a.options;a.from=a.from||b;a.currentPosition=
b;return this._checkIsOver(a.from,a.to,b)},b);return this},moveAlong:function(a,b){var c;a.CLASS_NAME=="OpenLayers.Feature.Vector"&&(c=this._getLonLatFromGeometry(a.geometry));for(var d=0;d<c.length;d++){var e=OpenLayers.Util.extend({},b);if(d==0)e.ratio=1;this.moveTo(c[d],e)}},_getLonLatFromGeometry:function(a){for(var a=a.components,b=[],c=0;c<a.length;c++)b.push(new Geo.LonLat(a[c].x,a[c].y));return b},_moveFeature:function(a,b){var c=b.options,d=c.to;if(b.counter==0)c.from=new Geo.LonLat(a.geometry.x,
a.geometry.y);var e=c.from,f=c.step,f=this._getMoveLonLat[c.moveType](e,d,f*b.counter,f),d=this._getMoveDirection(e,d);a.style.rotation=d;a.move(f);c.currentPosition=f},_checkIsOver:function(a,b,c){if(c.lon==b.lon&&c.lat==b.lat)return!0;var d=!1;a.lat<b.lat?(b=b.lat,d=a.lat):(d=b.lat,b=a.lat);return(d=c.lat>b||c.lat<d)&&d},animate:function(){},fadeIn:function(){},fadeOut:function(){},hide:function(){},show:function(){},_getMoveLonLat:{same_step:function(a,b,c){c>1&&(c=1);var d;d=a.lon===b.lon?a.lon:
a.lon+c*(b.lon-a.lon);c=a.lat===b.lat?a.lat:a.lat+c*(b.lat-a.lat);a.lon<b.lon&&(d=d>b.lon?b.lon:d,d=d<a.lon?a.lon:d);a.lon>b.lon&&(d=d<b.lon?b.lon:d,d=d>a.lon?a.lon:d);a.lat<b.lat&&(c=c>b.lat?b.lat:c,c=c<a.lat?a.lat:c);a.lat>b.lat&&(c=c<b.lat?b.lat:c,c=c>a.lat?a.lat:c);return new Geo.LonLat(d,c)},velocity:function(a,b,c,d){var e=(new OpenLayers.Geometry.Point(a.lon,a.lat)).distanceTo(new OpenLayers.Geometry.Point(b.lon,b.lat)),f=(b.lon-a.lon)/e*d;d*=(b.lat-a.lat)/e;f=a.lon===b.lon?a.lon:a.lon+f*c;
c=a.lat===b.lat?a.lat:a.lat+d*c;a.lon<b.lon&&(f=f>b.lon?b.lon:f,f=f<a.lon?a.lon:f);a.lon>b.lon&&(f=f<b.lon?b.lon:f,f=f>a.lon?a.lon:f);a.lat<b.lat&&(c=c>b.lat?b.lat:c,c=c<a.lat?a.lat:c);a.lat>b.lat&&(c=c<b.lat?b.lat:c,c=c>a.lat?a.lat:c);return new Geo.LonLat(f,c)}},_getPointsByNum:function(a,b,c){var d=a.x,a=a.y,e;e=b.y;var f=[];percentX=(b.x-d)/(c-1);percentY=(e-a)/(c-1);for(var g=0;g<c;g++)b=d+percentX*g,e=a+percentY*g,f.push([b,e]);return f},_getAllTempPointByPercent:function(a,b,c){for(var d=[],
e=0;e<1;){var f=getXorY(a.x,b.x,e),g=getXorY(a.y,b.y,e);d.push([f,g]);e+=c}e>=1&&d.push([b.x,b.y]);return d},_getMoveDirection:function(a,b){var c=Math.atan2(Math.abs(a.lon-b.lon),Math.abs(a.lat-b.lat));b.lon>=a.lon?b.lat>=a.lat||(c=Math.PI-c):c=b.lat>=a.lat?2*Math.PI-c:Math.PI+c;return c*180/Math.PI},CLASS_NAME:"Geo.Animator"});
Geo.AnimateZoomer=Geo.Class({map:null,currentStep:0,totalStep:4,intervalTime:90,animateIntervalId:null,bufferLayerContainer:null,zoomStep:null,layerLoaded:!1,oraginPoint:null,initialize:function(a,b){this.handlers={};a&&this.setMap(a);OpenLayers.Util.extend(this,b);if(this.id==null)this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},setMap:function(a){this.map=a;this.map.baseLayer.events.register("loadend",this,function(){this.layerLoaded=!0;this.isZoomAnimating()||this.clearBufferLayer()});
this.handlers.wheel=new OpenLayers.Handler.MouseWheel(this,{up:this.wheelUp,down:this.wheelDown},this.mouseWheelOptions);this.handlers.wheel.activate();a=this.map.getControlsByClass("OpenLayers.Control.Navigation");a.length!=0&&a[0].disableZoomWheel()},wheelUp:function(a,b){var c=this.map.getZoom()+1;this.map.isValidZoomLevel(c)&&(this.map.enableAnimateZoomer&&this.playZoomAnimate(c,!0),this.wheelChange(a,b||1))},wheelDown:function(a,b){var c=this.map.getZoom()-1;this.map.isValidZoomLevel(c)&&(this.map.enableAnimateZoomer&&
this.playZoomAnimate(c,!0),this.wheelChange(a,b||-1))},zoomIn:function(){this.zoomTo(this.map.getZoom()+1)},zoomOut:function(){this.zoomTo(this.map.getZoom()-1)},zoomTo:function(a){this.map.isValidZoomLevel(a)&&(this.map.enableAnimateZoomer&&this.playZoomAnimate(a),this.map.zoomTo(a))},zoom:function(a){a=this.map.getZoom()+a;this.map.isValidZoomLevel(a)&&(this.playZoomAnimate(a),this.map.zoomTo(a))},playZoomAnimate:function(a,b){this.zoomAnimateWheelEnabled=b?!0:!1;this.currentStep=0;this.currentStep++;
this.isZoomAnimating()&&this.stopZoomAnimate();this.clearBufferLayer();this.cloneLayersTile();if(this.bufferLayerContainer.childNodes.length!=0){this.hiddenAllLayers();var c;c=this.map.getZoom();this.zoomStep=a-c;this.oraginPoint={top:parseInt(this.map.layerContainerDiv.style.top),left:parseInt(this.map.layerContainerDiv.style.left)};this.mousePosition=this.handlers.wheel.mousePosition;c=OpenLayers.Function.bind(this.zoomAnimateStep,this);c();this.animateIntervalId=setInterval(c,this.intervalTime)}},
zoomAnimateStep:function(){if(this.shouldEndAnimate())this.stopZoomAnimate(),this.layerLoaded?this.clearBufferLayer():this.backBufferLayer(),this.restoreAllLayers();else{var a=this.currentStep*((Math.pow(2,this.zoomStep)-1)/this.totalStep);this.bufferLayerContainer.style.width=Math.round(100*(1+a))+"px";this.bufferLayerContainer.style.height=Math.round(100*(1+a))+"px";var b=this.map.getLayerPxFromLonLat(this.map.getCenter());this.zoomAnimateWheelEnabled&&(b=this.mousePosition||b);var b=b.add(-this.oraginPoint.left,
-this.oraginPoint.top),c=new OpenLayers.Size(1024,512),d=Math.round(c.h*a*(b.y/c.h));this.bufferLayerContainer.style.left=this.oraginPoint.left-Math.round(c.w*a*(b.x/c.w))+"px";this.bufferLayerContainer.style.top=this.oraginPoint.top-d+"px";this.currentStep++}},frontBufferLayer:function(){this.bufferLayerContainer.style.zIndex=746},backBufferLayer:function(){this.bufferLayerContainer.style.zIndex=99},stopZoomAnimate:function(){if(this.animateIntervalId)clearInterval(this.animateIntervalId),this.animateIntervalId=
null;this.currentStep=0},isZoomAnimating:function(){if(this.animateIntervalId)return!0;return!1},shouldEndAnimate:function(){if(this.currentStep>this.totalStep)return!0;return!1},prepareAnimate:function(){},hiddenAllLayers:function(){for(var a=this.map.layers,b=0;b<a.length;b++)a[b].div.style.visibility="hidden"},restoreAllLayers:function(){for(var a=this.map.layers,b=0;b<a.length;b++)a[b].div.style.visibility="visible"},clearBufferLayer:function(){if(!this.map||!this.bufferLayerContainer)return null;
this.map.layerContainerDiv.removeChild(this.bufferLayerContainer);this.bufferLayerContainer=null},cloneLayersTile:function(){var a=document.createElement("div");a.id="bufferLayerContainer";a.style.position="absolute";a.style.zIndex=749;a.style.width="100px";a.style.height="100px";a.style.left=this.map.layerContainerDiv.style.left;a.style.top=this.map.layerContainerDiv.style.top;for(var b=this.map.layers.length-1;b>=0;b--){var c=this.map.layers[b];c.div.style.display!="none"&&c.getVisibility()&&c.transitionEffect==
"resize"&&this.cloneSingleLayerTile(c,a)}this.bufferLayerContainer=a;this.map.layerContainerDiv.appendChild(this.bufferLayerContainer)},cloneSingleLayerTile:function(a,b){if(a)for(var c=[],d=a.grid,e=0,f=d.length;e<f;e++){for(var g=[],h=0,l=d[e].length;h<l;h++){var m=d[e][h],o=m.imgDiv,j=m.frame,n;if(o&&m.shouldDraw)n=o.cloneNode(!0),n.id=o.id+"_clone",j?(n.style.position=j.style.position,n.style.left=parseInt(j.style.left)+"%",n.style.top=parseInt(j.style.top)+"%",n.style.width=parseInt(j.style.width)+
"%",n.style.height=parseInt(j.style.height)+"%",n.style.display=j.style.display):(n.style.left=parseInt(n.style.left)+"%",n.style.top=parseInt(n.style.top)+"%",n.style.width=parseInt(n.style.width)+"%",n.style.height=parseInt(n.style.height)+"%"),n.style.zIndex=m.layer.div.style.zIndex,b.appendChild(n),g.push(n)}g.length&&c.push(g)}},wheelChange:function(a,b){var c=this.map.getZoom(),d=this.map.getZoom()+Math.round(b),d=Math.max(d,0),d=Math.min(d,this.map.getNumZoomLevels());if(d!==c){var e=this.map.getSize(),
c=e.w/2-a.xy.x,e=a.xy.y-e.h/2,f=this.map.baseLayer.getResolutionForZoom(d),g=this.map.getLonLatFromPixel(a.xy);this.map.setCenter(new OpenLayers.LonLat(g.lon+c*f,g.lat+e*f),d)}},destroy:function(){if(this.handler)this.handler.destroy(),this.handler=null;if(this.handlers){for(var a in this.handlers)this.handlers.hasOwnProperty(a)&&typeof this.handlers[a].destroy=="function"&&this.handlers[a].destroy();this.handlers=null}},CLASS_NAME:"Geo.AnimateZoomer"});
Geo.Util.englishColorToOx={black:"#000000",blue:"#0000FF",brown:"#A52A2A",cyan:"#00FFFF",gold:"#FFD700",gray:"#808080",green:"#008000",lime:"#00FF00",orange:"#FFA500",red:"#FF0000",white:"#FFFFFF",yellow:"#FFFF00"};
Geo.Util.ToArgb=function(a,b){var c=Geo.Util.englishColorToOx,d;for(d in c)d===a&&(a=c[d].replace("#",""));c=parseInt(a,16);d=c.toString(2);var e=d.length;if(e<24)for(i=0;i<24-e;i++)d="0"+d;d=b.toString(2)+d;return d.substr(0,1)=="1"?(d=d.substr(1,31),0-(2147483647-parseInt(d,2))-1):parseInt(b.toString(2)+c.toString(2),2)};
Geo.Util.getHexColor=function(a){var b=Geo.Util.englishColorToOx[a],c=a.indexOf("#"),d=null;c==0&&!b?(a=a.substr(1),a.length==3?d=a.charAt(0)+a.charAt(0)+a.charAt(1)+a.charAt(1)+a.charAt(2)+a.charAt(2):a.length==6&&(d=a)):c==-1&&b&&(d=b.substr(1));return"0x"+d};Geo.Util.meterToDegree=function(a,b){return a*(8.99E-6/Math.cos(OpenLayers.Util.rad(b.lat)))};Geo.Util.webColorToHex=function(a){return new Number("0x00"+a.replace("#",""))};
Geo.Util.replaceAll=function(a,b,c){return a.replace(RegExp(b,"gm"),c?c:"")};Geo.Util.Format={};
Geo.Pyramid=Geo.Class({name:null,pyramidID:null,description:null,topLevelIndex:null,resolutions:null,bottomLevelIndex:null,scaleX:null,scaleY:null,tileSize:null,originRowIndex:null,originColIndex:null,topTileFromX:null,topTileFromY:null,topTileToX:null,topTileToY:null,units:"degrees",initialize:function(a){if(!a||a==={})a=Geo.Pyramid.DEFAULT_PYRAMID;OpenLayers.Util.extend(this,a)},getMaxExtent:function(){var a,b,c,d;this.topTileFromX<this.topTileToX?(a=this.topTileFromX,c=this.topTileToX):(c=this.topTileFromX,
a=this.topTileToX);this.topTileFromY<this.topTileToY?(b=this.topTileFromY,d=this.topTileToY):(d=this.topTileFromY,b=this.topTileToY);return new Geo.Bounds(a,b,c,d)},getLevelForResolution:function(a){if(!a)return 0;var b,c,d=Number.POSITIVE_INFINITY,e=this.getResolutions();b=0;for(len=e.length;b<len;b++){c=Math.abs(e[b]-a);if(c>d)break;d=c}return Math.max(0,b-1)},getLevelForScale:function(a){return this.getLevelForResolution(OpenLayers.Util.getResolutionFromScale(a,this.units))},getResolutionForScale:function(a){return this.getResolutionForLevel(this.getLevelForScale(a,
this.units))},getResolutionForLevel:function(a){return this.getTopTileSize().w/this.tileSize.w/Math.pow(2,a)},getMaxResolution:function(){return this.getResolutionForLevel(this.topLevelIndex)},getMinResolution:function(){return this.getResolutionForLevel(this.bottomLevelIndex)},getResolutions:function(){for(var a=[],b=this.topLevelIndex;b<=this.bottomLevelIndex;b++)a.push(this.getResolutionForLevel(b));return a},getNumZoomLevels:function(){return this.bottomLevelIndex-this.topLevelIndex+1},getTopTileSize:function(){return new Geo.Size(Math.abs(this.topTileToX-
this.topTileFromX),Math.abs(this.topTileToY-this.topTileFromY))},getTileIndex:function(a,b){var c=a.lon,d=a.lat,e=this.getTopTileSize().w/Math.pow(2,b),f=this.maxExtent.getWidth(),g=this.maxExtent.getHeight(),f=Math.round(f/e),g=Math.round(g/e),c=Math.ceil(Math.abs(c-this.topTileFromX)/e)-1;this.topTileFromX<this.topTileToX||(c=f-c);d=Math.ceil(Math.abs(d-this.topTileFromY)/e)-1;this.topTileFromY>this.topTileToY||(d=g-d);return{col:c,row:d}},getTileBoundsForGridIndex:function(a,b,c){c=this.getResolutionForLevel(c);
a=this.topTileFromX+a*this.tileSize.w*c;b=this.topTileFromY-b*this.tileSize.h*c;return new Geo.Bounds(a,b-this.tileSize.h*c,a+this.tileSize.w*c,b)},getTileInfoFromBounds:function(a,b){var c=this.getTileIndex(new Geo.LonLat(a.left,a.top),b),d=this.getTileIndex(new Geo.LonLat(a.right,a.bottom),b);return{mincol:c.col,minrow:c.row,maxcol:d.col,maxrow:d.row}},getTileInfoFromLonLat:this.getTileIndex,clone:function(){return OpenLayers.Util.extend({},this)},CLASS_NAME:"Geo.Pyramid"});
Geo.Pyramid.Degree360={name:"360DegreePyramid",topLevelIndex:0,bottomLevelIndex:20,scaleX:2,scaleY:2,topTileFromX:-180,topTileFromY:90,topTileToX:180,topTileToY:-270,tileSize:new Geo.Size(256,256),originRowIndex:0,originColIndex:0,maxExtent:new Geo.Bounds(-180,-90,180,90)};
Geo.Pyramid.Degree18={name:"18DegreePyramid",topLevelIndex:0,bottomLevelIndex:20,scaleX:2,scaleY:2,topTileFromX:-180,topTileFromY:-90,topTileToX:-162,topTileToY:-72,tileSize:new Geo.Size(256,256),originRowIndex:0,originColIndex:0,maxExtent:new Geo.Bounds(-180,-90,180,90)};Geo.Pyramid.DEFAULT_PYRAMID=Geo.Pyramid.Degree360;
Geo.SymbolizerManager=Geo.Class({initialize:function(){},getImagePath:function(){return Geo.getScriptLocation()+"images/"},createSymbolizer:function(a,b){Geo.SymbolizerManager.symbolizerGroup[a]={};for(var c=0;c<b.length;c++)Geo.SymbolizerManager.symbolizerGroup[a][b[c].name]=b[c].symbolizer},updateSymbolizer:function(a,b,c){OpenLayers.Util.extend(Geo.SymbolizerManager.symbolizerGroup[a][b],c)},removeSymbolizer:function(a,b){Geo.SymbolizerManager.symbolizerGroup[a][b]=null;delete Geo.SymbolizerManager.symbolizerGroup[a][b]},
getSymbolizerGroup:function(){return Geo.SymbolizerManager.symbolizerGroup},CLASS_NAME:"Geo.SymbolizerManager"});
Geo.SymbolizerManager.symbolizerGroup={COMMON:{A:{externalGraphic:Geo.getScriptLocation()+"images/common/0.png",graphicWidth:32,graphicHeight:32,graphicXOffset:-15,graphicYOffset:-16},B:{externalGraphic:Geo.getScriptLocation()+"images/common/1.png",graphicWidth:32,graphicHeight:32,graphicXOffset:-15,graphicYOffset:-16},C:{externalGraphic:Geo.getScriptLocation()+"images/common/2.png",graphicWidth:32,graphicHeight:32,graphicXOffset:-15,graphicYOffset:-16},D:{externalGraphic:Geo.getScriptLocation()+
"images/common/3.png",graphicWidth:32,graphicHeight:32,graphicXOffset:-15,graphicYOffset:-16},E:{externalGraphic:Geo.getScriptLocation()+"images/common/4.png",graphicWidth:32,graphicHeight:32,graphicXOffset:-15,graphicYOffset:-16},F:{externalGraphic:Geo.getScriptLocation()+"images/common/5.png",graphicWidth:32,graphicHeight:32,graphicXOffset:-15,graphicYOffset:-16},G:{externalGraphic:Geo.getScriptLocation()+"images/common/6.png",graphicWidth:32,graphicHeight:32,graphicXOffset:-15,graphicYOffset:-16},
H:{externalGraphic:Geo.getScriptLocation()+"images/common/7.png",graphicWidth:32,graphicHeight:32,graphicXOffset:-15,graphicYOffset:-16},I:{externalGraphic:Geo.getScriptLocation()+"images/common/8.png",graphicWidth:32,graphicHeight:32,graphicXOffset:-15,graphicYOffset:-16},J:{externalGraphic:Geo.getScriptLocation()+"images/common/9.png",graphicWidth:32,graphicHeight:32,graphicXOffset:-15,graphicYOffset:-16}}};
Geo.GeoMarker=Geo.Class(Geo.Marker,{initialize:function(a,b,c){this.tag=c;Geo.Marker.prototype.initialize.apply(this,arguments)},setAnimation:function(a,b,c){if(!(a!==Geo.GeoMarker.ANIMATION_DROP&&a!==Geo.GeoMarker.ANIMATION_BOUNCE)&&(b=b?b:20,b=b<0?0:b,b!=0&&(c=c?c:500,c=c<0?0:c,c!=0))){this.timerId&&clearInterval(this.timerId);var d=this.icon.size,e=this.icon,f=c,g=0,h=-d.h-b;e.offset.y=h;var l=!1;this.timerId=window.setInterval(OpenLayers.Function.bind(function(){if(l&&a===Geo.GeoMarker.ANIMATION_DROP)clearInterval(this.timerId),
this.timerId=null;else{g+=0.01;var b=h+f*g*g/2;b>-d.h&&(b=-d.h,a===Geo.GeoMarker.ANIMATION_BOUNCE&&(g=-g),l=!0);e.offset.y=b;e.moveTo()}},this),10)}},setContentHTML:function(a){this.tag&&this.tag.setContentHTML(a)},drawTag:function(a){if(this.tag)return this.tag.draw(a);return null},isDrawnTag:function(){return this.tag&&this.tag.isDrawn()},destroy:function(){this.erase();this.map=null;this.events.destroy();this.events=null;if(this.icon!=null)this.icon.destroy(),this.icon=null;if(this.tag!=null)this.tag.destroy(),
this.tag=null},erase:function(){this.icon!=null&&this.icon.erase();this.tag!=null&&this.tag.erase()},CLASS_NAME:"Geo.GeoMarker"});Geo.GeoMarker.ANIMATION_DROP=1;Geo.GeoMarker.ANIMATION_BOUNCE=2;
OpenLayers.Renderer.Canvas.prototype.drawText=function(a,b){b=OpenLayers.Util.extend({fontColor:"#000000",labelAlign:"cm"},b);if(b.labelXOffset||b.labelYOffset){var c=isNaN(b.labelXOffset)?0:b.labelXOffset,d=isNaN(b.labelYOffset)?0:b.labelYOffset,e=this.getResolution();a.move(c*e,d*e)}c=this.getLocalXY(a);this.setCanvasStyle("reset");this.canvas.fillStyle=b.fontColor;this.canvas.globalAlpha=b.fontOpacity||1;var f=[b.fontStyle?b.fontStyle:"normal","normal",b.fontWeight?b.fontWeight:"normal",b.fontSize?
b.fontSize:"1em",b.fontFamily?b.fontFamily:"sans-serif"].join(" "),d=b.label.split("\n"),e=d.length;if(this.canvas.fillText){this.canvas.font=f;this.canvas.textAlign=OpenLayers.Renderer.Canvas.LABEL_ALIGN[b.labelAlign[0]]||"center";this.canvas.textBaseline=OpenLayers.Renderer.Canvas.LABEL_ALIGN[b.labelAlign[1]]||"middle";var g=OpenLayers.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[1]];g==null&&(g=-0.5);f=this.canvas.measureText("Mg").height||this.canvas.measureText("Mx").width;c[1]+=f*g*(e-1);var h=
b.labelRotation;if(h)this.canvas.save(),this.canvas.translate(c[0],c[1]),this.canvas.rotate(h*Math.PI/180),this.canvas.fillText(d[0],0,0),this.canvas.restore();else for(g=0;g<e;g++)this.canvas.fillText(d[g],c[0],c[1]+f*g)}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=f;h=OpenLayers.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[0]];h==null&&(h=-0.5);g=OpenLayers.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[1]];g==null&&(g=-0.5);f=this.canvas.mozMeasureText("xx");c[1]+=f*(1+g*e);for(g=0;g<e;g++){var l=
c[0]+h*this.canvas.mozMeasureText(d[g]),m=c[1]+g*f;this.canvas.translate(l,m);this.canvas.mozDrawText(d[g]);this.canvas.translate(-l,-m)}}this.setCanvasStyle("reset")};OpenLayers.Map.prototype.zoom=null;
(function(){var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Geo.Math.uuid=function(b,c){var d=[],c=c||a.length;if(b)for(var e=0;e<b;e++)d[e]=a[0|Math.random()*c];else{var f;d[8]=d[13]=d[18]=d[23]="-";d[14]="4";for(e=0;e<36;e++)d[e]||(f=0|Math.random()*16,d[e]=a[e==19?f&3|8:f])}return d.join("")};Geo.Math.uuidFast=function(){for(var b=Array(36),c=0,d,e=0;e<36;e++)e==8||e==13||e==18||e==23?b[e]="-":e==14?b[e]="4":(c<=2&&(c=33554432+Math.random()*16777216|0),d=c&15,c>>=
4,b[e]=a[e==19?d&3|8:d]);return b.join("")};Geo.Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=Math.random()*16|0;return(a=="x"?c:c&3|8).toString(16)}).toUpperCase()}})();
(function(a){var b=function(){var a=function(a){var b={data:[],heatmap:a};this.max=1;this.get=function(a){return b[a]};this.set=function(a,c){b[a]=c}};a.prototype={addDataPoint:function(a,b){if(!(a<0||b<0)){var c=this.get("heatmap"),d=this.get("data");d[a]||(d[a]=[]);d[a][b]||(d[a][b]=0);d[a][b]+=arguments.length<3?1:arguments[2];this.set("data",d);this.max<d[a][b]?(c.get("actx").clearRect(0,0,c.get("width"),c.get("height")),this.setDataSet({max:d[a][b],data:d},!0)):c.drawAlpha(a,b,d[a][b],!0)}},
setDataSet:function(a,b){var c=this.get("heatmap"),d=[],e=a.data,o=e.length;c.clear();this.max=a.max;c.get("legend")&&c.get("legend").update(a.max);if(b!=null&&b)for(var j in e){if(j!==void 0)for(var n in e[j])n!==void 0&&c.drawAlpha(j,n,e[j][n],!1)}else for(;o--;)j=e[o],c.drawAlpha(j.x,j.y,j.count,!1),d[j.x]||(d[j.x]=[]),d[j.x][j.y]||(d[j.x][j.y]=0),d[j.x][j.y]=j.count;c.colorize();this.set("data",e)},exportDataSet:function(){var a=this.get("data"),b=[],c;for(c in a)if(c!==void 0)for(var d in a[c])d!==
void 0&&b.push({x:parseInt(c,10),y:parseInt(d,10),count:a[c][d]});return{max:this.max,data:b}},generateRandomDataSet:function(a){var b=this.get("heatmap"),c=b.get("width"),b=b.get("height"),d={},e=Math.floor(Math.random()*1E3+1);d.max=e;for(var o=[];a--;)o.push({x:Math.floor(Math.random()*c+1),y:Math.floor(Math.random()*b+1),count:Math.floor(Math.random()*e+1)});d.data=o;this.setDataSet(d)}};var b=function(a){this.config=a;var b={element:null,labelsEl:null,gradientCfg:null,ctx:null};this.get=function(a){return b[a]};
this.set=function(a,c){b[a]=c};this.init()};b.prototype={init:function(){var a=this.config,b=a.title||"Legend",c=a.position,d=a.offset||10,a=document.createElement("ul"),e="";this.processGradientObject();e+=c.indexOf("t")>-1?"top:"+d+"px;":"bottom:"+d+"px;";e+=c.indexOf("l")>-1?"left:"+d+"px;":"right:"+d+"px;";c=document.createElement("div");c.style.cssText="border-radius:5px;position:absolute;"+e+"font-family:Helvetica; width:256px;z-index:10000000000; background:rgba(255,255,255,1);padding:10px;border:1px solid black;margin:0;";
c.innerHTML="<h3 style='padding:0;margin:0;text-align:center;font-size:16px;'>"+b+"</h3>";a.style.cssText="position:relative;font-size:12px;display:block;list-style:none;list-style-type:none;margin:0;height:15px;";b=document.createElement("div");b.style.cssText=["position:relative;display:block;width:256px;height:15px;border-bottom:1px solid black; background-image:url(",this.createGradientImage(),");"].join("");c.appendChild(a);c.appendChild(b);this.set("element",c);this.set("labelsEl",a);this.update(1)},
processGradientObject:function(){var a=this.config.gradient,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push({stop:c,value:a[c]});b.sort(function(a,b){return a.stop-b.stop});b.unshift({stop:0,value:"rgba(0,0,0,0)"});this.set("gradientArr",b)},createGradientImage:function(){var a=this.get("gradientArr"),b=a.length,c=document.createElement("canvas"),d=c.getContext("2d"),e;c.width="256";c.height="15";e=d.createLinearGradient(0,5,256,10);for(var o=0;o<b;o++)e.addColorStop(1/(b-1)*o,a[o].value);d.fillStyle=
e;d.fillRect(0,5,256,10);d.strokeStyle="black";d.beginPath();for(o=0;o<b;o++)d.moveTo((1/(b-1)*o*256>>0)+0.5,0),d.lineTo((1/(b-1)*o*256>>0)+0.5,o==0?15:5);d.moveTo(255.5,0);d.lineTo(255.5,15);d.moveTo(255.5,4.5);d.lineTo(0,4.5);d.stroke();this.set("ctx",d);return c.toDataURL()},getElement:function(){return this.get("element")},update:function(a){for(var b=this.get("gradientArr"),c=this.get("ctx"),d=this.get("labelsEl"),e,o="",j,n=0;n<b.length;n++)e=a*b[n].stop>>0,j=c.measureText(e).width/2>>0,n==
0&&(j=0),n==b.length-1&&(j*=2),o+='<li style="position:absolute;left:'+(((1/(b.length-1)*n*256||0)>>0)-j+0.5)+'px">'+e+"</li>";d.innerHTML=o}};var e=function(b){var d={radius:40,element:{},canvas:{},acanvas:{},ctx:{},actx:{},legend:null,visible:!0,width:0,height:0,max:!1,gradient:!1,opacity:180,premultiplyAlpha:!1,bounds:{l:1E3,r:0,t:1E3,b:0},debug:!1};this.store=new a(this);this.get=function(a){return d[a]};this.set=function(a,b){d[a]=b};this.configure(b);this.init()};e.prototype={configure:function(a){this.set("radius",
a.radius||40);this.set("element",a.element instanceof Object?a.element:document.getElementById(a.element));this.set("visible",a.visible!=null?a.visible:!0);this.set("max",a.max||!1);this.set("gradient",a.gradient||{0.45:"rgb(0,0,255)",0.55:"rgb(0,255,255)",0.65:"rgb(0,255,0)",0.95:"yellow",1:"rgb(255,0,0)"});this.set("opacity",parseInt(255/(100/a.opacity),10)||180);this.set("width",a.width||0);this.set("height",a.height||0);this.set("debug",a.debug);if(a.legend){var c=a.legend;c.gradient=this.get("gradient");
this.set("legend",new b(c))}this.set("map",a.map)},resize:function(){var a=this.get("element"),b=this.get("canvas"),c=this.get("acanvas");b.width=c.width=this.get("width")||a.style.width.replace(/px/,"")||this.getWidth(a);this.set("width",b.width);b.height=c.height=this.get("height")||a.style.height.replace(/px/,"")||this.getHeight(a);this.set("height",b.height)},init:function(){var a=document.createElement("canvas"),b=document.createElement("canvas"),c=a.getContext("2d"),d=b.getContext("2d"),e=this.get("element");
this.initColorPalette();this.set("canvas",a);this.set("ctx",c);this.set("acanvas",b);this.set("actx",d);this.resize();a.style.cssText=b.style.cssText="position:absolute;top:0;left:0;z-index:10000000;";if(!this.get("visible"))a.style.display="none";e.appendChild(a);this.get("legend")&&(this.get("map")?this.get("map").viewPortDiv.appendChild(this.get("legend").getElement()):e.appendChild(this.get("legend").getElement()));this.get("debug")&&document.body.appendChild(b);d.shadowOffsetX=15E3;d.shadowOffsetY=
15E3;d.shadowBlur=15},initColorPalette:function(){var a=document.createElement("canvas"),b=this.get("gradient"),c,d;a.width="1";a.height="256";a=a.getContext("2d");c=a.createLinearGradient(0,0,1,256);d=a.getImageData(0,0,1,1);d.data[0]=d.data[3]=64;d.data[1]=d.data[2]=0;a.putImageData(d,0,0);d=a.getImageData(0,0,1,1);this.set("premultiplyAlpha",d.data[0]<60||d.data[0]>70);for(var e in b)c.addColorStop(e,b[e]);a.fillStyle=c;a.fillRect(0,0,1,256);this.set("gradient",a.getImageData(0,0,1,256).data)},
getWidth:function(a){var b=a.offsetWidth;a.style.paddingLeft&&(b+=a.style.paddingLeft);a.style.paddingRight&&(b+=a.style.paddingRight);return b},getHeight:function(a){var b=a.offsetHeight;a.style.paddingTop&&(b+=a.style.paddingTop);a.style.paddingBottom&&(b+=a.style.paddingBottom);return b},colorize:function(a,b){var c=this.get("width"),d=this.get("radius"),e=this.get("height"),o=this.get("actx"),j=this.get("ctx"),n=d*3,d=this.get("premultiplyAlpha"),v=this.get("gradient"),u=this.get("opacity"),p=
this.get("bounds"),s,r,t;a!=null&&b!=null?(a+n>c&&(a=c-n),a<0&&(a=0),b<0&&(b=0),b+n>e&&(b=e-n),s=a,c=b,r=a+n,e=b+n):(s=p.l<0?0:p.l,r=p.r>c?c:p.r,c=p.t<0?0:p.t,e=p.b>e?e:p.b);o=o.getImageData(s,c,r-s,e-c);e=o.data;n=e.length;for(r=3;r<n;r+=4)if(t=e[r],p=t*4)t=t<u?t:u,e[r-3]=v[p],e[r-2]=v[p+1],e[r-1]=v[p+2],d&&(e[r-3]/=255/t,e[r-2]/=255/t,e[r-1]/=255/t),e[r]=t;o.data=e;j.putImageData(o,s,c)},drawAlpha:function(a,b,c,d){var e=this.get("radius"),o=this.get("actx");this.get("max");var j=this.get("bounds"),
n=a-1.5*e>>0,v=b-1.5*e>>0,u=a+1.5*e>>0,p=b+1.5*e>>0;o.shadowColor="rgba(0,0,0,"+(c?c/this.store.max:"0.1")+")";o.shadowOffsetX=15E3;o.shadowOffsetY=15E3;o.shadowBlur=15;o.beginPath();o.arc(a-15E3,b-15E3,e,0,Math.PI*2,!0);o.closePath();o.fill();d?this.colorize(n,v):(n<j.l&&(j.l=n),v<j.t&&(j.t=v),u>j.r&&(j.r=u),p>j.b&&(j.b=p))},toggleDisplay:function(){var a=this.get("visible");this.get("canvas").style.display=a?"none":"block";this.set("visible",!a)},getImageData:function(){return this.get("canvas").toDataURL()},
clear:function(){var a=this.get("width"),b=this.get("height");this.store.set("data",[]);this.get("ctx").clearRect(0,0,a,b);this.get("actx").clearRect(0,0,a,b)},cleanup:function(){this.get("element").removeChild(this.get("canvas"))}};return{create:function(a){return new e(a)},util:{mousePosition:function(a){var b,c;if(a.layerX)b=a.layerX,c=a.layerY;else if(a.offsetX)b=a.offsetX,c=a.offsetY;if(typeof b!="undefined")return[b,c]}}}}();a.h337=a.heatmapFactory=b})(window);
Geo.Util.Format.BusCapabilities=Geo.Class(Geo.Format.XML,{tagName:"NETWORK_Capabilities",read:function(a){typeof a=="string"&&(a=Geo.Format.XML.prototype.read.apply(this,[a]));var a=a.nodeName!=this.tagName?a.getElementsByTagName(this.tagName):[a],b={};a.length>0&&this.runChildNodes(b,a[0]);return b},runChildNodes:function(a,b,c){for(var b=b.childNodes,d,e,f=0;f<b.length;++f)d=b[f],d.nodeType==1&&(e=c?this["read_"+c+"_"+d.nodeName]:this["read_"+d.nodeName])&&e.apply(this,[a,d])},read_Service:function(a,
b){var c={};this.runChildNodes(c,b,"Service");a.service=c},read_Service_Name:function(a,b){var c=this.getChildValue(b);if(c)a.name=c},read_Service_Title:function(a,b){var c=this.getChildValue(b);if(c)a.title=c},read_Service_Abstract:function(a,b){var c=this.getChildValue(b);if(c)a.serviceAbstract=c},read_Service_KeywordList:function(){},read_Service_OnlineResource:function(a,b){var c=this.getChildValue(b);if(a)a.onlineResource=c},read_Capability:function(a,b){var c={};this.runChildNodes(c,b,"Capability");
a.capability=c},read_Capability_Request:function(a,b){var c={};this.runChildNodes(c,b,"Capability_Request");a.request=c},read_Capability_Request_GetCapabilities:function(a,b){var c=b.getElementsByTagName("HTTP"),d={};c[0]&&this.runChildNodes(d,c[0],"Capability_Request_GetCapabilities_DCPType_HTTP");a.getCapabilities=d},read_Capability_Request_GetCapabilities_DCPType_HTTP_Get:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.getUrl=c},read_Capability_Request_GetCapabilities_DCPType_HTTP_Post:function(a,
b){var c=b.getAttribute("onlineResource");if(c)a.postUrl=c},read_Capability_Request_queryStation:function(a,b){var c=b.getElementsByTagName("HTTP"),d={};c[0]&&this.runChildNodes(d,c[0],"Capability_Request_queryStation_DCPType_HTTP");a.queryStation=d},read_Capability_Request_queryStation_DCPType_HTTP_Get:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.getUrl=c},read_Capability_Request_queryStation_DCPType_HTTP_Post:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.postUrl=c},
read_Capability_Request_queryLine:function(a,b){var c=b.getElementsByTagName("HTTP"),d={};c[0]&&this.runChildNodes(d,c[0],"Capability_Request_queryLine_DCPType_HTTP");a.queryLine=d},read_Capability_Request_queryLine_DCPType_HTTP_Get:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.getUrl=c},read_Capability_Request_queryLine_DCPType_HTTP_Post:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.postUrl=c},read_Capability_Request_queryChange:function(a,b){var c=b.getElementsByTagName("HTTP"),
d={};c[0]&&this.runChildNodes(d,c[0],"Capability_Request_queryChange_DCPType_HTTP")},read_Capability_Request_queryChange_DCPType_HTTP_Get:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.getUrl=c},read_Capability_Request_queryChange_DCPType_HTTP_Post:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.postUrl=c},read_Capability_Networks:function(a,b){for(var c=b.getElementsByTagName("Name"),d=[],e=0;e<c.length;e++){var f=this.getChildValue(c[e]);f&&d.push(f)}a.networks=d},CLASS_NAME:"Geo.Util.Format.BusCapabilities"});
Geo.Util.Format.GlobeTileCapabilities=Geo.Class(Geo.Format.XML,{tagName:"ServiceCapabilities",read:function(a){typeof a=="string"&&(a=Geo.Format.XML.prototype.read.apply(this,[a]));var a=a.nodeName!=this.tagName?a.getElementsByTagName(this.tagName):[a],b=null;a.length>0&&(b={},this.runChildNodes(b,a[0],"capabilities"));return b},runChildNodes:function(a,b,c){for(var b=b.childNodes,d,e,f=0;f<b.length;++f)d=b[f],d.nodeType==1&&(e=this["read_"+c+"_"+d.nodeName])&&e.apply(this,[a,d])},read_capabilities_Name:function(a,
b){var c=this.getChildValue(b);if(c)a.name=c},read_capabilities_Service:function(a,b){var c=this.getChildValue(b);if(c)a.service=c},read_capabilities_Version:function(a,b){var c=this.getChildValue(b);if(c)a.version=c},read_capabilities_Abstract:function(a,b){var c=this.getChildValue(b);if(c)a.abstractValue=c},read_capabilities_ServerAddress:function(a,b){var c=this.getChildValue(b);if(c)a.serverAddress=c},read_capabilities_OperationList:function(a,b){var c=b.getElementsByTagName("Operations");c.length>
0&&this.read_capabilities_OperationList_Operations(a,c[0])},read_capabilities_OperationList_Operations:function(a,b){var c={},d={};this.runChildNodes(d,b,"capabilities_OperationList_Operations");c.operations=d;a.operationList=c},read_capabilities_OperationList_Operations_GetTile:function(a,b){var c={},d=[],e=b.getElementsByTagName("Format");if(e.length>0){for(var f=0;f<e.length;f++){var g=this.getChildValue(e[f]);d.push(g)}c.format=d}a.getTile=c},read_capabilities_Data:function(a,b){var c=b.getElementsByTagName("TileData");
c.length>0&&this.read_capabilities_Data_TileData(a,c[0])},read_capabilities_Data_TileData:function(a,b){var c={};this.runChildNodes(c,b,"capabilities_Data_TileData");a.tileData=c},read_capabilities_Data_TileData_Tile:function(a,b){var c=this.getChildValue(b);if(c)a.tile=c},read_capabilities_Data_TileData_CRS:function(a,b){var c=this.getChildValue(b);if(c)a.crs=c},read_capabilities_Data_TileData_BoundBox:function(a,b){var c=new Geo.Bounds(parseFloat(b.getAttribute("minx")||b.getAttribute("minX")),
parseFloat(b.getAttribute("miny")||b.getAttribute("minY")),parseFloat(b.getAttribute("maxx")||b.getAttribute("maxX")),parseFloat(b.getAttribute("maxy")||b.getAttribute("maxY")));a.boundBox=c},read_capabilities_Data_TileData_LevelZeroTileSizeX:function(a,b){var c=this.getChildValue(b);if(c)a.levelZeroTileSizeX=parseInt(c)},read_capabilities_Data_TileData_LevelZeroTileSizeY:function(a,b){var c=this.getChildValue(b);if(c)a.levelZeroTileSizeY=parseInt(c)},read_capabilities_Data_TileData_TopLevel:function(a,
b){var c=this.getChildValue(b);if(c)a.topLevel=parseInt(c)},read_capabilities_Data_TileData_BottomLevel:function(a,b){var c=this.getChildValue(b);if(c)a.bottomLevel=parseInt(c)},read_capabilities_Data_TileData_DEMDataType:function(a,b){var c=this.getChildValue(b);if(c)a.demDataType=c},read_capabilities_Data_TileData_TileVersionTime:function(a,b){var c=this.getChildValue(b);if(c){if(!a.tileVerstionTime)a.tileVerstionTime=[];a.tileVerstionTime.push(c)}},read_capabilities_Data_TileData_TilePixelsX:function(a,
b){var c=this.getChildValue(b);if(c)a.tilePixelsX=parseInt(c)},read_capabilities_Data_TileData_TilePixelsY:function(a,b){var c=this.getChildValue(b);if(c)a.tilePixelsY=parseInt(c)},read_capabilities_Data_TileData_CacheExpireTime:function(a,b){var c=this.getChildValue(b);if(c)a.cacheExpireTime=parseInt(c)},read_capabilities_Data_TileData_Pyramid:function(a,b){var c=(new Geo.Util.Format.Pyramid).read(b);a.pyramid=c},CLASS_NAME:"Geo.Util.Format.GlobeTileCapabilities"});
Geo.Util.Format.Pyramid=Geo.Class(Geo.Format.XML,{tagName:"Pyramid",read:function(a){typeof a=="string"&&(a=Geo.Format.XML.prototype.read.apply(this,[a]));var a=a.nodeName!=this.tagName?a.getElementsByTagName(this.tagName):[a],b={};a.length>0&&this.runChildNodes(b,a[0]);return b},runChildNodes:function(a,b){for(var c=b.childNodes,d,e,f=0;f<c.length;++f)d=c[f],d.nodeType==1&&(e=this["read_Pyramid_"+d.nodeName])&&e.apply(this,[a,d])},read_Pyramid_Basic:function(a,b){var c={name:b.getAttribute("Name"),
pyramidID:b.getAttribute("PyramidID"),description:b.getAttribute("Description")};OpenLayers.Util.extend(a,c)},read_Pyramid_Level:function(a,b){var c={topLevelIndex:parseInt(b.getAttribute("TopLevelIndex")),bottomLevelIndex:parseInt(b.getAttribute("BottomLevelIndex")),scaleX:parseInt(b.getAttribute("ScaleX")),scaleY:parseInt(b.getAttribute("ScaleY"))};OpenLayers.Util.extend(a,c)},read_Pyramid_TileBasic:function(a,b){var c={tileSizeX:parseFloat(b.getAttribute("TileSizeX")),tileSizeY:parseFloat(b.getAttribute("TileSizeY")),
originRowIndex:parseInt(b.getAttribute("OriginRowIndex")),originColIndex:parseInt(b.getAttribute("OriginColIndex"))};OpenLayers.Util.extend(a,c)},read_Pyramid_TopTile:function(a,b){var c={fromX:parseInt(b.getAttribute("FromX")),fromY:parseInt(b.getAttribute("FromY")),toX:parseInt(b.getAttribute("ToX")),toY:parseInt(b.getAttribute("ToY"))};OpenLayers.Util.extend(a,c)},read_Pyramid_Range:function(a,b){var c={xmin:parseInt(b.getAttribute("XMin")),xmax:parseInt(b.getAttribute("XMax")),ymin:parseInt(b.getAttribute("YMin")),
ymax:parseInt(b.getAttribute("YMax"))};OpenLayers.Util.extend(a,c)},CLASS_NAME:"Geo.Util.Format.Pyramid"});
Geo.Util.Format.XML2JSON=Geo.Class({initialize:function(){},read:function(a,b,c){b||(b="");a=a.replace(/\s*\/>/g,"/>");a=a.replace(/<\?[^>]*>/g,"").replace(/<\![^>]*>/g,"");b.sort||(b=b.split(","));for(var a=this.no_fast_endings(a),a=this.attris_to_tags(a),a=escape(a),a=a.split("%3C").join("<").split("%3E").join(">").split("%3D").join("=").split("%22").join('"'),d=0;d<b.length;d++)a=a.replace(RegExp("<"+b[d]+">","g"),"*$**"+b[d]+"**$*"),a=a.replace(RegExp("</"+b[d]+">","g"),"*$***"+b[d]+"**$*");this.xmlobject=
{};b=this.xml_to_object("<JSONTAGWRAPPER>"+a+"</JSONTAGWRAPPER>").JSONTAGWRAPPER;c&&(b=this.show_json_structure(b,c));return b},xml_to_object:function(a){for(var b=a.replace(/<\//g,"?"),b=b.split("<"),a=[],c=0,d=[],e=1;e<b.length;e++){var f=b[e].split(">")[0];d.push(f);c++;for(a.push(c+"<"+b[e].split("?")[0]);b[e].indexOf("?"+d[d.length-1]+">")>=0;)c--,d.pop()}for(var g=-1,b="this.xmlobject",e=0;e<a.length;e++){var c="",d=a[e].split("<")[0],h=a[e].split("<")[1].split(">")[0],h=h.replace(/%3A/,"_"),
f=a[e].split(">")[1];if(d<=g)for(var g=g-d+1,l=0;l<g;l++)b=b.substring(0,b.lastIndexOf("."));b+="."+h;g=b.substring(0,b.lastIndexOf("."));eval("typeof "+g)!="object"&&(c+=g+"={value:"+g+"};\n");l=b.substring(b.lastIndexOf(".")+1);h=!1;for(k in eval(g))k==l&&(h=!0);g=!0;for(l=0;l<f.length;l+=3)f.charAt(l)!="%"&&(g=!1);f!=""&&!g?f/1!=f&&(f="'"+f.replace(/\'/g,"\\'")+"'",f=f.replace(/\*\$\*\*\*/g,"</"),f=f.replace(/\*\$\*\*/g,"<"),f=f.replace(/\*\*\$\*/g,">")):f="{}";f.charAt(0)=="'"&&(f="unescape("+
f+")");h&&!eval(b+".sort")&&(c+=b+"=["+b+"];\n");g="=";after="";h&&(g=".push(",after=")");eval(c+b+g+f+after);eval(b+".sort")&&(b+="["+eval(b+".length-1")+"]");g=d}return this.xmlobject},show_json_structure:function(a,b,c){var d="";d+=a.sort?"[\n":"{\n";for(var e in a)a.sort||(d+=e+":"),d+=typeof a[e]=="object"?this.show_json_structure(a[e],!1,1):typeof a[e]=="function"?a[e]+"":typeof a[e]!="string"?a[e]+",\n":"'"+a[e].replace(/\'/g,"\\'").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r")+
"',\n";d+=a.sort?"],\n":"},\n";if(!c){d=d.substring(0,d.lastIndexOf(","));d=d.replace(RegExp(",\n}","g"),"\n}");d=d.replace(RegExp(",\n]","g"),"\n]");a=d.split("\n");d="";for(e=c=0;e<a.length;e++){(a[e].indexOf("}")>=0||a[e].indexOf("]")>=0)&&c--;tabs="";for(var f=0;f<c;f++)tabs+="\t";d+=tabs+a[e]+"\n";(a[e].indexOf("{")>=0||a[e].indexOf("[")>=0)&&c++}b=="html"&&(d=d.replace(/</g,"&lt;").replace(/>/g,"&gt;"),d=d.replace(/\n/g,"<BR>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;"));b=="compact"&&(d=d.replace(/\n/g,
"").replace(/\t/g,""))}return d},no_fast_endings:function(a){for(var a=a.split("/>"),b=1;b<a.length;b++){var c=a[b-1].substring(a[b-1].lastIndexOf("<")+1).split(" ")[0];a[b]="></"+c+">"+a[b]}return a=a.join("")},attris_to_tags:function(a){for(var b=" =\"'".split(""),a=a.split(">"),c=0;c<a.length;c++){for(var d=a[c].split("<"),e=0;e<4;e++)d[0]=d[0].replace(RegExp(b[e],"g"),"_jsonconvtemp"+e+"_");if(d[1]){d[1]=d[1].replace(/'/g,'"');d[1]=d[1].split('"');for(var f=1;f<d[1].length;f+=2)for(e=0;e<4;e++)d[1][f]=
d[1][f].replace(RegExp(b[e],"g"),"_jsonconvtemp"+e+"_");d[1]=d[1].join('"')}a[c]=d.join("<")}a=a.join(">");a=a.replace(/ ([^=]*)=([^ |>]*)/g,"><$1>$2</$1");a=a.replace(/>"/g,">").replace(/"</g,"<");for(e=0;e<4;e++)a=a.replace(RegExp("_jsonconvtemp"+e+"_","g"),b[e]);return a},CLASS_NAME:"Geo.Util.Format.XML2JSON"});
Geo.Util.Format.VwmtsGetVersionInfo=Geo.Class(Geo.Util.Format.XML2JSON,{read:function(a){typeof data=="string"&&(data=Geo.Util.Format.XML2JSON.prototype.read.apply(this,[a]));return data},CLASS_NAME:"Geo.Util.Format.VwmtsGetVersionInfo"});Geo.Util.Format.VwmtsGetVersions=Geo.Class(Geo.Util.Format.XML2JSON,{read:function(a){typeof a=="string"&&(a=Geo.Util.Format.XML2JSON.prototype.read.apply(this,[a]));return a},CLASS_NAME:"Geo.Util.Format.VwmtsGetVersions"});OpenLayers.Format.VWMTSCapabilities={};
OpenLayers.Format.VWMTSCapabilities.v1_0_0=OpenLayers.Class(OpenLayers.Format.WMTSCapabilities.v1_0_0,{initialize:function(){OpenLayers.Format.WMTSCapabilities.v1_0_0.prototype.initialize.apply(this,arguments)},readers:{wmts:{Capabilities:function(a,b){this.readChildNodes(a,b)},Contents:function(a,b){b.contents={};b.contents.layers=[];b.contents.tileMatrixSets={};this.readChildNodes(a,b.contents)},Layer:function(a,b){var c={styles:[],formats:[],tileMatrixSetLinks:[],dimensions:[],layers:[]};this.readChildNodes(a,
c);b.layers.push(c)},Style:function(a,b){var c={};c.isDefault=a.getAttribute("isDefault")==="true";this.readChildNodes(a,c);b.styles.push(c)},Format:function(a,b){b.formats.push(this.getChildValue(a))},Dimension:function(a,b){var c={values:[]};this.readChildNodes(a,c);b.dimensions.push(c)},Value:function(a,b){b.values.push(this.getChildValue(a))},TileMatrixSetLink:function(a,b){var c={};this.readChildNodes(a,c);b.tileMatrixSetLinks.push(c)},TileMatrixSet:function(a,b){if(b.layers){var c={matrixIds:[]};
this.readChildNodes(a,c);b.tileMatrixSets[c.identifier]=c}else b.tileMatrixSet=this.getChildValue(a)},TileMatrix:function(a,b){var c={supportedCRS:b.supportedCRS};this.readChildNodes(a,c);b.matrixIds.push(c)},ScaleDenominator:function(a,b){b.scaleDenominator=parseFloat(this.getChildValue(a))},TopLeftCorner:function(a,b){var c=this.getChildValue(a).split(" "),d;b.supportedCRS&&(d=b.supportedCRS.replace(/urn:ogc:def:crs:(\w+):.+:(\w+)$/,"urn:ogc:def:crs:$1::$2"),d.search(/GEOGCS/)===-1?(d=d.split("urn:ogc:def:crs:")[1].replace(/::/,
":"),d=OpenLayers.ProjAxisOrder.AxisOrder[d]):d=!0);if(this.isReverse===!0)b.topLeftCorner=d===!1?d?new OpenLayers.LonLat(c[0],c[1]):new OpenLayers.LonLat(c[1],c[0]):new OpenLayers.LonLat(c[1],c[0]);else if(this.isReverse===!1)b.topLeftCorner=d===!1?d?new OpenLayers.LonLat(c[1],c[0]):new OpenLayers.LonLat(c[0],c[1]):new OpenLayers.LonLat(c[0],c[1])},TileWidth:function(a,b){b.tileWidth=parseInt(this.getChildValue(a))},TileHeight:function(a,b){b.tileHeight=parseInt(this.getChildValue(a))},MatrixWidth:function(a,
b){b.matrixWidth=parseInt(this.getChildValue(a))},MatrixHeight:function(a,b){b.matrixHeight=parseInt(this.getChildValue(a))},WSDL:function(a,b){b.wsdl={};b.wsdl.href=a.getAttribute("xlink:href")},ServiceMetadataURL:function(a,b){b.serviceMetadataUrl={};b.serviceMetadataUrl.href=a.getAttribute("xlink:href")}},ows:OpenLayers.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"OpenLayers.Format.WMTSCapabilities.v1_0_0"});
Geo.Util.Format.MapServiceQuery=Geo.Class(Geo.Format.JSON,{read:function(a,b){var c=[],d=null;if(d=typeof a=="string"?OpenLayers.Format.JSON.prototype.read.apply(this,[a,b]):a)if(d.features){if(d.features.length>0)for(var e=0,f=d.features.length;e<f;e++)c.push(this.parseFeature(d.features[e]))}else OpenLayers.Console.error("Bad GeoJSON - no type: "+a);return c},write:function(a,b){var c={},d=[];if(OpenLayers.Util.isArray(a)){for(var e=0;e<a.length;++e){var f=a[e];if(!f instanceof OpenLayers.Feature.Vector)throw"\u8be5\u5bf9\u8c61\u5728\u6570\u7ec4\u4e2d\u4e0d\u662f\u8981\u7d20 "+
f;var f=this._getGeometryRepresentation(a[e].geometry),g=a[e].attributes,f=OpenLayers.Util.extend({},{attributes:g,geometry:f});d.push(f)}c.features=d}else if(a.CLASS_NAME.indexOf("OpenLayers.Geometry")==0)f=this._getGeometryRepresentation(a),c.geometry=f;else if(a instanceof OpenLayers.Feature.Vector)f=this._getGeometryRepresentation(a.geometry),g=a.attributes,OpenLayers.Util.extend(c,{attributes:g,geometry:f});return OpenLayers.Format.JSON.prototype.write.apply(this,[c,b])},_getGeometryRepresentation:function(a){if(a){var b=
null;switch(a.CLASS_NAME){case "OpenLayers.Geometry.Point":b={x:a.x,y:a.y};break;case "OpenLayers.Geometry.Polygon":a=this.extract.geometry.apply(this,[a]);b={rings:a.coordinates};break;case "OpenLayers.Geometry.MultiLineString":a=this.extract.geometry.apply(this,[a]);b={paths:a.coordinates};break;case "OpenLayers.Geometry.LineString":a=this.extract.geometry.apply(this,[a]),b={paths:[a.coordinates]}}return b}},parseFeature:function(a){var b=this._getGeometry(a.geometry),a=this._getAttribute(a.attributes);
return new OpenLayers.Feature.Vector(b,a)},_getGeometry:function(a){for(var b in a){if("spatialReference"==b)break;return a=a.hasOwnProperty("x")&&a.hasOwnProperty("y")?new OpenLayers.Geometry.Point(a.x,a.y):a.hasOwnProperty("xmin")&&a.hasOwnProperty("ymin")&&a.hasOwnProperty("xmax")&&a.hasOwnProperty("ymax")?(new OpenLayers.Bounds(a.xmin,a.ymin,a.xmax,a.ymax)).toGeometry():this._geometryType[b](a[b])}},_getAttribute:function(a){var b={};a&&!Geo.Util.isArray(a)&&(a=[a]);if(Geo.Util.isArray(a))for(var c=
0;c<a.length;c++)OpenLayers.Util.applyDefaults(b,a[c]);return b},_geometryType:{points:function(a){var b=[];if(OpenLayers.Util.isArray(a))for(var c=0,d=a.length;c<d;c++){var e=new OpenLayers.Geometry.Point(a[c][0],a[c][1]);b.push(e)}return b},paths:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],a[c][f][1]));e=new OpenLayers.Geometry.LineString(e);b.push(e)}c=new OpenLayers.Geometry.MultiLineString(b)}return c},
rings:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],a[c][f][1]));e=new OpenLayers.Geometry.LinearRing(e);b.push(e)}c=new OpenLayers.Geometry.Polygon(b)}return c}},extract:{feature:function(a){var b=this.extract.geometry.apply(this,[a.geometry]),b={type:"Feature",properties:a.attributes,geometry:b};if(a.fid!=null)b.id=a.fid;return b},geometry:function(a){if(a==null)return null;
this.internalProjection&&this.externalProjection&&(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));var b=a.CLASS_NAME.split(".")[2],a=this.extract[b.toLowerCase()].apply(this,[a]);return b=="Collection"?{type:"GeometryCollection",geometries:a}:{type:b,coordinates:a}},point:function(a){return[a.x,a.y]},multipoint:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},linestring:function(a){for(var b=[],
c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},multilinestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b},polygon:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b},multipolygon:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.polygon.apply(this,[a.components[c]]));
return b},collection:function(a){for(var b=a.components.length,c=Array(b),d=0;d<b;++d)c[d]=this.extract.geometry.apply(this,[a.components[d]]);return c}},CLASS_NAME:"Geo.Util.Format.MapServiceQuery"});
Geo.Util.Format.GeoTextFeatures=Geo.Class(Geo.Format.JSON,{json:null,layersStyle:null,commonFeatures:{},initialize:function(a){OpenLayers.Util.extend(this,a)},cleanCommonFeatures:function(){for(var a in this.commonFeatures)delete this.commonFeatures[a]},read:function(a,b){var c={};if(typeof a=="string"){this.json=OpenLayers.Format.JSON.prototype.read.apply(this,[a,b]);if(this.json.error)return c=this.json;c.tile=this.features.tile.apply(this,[this.json.tile])}return c},_getGeometry:function(a,b){for(var c in a){if("spatialReference"==
c)break;a=a.hasOwnProperty("x")&&a.hasOwnProperty("y")?new OpenLayers.Geometry.Point(a.x,a.y):a.hasOwnProperty("xmin")&&a.hasOwnProperty("ymin")&&a.hasOwnProperty("xmax")&&a.hasOwnProperty("ymax")?(new OpenLayers.Bounds(a.xmin,a.ymin,a.xmax,a.ymax)).toGeometry():this._geometryType[c](a[c]);a.gid=b;return a}},_geometryType:{points:function(a){var b=[];if(OpenLayers.Util.isArray(a))for(var c=0,d=a.length;c<d;c++){var e=new OpenLayers.Geometry.Point(a[c][0],a[c][1]);b.push(e)}return b},paths:function(a){var b=
[];if(OpenLayers.Util.isArray(a))if(a.length===1){for(var c=[],d=0,e=a[0].length;d<e;d++)c.push(new OpenLayers.Geometry.Point(a[0][d][0],a[0][d][1]));return c=new OpenLayers.Geometry.LineString(c)}else if(a.length>1){for(var f=0,g=a.length;f<g;f++){c=[];d=0;for(e=a[f].length;d<e;d++)c.push(new OpenLayers.Geometry.Point(a[f][d][0],a[f][d][1]));c=new OpenLayers.Geometry.LineString(c);b.push(c)}f=new OpenLayers.Geometry.MultiLineString(b)}return f},rings:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=
0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],a[c][f][1]));e=new OpenLayers.Geometry.LinearRing(e);b.push(e)}c=new OpenLayers.Geometry.Polygon(b)}return c}},convertLabelToMultiRow:function(a,b){var c=a,a=OpenLayers.String.trim(a),d=null,d=this.isCustomStyle&&b&&typeof b.maxCharactersPerLine==="number"?b.maxCharactersPerLine:this.eachRowNumer,d=Math.ceil(a.length/d);if(d>1){for(var c=Math.ceil(a.length/d),e=a.length-c*(d-1),f="",g=0;g<=
d-1;g++){if(g===d-1){f+=a.slice(a.length-e,a.length);break}f+=a.slice(g*c,g*c+c)+"\n"}return f}return c},featureTypes:{Point:function(a,b,c){if(!this.isCustomStyle){var d=null,e=null,e=this.url.indexOf("/",this.url.length-1)!=-1?this.url+"Icon/"+b.grid+"?version=1.0.0&service=TEXT":this.url+"/Icon/"+b.grid+"?version=1.0.0&service=TEXT";if(typeof b.grid==="number"&&b.text)d={externalGraphic:e,label:b.text,graphicHeight:10,graphicWidth:10,fontSize:"14px"};else if(!b.grid&&b.text)d.label=b.text;else if(b.grid&&
!b.text)d={externalGraphic:e,label:b.text,graphicHeight:10,graphicWidth:10,fontSize:"14px"};else return null;c=Geo.Util.extend(d,c)}if(!b.text)return null;c=Geo.Util.extend(d,c);c.label=this.convertLabelToMultiRow(b.text,d);return new Geo.Feature.Vector(a,null,c)},LineString:function(a,b,c){var d;d=c&&typeof b.text==="string"&&b.text.length>0?{strokeColor:"#ee9900",strokeOpacity:1,strokeWidth:6}:Geo.Util.extend({strokeColor:"#ee9900",strokeOpacity:1,strokeWidth:6},null);d.alongLineLabel=b.text;d=
Geo.Util.extend(d,c);return new Geo.Feature.Vector(a,null,d)},MultiLineString:function(a,b,c){var d=null;c&&typeof b.text==="string"?(c=Geo.Util.extend({alongLineLabel:b.text},c),d={strokeColor:"#ee9900",strokeOpacity:1,strokeWidth:6}):d=Geo.Util.extend({strokeColor:"#ee9900",strokeOpacity:1,strokeWidth:6},d);d.alongLineLabel=b.text;d=Geo.Util.extend(d,c);return new Geo.Feature.Vector(a,null,d)},Polygon:function(a,b,c){var d=null;if(typeof b.text==="string"&&b.text.length>0&&b.grid===void 0){if(c)c.label=
b.text}else if(typeof b.text==="string"&&b.text.length>0&&b.grid!==void 0&&c)c.label=b.text;a=a.getCentroid();featureStyle={externalGraphic:"",label:b.text,type:"polygon",graphicHeight:10,graphicWidth:10,fontSize:"14px"};pstyle=Geo.Util.extend(featureStyle,c);return d=new Geo.Feature.Vector(a,null,pstyle)},Polygon_markerTextPoint:function(a,b,c,d){a=a.getCentroid();return new Geo.Feature.Vector(a,null,{externalGraphic:d+"/"+b+"?version=1.0.0&service=TEXT",graphicHeight:32,graphicWidth:32,label:c,
fontSize:"12px"})}},features:{labelGeometry:function(a){for(var b=[],c=0,d=a.length;c<d;c++){var e=this._getGeometry.apply(this,[a[c].geometry,a[c].gid]);e!==void 0&&b.push(e)}return b},tile:function(a){for(var b=[],c=0,d=a.length;c<d;c++){var e=this.features.layer.apply(this,[a[c].layer]),e=new Geo.Util.Format.GeoTextFeatures.FeaturesTile({row:parseInt(a[c].x),col:parseInt(a[c].y),level:parseInt(a[c].l),features:e});b.push(e)}return b},l:function(){},x:function(){},y:function(){},layer:function(a){for(var b=
[],c=0;c<a.length;c++){var d=null;this.layersStyle&&(d=this.layersStyle[a[c].layerName]);d=this.features.feature.apply(this,[a[c].feature,d]);b=b.concat(d)}return b},layerName:function(){},feature:function(a,b){for(var c=this.features.labelGeometry.apply(this,[this.json.labelGeometry]),d=[],e=0,f=a.length;e<f;e++)for(var g=a[e],h=0,l=c.length;h<l;h++)if(c[h].gid===g.gid&&!(g.gid in this.commonFeatures)){var m=null;if(c[h]instanceof Geo.Geometry.Polygon)m=this.featureTypes.Polygon.apply(this,[c[h],
g,b]),this.commonFeatures[g.gid]=m;else if(c[h]instanceof Geo.Geometry.LineString)m=this.featureTypes.LineString.apply(this,[c[h],g,b]),this.commonFeatures[g.gid]=m;else if(c[h]instanceof Geo.Geometry.MultiLineString)m=this.featureTypes.MultiLineString.apply(this,[c[h],g,b]);else if(c[h]instanceof Geo.Geometry.Point&&(m=this.featureTypes.Point.apply(this,[c[h],g,b]),this.commonFeatures[g.gid]=m,m==null))continue;d.push(m)}return d}},CLASS_NAME:"Geo.Util.Format.GeoTextFeatures"});
Geo.Util.Format.GeoTextFeatures.FeaturesTile=Geo.Class({id:null,row:0,col:0,level:0,features:null,tileBounds:null,initialize:function(a){OpenLayers.Util.extend(this,a)},destroy:function(){this.features=[];this.level=this.col=this.row=this.id=this.tileBounds=this.features=null}});
Geo.Util.Format.GeoTextFeatures.LineLabelGroup=Geo.Class({features:[],labelCharSpace:5,isVisibleLabel:!0,label:null,initialize:function(a){this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_");OpenLayers.Util.extend(this,a);this.isIntersectLabelChar()},getLabelCharBounds:function(a,b){var c=new Geo.LonLat(a.geometry.x,a.geometry.y),d=a.style.label.length,e=b.getResolution(),d=new Geo.Size(parseInt(a.style.fontSize)*d*e,parseInt(a.style.fontSize)*e);return new Geo.Bounds(c.lon-d.w/2,c.lat-d.h/
2,c.lon+d.w/2,c.lat+d.h/2)},isIntersectLabelChar:function(){for(var a=this.features,b=0;b<a.length-1;b++){var c=this.getLabelCharBounds(a[b],map),d=this.getLabelCharBounds(a[b+1],map);if(c.intersectsBounds(d,!1)){this.isVisibleLabel=!1;break}}},getLabelBounds:function(a){for(var b=null,c=this.features,d=0;d<c.length;d++){var e=this.getLabelCharBounds(c[d],a);b==null?b=e:b.extend(e)}return b},destroy:function(){this.features=[];this.label=this.isShowLabel=this.labelCharSpace=this.features=null},CLASS_NAME:"LineLabelGroup"});
Geo.Util.GeoAvoidObject=Geo.Class({positions:[],postionIndex:0,rects:[],featrueObject:null,initialize:function(){},isIntersect:function(a){var b=this.positions[this.postionIndex].x-a.positions[a.postionIndex].x,c=this.positions[this.postionIndex].y-a.positions[a.postionIndex].y,d=this.rects[this.postionIndex],a=a.rects[a.postionIndex],e=Math.abs(b),f=Math.abs(c);if(b<0){if(e>d.w)return!1}else if(e>a.w)return!1;if(c<0){if(f>d.h)return!1}else if(f>a.h)return!1;return!0},CLASS_NAME:"Geo.Util.GeoAvoidObject"});
Geo.Util.GeoPreAvoidContainer=Geo.Class({array:[],initialize:function(){},append:function(a){for(var b=!0,c=0;c<a.positions.length;c++){b=!0;a.postionIndex=c;for(var d=0;d<this.array.length;d++)if(a.isIntersect(this.array[d])){b=!1;break}if(b)return this.array.push(a),!0}return!1},getGeoAvoidObjects:function(){return this.array},clean:function(){this.array=[]},CLASS_NAME:"Geo.Util.GeoPreAvoidContainer"});
Geo.View2D.Map=Geo.Class(OpenLayers.Map,{pyramid:null,allOverlays:!1,layerGroup:null,EVENT_TYPES:["unloadLayerGroup","loadlayergroup"],overLayers:null,enableAnimateZoomer:!1,animateZoomer:null,initialize:function(a,b){this.EVENT_TYPES=Geo.View2D.Map.prototype.EVENT_TYPES.concat(OpenLayers.Map.prototype.EVENT_TYPES);this.overLayers=[];b=b||{};this.controls=b.controls==null?[new Geo.View2D.Control.Navigation,new Geo.View2D.Control.PanZoomBar,new Geo.View2D.Control.ArgParser,new Geo.View2D.Control.MagnifyingGlass]:
[];OpenLayers.Map.prototype.initialize.apply(this,arguments);this.allOverlays=!1;this.pyramid=this.pyramid?this.pyramid:new Geo.Pyramid;this.setPyramid(this.pyramid);var c={layerLoaded:!0};typeof this.enableAnimateZoomer==="object"&&(c=OpenLayers.Util.extend(c,this.enableAnimateZoomer));this.animateZoomer=this.enableAnimateZoomer?new Geo.AnimateZoomer(this,c):null},addLayer:function(a,b){a.isBaseLayer=!1;OpenLayers.Map.prototype.addLayer.apply(this,arguments);b||(this.updateBaseLayer(),this.resetTopLayer())},
addOverLayer:function(a){this.addLayer(a);this.overLayers.push(a)},removeLayer:function(a){OpenLayers.Util.removeItem(this.overLayers,a);OpenLayers.Map.prototype.removeLayer.apply(this,arguments)},raiseLayer:function(a,b){var c=this.getLayerIndex(a),d=Math.abs(b);if(b>0)for(var e=this.layers.length;c<e;c++){if(d==0||e<=c+1)break;this.layers[c+1].displayInLayerSwitcher?d--:b++}else if(b<0)for(;c>=0;c--){if(d==0||c-1<0)break;this.layers[c-1].displayInLayerSwitcher?d--:b-=1}OpenLayers.Map.prototype.raiseLayer.apply(this,
arguments)},resetTopLayer:function(){var a=this.layers.length,b=a-1;for(a-=1;a>=0;a--){var c=this.layers[a];c.isOnTop&&!c.isBaseLayer&&this.setLayerIndex(c,b--)}},resetOverLayer:function(){var a=this.layers.length,b=a-1;for(a-=1;a>=0;a--){var c=this.layers[a];OpenLayers.Util.indexOf(this.overLayers,c)!=-1&&this.setLayerIndex(c,b--)}},setPyramid:function(a){a||(a=new Geo.Pyramid);this.pyramid=a;this.numZoomLevels=this.pyramid.getNumZoomLevels();this.maxExtent=this.pyramid.maxExtent.clone();this.pyramid.resolutions&&
typeof this.pyramid.resolutions=="object"&&this.pyramid.resolutions.constructor==Array?this.updateBaseLayer({resolutions:this.pyramid.resolutions,maxExtent:this.maxExtent}):(this.maxResolution=this.pyramid.getMaxResolution(),this.minResolution=this.pyramid.getMinResolution(),this.updateBaseLayer({maxResolution:this.maxResolution,minResolution:this.minResolution,maxExtent:this.maxExtent}))},removePopup:function(a){Geo.Util.removeItem(this.popups,a);if(a.div)try{this.layerContainerDiv.removeChild(a.div)}catch(b){}a.calculateShadowLocation&&
this.events.unregister("zoomend",a,a.calculateShadowLocation);if(a.shadowDiv)try{this.layerContainerDiv.removeChild(a.shadowDiv)}catch(c){}a.map=null},updateBaseLayer:function(a){var b={};a?OpenLayers.Util.extend(b,a):(a=this.getResolutions(),b=OpenLayers.Util.isArray(a)?{resolutions:a,maxExtent:this.getLayersMaxExtent()}:{maxResolution:this.getLayersMaxResolution(),minResolution:this.getLayersMinResolution(),maxExtent:this.getLayersMaxExtent()});OpenLayers.Util.extend(b,{displayInLayerSwitcher:!1,
isBaseLayer:!0});a=new OpenLayers.Layer("GeoGlobeBaseLayer",b);this.baseLayer&&this.removeLayer(this.baseLayer);OpenLayers.Map.prototype.addLayer.apply(this,[a])},getResolutions:function(){return this.resolutions||this.pyramid.resolutions},getLayersMaxResolution:function(){for(var a=this.layers,b=null,c=0;c<a.length;c++){var d=a[c].getOptions().maxResolution;!a[c].isBaseLayer&&d&&(b=b?Math.max(b,d):d)}a=this.pyramid.getMaxResolution();return b<=0||b>a?a:b},getLayersMinResolution:function(){for(var a=
this.layers,b=null,c=0;c<a.length;c++){var d=a[c].getOptions().minResolution;!a[c].isBaseLayer&&d&&(b=b?Math.min(b,d):d)}a=this.pyramid.getMinResolution();return b<=0||b<a?a:b},getLayersMaxExtent:function(){for(var a=null,b=this.layers,c=0;c<b.length;c++)!b[c].isBaseLayer&&b[c].maxExtent&&(a?a.extend(b[c].maxExtent):a=b[c].maxExtent.clone());b=this.pyramid.maxExtent.clone();return a?a:b},loadLayerGroup:function(a){if(this.layerGroup==a)return OpenLayers.Console.warn("\u4e0d\u80fd\u91cd\u590d\u52a0\u8f7d\u56fe\u5c42\u7ec4\u5230\u5730\u56fe\u4e2d\uff01"),
!1;this.unloadLayerGroup();a.setMap(this);this.layerGroup=a;this.updateBaseLayer();this.resetOverLayer();this.resetTopLayer();this.events.triggerEvent("loadlayergroup",{layerGroup:a,map:this})},unloadLayerGroup:function(){var a=this.layerGroup;if(!a)return!1;a.removeMap();this.layerGroup=null},CLASS_NAME:"Geo.View2D.Map"});
Geo.View2D.Tile.TileFeature=Geo.Class(Geo.View2D.Tile,{initialize:function(){Geo.View2D.Tile.prototype.initialize.apply(this,arguments)},draw:function(){if(this.layer!=this.layer.map.baseLayer&&this.layer.reproject)this.bounds=this.getBoundsFromBaseLayer(this.position);Geo.View2D.Tile.prototype.draw.apply(this,arguments);return this.renderTile()},renderTile:function(){this.url=this.layer.getURL(this.bounds);if(this.url!=""){for(var a=!1,b=0;b<this.layer.urls.length;b++)this.layer.urls[b]==this.url&&
(a=!0);a||(this.layer.urls.push(this.url),OpenLayers.Request.GET({url:this.url,params:{},scope:this,async:!0,success:function(a){a=a.responseText;if(!(a==""||a==null)&&this.layer&&this.layer.vectorLayer){for(var a=(new OpenLayers.Format.GeoJSON).read(a),b={fillColor:"#ee9900",fillOpacity:0,strokeColor:"#ee9900",strokeOpacity:0,cursor:"pointer"},e=[],f=0;f<a.length;f++){a[f].style=b;a[f].attributes.type=a[f].data.type="polygon";var g=a[f].attributes.displayname,h=a[f].attributes.descriptionname,l=
new Geo.Geometry.Point(a[f].attributes.x,a[f].attributes.y),m=a[f].attributes.picsymid,g=new Geo.Feature.Vector(l,{type:"point",relatedid:a[f].id,picsymid:m,displayname:g,descriptionname:h,overPicUrl:this.layer.getPicURL(m,!0),outPicUrl:this.layer.getPicURL(m,!1)});a[f].attributes.relatedid=a[f].data.relatedid=g.id;m=this.layer.getPicURL(m,!1);l=new Image;l.src=m;h=l.width;l=l.height;g.style={externalGraphic:m,graphicWidth:h,graphicHeight:l,graphicXOffset:parseInt(-h/2),graphicYOffset:parseInt(-l/
2),cursor:"pointer"};e.push(g)}this.layer.vectorLayer.addFeatures(a);this.layer.vectorLayer.addFeatures(e)}},failure:function(){}}))}},moveTo:function(a,b,c){c==null&&(c=!0);this.bounds=a.clone();this.position=b.clone();c&&this.draw()},CLASS_NAME:"Geo.View2D.Tile.TileFeature"});
Geo.View2D.Layer.GlobeTile=Geo.Class(Geo.View2D.Layer.Grid,{alwaysInRange:!1,isBaseLayer:!1,topLevel:null,bottomLevel:null,pyramid:null,accessUrl:null,mirrorUrl:null,serviceName:null,verstionTime:"9999-01-01 00:00:00",cacheExpireTime:"now",buffer:0,transitionEffect:null,initialize:function(a,b,c){this.name=a;this.url=b;this.convertUrl(this.url);c||(c={});c.pyramid=c.pyramid?c.pyramid:new Geo.Pyramid;c.topLevel=c.topLevel?c.topLevel:c.pyramid.topLevelIndex;c.bottomLevel=c.bottomLevel?c.bottomLevel:
c.pyramid.bottomLevelIndex;c.pyramid.getMaxResolution();c.maxResolution=c.pyramid.getResolutionForLevel(c.topLevel);c.minResolution=c.pyramid.getResolutionForLevel(c.bottomLevel);c.tileSize=c.pyramid.tileSize;Geo.View2D.Layer.Grid.prototype.initialize.apply(this,[a,b,null,c])},convertUrl:function(a){var b=a.split("/services/");b[0]&&b[1]?(this.accessUrl=b[0]+"/DataServer",this.serviceName=b[1]):OpenLayers.Console.error("\u89e3\u6790GeoGlobe 2.0.0\u670d\u52a1\u5730\u5740\u9519\u8bef:"+a)},addTile:function(a,
b){return new Geo.View2D.Tile.Image(this,b,a,null,this.tileSize)},setVerstionTime:function(a){if(a)this.verstionTime=a,this.redraw()},getURL:function(a){OpenLayers.Util.getImagesLocation();a=this.adjustBounds(a);this.pyramid.getMaxResolution();var b,c,d;c=this.pyramid.getLevelForResolution(this.map.getResolution());b=this.pyramid.getTopTileSize().w/Math.pow(2,c);d=this.pyramid.topTileFromX<this.pyramid.topTileToX?Math.round((a.left-this.pyramid.topTileFromX)/b):Math.round((this.pyramid.topTileFromX-
a.right)/b);a=this.pyramid.topTileFromY<this.pyramid.topTileToY?Math.round((a.bottom-this.pyramid.topTileFromY)/b):Math.round((this.pyramid.topTileFromY-a.top)/b);if(d<0||a<0)return OpenLayers.Util.getImagesLocation()+"blank.gif";b="";var e={};if(this.mirrorUrl==null)b=this.accessUrl,e={T:this.serviceName,X:d,Y:a,L:c,INDATE:this.verstionTime};else{b=this.selectUrl(d,this.mirrorUrl);var f=b.split("/services/");f[0]&&f[1]&&(b=f[0]+"/DataServer",e={T:f[1],X:d,Y:a,L:c,INDATE:this.verstionTime})}return b=
this.getFullRequestString(e,b)},selectUrl:function(a,b){return b[a%b.length]},getDataExtent:function(){if(this.maxExtent)return this.maxExtent.clone()},clone:function(a){a==null&&(a=new Geo.View2D.Layer.GlobeTile(this.name,this.url,this.options));return a=Geo.View2D.Layer.Grid.prototype.clone.apply(this,[a])},CLASS_NAME:"Geo.View2D.Layer.GlobeTile"});
Geo.View2D.Layer.CWMS=Geo.Class(Geo.View2D.Layer.Grid,{layerId:null,mapStyleId:null,srid:null,sourceDate:null,formatSuffix:null,buffer:0,initialize:function(a,b,c){this.mapStyleId=c.mapStyleId;this.srid=c.srid;this.sourceDate=c.sourceDate;this.formatSuffix=c.formatSuffix||"png";Geo.View2D.Layer.Grid.prototype.initialize.apply(this,[a,b,null,c])},addTile:function(a,b){return new Geo.View2D.Tile.Image(this,b,a,null,this.tileSize)},getURL:function(a){var a=this.adjustBounds(a),b=this.map.getResolution(),
c=Math.floor((a.left-this.map.maxExtent.left)/(b*this.tileSize.w)),a=Math.floor((this.map.maxExtent.top-a.top)/(b*this.tileSize.h)),b=new Geo.Service.CWMS(this.name,this.url),d=this.map.pyramid.getLevelForResolution(this.map.getResolution());return b.getMap({layerId:this.layerId,mapStyleId:this.mapStyleId,srid:this.srid,sourceDate:this.sourceDate,level:d,col:c,row:a,formatSuffix:this.formatSuffix})},CLASS_NAME:"Geo.View2D.Layer.CWMS"});
Geo.View2D.Layer.GeoWMTS=Geo.Class(Geo.View2D.Layer.WMTS,{pyramid:null,time:"9999-01-01 00:00:00",userecent:!0,initialize:function(a){var b={};if(a.params){if(a.params.time)this.time=a.params.time;if(typeof a.params.userecent==="boolean")this.userecent=a.params.userecent}else{if(a.time)this.time=b.time=a.time;if(typeof a.userecent==="boolean")this.userecent=b.userecent=a.userecent;a.params=b}a.pyramid=a.pyramid?a.pyramid:new Geo.Pyramid;Geo.View2D.Layer.WMTS.prototype.initialize.apply(this,arguments)},
setVerstionTime:function(a){if(a)this.time=this.params.TIME=a,this.redraw()},setParams:function(a){if(a.time)this.time=this.params.TIME=a.time,a=typeof a.userecent=="boolean"?a.userecent:!0,this.userecent=this.params.USERECENT=a,this.redraw()},getTileInfo:function(a){var b=this.pyramid.getLevelForResolution(this.map.getResolution()),c=a.lon,a=a.lat,b=this.pyramid.getTopTileSize().w/Math.pow(2,b),d=this.pyramid.maxExtent.getWidth(),e=this.pyramid.maxExtent.getHeight(),d=Math.round(d/b),e=Math.round(e/
b),c=Math.ceil(Math.abs(c-this.pyramid.topTileFromX)/b)-1;this.pyramid.topTileFromX<this.pyramid.topTileToX||(c=d-c);a=Math.ceil(Math.abs(a-this.pyramid.topTileFromY)/b)-1;this.pyramid.topTileFromY>this.pyramid.topTileToY||(a=e-a);return{col:c,row:a}},clone:function(a){a==null&&(a=new Geo.View2D.Layer.GeoWMTS(this.options));return a=Geo.View2D.Layer.WMTS.prototype.clone.apply(this,[a])},CLASS_NAME:"Geo.View2D.Layer.GeoWMTS"});
Geo.View2D.Layer.ArcGISTileLayer=Geo.Class(Geo.View2D.Layer.XYZ,{url:null,useArcGISServer:!0,initialize:function(a,b){OpenLayers.Layer.XYZ.prototype.initialize.apply(this,arguments);if(this.resolutions)this.serverResolutions=this.resolutions,this.maxExtent=this.getMaxExtentForResolution(this.resolutions[0]);this.jsonp=new OpenLayers.Protocol.Script;this.jsonp.createRequest(b,{f:"json",pretty:"true"},OpenLayers.Function.bind(this._loadTiles,this))},_loadTiles:function(a){if(a){var b=new OpenLayers.Bounds(a.fullExtent.xmin,
a.fullExtent.ymin,a.fullExtent.xmax,a.fullExtent.ymax);this.projection="EPSG:"+a.spatialReference.wkid;this.sphericalMercator=a.spatialReference.wkid==102100;this.units=a.units=="esriFeet"?"dd":"m";if(a.tileInfo){this.tileSize=new OpenLayers.Size(a.tileInfo.width||a.tileInfo.cols,a.tileInfo.height||a.tileInfo.rows);this.tileOrigin=new OpenLayers.LonLat(a.tileInfo.origin.x,a.tileInfo.origin.y);var c=new OpenLayers.Geometry.Point(b.left,b.top),b=new OpenLayers.Geometry.Point(b.right,b.bottom);this.useScales?
this.scales=[]:this.resolutions=[];this.lods=[];for(var d in a.tileInfo.lods)if(a.tileInfo.lods.hasOwnProperty(d)){var e=a.tileInfo.lods[d];this.useScales?this.scales.push(e.scale):this.resolutions.push(e.resolution);var f=this.getContainingTileCoords(c,e.resolution);e.startTileCol=f.x;e.startTileRow=f.y;f=this.getContainingTileCoords(b,e.resolution);e.endTileCol=f.x;e.endTileRow=f.y;this.lods.push(e)}this.maxExtent=this.calculateMaxExtentWithLOD(this.lods[0]);this.serverResolutions=this.resolutions;
if(this.overrideDPI&&a.tileInfo.dpi)OpenLayers.DOTS_PER_INCH=a.tileInfo.dpi}}},setMap:function(){OpenLayers.Layer.XYZ.prototype.setMap.apply(this,arguments)},getContainingTileCoords:function(a,b){return new OpenLayers.Pixel(Math.max(Math.floor((a.x-this.tileOrigin.lon)/(this.tileSize.w*b)),0),Math.max(Math.floor((this.tileOrigin.lat-a.y)/(this.tileSize.h*b)),0))},calculateMaxExtentWithLOD:function(a){var b=this.tileOrigin.lon+a.startTileCol*this.tileSize.w*a.resolution,c=this.tileOrigin.lat-a.startTileRow*
this.tileSize.h*a.resolution;return new OpenLayers.Bounds(b,c-(a.endTileRow-a.startTileRow+1)*this.tileSize.h*a.resolution,b+(a.endTileCol-a.startTileCol+1)*this.tileSize.w*a.resolution,c)},calculateMaxExtentWithExtent:function(a,b){var c=new OpenLayers.Geometry.Point(a.left,a.top),d=new OpenLayers.Geometry.Point(a.right,a.bottom),c=this.getContainingTileCoords(c,b),d=this.getContainingTileCoords(d,b);return this.calculateMaxExtentWithLOD({resolution:b,startTileCol:c.x,startTileRow:c.y,endTileCol:d.x,
endTileRow:d.y})},getUpperLeftTileCoord:function(a){return this.getContainingTileCoords(new OpenLayers.Geometry.Point(this.maxExtent.left,this.maxExtent.top),a)},getLowerRightTileCoord:function(a){return this.getContainingTileCoords(new OpenLayers.Geometry.Point(this.maxExtent.right,this.maxExtent.bottom),a)},getMaxExtentForResolution:function(a){var b=this.getUpperLeftTileCoord(a),c=this.getLowerRightTileCoord(a),d=this.tileOrigin.lon+b.x*this.tileSize.w*a,e=this.tileOrigin.lat-b.y*this.tileSize.h*
a;return new OpenLayers.Bounds(d,e-(c.y-b.y+1)*this.tileSize.h*a,d+(c.x-b.x+1)*this.tileSize.w*a,e)},clone:function(a){a==null&&(a=new Geo.View2D.Layer.ArcGISTileLayer(this.name,this.url,this.options));return OpenLayers.Layer.XYZ.prototype.clone.apply(this,[a])},getMaxExtent:function(){this.map.getResolution();return this.maxExtent},getTileOrigin:function(){var a=this.getMaxExtent();return new OpenLayers.LonLat(a.left,a.bottom)},getURL:function(a){var b=this.getResolution(),c=this.tileOrigin.lon+
b*this.tileSize.w/2,d=this.tileOrigin.lat-b*this.tileSize.h/2,a=a.getCenterLonLat(),c=Math.round(Math.abs((a.lon-c)/(b*this.tileSize.w))),d=Math.round(Math.abs((d-a.lat)/(b*this.tileSize.h))),a=this.map.getZoom();if(this.lods){if(b=this.lods[this.map.getZoom()],c<b.startTileCol||c>b.endTileCol||d<b.startTileRow||d>b.endTileRow)return null}else{var e=this.getUpperLeftTileCoord(b),b=this.getLowerRightTileCoord(b);if(c<e.x||c>=b.x||d<e.y||d>=b.y)return null}b=this.url;e=""+c+d+a;OpenLayers.Util.isArray(b)&&
(b=this.selectUrl(e,b));this.useArcGISServer?b+="/tile/${z}/${y}/${x}":(c="C"+this.zeroPad(c,8,16),d="R"+this.zeroPad(d,8,16),a="L"+this.zeroPad(a,2,16),b=b+"/${z}/${y}/${x}."+this.type);return b=OpenLayers.String.format(b,{x:c,y:d,z:a})},zeroPad:function(a,b,c){for(a=a.toString(c||10);a.length<b;)a="0"+a;return a},CLASS_NAME:"Geo.View2D.Layer.ArcGISTileLayer"});
var OSMBuildings=function(){function a(a,b){var c=a[0]-b[0],d=a[1]-b[1];return c*c+d*d}function b(a){for(var b=0,c=0,d=0,e=a.length-3;d<e;d+=2)b+=a[d],c+=a[d+1];a=(a.length-2)/2;return[b/a<<0,c/a<<0]}function c(a,b){var c,d,e,f,g=0,h,l;h=0;for(l=a.length-3;h<l;h+=2)c=a[h],d=a[h+1],e=a[h+2],f=a[h+3],g+=c*f-e*d;if((g/2>0?"CW":"CCW")===b)return a;c=[];for(d=a.length-2;d>=0;d-=2)c.push(a[d],a[d+1]);return c}var d=d||Array,e=e||Array,f=Math,g=f.exp,h=f.log,l=f.sin,m=f.cos,o=f.tan,j=f.atan,n=f.min,v=f.max,
u=f.ceil,p=f.floor,s=document,r=function(){function a(d){var e,f,g;if(d.s===0)e=f=g=d.l;else{g=d.l<0.5?d.l*(1+d.s):d.l+d.s-d.l*d.s;var h=2*d.l-g;d.h/=360;e=b(h,g,d.h+1/3);f=b(h,g,d.h);g=b(h,g,d.h-1/3)}return new c(e*255<<0,f*255<<0,g*255<<0,d.a)}function b(a,c,d){d<0&&(d+=1);d>1&&(d-=1);if(d<1/6)return a+(c-a)*6*d;if(d<0.5)return c;if(d<2/3)return a+(c-a)*(2/3-d)*6;return a}function c(a,b,d,e){this.r=a;this.g=b;this.b=d;this.a=arguments.length<4?1:e}var d=c.prototype;d.toString=function(){return"rgba("+
[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};d.setLightness=function(b){var d=c.toHSLA(this);d.l*=b;d.l=Math.min(1,Math.max(0,d.l));return a(d)};d.setAlpha=function(a){return new c(this.r,this.g,this.b,this.a*a)};c.parse=function(b){var d;b+="";if(~b.indexOf("#")&&(d=b.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/)))return new c(parseInt(d[1],16),parseInt(d[2],16),parseInt(d[3],16),d[4]?parseInt(d[4],16)/255:1);if(d=b.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new c(parseInt(d[1],
10),parseInt(d[2],10),parseInt(d[3],10),d[4]?parseFloat(d[5]):1);if(d=b.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return a({h:parseInt(d[1],10),s:parseFloat(d[2]),l:parseFloat(d[3]),a:d[4]?parseFloat(d[5]):1})};c.toHSLA=function(a){var b=a.r/255,c=a.g/255,d=a.b/255,e=Math.max(b,c,d),f=Math.min(b,c,d),g,h=(e+f)/2,l;if(e===f)g=f=0;else{l=e-f;f=h>0.5?l/(2-e-f):l/(e+f);switch(e){case b:g=(c-d)/l+(c<d?6:0);break;case c:g=(d-b)/l+2;break;case d:g=(b-c)/l+4}g/=6}return{h:g*360,s:f,l:h,
a:a.a}};return c}(),t=function(){var a=Math,b=a.PI,c=a.sin,d=a.cos,e=a.tan,f=a.asin,g=a.atan2,h=b/180,l=h*23.4397;return function(a,m,j){j=h*-j;m*=h;var a=a.valueOf()/864E5-0.5+2440588-2451545,o=h*(357.5291+0.98560028*a),n=h*(1.9148*c(o)+0.02*c(2*o)+3.0E-4*c(3*o)),n=o+n+h*102.9372+b,o=f(c(0)*d(l)+d(0)*c(l)*c(n)),n=g(c(n)*d(l)-e(0)*c(l),d(n)),j=h*(280.16+360.9856235*a)-j-n;return{altitude:f(c(m)*c(o)+d(m)*d(o)*d(j)),azimuth:g(c(j),d(j)*c(m)-e(o)*d(m))-b/2}}}(),ba=function(){function a(b){var c=parseFloat(b);
if(~b.indexOf("m"))return c<<0;if(~b.indexOf("yd"))return c*h<<0;if(~b.indexOf("ft"))return c*l<<0;if(~b.indexOf("'"))return b=b.split("'"),b[0]*l+b[1]*m<<0;return c<<0}function b(a){a=a.toLowerCase();if(a[0]==="#")return a;return n[o[a]||a]||null}function d(a){return(a=a.tags)&&!a.landuse&&(a.building||a["building:part"])&&(!a.layer||a.layer>=0)}function e(a){if(a){for(var b=[],c,d=0,f=a.length;d<f;d++)c=p[a[d]],b.push(c[0],c[1]);b[b.length-2]!==b[0]&&b[b.length-1]!==b[1]&&b.push(b[0],b[1]);if(!(b.length<
8))return b}}function f(c){var d=0,e=0;c.height&&(d=a(c.height));!d&&c["building:height"]&&(d=a(c["building:height"]));!d&&c.levels&&(d=c.levels*j<<0);!d&&c["building:levels"]&&(d=c["building:levels"]*j<<0);c.min_height&&(e=a(c.min_height));!e&&c["building:min_height"]&&(e=a(c["building:min_height"]));!e&&c.min_level&&(e=c.min_level*j<<0);!e&&c["building:min_level"]&&(e=c["building:min_level"]*j<<0);var g,h;c["building:material"]&&(g=b(c["building:material"]));c["building:facade:material"]&&(g=b(c["building:facade:material"]));
c["building:cladding"]&&(g=b(c["building:cladding"]));c["building:color"]&&(g=c["building:color"]);c["building:colour"]&&(g=c["building:colour"]);c["roof:material"]&&(h=b(c["roof:material"]));c["building:roof:material"]&&(h=b(c["building:roof:material"]));c["roof:color"]&&(h=c["roof:color"]);c["roof:colour"]&&(h=c["roof:colour"]);c["building:roof:color"]&&(h=c["building:roof:color"]);c["building:roof:colour"]&&(h=c["building:roof:colour"]);return{height:d,minHeight:e,wallColor:g,roofColor:h}}function g(a,
b,d,e){a={id:a,footprint:c(d,"CW"),holes:e};if(b.height)a.height=b.height;if(b.minHeight)a.minHeight=b.minHeight;if(b.wallColor)a.wallColor=b.wallColor;if(b.roofColor)a.roofColor=b.roofColor;if(e)a.holes=e;v.push(a)}var h=0.9144,l=0.3048,m=0.0254,j=3,o={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",
sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"},n={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},p,r,v;
return function(a){p={};r={};v=[];for(var b,h=0,l=a.length;h<l;h++)switch(b=a[h],b.type){case "node":p[b.id]=[b.lat,b.lon];break;case "way":var m=void 0,j=void 0;if(d(b))m=f(b.tags),(j=e(b.nodes))&&g(b.id,m,j);else if(m=b.tags,!m||!m.highway&&!m.railway&&!m.landuse)r[b.id]=b;break;case "relation":var j=b,o=void 0,n=void 0;b=[];var t=void 0,u=void 0,m=void 0;if(d(j)&&(j.tags.type==="multipolygon"||j.tags.type==="building")){var s;for(var o=j.members,u=n=void 0,t=[],q=0,x=o.length;q<x;q++)n=o[q],n.type===
"way"&&r[n.ref]&&(!n.role||n.role==="outer"?u=r[n.ref]:(n.role==="inner"||n.role==="enclave")&&t.push(r[n.ref]));u&&u.tags&&(s={outer:u,inner:t});if(o=s)if(q=f(j.tags),n=o.outer)if(t=f(n.tags),u=e(n.nodes)){j=t;t=q;q=void 0;for(q in t)j[q]||(j[q]=t[q]);t=j;j=0;for(q=o.inner.length;j<q;j++)(m=e(o.inner[j].nodes))&&b.push(c(m,"CCW"));g(n.id,t,u,b.length?b:null)}}}return v}}(),R=Math.PI,pa=R/2,va=R/4,wa=180/R,xa=256,ya="latitude",za="longitude",Aa=15,qa=3,f=function(){function f(a,b){var c={};a/=P;b/=
P;c[ya]=b<=0?90:b>=1?-90:wa*(2*j(g(R*(1-2*b)))-pa);c[za]=(a===1?1:(a%1+1)%1)*360-180;return c}function ta(a,b,c){function d(a){if("XDomainRequest"in window&&a!==e.readyState&&(e.readyState=a,e.onreadystatechange))e.onreadystatechange()}var a=a.replace(/\{ *([\w_]+) *\}/g,function(a,c){return b[c]||a}),e="XDomainRequest"in window?new XDomainRequest:new XMLHttpRequest;e.onerror=function(){e.status=500;e.statusText="Error";d(4)};e.ontimeout=function(){e.status=408;e.statusText="Timeout";d(4)};e.onprogress=
function(){d(3)};e.onload=function(){e.status=200;e.statusText="Ok";d(4)};e.onreadystatechange=function(){e.readyState===4&&e.status&&!(e.status<200||e.status>299)&&c&&e.responseText&&c(JSON.parse(e.responseText))};d(0);e.open("GET",a);d(1);e.send(null);d(2);return e}function ua(){$||($=setInterval(function(){for(var a,b=!1,c=0,d=E.renderItems.length;c<d;c++)if(a=E.renderItems[c],a.scale<1){a.scale+=0.1;if(a.scale>1)a.scale=1;b=!0}F();b||(clearInterval($),$=null)},33))}function F(){ca.render();ea.render();
ja()}function ja(){A.clearRect(0,0,G,x);if(!(N<aa||T)){var b,c,d,e,f,g,h,l=ea.MAX_HEIGHT,j=[U+I,V+H],m={minX:I,maxX:I+G,minY:H,maxY:H+x},n,o,fa,p;E.renderItems.sort(function(b,c){return a(c.center,j)/c.height-a(b.center,j)/b.height});b=0;for(c=E.renderItems.length;b<c;b++)if(f=E.renderItems[b],!(f.height<=l)){g=!1;n=f.footprint;d=0;for(e=n.length-1;d<e;d+=2)g||(g=n[d]>m.minX&&n[d]<m.maxX&&n[d+1]>m.minY&&n[d+1]<m.maxY);if(g){d=f.scale<1?f.height*f.scale:f.height;g=O/(O-d);h=0;f.minHeight&&(d=f.scale<
1?f.minHeight*f.scale:f.minHeight,h=O/(O-d));fa=f.wallColor||da;p=f.altColor||Z;n=ka(n,g,h,fa,p);o=[];if(f.holes){d=0;for(e=f.holes.length;d<e;d++)o[d]=ka(f.holes[d],g,h,fa,p)}A.fillStyle=f.roofColor||Q;A.strokeStyle=p;la(n,!0,o)}}}}function ka(a,b,c,d,e){for(var f={x:0,y:0},g={x:0,y:0},h,l,j=[],m=0,n=a.length-3;m<n;m+=2){f.x=a[m]-I;f.y=a[m+1]-H;g.x=a[m+2]-I;g.y=a[m+3]-H;h=W(f.x,f.y,b);l=W(g.x,g.y,b);c&&(f=W(f.x,f.y,c),g=W(g.x,g.y,c));if((g.x-f.x)*(h.y-f.y)>(h.x-f.x)*(g.y-f.y))A.fillStyle=f.x<g.x&&
f.y<g.y||f.x>g.x&&f.y>g.y?e:d,la([g.x,g.y,f.x,f.y,h.x,h.y,l.x,l.y]);j[m]=h.x;j[m+1]=h.y}return j}function la(a,b,c){if(a.length){var d,e,f,g;A.beginPath();A.moveTo(a[0],a[1]);d=2;for(e=a.length;d<e;d+=2)A.lineTo(a[d],a[d+1]);if(c){d=0;for(e=c.length;d<e;d++){a=c[d];A.moveTo(a[0],a[1]);f=2;for(g=a.length;f<g;f+=2)A.lineTo(a[f],a[f+1])}}A.closePath();b&&A.stroke();A.fill()}}function W(a,b,c){return{x:(a-U)*c+U<<0,y:(b-V)*c+V<<0}}function ma(a,b){G=a;x=b;X=G/2<<0;oa=x/2<<0;U=X;V=x;O=G/(1.5/(window.devicePixelRatio||
1))/o(45)<<0;sa.setSize(G,x);ga=O-50}function na(a){N=a;P=xa<<N;var a=N,b=aa,c=ha,a=n(v(a,b),c);q=1-n(v(0+(a-b)/(c-b)*0.3,0),0.3);da=C.setAlpha(q)+"";Z=Y.setAlpha(q)+"";Q=K.setAlpha(q)+""}var G=0,x=0,X=0,oa=0,I=0,H=0,N,P,A,C=new r(200,190,180),Y=C.setLightness(0.8),K=C.setLightness(1.2),da=C+"",Z=Y+"",Q=K+"",$,q=1,aa=15,ha=20,ga,U,V,O,T,ia=function(){var a=new Date,b={};return{add:function(a,c){b[a]={data:c,time:Date.now()}},get:function(a){return b[a]&&b[a].data},purge:function(){a.setMinutes(a.getMinutes()-
5);for(var c in b)b[c].time<a&&delete b[c]}}}(),E=function(){function a(b){return function(a){g(a,b)}}function g(a,b){if(a){var d;if(a.type==="FeatureCollection"){d=a.features;var e,f,h,l,j,n,o=[],y,p,B,r,t,D,w,q;e=0;for(f=d.length;e<f;e++)if(y=d[e],y.type==="Feature"){p=y.geometry;y=y.properties;if(p.type==="LineString"&&(D=B.length-1,B[0][0]===B[D][0]&&B[0][1]===B[D][1]))B=p.coordinates;if(p.type==="Polygon")B=p.coordinates;p.type==="MultiPolygon"&&(B=p.coordinates[0]);if(B){if(y.color||y.wallColor)r=
y.color||y.wallColor;if(y.roofColor)t=y.roofColor;p=B[0];q=[];w=y.height;h=D=0;for(l=p.length;h<l;h++)q.push(p[h][1],p[h][0]),D+=w||p[h][2]||0;w=[];h=1;for(l=B.length;h<l;h++)if(p=B[e],w[h-1]=[],p){j=0;for(n=p.length;j<n;j++)w[h-1].push(p[j][1],p[j][0])}h={id:y.id||q[0]+","+q[1],footprint:c(q,"CW")};if(p&&D)h.height=D/p.length<<0;if(y.minHeight)h.minHeight=y.minHeight;if(r)h.wallColor=r;if(t)h.roofColor=t;if(w.length)h.holes=w;o.push(h)}}d=o}else a.osm3s&&(d=ba(a.elements));b&&ia.add(b,d);m(d,!0)}}
function l(a){for(var b=new d(a.length),c,f=0,g=a.length-1;f<g;f+=2){c=a[f+1];var j=n(1,v(0,0.5-h(o(va+pa*a[f]/180))/R/2));c={x:(c/360+0.5)*P<<0,y:j*P<<0};b[f]=c.x;b[f+1]=c.y}a=b;b=a.length/2;f=new e(b);g=0;c=b-1;var m,y,p,B=[],r=[],D=[];for(f[g]=f[c]=1;c;){m=0;for(j=g+1;j<c;j++){y=a[j*2];var t=a[j*2+1],w=a[g*2],q=a[g*2+1],u=a[c*2],ra=a[c*2+1],s=u-w,x=ra-q,S=void 0;if(s!==0||x!==0)S=((y-w)*s+(t-q)*x)/(s*s+x*x),S>1?(w=u,q=ra):S>0&&(w+=s*S,q+=x*S);s=y-w;x=t-q;y=s*s+x*x;y>m&&(p=j,m=y)}m>2&&(f[p]=1,B.push(g),
r.push(p),B.push(p),r.push(c));g=B.pop();c=r.pop()}for(j=0;j<b;j++)f[j]&&D.push(a[j*2],a[j*2+1]);b=D;if(!(b.length<8))return b}function m(a,c){var d,e,f,g,h=[],j,o,y,p,B,D,s,u,x=ha-N;d=0;for(e=a.length;d<e;d++)if(j=a[d],o=(j.height||Aa)*qa>>x)if(y=j.minHeight*qa>>x,!(y>ga)&&(p=l(j.footprint))){s=[];if(j.holes){f=0;for(g=j.holes.length;f<g;f++)(u=l(j.holes[f]))&&s.push(u)}g=f=null;if(j.wallColor&&(B=r.parse(j.wallColor)))f=B.setAlpha(q),g=""+f.setLightness(0.8),f=""+f;D=null;if(j.roofColor&&(B=r.parse(j.roofColor)))D=
""+B.setAlpha(q);h.push({id:j.id,footprint:p,height:n(o,ga),minHeight:y,wallColor:f,altColor:g,roofColor:D,center:b(p),holes:s.length?s:null})}e=0;for(j=h.length;e<j;e++)if(d=h[e],!t[d.id])d.scale=c?0:1,w.renderItems.push(h[e]),t[d.id]=1;ua()}var j,t={},w={renderItems:[]};w.load=function(a){j=a||"http://overpass-api.de/api/interpreter?data=[out:json];(way[%22building%22]({s},{w},{n},{e});node(w);way[%22building:part%22=%22yes%22]({s},{w},{n},{e});node(w);relation[%22building%22]({s},{w},{n},{e});way(r);node(w););out;";
w.update()};w.update=function(){if(j&&!(N<15)){var b=f(I,H),c=f(I+G,H+x),b={n:u(b.latitude/0.0075)*0.0075,e:u(c.longitude/0.015)*0.015,s:p(c.latitude/0.0075)*0.0075,w:p(b.longitude/0.015)*0.015};ia.purge();w.renderItems=[];t={};for(var d,e,g,c=b.s;c<=b.n;c+=0.0075)for(d=b.w;d<=b.e;d+=0.015)g=c+","+d,(e=ia.get(g))?m(e):ta(j,{n:((c+0.0075)*1E4<<0)/1E4,e:((d+0.015)*1E4<<0)/1E4,s:(c*1E4<<0)/1E4,w:(d*1E4<<0)/1E4},a(g))}};w.set=function(a){w.renderItems=[];t={};g(a)};return w}(),ca=function(){function a(b,
c,d){return{x:b+g.x*d,y:c+g.y*d}}var b,c=!0,d=new r(0,0,0),e=null,g={x:0,y:0},h={};h.setContext=function(a){b=a;h.setDate((new Date).setHours(10))};h.enable=function(a){c=!!a};h.render=function(){var h,j,n,p;b.clearRect(0,0,G,x);if(c&&!(N<aa||T))if(h=f(I+X,H+oa),h=t(e,h.latitude,h.longitude),!(h.altitude<=0)){j=1/o(h.altitude);n=0.4/j;g.x=m(h.azimuth)*j;g.y=l(h.azimuth)*j;d.a=n;p=d+"";var r,q,w,s,u,v,A,L,J,M,C,F,K=[];b.beginPath();h=0;for(j=E.renderItems.length;h<j;h++){q=E.renderItems[h];L=!1;w=
q.footprint;A=[];n=0;for(r=w.length-1;n<r;n+=2)A[n]=u=w[n]-I,A[n+1]=v=w[n+1]-H,L||(L=u>0&&u<G&&v>0&&v<x);if(L){w=q.scale<1?q.height*q.scale:q.height;q.minHeight&&(s=q.scale<1?q.minHeight*q.scale:q.minHeight);u=null;n=0;for(r=A.length-3;n<r;n+=2){v=A[n];J=A[n+1];L=A[n+2];M=A[n+3];C=a(v,J,w);F=a(L,M,w);if(q.minHeight)J=a(v,J,s),M=a(L,M,s),v=J.x,J=J.y,L=M.x,M=M.y;(L-v)*(C.y-J)>(C.x-v)*(M-J)?(u===1&&b.lineTo(v,J),u=0,n||b.moveTo(v,J),b.lineTo(L,M)):(u===0&&b.lineTo(C.x,C.y),u=1,n||b.moveTo(C.x,C.y),b.lineTo(F.x,
F.y))}b.closePath();K.push(A)}}b.fillStyle=p;b.fill();b.globalCompositeOperation="destination-out";b.beginPath();h=0;for(j=K.length;h<j;h++){s=K[h];b.moveTo(s[0],s[1]);n=2;for(r=s.length;n<r;n+=2)b.lineTo(s[n],s[n+1]);b.lineTo(s[0],s[1]);b.closePath()}b.fillStyle="#00ff00";b.fill();b.globalCompositeOperation="source-over"}};h.setDate=function(a){e=a;h.render()};return h}(),ea=function(){var a,b={MAX_HEIGHT:8,setContext:function(b){a=b}};b.render=function(){a.clearRect(0,0,G,x);if(!(N<aa||T)){var c,
d,e,f,g,h,j,l,m;a.beginPath();c=0;for(d=E.renderItems.length;c<d;c++)if(e=E.renderItems[c],!(e.height>b.MAX_HEIGHT)){m=!1;g=e.footprint;l=[];e=0;for(f=g.length-1;e<f;e+=2)l[e]=h=g[e]-I,l[e+1]=j=g[e+1]-H,m||(m=h>0&&h<G&&j>0&&j<x);if(m){e=0;for(f=l.length-3;e<f;e+=2)m=l[e],g=l[e+1],e?a.lineTo(m,g):a.moveTo(m,g);a.closePath()}}a.fillStyle=Q;a.strokeStyle=Z;a.stroke();a.fill()}};return b}(),sa=function(){function a(){var d=s.createElement("CANVAS");d.style.webkitTransform="translate3d(0,0,0)";d.style.imageRendering=
"optimizeSpeed";d.style.position="absolute";d.style.left=0;d.style.top=0;var e=d.getContext("2d");e.lineCap="round";e.lineJoin="round";e.lineWidth=1;e.mozImageSmoothingEnabled=!1;e.webkitImageSmoothingEnabled=!1;c.push(d);b.appendChild(d);return e}var b=s.createElement("DIV");b.style.pointerEvents="none";b.style.position="absolute";b.style.left=0;b.style.top=0;var c=[];ca.setContext(a());ea.setContext(a());A=a();return{appendTo:function(a){a.appendChild(b);return b},setSize:function(a,b){for(var d=
0,e=c.length;d<e;d++)c[d].width=a,c[d].height=b}}}();this.onResize=function(a){ma(a.width,a.height);F();E.update()};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)C=r.parse(a.color||a.wallColor),da=C.setAlpha(q)+"",Y=C.setLightness(0.8),Z=Y.setAlpha(q)+"",K=C.setLightness(1.2),Q=K.setAlpha(q)+"";a.roofColor&&(K=r.parse(a.roofColor),Q=K.setAlpha(q)+"");a.shadows!==void 0&&ca.enable(a.shadows);F()};this.setCamOffset=function(a,b){U=X+a;V=x+b};this.setMaxZoom=function(a){ha=a};this.setDate=
function(a){ca.setDate(a)};this.appendTo=function(a){return sa.appendTo(a)};this.loadData=function(a){E.load(a)};this.setData=function(a){E.set(a)};this.onMoveEnd=function(){F();E.update()};this.onZoomEnd=function(a){T=!1;na(a.zoom);E.update();F()};this.onZoomStart=function(){T=!0;F()};this.setOrigin=function(a,b){I=a;H=b};this.setSize=ma;this.setZoom=na;this.render=ja;this.renderAll=F};f.VERSION="0.1.8a";f.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';return f}();
Geo.View2D.Layer.Buildings=Geo.Class(Geo.View2D.Layer,{name:"GEO Buildings",url:null,minLevel:15,maxLevel:20,featureExt:null,heightScaleRatio:1,heightAttribute:"HRG",query:null,extentScaleRatio:2.1,zoomOffset:0,dxSum:0,dySum:0,initialize:function(a,b,c){document.createElement("canvas").getContext||alert("\u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u5f53\u524d\u7684canvas\u77e2\u91cf\u6e32\u67d3\u65b9\u5f0f\uff0c\u8bf7\u4f7f\u7528\u652f\u6301HTML5\u7684\u6d4f\u89c8\u5668\u8fd0\u884c\u3002");c=
c||{};this.format=new Geo.Format.JSON;this.query=c.query instanceof Geo.Query.MapServiceQueryParameters?c.query:new Geo.Query.MapServiceQueryParameters;this.query.returnGeometry=!0;if(typeof b=="string"){this.url=b;this.mapServiceQuery=new Geo.Query.MapServiceQuery(b);var d=this.format;this.mapServiceQuery.queryTemp=function(a,b,c){a=this._getParamsFromQueryParameter(a);Geo.Util.applyDefaults(a,{f:"json",pretty:!0});OpenLayers.loadURL(this.url,a,this,function(a){a=d.read(a.responseText);b(a)},c)}}Geo.View2D.Layer.prototype.initialize.apply(this,
[a,c])},_loadData:function(){this.timerId!=null&&window.clearTimeout(this.timerId);this.timerId=window.setTimeout(OpenLayers.Function.bind(function(){if(this.mapServiceQuery instanceof Geo.Query.MapServiceQuery&&(!this.featureExt||!this.featureExt.featureExt||!(this.featureExt.featureExt.containsBounds(this.map.getExtent())&&this.featureExt.zoom===this.map.zoom)))this.featureExt={featureExt:this.map.getExtent().scale(this.extentScaleRatio),zoom:this.map.zoom},this.query.geometry=this.featureExt.featureExt,
this.mapServiceQuery.queryTemp(this.query,Geo.Function.bind(this._onQueryComplete,this))},this),500)},_getPolygon:function(){var a=this.map.getExtent().scale(this.extentScaleRatio),b=this.featureExt,c=null;if(b instanceof Geo.Bounds)if(a.left>b.left&&a.bottom>b.bottom)var c=new Geo.Geometry.Point(a.left,a.bottom),d=new Geo.Geometry.Point(b.right,b.top),e=new Geo.Geometry.Point(b.right,a.bottom),f=new Geo.Geometry.Point(a.right,a.bottom),b=new Geo.Geometry.Point(a.right,a.top),g=new Geo.Geometry.Point(a.left,
a.top),c=new Geo.Geometry.Polygon(new Geo.Geometry.LinearRing([c,d,e,f,b,g,c]));else a.left>b.left&&a.bottom<b.bottom?(c=new Geo.Geometry.Point(a.left,a.bottom),f=new Geo.Geometry.Point(a.left,b.bottom),e=new Geo.Geometry.Point(b.right,b.bottom),d=new Geo.Geometry.Point(b.right,a.top),b=new Geo.Geometry.Point(a.right,a.top),g=new Geo.Geometry.Point(a.left,a.bottom),c=new Geo.Geometry.Polygon(new Geo.Geometry.LinearRing([c,f,e,d,b,g,c]))):a.bottom>b.bottom&&a.right<b.right?(g=new Geo.Geometry.Point(a.left,
a.top),c=new Geo.Geometry.Point(a.left,a.bottom),f=new Geo.Geometry.Point(b.left,a.bottom),e=new Geo.Geometry.Point(b.left,b.top),d=new Geo.Geometry.Point(a.right,b.top),b=new Geo.Geometry.Point(a.right,a.top),c=new Geo.Geometry.Polygon(new Geo.Geometry.LinearRing([g,c,f,e,d,b,g]))):a.bottom<b.bottom&&a.right<b.right&&(c=new Geo.Geometry.Point(a.left,a.bottom),f=new Geo.Geometry.Point(a.right,a.bottom),e=new Geo.Geometry.Point(a.right,b.bottom),d=new Geo.Geometry.Point(b.left,b.bottom),b=new Geo.Geometry.Point(b.left,
a.top),g=new Geo.Geometry.Point(a.left,a.top),c=new Geo.Geometry.Polygon(new Geo.Geometry.LinearRing([c,f,e,d,b,g,c])));return c},_onQueryComplete:function(a){Geo.Util.isArray(a.features)&&(a.features.length<=0?alert("\u6ca1\u6709\u6570\u636e!"):this.geoJSON(a.features))},loadData:function(a){if(typeof this.url!=="string"){a=this.format.read(a);this.features=a.features;var b=this.zoomOffset+this.map.getZoom();this.features&&this.features.length>0&&this.maxLevel>=b&&this.minLevel<=b&&this.geoJSON(a.features)}},
geoJSON:function(a){var b=[];this._oids={};for(var c=0;c<a.length;c++){var d=a[c];b[c]={type:"Feature",geometry:{type:"Polygon",coordinates:d.geometry.rings},properties:{height:d.attributes[this.heightAttribute]*this.heightScaleRatio+40,isNew:1}}}this.osmb.setData({type:"FeatureCollection",features:b})},setOrigin:function(){var a=this.map.getLonLatFromPixel(new Geo.Pixel(0,0)),b=this.map.resolution,c=this.maxExtent;this.osmb.setOrigin(Math.round((a.lon-c.left)/b),Math.round((c.top-a.lat)/b))},setMap:function(a){this.map||
Geo.View2D.Layer.prototype.setMap.call(this,a);if(!this.osmb)this.osmb=new OSMBuildings,this.container=this.osmb.appendTo(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.map.events.register("zoomend",this,this._zoomend);this.map.events.register("moveend",this,this._moveend)},_zoomend:function(){if(typeof this.url==="string")this.map.getExtent(),this.maxLevel>=this.map.getZoom()&&this.map.getZoom();else if(this.url===void 0||this.url===
null){var a=this.zoomOffset+this.map.getZoom();this.features&&this.features.length>0&&this.maxLevel>=a&&this.minLevel<=a&&this.geoJSON(this.features)}},_moveend:function(){},removeMap:function(a){this.map.events.unregister("zoomend",this,this._zoomend);this.map.events.unregister("moveend",this,this._moveend);this.container.parentNode.removeChild(this.container);this.format=this.mapServiceQuery=this.query=this.osmb=null;Geo.View2D.Layer.prototype.removeMap.call(this,a)},onMapResize:function(){Geo.View2D.Layer.prototype.onMapResize.call(this);
this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},moveTo:function(a,b,c){a=Geo.View2D.Layer.prototype.moveTo.call(this,a,b,c);if(!c){var c=parseInt(this.map.layerContainerDiv.style.left,10),d=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-c+"px";this.div.style.top=-d+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);c=this.zoomOffset+this.map.getZoom();b?(this.osmb.onZoomEnd({zoom:c}),this.maxLevel>=c&&this.minLevel<=
c&&this._loadData()):(b=this.map.getExtent(),this.maxLevel>=c&&this.minLevel<=c&&this.featureExt&&!this.featureExt.featureExt.containsBounds(b)&&this._loadData(),this.osmb.onMoveEnd());return a},moveByPx:function(a,b){this.dxSum+=a;this.dySum+=b;var c=Geo.View2D.Layer.prototype.moveByPx.call(this,a,b);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return c},setStyle:function(a){this.osmb.setStyle(a);return this},setDate:function(a){this.osmb.setDate(a);return this},CLASS_NAME:"Geo.View2D.Layer.Buildings"});
Geo.View2D.Layer.GeoThematicLayer=Geo.Class(Geo.View2D.Layer.Vector,{loaded:!1,format:null,formatOptions:null,gmlUrl:null,styleUrl:null,initialize:function(a,b){var c=[];c.push(a,b);Geo.View2D.Layer.Vector.prototype.initialize.apply(this,c)},setVisibility:function(){Geo.View2D.Layer.Vector.prototype.setVisibility.apply(this,arguments);this.visibility&&!this.loaded&&this.loadGML()},moveTo:function(){Geo.View2D.Layer.Vector.prototype.moveTo.apply(this,arguments);this.visibility&&!this.loaded&&this.loadGML()},
loadGML:function(){if(!this.loaded)this.events.triggerEvent("loadstart"),OpenLayers.Request.GET({url:this.gmlUrl,success:this.requestSuccess,failure:this.requestFailure,scope:this}),this.loaded=!0},setUrl:function(a){this.gmlUrl=a;this.destroyFeatures();this.loaded=!1;this.loadGML()},requestSuccess:function(a){var b=a.responseXML;if(!b||!b.documentElement)b=a.responseText;a={};OpenLayers.Util.extend(a,this.formatOptions);if(this.map&&!this.projection.equals(this.map.getProjectionObject()))a.externalProjection=
this.projection,a.internalProjection=this.map.getProjectionObject();b=(this.format?new this.format(a):new OpenLayers.Format.GML(a)).read(b);this.styleUrl&&OpenLayers.Request.GET({async:!1,url:this.styleUrl,success:function(a){this.thematicStyle=(new OpenLayers.Format.JSON).read(a.responseText)},failure:function(){alert("\u52a0\u8f7d\u4e13\u9898\u56fe\u6837\u5f0f\u6587\u4ef6 "+this.styleUrl+" \u51fa\u73b0\u9519\u8bef\u3002")},scope:this});this.setThematicFeaturesStyle(b,this.thematicStyle);this.addFeatures(b);
this.addThematicLegend();this.events.triggerEvent("loadend")},requestFailure:function(){OpenLayers.Console.userError(OpenLayers.i18n("errorLoadingGML",{url:this.gmlUrl}));this.events.triggerEvent("loadend")},setThematicFeaturesStyle:function(a,b){if(b)for(var c=b.Renditions.PropertyRendition.PropertyName,d=b.Renditions.PropertyRendition.RangeValueRule,e=0;e<a.length;e++){for(var f={},g=a[e].attributes[c],h=0;h<d.length;h++){var l=Number(d[h].BottomValue),m=Number(d[h].TopValue);if((d[h].IncludeBottom&&
l==g||l<g)&&(d[h].IncludeTop&&m==g||g<m)){f={fillColor:d[h].PolygonRendition.FillColor,fillOpacity:Number(d[h].PolygonRendition.FillOpacity),strokeColor:d[h].PolygonRendition.StrokeColor,strokeOpacity:Number(d[h].PolygonRendition.StrokeOpacity),strokeWidth:Number(d[h].PolygonRendition.StrokeWidth)};break}}a[e].style=f}},addThematicLegend:function(){if(this.thematicStyle&&this.map){var a=document.createElement("DIV");this.thematicLegendDIV=a;a.id="pieLegendContainer";a.style.position="absolute";a.style.zIndex=
"1000";a.style.right="5px";a.style.bottom="5px";a.style.border="#15589a 1px solid";a.innerHTML='<div id="legendTitle"><span>\u56fe\u4f8b</span></div><div id="legendContent"></div>';this.map.viewPortDiv.appendChild(a);document.getElementById("legendContent").innerHTML="";for(var a=this.thematicStyle.Renditions.PropertyRendition.RangeValueRule,b=0;b<a.length;b++)document.getElementById("legendContent").innerHTML+='<div class="legend-item"><span class="legend-color" style="background-color: '+a[b].PolygonRendition.FillColor+
';"></span><span class="legend-itemName">'+a[b].BottomValue+" - "+a[b].TopValue+"</span></div>"}},removeThematicLegend:function(){if(this.map)this.map.viewPortDiv&&this.map.viewPortDiv.removeChild(this.thematicLegendDIV),this.thematicLegendDIV.innerHTML="",this.thematicLegendDIV=null},CLASS_NAME:"Geo.View2D.Layer.GeoThematicLayer"});
Geo.View2D.Layer.HeatMapLayer=Geo.Class(Geo.View2D.Layer,{heatmap:null,tmpData:null,heatmapOptions:null,initialize:function(a,b){Geo.View2D.Layer.prototype.initialize.apply(this,[a,b])},setMap:function(a){Geo.View2D.Layer.prototype.setMap.apply(this,arguments);var b=document.createElement("div");b.style.cssText="position:absolute;width:"+this.map.size.w+"px;height:"+this.map.size.h+"px;";this.div.appendChild(b);this.heatmapOptions.element=b;this.heatmapOptions.map=a;this.heatmap=h337.create(this.heatmapOptions);
this.map.events.on({zoomend:this.updateLayer,moveend:this.updateLayer,scope:this})},updateLayer:function(){if(this.tmpData&&this.tmpData.max){var a=this.getPixelOffset(),b=this.heatmap.get("element");b.style.top=(a.y>0?"-"+a.y:Math.abs(a.y))+"px";b.style.left=(a.x>0?"-"+a.x:Math.abs(a.x))+"px";this.setDataSet(this.tmpData)}},getPixelOffset:function(){var a=this.map.layerContainerOrigin,a=this.getViewPortPxFromLonLat(new OpenLayers.LonLat(a.lon,a.lat)),b=this.map.center,b=this.getViewPortPxFromLonLat(new OpenLayers.LonLat(b.lon,
b.lat));return{x:a.x-b.x,y:a.y-b.y}},setDataSet:function(a){var b={},c=a.data,d=c.length,e,f;b.max=a.max;for(b.data=[];d--;)e=c[d],f=e.lonlat.clone().transform(this.projection,this.map.getProjectionObject()),(f=this.roundPixels(this.getViewPortPxFromLonLat(f)))&&b.data.push({x:f.x,y:f.y,count:e.count});this.tmpData=a;this.heatmap.store.setDataSet(b)},roundPixels:function(a){if(a.x<0||a.y<0)return!1;a.x>>=0;a.y>>=0;return a},addDataPoint:function(a){var b=this.roundPixels(this.getViewPortPxFromLonLat(a)),
c={lonlat:a};if(arguments.length==2)c.count=arguments[1];this.tmpData.data.push(c);b&&(b=[b.x,b.y],arguments.length==2&&b.push(arguments[1]),this.heatmap.store.addDataPoint.apply(this.heatmap.store,b))},toggle:function(){this.heatmap.toggleDisplay()},toggleLegend:function(){if(this.heatmap.get("legend")){var a=this.heatmap.get("legend").getElement().style.display;a==""||a=="block"?this.heatmap.get("legend").getElement().style.display="none":this.heatmap.get("legend").getElement().style.display="block"}},
destroy:function(){this.heatmap.cleanup();this.map&&this.heatmap.get("legend")&&this.map.viewPortDiv.removeChild(this.heatmap.get("legend").getElement());this.map.events.un({zoomend:this.updateLayer,moveend:this.updateLayer,scope:this});Geo.View2D.Layer.prototype.destroy.apply(this,arguments)},CLASS_NAME:"Geo.View2D.Layer.HeatMapLayer"});
Geo.View2D.Layer.ThematicTile=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{version:"1.0.0",format:"jpeg"},version:"1.0.0",layerID:null,chartID:null,maxExtent:null,format:"png",colorSchemeID:null,hasLegend:!0,legendSize:new Geo.Size(250,250),legendPosition:"br",hasEdge:!0,hasLabel:!0,vectorLayer:null,thematicTipsListeners:null,featureoverCallback:null,featureoutCallback:null,initialize:function(a,b,c,d){var e=[],c=OpenLayers.Util.upperCaseObject(c);if(parseFloat(c.VERSION)>=1.3&&!c.EXCEPTIONS)c.EXCEPTIONS=
"INIMAGE";e.push(a,b,c,d);this.singleTile=!0;OpenLayers.Layer.Grid.prototype.initialize.apply(this,e);OpenLayers.Util.applyDefaults(this.params,OpenLayers.Util.upperCaseObject(this.DEFAULT_PARAMS));if(!this.noMagic&&this.params.TRANSPARENT&&this.params.TRANSPARENT.toString().toLowerCase()=="true"){if(d==null||!d.isBaseLayer)this.isBaseLayer=!1;if(this.params.FORMAT=="image/jpeg")this.params.FORMAT=OpenLayers.Util.alphaHack()?"gif":"png"}a=this.featureoverCallback||OpenLayers.Function.bind(function(a){a.feature.geometry.getCentroid();
if(this.timerId1!==null)window.clearTimeout(this.timerId1),this.timerId1=null;this.timerId1=window.setTimeout(OpenLayers.Function.bind(function(){for(var b=map.popups,c=0;c<b.length;c++)map.removePopup(b[c]);b=a.feature.attributes.text;c=a.feature.geometry.getCentroid();a.feature.style.fillOpacity=0.7;a.feature.style.strokeOpacity=0.7;this.vectorLayer.drawFeature(a.feature);b=new OpenLayers.Popup.FramedCloud("",new Geo.LonLat(c.x,c.y),null,b,null,!1);map.addPopup(b);this.couter++},this),200)},this);
b=this.featureoutCallback||OpenLayers.Function.bind(function(a){a.feature.style.fillOpacity=0;a.feature.style.strokeOpacity=0;this.vectorLayer.drawFeature(a.feature);for(var a=map.popups,b=0;b<a.length;b++)map.removePopup(a[b])},this);this.vectorLayer=new Geo.View2D.Layer.Vector("hotArea",{maxExtent:this.maxExtent,eventListeners:this.thematicTipsListeners||{featureover:a,featureout:b}});this.jsonp=new OpenLayers.Protocol.Script;this.events.on({moveend:OpenLayers.Function.bind(this.updateHotArea,this)})},
setOpacity:function(a){OpenLayers.Layer.Grid.prototype.setOpacity.apply(this,[a]);this.imageLegend&&this.imageLegend.parentNode&&OpenLayers.Util.modifyDOMElement(this.imageLegend,null,null,null,null,null,null,a)},display:function(a){OpenLayers.Layer.Grid.prototype.display.apply(this,[a]);if(this.imageLegend&&this.imageLegend.parentNode&&a!=(this.div.style.display!="none"))this.imageLegend.style.display=a},getLegend:function(a){if(this.url.indexOf("/",this.url.length-1)!=-1)this.url=this.url.substr(0,
this.url.length-1);var b;b=Geo.String.format("${url}/legend/${layerID}/${chartID}.${format}",{url:this.url,layerID:a.layerID,chartID:a.chartID,format:a.format||"png"});typeof a.colorSchemeID==="string"&&(b+="?colorSchemeID="+a.colorSchemeID);return b},showLegend:function(){var a=this.getLegend({layerID:this.layerID,chartID:this.chartID,ColorSchemeID:this.ColorSchemeID});if(!this.imageLegend)this.imageLegend=Geo.Util.createImage(this.id,new Geo.Pixel(0,0),this.legendSize,a),this.imageLegend.style.zIndex=
this.map.Z_INDEX_BASE.Popup,this.setLegendLocation(this.imageLegend),this.map.viewPortDiv.appendChild(this.imageLegend)},setLegendLocation:function(a){var b=this.map.getSize();switch(this.legendPosition){case "br":var c=b.w-this.legendSize.w,b=b.h-this.legendSize.h;a.style.left=c+"px";a.style.top=b+"px";break;case "bl":b=b.h-this.legendSize.h;a.style.left="0px";a.style.top=b+"px";break;case "tl":a.style.left="0px";a.style.top="0px";break;case "tr":c=b.w-this.legendSize.w,a.style.left=c+"px",a.style.top=
"0px"}},updateHotArea:function(a){a.zoomChanged?this.vectorLayer.removeAllFeatures():this.vectorLayer.redraw()},clone:function(a){a==null&&(a=new Geo.View2D.Layer.ThematicTile(this.name,this.url,this.params,this.getOptions()));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){var a=this.adjustBounds(a),b=this.getImageSize(),a=OpenLayers.String.format("${url}/map/${layerID}/${chartID}/${left}/${bottom}/${right}/${top}/${width}/${height}.${format}?hasLegend=${hasLegend}&hasEdge=${hasEdge}&hasLabel=${hasLabel}",
{url:this.url,layerID:this.layerID,chartID:this.chartID,left:a.left,bottom:a.bottom,right:a.right,top:a.top,width:b.w,height:b.h,format:this.format,hasLegend:this.hasLegend,hasEdge:this.hasEdge,hasLabel:this.hasLabel,colorSchemeID:this.colorSchemeID});typeof this.colorSchemeID==="string"&&(a+="&colorSchemeID="+this.colorSchemeID);return a},initSingleTile:function(a){OpenLayers.Layer.Grid.prototype.initSingleTile.apply(this,arguments);var b=a.getCenterLonLat(),c=a.getWidth()*this.ratio,d=a.getHeight()*
this.ratio,e=new OpenLayers.Bounds(b.lon-c/2,b.lat-d/2,b.lon+c/2,b.lat+d/2),b=this.map.getLayerPxFromLonLat({lon:e.left,lat:e.top}),c=this.map.getLayerPxFromLonLat({lon:e.right,lat:e.bottom}),f=new Geo.Size(c.x-b.x,c.y-b.y);if(this.timerId!==null)window.clearTimeout(this.timerId),this.timerId=null;this.timerId=window.setTimeout(OpenLayers.Function.bind(function(){this.getTileFeature(e,f)},this),80)},getTileFeature:function(a,b){var c;c=OpenLayers.String.format("${url}/hotarea/${layerID}/${chartID}/${left}/${bottom}/${right}/${top}/${width}/${height}?f=json",
{url:this.url,layerID:this.layerID,chartID:this.chartID,left:a.left,bottom:a.bottom,right:a.right,top:a.top,width:b.w,height:b.h});this.jsonp.createRequest(c,null,OpenLayers.Function.bind(function(b){var c=c||this.failFn;if(b.error)c(b.error);else{b=b.HotAreas;c=[];if(b){var f=Geo.Util.extend({},OpenLayers.Feature.Vector.style["default"]);f.fillOpacity=0;for(var g=f.strokeOpacity=0,h=b.length;g<h;g++){f.text=b[g].text;var l=new Geo.Feature.Vector(this._getGeometry(b[g].geometry,a,b[g].text),f,f);
c.push(l)}}c.length>0&&(this.vectorLayer.removeAllFeatures(),this.vectorLayer.addFeatures(c));this.hasLegend&&this.showLegend()}},this))},_getGeometry:function(a,b,c){for(var d in a){if("spatialReference"==d)break;return a=a.hasOwnProperty("x")&&a.hasOwnProperty("y")?new OpenLayers.Geometry.Point(a.x,a.y):a.hasOwnProperty("xmin")&&a.hasOwnProperty("ymin")&&a.hasOwnProperty("xmax")&&a.hasOwnProperty("ymax")?(new OpenLayers.Bounds(a.xmin,a.ymin,a.xmax,a.ymax)).toGeometry():this._geometryType[d].apply(this,
[a[d],b,c])}},convertPixelsToLonLats:function(a,b){var c=this.map.getLayerPxFromLonLat({lon:b.left,lat:b.top}),d=this.map.getLayerPxFromLonLat({lon:b.right,lat:b.bottom}),c=new Geo.Pixel(d.x-c.x,d.y-c.y);return[b.left+a[0]/c.x*(b.right-b.left),b.top+a[1]/c.y*(b.bottom-b.top)]},_geometryType:{points:function(a,b){var c=[];if(OpenLayers.Util.isArray(a))for(var d=0,e=a.length;d<e;d++){var f=this.convertPixelsToLonLats(a[d],b),f=new OpenLayers.Geometry.Point(f[0],f[1]);c.push(f)}return c},paths:function(a,
b){var c=[];if(OpenLayers.Util.isArray(a)){for(var d=0,e=a.length;d<e;d++){for(var f=[],g=0,h=a[d].length;g<h;g++){var l=this.convertPixelsToLonLats(a[d][g],b);f.push(new OpenLayers.Geometry.Point(l[0],l[1]))}f=new OpenLayers.Geometry.LineString(f);c.push(f)}d=new OpenLayers.Geometry.MultiLineString(c)}return d},rings:function(a,b){var c=[];if(OpenLayers.Util.isArray(a)){for(var d=0,e=a.length;d<e;d++){for(var f=[],g=0,h=a[d].length;g<h;g++){var l=this.convertPixelsToLonLats(a[d][g],b);f.push(new OpenLayers.Geometry.Point(l[0],
l[1]))}f=new OpenLayers.Geometry.LinearRing(f);c.push(f)}d=Geo.Util.extend({},OpenLayers.Feature.Vector.style["default"]);d=new OpenLayers.Geometry.Polygon(c,null,d)}return d}},mergeNewParams:function(a){a=[OpenLayers.Util.upperCaseObject(a)];return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,a)},setMap:function(a){OpenLayers.Layer.Grid.prototype.setMap.call(this,a);a.events.register("mousemove",this,OpenLayers.Function.bind(function(b){this._mouselonLatPosition=a.getLonLatFromPixel(b.xy)},
this));a.addLayer(this.vectorLayer)},removeMap:function(a){this.vectorLayer.destroyFeatures(this.vectorLayer.features);OpenLayers.Layer.Grid.prototype.removeMap.call(this,a);for(var b=0,c=a.layers.length;b<c;b++)if(a.layers[b].id===this.vectorLayer.id){a.removeLayer(this.vectorLayer);break}if(this.imageLegend&&this.imageLegend.parentNode)this.imageLegend.parentNode.removeChild(this.imageLegend),this.imageLegend=null;this.map.events.un({zoomend:this.updateHotArea});this.jsonp.destroy()},getFullRequestString:function(a){var b=
this.map.getProjectionObject(),b=this.projection&&this.projection.equals(b)?this.projection.getCode():b.getCode(),b=b=="none"?null:b;parseFloat(this.params.VERSION)>=1.3?this.params.CRS=b:this.params.SRS=b;if(typeof this.params.TRANSPARENT=="boolean")a.TRANSPARENT=this.params.TRANSPARENT?"TRUE":"FALSE";return OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,arguments)},CLASS_NAME:"Geo.View2D.Layer.ThematicTile"});
Geo.View2D.Layer.GeoText=Geo.Class(Geo.View2D.Layer.Vector,{renderers:["Canvas"],url:null,eachRowNumer:4,isCustomStyle:!1,layersStyle:null,isHideGlandFeatures:!1,isShowLine:!1,lineLabelDefaultStyle:{fontColor:"#000000",fontFamily:"\u5b8b\u4f53",fontOpacity:1,fontSize:"16px"},textFeatures:[],pyramid:null,isRotation:!1,positionIndex:1,drawFeatures:{},isAvoidOuterMaxExtent:!0,currentFeatures:null,textCounter:0,service:"TEXT",alongLineoffset:null,labelCharSpace:9,labelSpaceRadio:1,version:"1.0.0",layersID:null,
directions:["rt","ct","cb","lt","rb","lb","rm","lm"],avoidArea:null,initialize:function(a,b){b.pyramid=b.pyramid?b.pyramid:new Geo.Pyramid;Geo.View2D.Layer.Vector.prototype.initialize.apply(this,arguments);if(!this.layersID&&!this.url)throw Error("\u56fe\u5c42id\u6216\u6587\u5b57\u670d\u52a1\u5730\u5740\u4e0d\u80fd\u4e3a\u7a7a\uff01");var c=new Geo.Service.GeoText("GeoText",this.url);c.getCapabilities(OpenLayers.Function.bind(function(a){if(typeof this.layersID==="string"&&this.layersID.length>0){var e=
this.layersID.split(":");if(e.length>1)var f=e[1].split(",");else e.length===1&&(f=e[0].split(","));for(var e=[],g=0;g<f.length;g++)e.push(parseInt(f[g]))}a=c.getTextStylesByLayerIds(a,e);f={};f.url=this.url;f.isCustomStyle=this.isCustomStyle;f.layersStyle=typeof b.layersStyle==="object"&&b.isCustomStyle?b.layersStyle:a;if(b.isCustomStyle)f.eachRowNumer=b.eachRowNumer||this.eachRowNumer;this.formatFeatures=new Geo.Util.Format.GeoTextFeatures(f)},this));this.geoPreAvoidContainer=new Geo.Util.GeoPreAvoidContainer;
this.events.on({moveend:OpenLayers.Function.bind(function(){if(this.timer!==null)window.clearInterval(this.timer),this.timer=null},this)})},read:function(a,b,c){a=OpenLayers.Util.extend({},a);b=new OpenLayers.Protocol.Response({requestType:"read"});c=c||function(){};OpenLayers.Util.applyDefaults(a,this.options||{});b.priv=OpenLayers.Request.GET({url:this.url+"/Features/"+this.layersID+"/"+a.lxyArray+"?f=json&version="+this.version+"&service="+this.service,scope:this,callback:this.createCallback(this.handleRead,
b,a),failure:c});return b},createCallback:function(a,b,c){return OpenLayers.Function.bind(function(){a.apply(this,[b,c])},this)},handleRead:function(a,b){b=OpenLayers.Util.extend({},b);OpenLayers.Util.applyDefaults(b,this.options);if(b.callback){var c=a.priv;c.status>=200&&c.status<300?(c=this.parseResponse(c,b.readOptions))&&!c.error?(a.features=c,a.code=OpenLayers.Protocol.Response.SUCCESS):(a.code=OpenLayers.Protocol.Response.FAILURE,a.error=c):a.code=OpenLayers.Protocol.Response.FAILURE;b.callback.call(b.scope,
a)}},parseResponse:function(a){a=this.formatFeatures.read(a.responseText);if(a.error)return a;return a.tile},getValidLabelPlaceCode:function(a,b){for(var c=this.directions,d,e=c.length-1;e>-1;e--)if(this.isValidLabelBounds(this.getLabelInfo(a,null,c[e]).bounds,b)){d=c[e];break}if(!d)d="none",a.style.display="none";return d},isValidLabelBounds:function(a,b){var c=!0,d=!0,e=this.avoidArea;if(a instanceof OpenLayers.Bounds&&(d=b.containsBounds(a),!d&&this.isAvoidOuterMaxExtent))return!1;for(d=e.length-
1;d>-1;d--)if(this.isIntersects(e[d],a)){c=!1;break}return c},isIntersects:function(a,b){var c;a.CLASS_NAME==b.CLASS_NAME&&a.CLASS_NAME==="OpenLayers.Bounds"&&(c=a.intersectsBounds(b,!1));if(a.CLASS_NAME!==b.CLASS_NAME){c=a.CLASS_NAME=="OpenLayers.Bounds"?a.toGeometry():a;var d=b.CLASS_NAME=="OpenLayers.Bounds"?b.toGeometry():b;c=c.intersects(d)}return c},convertPixelToLonlatSize:function(a){var b=this.map.getResolution();return new Geo.Size(a.w*b,a.h*b)},getLabelPixelSize:function(a){var b=a.label;
if(!b)return null;var c=b.split("\n"),d=c.length,b=this.renderer.canvas;b.save();a=[a.fontStyle?a.fontStyle:"normal","normal",a.fontWeight?a.fontWeight:"normal",a.fontSize?a.fontSize:"1em",a.fontFamily?a.fontFamily:"sans-serif"].join(" ");b.font=a;a=b.measureText("MM").width;c=new Geo.Size(b.measureText(c[0]).width,a*d);b.restore();return c},getLabelInfo:function(a,b,c){var b=b||a.style,d=this.convertPixelToLonlatSize(this.getLabelPixelSize(b)),a=new Geo.LonLat(a.geometry.x,a.geometry.y),e=null,e=
b.graphicWidth?new Geo.Size(b.graphicWidth,b.graphicHeight):new Geo.Size(b.pointRadius*2,b.pointRadius*2),b=this.convertPixelToLonlatSize(e),f;switch(c){case "lt":f=new Geo.LonLat(a.lon-b.w/2-d.w,a.lat+b.h/2+d.h);break;case "ct":f=new Geo.LonLat(a.lon-d.w/2,a.lat+b.h/2+d.h);break;case "rt":f=new Geo.LonLat(a.lon+b.w/2,a.lat+b.h/2+d.h);break;case "lm":f=new Geo.LonLat(a.lon-b.w/2-d.w,a.lat+d.h/2);break;case "rm":f=new Geo.LonLat(a.lon+b.w/2,a.lat+d.h/2);break;case "lb":f=new Geo.LonLat(a.lon-b.w/2-
d.w,a.lat-b.h/2);break;case "cb":f=new Geo.LonLat(a.lon-d.w/2,a.lat-b.h/2);break;case "rb":f=new Geo.LonLat(a.lon+b.w/2,a.lat-b.h/2)}c=new Geo.Bounds(f.lon,f.lat-d.h,f.lon+d.w,f.lat);return{location:f,bounds:c}},getFeatureArea:function(a){var b=a.geometry;switch(b.CLASS_NAME){case "OpenLayers.Geometry.Point":var c=this.map.getResolution(),a=a.style,d=null,d=a.graphicWidth?new Geo.Size(a.graphicWidth,a.graphicHeight):new Geo.Size(a.pointRadius*2,a.pointRadius*2),c=new Geo.Size(c*d.w,c*d.h);return new Geo.Bounds(b.x-
c.w/2,b.y-c.h/2,b.x+c.w/2,b.y+c.h/2);case "OpenLayers.Geometry.LineString":case "OpenLayers.Geometry.LinearRing":case "OpenLayers.Geometry.MultiLineString":case "OpenLayers.Geometry.Polygon":return b}},setMap:function(){Geo.View2D.Layer.Vector.prototype.setMap.apply(this,arguments)},update:function(a){this.textCounter--;a&&a.length!=0&&this.avoidLabelArea(a)},removeFeatures:function(){this.avoidArea=[];this.avoidArea.length=0;for(var a in this.drawFeatures)delete this.drawFeatures[a];this.removeAllFeatures();
if(this.delayedClearText!==null)window.clearTimeout(this.delayedClearText),this.delayedClearText=null},getTextWidthAndHeight:function(a){var b=a.label;if(!b)return null;var c=this.renderer.canvas;c.save();a=[a.fontStyle?a.fontStyle:"normal","normal",a.fontWeight?a.fontWeight:"normal",a.fontSize?a.fontSize:"1em",a.fontFamily?a.fontFamily:"sans-serif"].join(" ");c.font=a;a=c.measureText("MM").width;b=new Geo.Size(c.measureText(b).width,a);c.restore();return b},avoidLabelArea:function(a){for(var b=[],
c=[],d=a.length-1;d>=0;d--){var e=this.pyramid.getTileBoundsForGridIndex(a[d].row,a[d].col,a[d].level);a[d].tileBounds=e;this.avoidArea=[];this.avoidArea.length=0;e=this.avoidFeatureArea(a[d]);if(a[d].labelFeatures&&a[d].labelFeatures.length>0)var f=this.addLabelFeatures(a[d]),c=c.concat(f);e=this.avoidFeatures(e,a[d].tileBounds);b=b.concat(e)}if(c.length>0){a=0;for(d=c.length;a<d;a++){e=0;for(f=b.length;e<f;e++)if(c[a].geometry.intersects(b[e]))b[e].style.display="none"}}OpenLayers.Layer.Vector.prototype.addFeatures.apply(this,
[c]);OpenLayers.Layer.Vector.prototype.addFeatures.apply(this,[b])},destroyLineLabelGroup:function(a){for(var b=0,c=a.labelFeatures.length;b<c;b++)a.labelFeatures[b].destroy()},clearfeaturestile:function(a){for(var b=a.length-1;b>=0;b--)a[b].destroy()},addLabelFeatures:function(a){for(var b=0,c=a.labelFeatures.length;b<c;b++)for(var d=a.labelFeatures[b].getLabelBounds(map),e=0,f=a.labelFeatures.length;e<f;e++)if(b!==e){var g=a.labelFeatures[e].getLabelBounds(map);if(d.intersectsBounds(g))a.labelFeatures[e].isVisibleLabel=
!1}b=[];e=0;for(f=a.labelFeatures.length;e<f;e++)a.labelFeatures[e].isVisibleLabel&&(b=b.concat(a.labelFeatures[e].features));a.labelFeatures=[];return b},avoidFeatures:function(a,b){for(var c=[],d=a.length-1;d>-1;d--)a[d].geometry.CLASS_NAME==="OpenLayers.Geometry.Point"?a[d].style.display==="none"||a[d].style.label&&OpenLayers.String.trim(a[d].style.label)===""||a[d].style.alongLineLabel&&OpenLayers.String.trim(a[d].style.alongLineLabel)===""||(a[d].style.type!=="polygon"&&this.avoidPointLabel(a[d],
b),c.push(a[d])):a[d].geometry.CLASS_NAME==="OpenLayers.Geometry.LineString"||a[d].geometry.CLASS_NAME==="OpenLayers.Geometry.MultiLineString"||c.push(a[d]);return c},avoidPointLabel:function(a,b){var c=this.getValidLabelPlaceCode(a,b);c==="none"?(a.style.label="",a.style.display="none",a.style.fontSize=""):(this.convertToLabelPlaceStyle(a.style,c),this.avoidArea.push(this.getLabelInfo(a,null,c).bounds))},convertToLabelPlaceStyle:function(a,b){var c=a.graphicWidth?new Geo.Size(a.graphicWidth,a.graphicHeight):
new Geo.Size(a.pointRadius*2,a.pointRadius*2);switch(b){case "lt":a.labelAlign="rb";a.labelXOffset=-(0+c.w/2);a.labelYOffset=0+c.h/2;break;case "ct":a.labelAlign="cb";a.labelXOffset=0;a.labelYOffset=0+c.h/2;break;case "rt":a.labelAlign="lb";a.labelXOffset=0+c.w/2;a.labelYOffset=0+c.h/2;break;case "lm":a.labelAlign="rm";a.labelXOffset=0-c.w/2;a.labelYOffset=0;break;case "rm":a.labelAlign="lm";a.labelXOffset=0+c.w/2;a.labelYOffset=0;break;case "lb":a.labelAlign="rt";a.labelXOffset=-(0+c.w/2);a.labelYOffset=
-(0+c.w/2);break;case "cb":a.labelAlign="ct";a.labelXOffset=0;a.labelYOffset=-(0+c.h/2);break;case "rb":a.labelAlign="lt",a.labelXOffset=0+c.w/2,a.labelYOffset=-(0+c.w/2)}return a},addLabelCharBoundsToInvalidBounds:function(a){for(var b=0;b<a.length;b++)this.avoidArea.push(this.getLaeblBounds(a[b]))},boundsToFeature:function(a){a=a.toGeometry();return new Geo.Feature.Vector(a)},getLabelBounds:function(a){var b=new Geo.LonLat(a.geometry.x,a.geometry.y),c=a.style.label.length,d=map.getResolution(),
a=new Geo.Size((a.style.fontSize+this.labelCharSpace/2)*c*d,a.style.fontSize*d);return new Geo.Bounds(b.lon-a.w/2,b.lat-a.h/2,b.lon+a.w/2,b.lat+a.h/2)},getLabelLonLatSize:function(a,b){var c=parseInt(b.fontSize),d=this.map.getResolution();return new Geo.Size((c+this.labelCharSpace/2)*a.length*d,c*d)},getLabelFeaturesForLineString:function(a,b,c,d){c.move(-map.getResolution()*12,0);for(var e=this.getLabelLonLatSize(a,b).w,f=e*6,g=c.getLength(),h=Math.floor(g/(e+f))+Math.floor(g%(e+f)/e),l=(g-(h-1)*
f-e*h)/2;l<0;)h-=1,l=(g-(h-1)*f-e*h)/2;for(var m=e/a.length,g=[],o=[],j=0;j<h;j++)for(var n=0;n<a.length;n++)g.push(l+j*(e+f)+n*m),o.push(a[n]);e=c.getVertices();c=[];for(j=f=0;j<e.length-1;j++)h=e[j],l=e[j+1],m=this.getTwoPointsAngle(h,l),n=h.distanceTo(l),f+=n,c.push({start:h,end:l,angle:m,length:n,totalLength:f});e=[];for(j=f=0;j<g.length;j++){l=g[j];m=0;for(h=c[f];h.totalLength<l;)f++,h=c[f];m=l-(f>0?c[f-1].totalLength:0);l=this.getPointOnLine(h.start,h.end,m);m=Geo.Util.extend({},this.lineLabelDefaultStyle);
m.label=o[j];if(this.isRotation)m.labelRotation=-h.angle;m=Geo.Util.extend(m,b);e.push(new Geo.Feature.Vector(l,null,m))}return this.getSortLabelCharFeatures(e,a,d)},getSortLabelCharFeatures:function(a,b,c){for(var d=[],e=0;e<a.length;e++)if(/^[-]{0,1}[0-9]{1,}$/.test(""+(e+1)/b.length)){d.push(a[e]);var d=new Geo.Util.Format.GeoTextFeatures.LineLabelGroup({features:d,labelCharSpace:this.labelCharSpace,label:b}),f=d.getLabelBounds(this.map);if(c.tileBounds.containsBounds(f,!0)){if(!Geo.Util.isArray(c.labelFeatures))c.labelFeatures=
[];c.labelFeatures.push(d)}for(var d=[],g=0,h=0,f=0;f<b.length-1;f++)g+=Math.abs(a[e-f].geometry.x-a[e-f-1].geometry.x),h+=Math.abs(a[e-f].geometry.y-a[e-f-1].geometry.y);if(g<=h&&a[e-(b.length-1)].geometry.x>=a[e].geometry.x&&a[e-(b.length-1)].geometry.y<=a[e].geometry.y)for(f=0;f<b.length;f++)if(b.length%2===0&&f+1<=b.length/2)g=a[e-f].geometry.clone(),h=a[e-(b.length-1)+f].geometry.clone(),a[e-f].geometry=h,a[e-(b.length-1)+f].geometry=g;else{if(b.length%2!==0&&f+1<Math.ceil(b.length/2))g=a[e-
f].geometry.clone(),h=a[e-(b.length-1)+f].geometry.clone(),a[e-f].geometry=h,a[e-(b.length-1)+f].geometry=g}else if(g<=h&&a[e-(b.length-1)].geometry.x<=a[e].geometry.x&&a[e-(b.length-1)].geometry.y<=a[e].geometry.y)for(f=0;f<b.length;f++)if(b.length%2===0&&f+1<=b.length/2)g=a[e-f].geometry.clone(),h=a[e-(b.length-1)+f].geometry.clone(),a[e-f].geometry=h,a[e-(b.length-1)+f].geometry=g;else{if(b.length%2!==0&&f+1<Math.ceil(b.length/2))g=a[e-f].geometry.clone(),h=a[e-(b.length-1)+f].geometry.clone(),
a[e-f].geometry=h,a[e-(b.length-1)+f].geometry=g}else if(g>h&&a[e-(b.length-1)].geometry.x>a[e].geometry.x)for(f=0;f<b.length;f++)if(b.length%2===0&&f+1<=b.length/2)g=a[e-f].geometry.clone(),h=a[e-(b.length-1)+f].geometry.clone(),a[e-f].geometry=h,a[e-(b.length-1)+f].geometry=g;else if(b.length%2!==0&&f+1<Math.ceil(b.length/2))g=a[e-f].geometry.clone(),h=a[e-(b.length-1)+f].geometry.clone(),a[e-f].geometry=h,a[e-(b.length-1)+f].geometry=g}else d.push(a[e]);return[]},getPointOnLine:function(a,b,c){if(!(c<=
0))var d=a.distanceTo(b),a=new Geo.Geometry.Point(a.x+(b.x-a.x)*c/d,a.y+(b.y-a.y)*c/d);return a},getTwoPointsAngle:function(a,b){return Math.atan((b.y-a.y)/(b.x-a.x))/0.017453293},avoidFeatureArea:function(a){for(var b=a.features,c=b.length-1;c>-1;c--){var d=this.getFeatureArea(b[c]),e=b[c].geometry.clone(),f=b[c].style.alongLineLabel;if(b[c].geometry instanceof OpenLayers.Geometry.LineString)this.getLabelFeaturesForLineString(f,b[c].style,e,a);else if(b[c].geometry instanceof OpenLayers.Geometry.MultiLineString)for(var g=
0,h=e.components.length;g<h;g++)this.getLabelFeaturesForLineString(f,{fontSize:16},e.components[g].clone(),a);this.avoidArea.push(d)}return b},removeMap:function(a){Geo.View2D.Layer.Vector.prototype.removeMap.apply(this,arguments);a.events.un({zoomend:this.update})},CLASS_NAME:"Geo.View2D.Layer.GeoText"});Geo.View2D.Layer.GeoText.TOP="ct";Geo.View2D.Layer.GeoText.BOTTOM="cb";Geo.View2D.Layer.GeoText.LEFT="lm";Geo.View2D.Layer.GeoText.RIGHT="rm";Geo.View2D.Layer.GeoText.TOP_LEFT="lt";
Geo.View2D.Layer.GeoText.BOTTOM_LEFT="lb";Geo.View2D.Layer.GeoText.TOP_RIGHT="rt";Geo.View2D.Layer.GeoText.BOTTOM_RIGHT="rb";
Geo.View2D.Layer.HotareaWMTS=Geo.Class(Geo.View2D.Layer.WMTS,{vectorLayer:null,selectCtrl:null,initialize:function(){Geo.View2D.Layer.WMTS.prototype.initialize.apply(this,arguments);this.urls=[]},setMap:function(){Geo.View2D.Layer.WMTS.prototype.setMap.apply(this,arguments);this.map.events.register("zoomend",this,this.removeFeatures);this.map.addLayers([this.vectorLayer]);this.highlightCtrl=new Geo.View2D.Control.SelectFeature(this.vectorLayer,{hover:!0,highlightOnly:!0,eventListeners:{beforefeaturehighlighted:function(){},
featurehighlighted:function(a){a=a.feature;this.hotareaWMTS.highlight(a);a=this.hotareaWMTS.getCombinationFeature(a).point;if(!a.isclicked)this.hotareaWMTS.onMouseOverFeature(a)},featureunhighlighted:function(a){var a=a.feature,b=this.hotareaWMTS.getCombinationFeature(a).point;b.isclicked?this.hotareaWMTS.highlight(a):(this.hotareaWMTS.unhighlight(a),this.hotareaWMTS.onMouseOutFeature(b))}}});this.selectCtrl=new Geo.View2D.Control.SelectFeature(this.vectorLayer,{hover:!1,clickout:!0,eventListeners:{beforefeaturehighlighted:function(){},
featurehighlighted:function(a){this.hotareaWMTS.highlight(a.feature)},featureunhighlighted:function(){}},onSelect:function(a){this.hotareaWMTS.highlight(a);a=this.hotareaWMTS.getCombinationFeature(a).point;a.isclicked=!0;this.hotareaWMTS.onSelectFeature(a)},onUnselect:function(a){this.hotareaWMTS.unhighlight(a);a=this.hotareaWMTS.getCombinationFeature(a).point;a.isclicked=!1;this.hotareaWMTS.onUnselectFeature(a)}});this.map.addControl(this.highlightCtrl);this.map.addControl(this.selectCtrl);this.highlightCtrl.activate();
this.selectCtrl.activate();this.highlightCtrl.hotareaWMTS=this;this.selectCtrl.hotareaWMTS=this},highlight:function(a){var b=this.getCombinationFeature(a),a=b.point,b=b.polygon,c=a.attributes.overPicUrl,d=new Image;d.src=c;var e=d.width,d=d.height,c={point:{externalGraphic:c,graphicWidth:e,graphicHeight:d,graphicXOffset:parseInt(-e/2),graphicYOffset:parseInt(-d/2),cursor:"pointer"},polygon:{fillOpacity:0,strokeOpacity:0,cursor:"pointer"}};this.vectorLayer.drawFeature(a,c.point);this.vectorLayer.drawFeature(b,
c.polygon)},unhighlight:function(a){var b=this.getCombinationFeature(a),a=b.point,b=b.polygon,c=a.attributes.outPicUrl,d=new Image;d.src=c;var e=d.width,d=d.height,c={point:{externalGraphic:c,graphicWidth:e,graphicHeight:d,graphicXOffset:parseInt(-e/2),graphicYOffset:parseInt(-d/2),cursor:"pointer"},polygon:{fillColor:"#f0f7fe",fillOpacity:0,strokeColor:"#76a1cb",strokeOpacity:0,strokeWidth:1,cursor:"pointer"}};this.vectorLayer.drawFeature(a,c.point);this.vectorLayer.drawFeature(b,c.polygon)},onSelectFeature:function(){},
onUnselectFeature:function(){},onMouseOverFeature:function(){},onMouseOutFeature:function(){},removeFeatures:function(){this.selectCtrl.unselectAll();this.vectorLayer.destroyFeatures();this.urls=[]},moveTo:function(a,b,c){(b||!this.matrix)&&this.updateMatrixProperties();OpenLayers.Layer.HTTPRequest.prototype.moveTo.apply(this,arguments);a=a||this.map.getExtent();if(a!=null){var d=!this.grid.length||b,e=this.getTilesBounds();this.singleTile?(d||!c&&!e.containsBounds(a))&&this.initSingleTile(a):d||
!e.containsBounds(a,!0)?this.initGriddedTiles(a):this.moveGriddedTiles()}},getCombinationFeature:function(a){var b=null,c=null,c=a.attributes.relatedid;a.attributes.type=="point"?(b=a,c=this.vectorLayer.getFeatureById(c)):(b=this.vectorLayer.getFeatureById(c),c=a);return{point:b,polygon:c}},removeMap:function(){OpenLayers.Layer.Grid.prototype.removeMap.apply(this,arguments)},addTile:function(a,b){if(this.format=="text/json")return new Geo.View2D.Tile.TileFeature(this,b,a,null,this.tileSize,this.tileOptions)},
destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments)},getPicURL:function(a,b){return OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[{SERVICE:"WMTS",REQUEST:"GetIcon",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,PICID:a,ISANTI:b}])},CLASS_NAME:"Geo.View2D.Layer.HotareaWMTS"});
Geo.View2D.BaseLayerGroup=Geo.Class({id:null,layers:null,map:null,initialize:function(a){this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_");this.layers=[];OpenLayers.Util.extend(this,a)},setMap:function(a){if(a&&!this.map){this.map=a;for(a=0;a<this.layers.length;a++)this.map.addLayer(this.layers[a],!0)}},removeMap:function(){if(this.map){for(var a=0;a<this.layers.length;a++)this.layers[a].map&&this.map.removeLayer(this.layers[a]);this.map=null}},getMaxResolution:function(){for(var a=this.layers,
b=null,c=0;c<a.length;c++)var d=a[c].getOptions().maxResolution,b=b==null?d:Math.max(b,d);return b},getMinResolution:function(){for(var a=this.layers,b=null,c=0;c<a.length;c++)var d=a[c].getOptions().minResolution,b=b==null?d:Math.min(b,d);return b},getMaxExtent:function(){for(var a=null,b=0;b<this.layers.length;b++)a?a.extend(this.layers[b].getDataExtent()):a=this.layers[b].getDataExtent();return a},destroy:function(){this.removeMap();for(var a=0;a<layers.length;a++)layers[a].destroy();this.layers=
null},CLASS_NAME:"Geo.View2D.BaseLayerGroup"});
Geo.View2D.BaseLayerGroup.getTianDiTuGroup=function(a){new Geo.Bounds(-180,-90,180,90);new Geo.Bounds(-180,-90,180,90);if(a={img:[new Geo.View2D.Layer.GlobeTile("\u5168\u7403\u5f71\u50cf\u5e95\u56fe(2-10)","http://tile0.tianditu.com/services/sbsm0210",{transitionEffect:"resize",topLevel:2,bottomLevel:10,maxExtent:new Geo.Bounds(-180,-90,180,90),mirrorUrl:["http://tile0.tianditu.com/services/sbsm0210","http://tile1.tianditu.com/services/sbsm0210","http://tile2.tianditu.com/services/sbsm0210","http://tile3.tianditu.com/services/sbsm0210",
"http://tile4.tianditu.com/services/sbsm0210","http://tile5.tianditu.com/services/sbsm0210","http://tile6.tianditu.com/services/sbsm0210","http://tile7.tianditu.com/services/sbsm0210"]}),new Geo.View2D.Layer.GlobeTile("\u5168\u7403\u5f71\u50cf\u6ce8\u8bb0(2-10)","http://tile0.tianditu.com/services/A0104_ImgAnnoE",{topLevel:2,bottomLevel:10,maxExtent:new Geo.Bounds(-180,-90,180,90),mirrorUrl:["http://tile0.tianditu.com/services/A0610_ImgAnno","http://tile1.tianditu.com/services/A0610_ImgAnno","http://tile2.tianditu.com/services/A0610_ImgAnno",
"http://tile3.tianditu.com/services/A0610_ImgAnno","http://tile4.tianditu.com/services/A0610_ImgAnno","http://tile5.tianditu.com/services/A0610_ImgAnno","http://tile6.tianditu.com/services/A0610_ImgAnno","http://tile7.tianditu.com/services/A0610_ImgAnno"]}),new Geo.View2D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf(14)","http://tile0.tianditu.com/services/eastdawnall",{transitionEffect:"resize",topLevel:14,bottomLevel:14,maxExtent:new Geo.Bounds(73.30078125,17.9296875,135.17578125,53.701171875),mirrorUrl:["http://tile0.tianditu.com/services/eastdawnall",
"http://tile1.tianditu.com/services/eastdawnall","http://tile2.tianditu.com/services/eastdawnall","http://tile3.tianditu.com/services/eastdawnall","http://tile4.tianditu.com/services/eastdawnall","http://tile5.tianditu.com/services/eastdawnall","http://tile6.tianditu.com/services/eastdawnall","http://tile7.tianditu.com/services/eastdawnall"]}),new Geo.View2D.Layer.GlobeTile("\u5168\u7403\u5f71\u50cf(15-18)","http://tile0.tianditu.com/services/sbsm1518",{transitionEffect:"resize",topLevel:15,bottomLevel:18,
maxExtent:new Geo.Bounds(-180,-90,180,90),mirrorUrl:["http://tile0.tianditu.com/services/sbsm1518","http://tile1.tianditu.com/services/sbsm1518","http://tile2.tianditu.com/services/sbsm1518","http://tile3.tianditu.com/services/sbsm1518","http://tile4.tianditu.com/services/sbsm1518","http://tile5.tianditu.com/services/sbsm1518","http://tile6.tianditu.com/services/sbsm1518","http://tile7.tianditu.com/services/sbsm1518"]}),new Geo.View2D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf(13)","http://tile0.tianditu.com/services/e13",
{transitionEffect:"resize",topLevel:13,bottomLevel:13,maxExtent:new Geo.Bounds(73.30078125,17.9736328125,135.1318359375,53.6572265625),mirrorUrl:["http://tile0.tianditu.com/services/e13","http://tile1.tianditu.com/services/e13","http://tile2.tianditu.com/services/e13","http://tile3.tianditu.com/services/e13","http://tile4.tianditu.com/services/e13","http://tile5.tianditu.com/services/e13","http://tile6.tianditu.com/services/e13","http://tile7.tianditu.com/services/e13"]}),new Geo.View2D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf(12)",
"http://tile0.tianditu.com/services/e12",{transitionEffect:"resize",topLevel:12,bottomLevel:12,maxExtent:new Geo.Bounds(73.30078125,17.9296875,135.17578125,53.701171875),mirrorUrl:["http://tile0.tianditu.com/services/e12","http://tile1.tianditu.com/services/e12","http://tile2.tianditu.com/services/e12","http://tile3.tianditu.com/services/e12","http://tile4.tianditu.com/services/e12","http://tile5.tianditu.com/services/e12","http://tile6.tianditu.com/services/e12","http://tile7.tianditu.com/services/e12"]}),
new Geo.View2D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf(11)","http://tile0.tianditu.com/services/e11",{transitionEffect:"resize",topLevel:11,bottomLevel:11,maxExtent:new Geo.Bounds(73.30078125,17.9296875,135.17578125,53.7890625),mirrorUrl:["http://tile0.tianditu.com/services/e11","http://tile1.tianditu.com/services/e11","http://tile2.tianditu.com/services/e11","http://tile3.tianditu.com/services/e11","http://tile4.tianditu.com/services/e11","http://tile5.tianditu.com/services/e11","http://tile6.tianditu.com/services/e11",
"http://tile7.tianditu.com/services/e11"]}),new Geo.View2D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf\u6ce8\u8bb0(11-14)","http://tile0.tianditu.com/services/B0530_eImgAnno",{topLevel:11,bottomLevel:14,maxExtent:new Geo.Bounds(73.4765625,2.8125,135.439453125,53.7890625),mirrorUrl:["http://tile0.tianditu.com/services/B0530_eImgAnno","http://tile1.tianditu.com/services/B0530_eImgAnno","http://tile2.tianditu.com/services/B0530_eImgAnno","http://tile3.tianditu.com/services/B0530_eImgAnno","http://tile4.tianditu.com/services/B0530_eImgAnno",
"http://tile5.tianditu.com/services/B0530_eImgAnno","http://tile6.tianditu.com/services/B0530_eImgAnno","http://tile7.tianditu.com/services/B0530_eImgAnno"]}),new Geo.View2D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf\u6ce8\u8bb0(15-18)","http://tile0.tianditu.com/services/siweiAnno68",{topLevel:15,bottomLevel:18,maxExtent:new Geo.Bounds(73.4765625,2.8125,135.439453125,53.7890625),mirrorUrl:["http://tile0.tianditu.com/services/siweiAnno68","http://tile1.tianditu.com/services/siweiAnno68","http://tile2.tianditu.com/services/siweiAnno68",
"http://tile3.tianditu.com/services/siweiAnno68","http://tile4.tianditu.com/services/siweiAnno68","http://tile5.tianditu.com/services/siweiAnno68","http://tile6.tianditu.com/services/siweiAnno68","http://tile7.tianditu.com/services/siweiAnno68"]})],dlg:[new Geo.View2D.Layer.GlobeTile("\u5168\u56fd\u77e2\u91cf(2-10)","http://tile0.tianditu.com/services/A0512_EMap",{transitionEffect:"resize",topLevel:2,bottomLevel:10,maxExtent:new Geo.Bounds(-180,-90,180,90),mirrorUrl:["http://tile0.tianditu.com/services/A0512_EMap",
"http://tile1.tianditu.com/services/A0512_EMap","http://tile2.tianditu.com/services/A0512_EMap","http://tile3.tianditu.com/services/A0512_EMap","http://tile4.tianditu.com/services/A0512_EMap","http://tile5.tianditu.com/services/A0512_EMap","http://tile6.tianditu.com/services/A0512_EMap","http://tile7.tianditu.com/services/A0512_EMap"]}),new Geo.View2D.Layer.GlobeTile("\u5168\u56fd\u77e2\u91cf\u6ce8\u8bb0(2-10)","http://tile0.tianditu.com/services/AB0512_Anno",{topLevel:2,bottomLevel:10,maxExtent:new Geo.Bounds(-180,
-90,180,90),mirrorUrl:["http://tile0.tianditu.com/services/AB0512_Anno","http://tile1.tianditu.com/services/AB0512_Anno","http://tile2.tianditu.com/services/AB0512_Anno","http://tile3.tianditu.com/services/AB0512_Anno","http://tile4.tianditu.com/services/AB0512_Anno","http://tile5.tianditu.com/services/AB0512_Anno","http://tile6.tianditu.com/services/AB0512_Anno","http://tile7.tianditu.com/services/AB0512_Anno"]}),new Geo.View2D.Layer.GlobeTile("\u5168\u56fd\u77e2\u91cf(11-12)","http://tile0.tianditu.com/services/B0627_EMap1112",
{transitionEffect:"resize",topLevel:11,bottomLevel:12,maxExtent:new Geo.Bounds(69.9609375,0.87890625,879.9609375,56.25),mirrorUrl:["http://tile0.tianditu.com/services/B0627_EMap1112","http://tile1.tianditu.com/services/B0627_EMap1112","http://tile2.tianditu.com/services/B0627_EMap1112","http://tile3.tianditu.com/services/B0627_EMap1112","http://tile4.tianditu.com/services/B0627_EMap1112","http://tile5.tianditu.com/services/B0627_EMap1112","http://tile6.tianditu.com/services/B0627_EMap1112","http://tile7.tianditu.com/services/B0627_EMap1112"]}),
new Geo.View2D.Layer.GlobeTile("\u5168\u56fd\u77e2\u91cf(13-18)","http://tile0.tianditu.com/services/siwei0608",{transitionEffect:"resize",topLevel:13,bottomLevel:18,maxExtent:new Geo.Bounds(-180,-90,180,90),mirrorUrl:["http://tile0.tianditu.com/services/siwei0608","http://tile1.tianditu.com/services/siwei0608","http://tile2.tianditu.com/services/siwei0608","http://tile3.tianditu.com/services/siwei0608","http://tile4.tianditu.com/services/siwei0608","http://tile5.tianditu.com/services/siwei0608",
"http://tile6.tianditu.com/services/siwei0608","http://tile7.tianditu.com/services/siwei0608"]})]}[a])return new Geo.View2D.BaseLayerGroup({layers:a});return null};Geo.View2D.LayerGroup=Geo.View2D.BaseLayerGroup;
Geo.View2D.FeatureManager=Geo.Class({id:null,map:null,_typeMapping:null,featureSortField:"featureSort",orderNumberField:"orderNumber",styleMap:null,vectorLayerOptions:null,vectorLayer:null,selectControlOptions:null,selectControl:null,maxFeaturesPerPage:15,topicCSSClass:null,topicDiv:null,initialize:function(a){this._typeMapping={};this.styleMap=Geo.View2D.FeatureManager.defaultStyleMap;this.registerResultType("default");OpenLayers.Util.extend(this,a)},setMap:function(a){if(a&&!this.map)this.map=a,
this.vectorLayer=new OpenLayers.Layer.Vector("GeoGlobeFeatureManagerVector",{styleMap:this.styleMap,isOnTop:!0,displayInLayerSwitcher:!1,rendererOptions:{zIndexing:!0}}),this.map.addLayer(this.vectorLayer),this._initSelectControl(),this._addTopicDiv()},registerFeatureSort:function(a,b){this._typeMapping[a]=OpenLayers.Util.extend({features:[],currentPage:0,maxFeaturesPerPage:this.maxFeaturesPerPage,onTurnToPage:this.onTurnToPage,onFeatureSelect:Geo.View2D.FeatureManager.showFramedCloud,onFeatureUnselect:Geo.View2D.FeatureManager.closeFramedCloud,
onFeatureOver:Geo.View2D.FeatureManager.showTopic,onFeatureOut:Geo.View2D.FeatureManager.closeTopic},b)},registerResultType:function(a,b){this.registerFeatureSort(a,b)},addFeatures:function(a,b,c){b=b||"default";Geo.Util.isArray(a)||(a=[a]);if(this._typeMapping[b]){var a=this._addTypeMarker(a,b),d=this._typeMapping[b].style;d&&this._addStyleForFeatures(a,d);c?this._typeMapping[b].features=this._typeMapping[b].features.concat(a):(this.clearResultFromMap(b),this._typeMapping[b].features=a);this._typeMapping[b].currentPage=
0}},onTurnToPage:function(){},turnToPageN:function(a,b){var b=b||"default",c=this._typeMapping[b],d=this.getTotalPageNumber(b),a=a<=0?1:a,a=a>d?d:a,d=this._pagingFeatures({maxPerPage:c.maxFeaturesPerPage,pageNum:a,resultArr:c.features});this.addOrderForFeatures(d);if(a!==c.currentPage)this.clearResultFromMap(b),this.drawFeaturesToMap(d),c.currentPage=a;c.onTurnToPage(d);return d},turnToFirst:function(a,b){return this.turnToPageN(1,a||"default",b)},turnToNext:function(a,b){a=a||"default";return this.turnToPageN(this._typeMapping[a].currentPage+
1,a,b)},turnToPre:function(a,b){a=a||"default";return this.turnToPageN(this._typeMapping[a].currentPage-1,a,b)},turnToLast:function(a,b){a=a||"default";this.turnToPageN(this.getTotalPageNumber(a),a,b)},getPageInfo:function(a){a=this._typeMapping[a||"default"];return Math.ceil(a.features.length/a.maxFeaturesPerPage)},getTotalPageNumber:function(a){a=this._typeMapping[a||"default"];return Math.ceil(a.features.length/a.maxFeaturesPerPage)},getFeatures:function(a){return(a=this._typeMapping[a||"default"])&&
a.features?a.features:[]},drawFeaturesToMap:function(a){var b,c,d;b=this.map;c=this.vectorLayer;if(typeof a=="string"){var e=a||"default";this._typeMapping[e]&&b&&(d=this.getFeatures(e))}a instanceof Array&&(d=a);c.addFeatures(d);(a=c.getDataExtent())&&c.map.zoomToExtent(a)},selectFeatureById:function(a){this.selectControl.unselectAll();a=this.vectorLayer.getFeatureById(a);this.vectorLayer.drawFeature(a);this.selectControl.select(a);a.selectControl=this.selectControl},clearFeatureFromMap:function(a){var a=
a||"default",b=this._typeMapping[a],c=this.vectorLayer,a=a=="allType"?this.vectorLayer.features:b?b.features:[];c&&(this.selectControl.unselectAll(),c.removeFeatures(a))},clearResultFromMap:function(a){this.clearFeatureFromMap(a)},clearFeatures:function(a){var a=a||"default",b=this._typeMapping[a];if(b)this.clearResultFromMap(a),b.features=[]},clearResult:function(a){this.clearFeatures(a)},addOrderForFeatures:function(a){for(var b=0;b<a.length;b++)a[b].attributes[this.orderNumberField]=b;return a},
_addStyleForFeatures:function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(!d.style)d.style=b}},_addTypeMarker:function(a,b){for(var c=0;c<a.length;c++)a[c].attributes[this.featureSortField]=b;return a},_addTopicDiv:function(){var a=OpenLayers.Util.getElement(this.map.id+"featureManagerTopic");if(!a){a=document.createElement("div");if(!this.topicCSSClass)a.style.backgroundColor="#fff",a.style.border="1px solid #000",a.style.padding="3px",a.style.position="absolute",a.style.top="30px",a.style.left=
"30px",a.style.display="none",a.innerHTML="test";this.map.div.appendChild(a);this.topicDiv=a}},_pagingFeatures:function(a){var b=a.maxPerPage,c=a.pageNum;return a.resultArr.slice((c-1)*b,c*b-1+1)},_dispatchEvent:function(a,b,c){a._typeMapping[b.attributes[a.featureSortField]][c](b)},_initSelectControl:function(){if(this.map&&!this.selectControl){var a={onSelect:OpenLayers.Function.bind(function(a){this._dispatchEvent(this,a,"onFeatureSelect")},this),onUnselect:OpenLayers.Function.bind(function(a){this._dispatchEvent(this,
a,"onFeatureUnselect")},this),callbacks:{over:OpenLayers.Function.bind(function(a){this._dispatchEvent(this,a,"onFeatureOver")},this),out:OpenLayers.Function.bind(function(a){this._dispatchEvent(this,a,"onFeatureOut")},this)}},a=OpenLayers.Util.applyDefaults(this.selectControlOptions,a);this.selectControl=new Geo.View2D.Control.SelectFeature(this.vectorLayer,a);this.map.addControl(this.selectControl)}}});
Geo.View2D.FeatureManager.defaultStyleMap=new Geo.StyleMap({"default":new Geo.Style({externalGraphic:OpenLayers.Util.getImagesLocation()+"marker.png",graphicWidth:21,graphicHeight:25,graphicXOffset:-10,graphicYOffset:-12}),select:new Geo.Style({externalGraphic:OpenLayers.Util.getImagesLocation()+"marker-blue.png",graphicWidth:21,graphicHeight:25,graphicXOffset:-10,graphicYOffset:-12})});
Geo.View2D.FeatureManager.showFramedCloud=function(a,b){var c=a.layer,d=c?c.map:null;if(c&&d){var c=b?b:function(){var b="",c;for(c in a.attributes)b+=c+":"+a.attributes[c]+"<br>";return b}(),e=null;"OpenLayers.Geometry.LineString"==a.geometry.CLASS_NAME?(e=a.geometry.components[Math.floor(a.geometry.components.length/2)],e=new Geo.LonLat(e.x,e.y)):e=a.geometry.getBounds().getCenterLonLat();d&&d.setCenter(e);c=new Geo.View2D.Popup.FramedCloud("featureInfo",e,null,c,null,!0,Geo.View2D.FeatureManager.onPopupClose);
a.popup=c;c.feature=a;if(this.selectControl)a.selectControl=this.selectControl;d.addPopup(c)}};Geo.View2D.FeatureManager.closeFramedCloud=function(a){var b=a.layer,c=b?b.map:null;if(a.popup&&b&&c)c.removePopup(a.popup),a.popup.destroy(),a.popup=null};Geo.View2D.FeatureManager.onPopupClose=function(){if(this.feature&&this.feature.selectControl)this.feature.selectControl.unselect(this.feature);else{var a=this.map;a&&a.removePopup(this)}};Geo.View2D.FeatureManager.showTopic=function(){};
Geo.View2D.FeatureManager.closeTopic=function(){};
Geo.View2D.MarkerTag=Geo.Class({size:null,offset:null,calculateOffset:null,div:null,px:null,initialize:function(a,b,c,d){this.html=a;a=OpenLayers.Util.getRenderedDimensions(a,null,{containerElement:this.map?this.map.layerContainerDiv:document.body});this.size=b?b:a;this.offset=c?c:new Geo.Pixel(-(this.size.w/2),-(this.size.h/2));this.calculateOffset=d;b=OpenLayers.Util.createUniqueID("OL_Div_");this.div=OpenLayers.Util.createDiv(b,null,null,null,"absolute",null,null,null)},destroy:function(){this.erase();
this.div.innerHTML="";this.div=null},clone:function(){return new Geo.View2D.MarkerTag(this.html,this.size,this.offset,this.calculateOffset)},setSize:function(a){if(a!=null)this.size=a;this.draw()},setContentHTML:function(a){if(a!=null)this.html=a;this.draw()},draw:function(a){OpenLayers.Util.modifyDOMElement(this.div,null,null,this.size,"absolute");this.div.innerHTML=this.html;this.moveTo(a);return this.div},erase:function(){this.div!=null&&this.div.parentNode!=null&&OpenLayers.Element.remove(this.div)},
setOpacity:function(a){OpenLayers.Util.modifyDOMElement(this.div,null,null,null,null,null,null,a)},moveTo:function(a){if(a!=null)this.px=a;if(this.div!=null)if(this.px==null)this.display(!1);else{if(this.calculateOffset)this.offset=this.calculateOffset(this.size);a=this.px.offset(this.offset);OpenLayers.Util.modifyDOMElement(this.div,null,a)}},display:function(a){this.div.style.display=a?"":"none"},isDrawn:function(){return this.div&&this.div.parentNode&&this.div.parentNode.nodeType!=11},CLASS_NAME:"Geo.View2D.MarkerTag"});
Geo.View2D.Control.DrawCircle=Geo.Class(Geo.View2D.Control,{type:Geo.View2D.Control.TYPE_TOOL,sides:40,persist:!1,initialize:function(a){Geo.View2D.Control.prototype.initialize.apply(this,[a]);this.handler=new OpenLayers.Handler.RegularPolygon(this,{done:this.done},{sides:this.sides,persist:this.persist})},done:function(){},CLASS_NAME:"Geo.View2D.Control.DrawCircle"});
Geo.View2D.Control.DrawPath=Geo.Class(Geo.View2D.Control,{type:Geo.View2D.Control.TYPE_TOOL,persist:!1,initialize:function(a){Geo.View2D.Control.prototype.initialize.apply(this,[a]);this.handler=new OpenLayers.Handler.Path(this,{done:this.done},{persist:this.persist})},done:function(){},CLASS_NAME:"Geo.View2D.Control.DrawPath"});
Geo.View2D.Control.DrawPoint=Geo.Class(Geo.View2D.Control,{type:Geo.View2D.Control.TYPE_TOOL,persist:!1,initialize:function(a){Geo.View2D.Control.prototype.initialize.apply(this,[a]);this.handler=new OpenLayers.Handler.Point(this,{done:this.done},{persist:this.persist})},done:function(){},CLASS_NAME:"Geo.View2D.Control.DrawPoint"});
Geo.View2D.Control.DrawPolygon=Geo.Class(Geo.View2D.Control,{type:Geo.View2D.Control.TYPE_TOOL,persist:!1,initialize:function(a){Geo.View2D.Control.prototype.initialize.apply(this,[a]);this.handler=new OpenLayers.Handler.Polygon(this,{done:this.done})},done:function(){},CLASS_NAME:"Geo.View2D.Control.DrawPolygon"});
Geo.View2D.Control.DrawRectangle=Geo.Class(Geo.View2D.Control,{type:Geo.View2D.Control.TYPE_TOOL,persist:!1,initialize:function(a){Geo.View2D.Control.prototype.initialize.apply(this,[a]);this.handler=new OpenLayers.Handler.RegularPolygon(this,{done:this.done},{irregular:!0,persist:this.persist})},done:function(){},CLASS_NAME:"Geo.View2D.Control.DrawRectangle"});
Geo.View2D.Control.MagnifyingGlass=Geo.Class(Geo.View2D.Control,{autoActivate:!0,initialize:function(){Geo.View2D.Control.prototype.initialize.apply(this,arguments)},draw:function(){Geo.View2D.Control.prototype.draw.apply(this,arguments);this.handler=new Geo.View2D.Handler.MouseWheel(this,{down:this.magnifyingglassZoomOut,up:this.magnifyingglassZoomIn});this.initDiv()},initDiv:function(){var a=OpenLayers.Util.createDiv("map_magnifyingglass"+this.id.split("_")[1]);a.style.borderRight="medium none";
a.style.borderTop="medium none";a.style.borderLeft="medium none";a.style.borderBottom="medium none";a.style.width="111px";a.style.height="74px";a.style.display="none";a.style.unselectable="on";var b=OpenLayers.Util.createDiv();b.style.lineHeight="1px";b.style.width="4px";b.style.height="4px";b.style.left="0";var c=OpenLayers.Util.createDiv();c.style.lineHeight="1px";c.style.width="4px";c.style.height="4px";c.style.right="0";var d=OpenLayers.Util.createDiv();d.style.lineHeight="1px";d.style.width=
"4px";d.style.height="4px";d.style.right="0";d.style.top="40px";var e=OpenLayers.Util.createDiv();e.style.lineHeight="1px";e.style.width="4px";e.style.height="4px";e.style.left="0";e.style.top="40px";a.appendChild(b);a.appendChild(c);a.appendChild(d);a.appendChild(e);this.map.viewPortDiv.appendChild(a)},bw_out:null,bw_in:null,variable:1,getTimeout:function(a,b,c){return window.setTimeout(function(){b.apply(a)},c)},magnifyingglassZoomOut:function(a){if(this.variable==1){var b=OpenLayers.Util.getElement("map_magnifyingglass"+
this.id.split("_")[1]);if(b)b.style.width=111,b.style.height=74,this.evt=a,this.out()}},magnifyingglassZoomIn:function(a){if(this.variable==1){var b=OpenLayers.Util.getElement("map_magnifyingglass"+this.id.split("_")[1]);if(b)b.style.width="27px",b.style.height="24px",this.evt=a,this.in_()}},out:function(){this.Rx1(!0)},in_:function(){this.Rx1(!1)},Rx1:function(a){var b=OpenLayers.Util.getElement("map_magnifyingglass"+this.id.split("_")[1]);if(this.variable<=4){if(b){var c=1,d;if(a){d=parseInt(b.style.width);
obj_h=parseInt(b.style.height);c*=15;if(d>=30){if(d&&c)b.style.width=Math.abs(d-(c+6))+"px";if(obj_h>=25&&obj_h&&c)b.style.height=Math.abs(obj_h-c)+"px";b.style.left=this.evt.xy.x-parseInt(b.style.width)/2+"px";b.style.top=this.evt.xy.y-parseInt(b.style.height)/2+"px";b.childNodes[0].style.borderWidth="0px 2px 2px 0px";b.childNodes[0].style.borderStyle="solid";b.childNodes[0].style.borderColor="red";b.childNodes[1].style.borderWidth="0px 0px 2px 2px";b.childNodes[1].style.borderStyle="solid";b.childNodes[1].style.borderColor=
"red";b.childNodes[2].style.borderWidth="2px 0px 0px 2px";b.childNodes[2].style.borderStyle="solid";b.childNodes[2].style.borderColor="red";b.childNodes[3].style.borderWidth="2px 2px 0px 0px";b.childNodes[3].style.borderStyle="solid";b.childNodes[3].style.borderColor="red";b.childNodes[2].style.top=b.style.height;b.childNodes[3].style.top=b.style.height;b.style.display="";b.style.zIndex=1010}this.variable++;this.bw_out=this.getTimeout(this,a?this.out:this.in_,60)}else{d=parseInt(b.style.width);obj_h=
parseInt(b.style.height);c*=15;if(d<=111){b.style.width=Math.abs(d+c)+"px";if(obj_h<=64)b.style.height=Math.abs(obj_h+c)+"px";b.style.left=this.evt.xy.x-parseInt(b.style.width)/2+"px";b.style.top=this.evt.xy.y-parseInt(b.style.height)/2+"px";b.childNodes[0].style.borderWidth="2px 0px 0px 2px";b.childNodes[0].style.borderStyle="solid";b.childNodes[0].style.borderColor="red";b.childNodes[1].style.borderWidth="2px 2px 0px 0px";b.childNodes[1].style.borderStyle="solid";b.childNodes[1].style.borderColor=
"red";b.childNodes[2].style.borderWidth="0px 2px 2px 0px";b.childNodes[2].style.borderStyle="solid";b.childNodes[2].style.borderColor="red";b.childNodes[3].style.borderWidth="0px 0px 2px 2px";b.childNodes[3].style.borderStyle="solid";b.childNodes[3].style.borderColor="red";b.childNodes[2].style.top=b.style.height;b.childNodes[3].style.top=b.style.height;b.style.display="";b.style.zIndex=1010}this.variable++;this.bw_in=this.getTimeout(this,a?this.out:this.in_,100)}}}else a?(window.clearTimeout(this.bw_out),
this.bw_out=null):(window.clearTimeout(this.bw_in),this.bw_in=null),this.variable=1,b.style.display="none",b.style.zIndex=0,b.style.width="111px",b.style.height="74px"},CLASS_NAME:"Geo.View2D.Control.MagnifyingGlass"});
Geo.View2D.Control.PanZoomBarTitle=Geo.Class(Geo.View2D.Control.PanZoom,{zoomStopWidth:18,zoomStopHeight:11,slider:null,sliderEvents:null,zoomBarDiv:null,divEvents:null,zoomWorldIcon:!1,leftTip:[],leftTooltips:null,imageLocation:"",initialize:function(){this.imageLocation=Geo.getScriptLocation()+"images/";OpenLayers.Control.PanZoom.prototype.initialize.apply(this,arguments)},destroy:function(){this._removeZoomBar();this.map.events.un({changebaselayer:this.redraw,scope:this});OpenLayers.Control.PanZoom.prototype.destroy.apply(this,
arguments)},setMap:function(){OpenLayers.Control.PanZoom.prototype.setMap.apply(this,arguments);this.map.events.register("changebaselayer",this,this.redraw)},redraw:function(){this.div!=null&&(this.removeButtons(),this._removeZoomBar());this.draw()},draw:function(a){OpenLayers.Control.prototype.draw.apply(this,arguments);a=this.position.clone();this.buttons=[];this.leftTip=[];var b=new OpenLayers.Size(24,24),c=new OpenLayers.Pixel(a.x+b.w/2,a.y),d=b.w;this.zoomWorldIcon&&(c=new OpenLayers.Pixel(a.x+
b.w,a.y));this._addButton("panup","panzoombar_blue/north-mini.png",c,b,"\u5411\u4e0a\u5e73\u79fb");a.y=c.y+b.h;this._addButton("panleft","panzoombar_blue/west-mini.png",a,b,"\u5411\u5de6\u5e73\u79fb");this.zoomWorldIcon&&(this._addButton("zoomworld","panzoombar_blue/zoom-world-mini.png",a.add(b.w,0),b,"\u5168\u90e8\u5730\u56fe"),d*=2);this._addButton("panright","panzoombar_blue/east-mini.png",a.add(d,0),b,"\u5411\u53f3\u5e73\u79fb");this._addButton("pandown","panzoombar_blue/south-mini.png",c.add(0,
b.h*2),b,"\u5411\u4e0b\u5e73\u79fb");this._addButton("zoomin","panzoombar_blue/zoom-plus-mini.png",c.add(0,b.h*3+5),b,"\u653e\u5927\u4e00\u7ea7");c=this._addZoomBar(c.add(3,b.h*4+5));this._addButton("zoomout","panzoombar_blue/zoom-minus-mini.png",c.add(-3,0),b,"\u7f29\u5c0f\u4e00\u7ea7");b=new OpenLayers.Size(62,12);this._addZoomToolTip("zoomtooltip","panzoombar_blue/zoom_0.png",c.add(20,0),b);this.leftTooltips={zltCountry:{url:"panzoombar_blue/zoom_Country.png",x:23,res:0.087890625},zltPro:{url:"panzoombar_blue/zoom_Province.png",
x:23,res:0.010986328125},zltCity:{url:"panzoombar_blue/zoom_City.png",x:23,res:0.001373291015625},zltStr:{url:"panzoombar_blue/zoom_Street.png",x:23,res:1.072883605957031E-5}};for(var e in this.leftTooltips)b=this.leftTooltips[e],this._addZoomLeftTip(e,b.url,c.add(-b.x,0),new OpenLayers.Size(b.x,17),b.res);return this.div},_addButton:function(a,b,c,d){b=OpenLayers.Util.createAlphaImageDiv(this.id+"_"+a,c,d,this.imageLocation+b,"absolute");b.style.cursor="pointer";this.div.appendChild(b);OpenLayers.Event.observe(b,
"mousedown",OpenLayers.Function.bindAsEventListener(this.onButtonClick,b));OpenLayers.Event.observe(b,"dblclick",OpenLayers.Function.bindAsEventListener(this.doubleClick,b));OpenLayers.Event.observe(b,"click",OpenLayers.Function.bindAsEventListener(this.doubleClick,b));b.action=a;b.map=this.map;if(this.slideRatio)var e=this.slideRatio,a=function(a){return this.map.getSize()[a]*e};else var f=this.slideFactor,a=function(){return f};b.getSlideFactor=a;this.buttons.push(b);return b},_addZoomToolTip:function(a,
b,c,d){a=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_PanZoom_"+a,c,d,this.imageLocation+b,"absolute");OpenLayers.Control.PanZoomBarTitle.isVisible=!1;this.tooltip=a;this.tooltip.style.display="none";this.div.appendChild(a);return a},_addZoomLeftTip:function(a,b,c,d,e){if(e<=this.map.baseLayer.maxResolution&&e>=this.map.baseLayer.minResolution)return a=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_PanZoom_"+a,c,d,this.imageLocation+b,"absolute"),this.tipEvents=new OpenLayers.Events(this,
a,null,!0,{includeXY:!0}),b=this.getCurrentZoomNumFromResolution(this.map.baseLayer.maxResolution,this.map.baseLayer.minResolution),c=this.map.getZoomForResolution(e),b=(b-c)*this.zoomStopHeight+this.startTop,this.tipEvents.on({click:this.tipClick,mouseover:this.slideMouseOver,mouseout:this.mouseOut}),this.leftTip.push(a),this.tooltipLeft=a,a.res=e,a.style.top=b-3+"px",a.style.display="none",a.style.cursor="hand",this.div.appendChild(a),a},tipClick:function(a){var b=this.leftTooltips[(a.srcElement?
a.srcElement:a.target).id.split("_")[3]].res,c=this.map.getZoomForResolution(b);b==0.3515625?this.map.setCenter(new OpenLayers.LonLat(104.293175,0),c):this.map.zoomTo(c);OpenLayers.Event.stop(a)},_addZoomBar:function(a){var b=this.id+"_"+this.map.id,c=this.map.getNumZoomLevels()-1-this.map.getZoom();this.slider=c=OpenLayers.Util.createAlphaImageDiv(b,a.add(-1,c*this.zoomStopHeight),new OpenLayers.Size(20,9),this.imageLocation+"panzoombar_blue/slider.png","absolute");this.sliderEvents=new OpenLayers.Events(this,
c,null,!0,{includeXY:!0});this.sliderEvents.on({mousedown:this.zoomBarDown,mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp,dblclick:this.doubleClick,click:this.doubleClick,mouseover:this.slideMouseOver,mouseout:this.mouseOut});var d=new OpenLayers.Size;d.h=this.zoomStopHeight*this.map.getNumZoomLevels();d.w=this.zoomStopWidth;b=null;OpenLayers.Util.alphaHack()?(b=this.id+"_"+this.map.id,b=OpenLayers.Util.createAlphaImageDiv(b,a,new OpenLayers.Size(d.w,this.zoomStopHeight),this.imageLocation+"panzoombar_blue/zoombar.png",
"absolute",null,"crop"),b.style.height=d.h+"px"):b=OpenLayers.Util.createDiv("OpenLayers_Control_PanZoomBar_Zoombar"+this.map.id,a,d,this.imageLocation+"panzoombar_blue/zoombar.png");this.zoombarDiv=b;this.divEvents=new OpenLayers.Events(this,b,null,!0,{includeXY:!0});this.divEvents.on({mousedown:this.divClick,mousemove:this.passEventToSlider,dblclick:this.doubleClick,click:this.doubleClick,mouseout:this.mouseOut});this.div.appendChild(b);this.startTop=parseInt(b.style.top);this.div.appendChild(c);
this.map.events.register("zoomend",this,this.moveZoomBar);return a=a.add(0,this.zoomStopHeight*this.map.getNumZoomLevels())},_removeZoomBar:function(){this.sliderEvents.un({mousedown:this.zoomBarDown,mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp,dblclick:this.doubleClick,click:this.doubleClick,mouseover:this.slideMouseOver,mouseout:this.mouseOut});this.sliderEvents.destroy();this.divEvents.un({mousedown:this.divClick,mousemove:this.passEventToSlider,dblclick:this.doubleClick,click:this.doubleClick,
mouseout:this.mouseOut});this.divEvents.destroy();for(var a=0;a<this.leftTip.length;a++)this.div.removeChild(this.leftTip[a]);this.tooltipLeft=null;this.div.removeChild(this.zoombarDiv);this.zoombarDiv=null;this.div.removeChild(this.slider);this.slider=null;this.map.events.unregister("zoomend",this,this.moveZoomBar)},slideMouseOver:function(){OpenLayers.Control.PanZoomBarTitle.isVisible=!0;this.tooltip.style.display="";for(var a=0;a<this.leftTip.length;a++)this.leftTip[a].style.display="";a=this.getCurrentZoomNum();
this.tooltip.style.top=(this.map.getNumZoomLevels()-1-this.map.getZoom())*this.zoomStopHeight+this.startTop+1-3+"px";this.tooltip.childNodes[0].src=this.imageLocation+"panzoombar_blue/zoom_"+(parseInt(a)+0)+".png"},passEventToSlider:function(a){OpenLayers.Control.PanZoomBarTitle.isVisible=!0;this.tooltip.style.display="";for(var b=0;b<this.leftTip.length;b++)this.leftTip[b].style.display="";this.map.getNumZoomLevels();this.map.getZoom();b=this.getFixZoom(a.xy.y)-10;b==-1&&(b=0);var c=this.map.pyramid.getTopTileSize().w/
this.map.pyramid.tileSize.w/Math.pow(2,this.map.pyramid.topLevelIndex),d=this.map.getResolutionForZoom(b),c=this.getCurrentZoomNumFromResolution(c,d);this.tooltip.style.top=(this.map.getNumZoomLevels()-1-b)*this.zoomStopHeight+this.startTop+1-3+"px";this.tooltip.childNodes[0].src=this.imageLocation+"panzoombar_blue/zoom_"+(parseInt(c)+0)+".png";this.sliderEvents.handleBrowserEvent(a)},getCurrentZoomNum:function(){return this.getCurrentZoomNumFromResolution(this.map.pyramid.getTopTileSize().w/this.map.pyramid.tileSize.w/
Math.pow(2,this.map.pyramid.topLevelIndex),this.map.getResolution())},getCurrentZoomNumFromResolution:function(a,b){var c=a/b;if(c<1)return 0;for(var d=0;c/2>=1;)d++,c/=2;return d},getFixZoom:function(a){for(var b=this.map.getZoom(),c=(this.map.getNumZoomLevels()-1-b)*this.zoomStopHeight+this.startTop+6;;){var d=a-c;if(d>=0){if(d<this.zoomStopHeight/2)break;b--;c+=this.zoomStopHeight}else{if(d>=-this.zoomStopHeight/2)break;b++;c-=this.zoomStopHeight}}return b},mouseOut:function(a){var b=this.tooltip;
OpenLayers.Control.PanZoomBarTitle.isVisible=!1;var c=OpenLayers.Function.bind(function(){if(!OpenLayers.Control.PanZoomBarTitle.isVisible){b.style.display="none";for(var a=0;a<this.leftTip.length;a++)this.leftTip[a].style.display="none"}},this);window.setTimeout(c,1E3);OpenLayers.Event.stop(a)},divClick:function(a){if(OpenLayers.Event.isLeftClick(a)){var b=a.xy.y,c=OpenLayers.Util.pagePosition(a.object)[1],b=(b-c)/this.zoomStopHeight;this.map.fractionalZoom||(b=Math.floor(b));b=this.map.getNumZoomLevels()-
1-b;b=Math.min(Math.max(b,0),this.map.getNumZoomLevels()-1);this.map.zoomTo(b);OpenLayers.Event.stop(a)}},zoomBarDown:function(a){if(OpenLayers.Event.isLeftClick(a))this.map.events.on({mousemove:this.passEventToSlider,mouseup:this.passEventToSlider,scope:this}),this.mouseDragStart=a.xy.clone(),this.zoomStart=a.xy.clone(),this.div.style.cursor="move",this.zoombarDiv.offsets=null,OpenLayers.Event.stop(a)},zoomBarDrag:function(a){if(this.mouseDragStart!=null){var b=this.mouseDragStart.y-a.xy.y,c=OpenLayers.Util.pagePosition(this.zoombarDiv);
if(a.clientY-c[1]>0&&a.clientY-c[1]<parseInt(this.zoombarDiv.style.height)-2)this.slider.style.top=parseInt(this.slider.style.top)-b+"px",this.mouseDragStart=a.xy.clone();OpenLayers.Event.stop(a)}},zoomBarUp:function(a){if(OpenLayers.Event.isLeftClick(a)&&this.zoomStart){this.div.style.cursor="";this.map.events.un({mouseup:this.passEventToSlider,mousemove:this.passEventToSlider,scope:this});var b=this.zoomStart.y-a.xy.y,c=this.map.zoom;this.map.fractionalZoom?(c+=b/this.zoomStopHeight,c=Math.min(Math.max(c,
0),this.map.getNumZoomLevels()-1)):c+=Math.round(b/this.zoomStopHeight);this.map.zoomTo(c);this.moveZoomBar();this.mouseDragStart=null;OpenLayers.Event.stop(a)}},moveZoomBar:function(){OpenLayers.Control.PanZoomBarTitle.isVisible=!1;this.tooltip.style.display="";var a=this.getCurrentZoomNum(),b=(this.map.getNumZoomLevels()-1-this.map.getZoom())*this.zoomStopHeight+this.startTop+1;this.tooltip.style.top=b-3+"px";this.tooltip.childNodes[0].src=this.imageLocation+"panzoombar_blue/zoom_"+(parseInt(a)+
0)+".png";this.slider.style.top=b+"px";var c=this.tooltip,a=OpenLayers.Function.bind(function(){if(!OpenLayers.Control.PanZoomBarTitle.isVisible){c.style.display="none";for(var a=0;a<this.leftTip.length;a++)this.leftTip[a].style.display="none"}},this);window.setTimeout(a,1E3)},doubleClick:function(a){OpenLayers.Event.stop(a);return!1},onButtonClick:function(){switch(this.action){case "panup":this.map.pan(0,-this.getSlideFactor("h"));break;case "pandown":this.map.pan(0,this.getSlideFactor("h"));break;
case "panleft":this.map.pan(-this.getSlideFactor("w"),0);break;case "panright":this.map.pan(this.getSlideFactor("w"),0);break;case "zoomin":this.map.zoomIn();break;case "zoomout":this.map.zoomOut();break;case "zoomworld":this.map.zoomToMaxExtent()}},CLASS_NAME:"Geo.View2D.Control.PanZoomBarTitle"});
Geo.View2D.Control.GeoOverviewMap=Geo.Class(Geo.View2D.Control.OverviewMap,{initialize:function(a){a=a||{};if(a.layers&&a.layers.length>0){for(var b=0,c=a.layers.length;b<c;b++)if(!(a.layers[b]instanceof Geo.View2D.Layer.Vector))a.layers[b]=a.layers[b].clone(),a.layers[b].isBaseLayer=!1;b=new Geo.View2D.Layer("GeoGlobeBaseLayer",{displayInLayerSwitcher:!1,isBaseLayer:!0});a.layers.push(b)}Geo.View2D.Control.OverviewMap.prototype.initialize.apply(this,[a])},draw:function(){return Geo.View2D.Control.OverviewMap.prototype.draw.apply(this,
arguments)},createMap:function(){Geo.View2D.Control.OverviewMap.prototype.createMap.apply(this,arguments);this.layers.length==1?(this.map&&this.map.layerGroup&&this._loadLayers(this.map),this.map.events.on({loadlayergroup:function(a){this._unloadLayers(a.map);this._loadLayers(a.map)},scope:this})):this.layers.length>1&&this._updateBaseLayer(this.map)},_loadLayers:function(a){this.layers=[];for(var b=a.layerGroup.layers,c=0;c<b.length;c++)b[c]instanceof Geo.View2D.Layer.Vector||this.layers.push(b[c].clone());
this.ovmap.addLayers(this.layers);this._updateBaseLayer(a)},_updateBaseLayer:function(a){var b=this.ovmap;if(a.baseLayer){for(var a=a.baseLayer.clone(),c=0,d=this.layers.length;c<d;c++)this.layers[c].baseLayer&&OpenLayers.Util.removeItem(this.layers,this.layers[c]);this.layers.push(a);b.baseLayer&&b.removeLayer(b.baseLayer);b.addLayer(a)}},_unloadLayers:function(){for(var a=this.ovmap,b=a.layers,c=[],d=0,e=b.length;d<e;d++)b[d].isBaseLayer||c.push(b[d]);d=0;for(e=c.length;d<e;d++)a.removeLayer(c[d])},
destroy:function(){this.map.events.un({loadlayergroup:this.loadLayerGroup,scope:this});Geo.View2D.Control.OverviewMap.prototype.destroy.apply(this,arguments)}});
Geo.View2D.Control.GeoPanZoom=Geo.Class(Geo.View2D.Control,{slideFactor:50,slideRatio:null,buttons:null,position:null,zoomWorldIcon:!1,initialize:function(){this.position=new OpenLayers.Pixel(Geo.View2D.Control.GeoPanZoom.X,Geo.View2D.Control.GeoPanZoom.Y);OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.removeButtons();this.position=this.buttons=null;OpenLayers.Control.prototype.destroy.apply(this,arguments)},draw:function(a){OpenLayers.Control.prototype.draw.apply(this,
arguments);a=this.position;this.buttons=[];var b=new OpenLayers.Size(18,18),c=new OpenLayers.Pixel(a.x+b.w/2,a.y);this._addButton("panup","north-mini.png",c,b);a.y=c.y+b.h;this._addButton("panleft","west-mini.png",a,b);this._addButton("panright","east-mini.png",a.add(b.w,0),b);this._addButton("pandown","south-mini.png",c.add(0,b.h*2),b);this._addButton("zoomin","zoom-plus-mini.png",c.add(0,b.h*3+5),b);var d=4;this.zoomWorldIcon&&this._addButton("zoomworld","zoom-world-mini.png",c.add(0,b.h*d++ +5),
b);this._addButton("zoomout","zoom-minus-mini.png",c.add(0,b.h*d++ +5),b);return this.div},_addButton:function(a,b,c,d){b=OpenLayers.Util.getImagesLocation()+b;c=OpenLayers.Util.createAlphaImageDiv(this.id+"_"+a,c,d,b,"absolute");c.style.cursor="pointer";this.div.appendChild(c);OpenLayers.Event.observe(c,"mousedown",OpenLayers.Function.bindAsEventListener(this.buttonDown,c));OpenLayers.Event.observe(c,"dblclick",OpenLayers.Function.bindAsEventListener(this.doubleClick,c));OpenLayers.Event.observe(c,
"click",OpenLayers.Function.bindAsEventListener(this.doubleClick,c));c.action=a;c.map=this.map;if(this.slideRatio)var e=this.slideRatio,a=function(a){return this.map.getSize()[a]*e};else var f=this.slideFactor,a=function(){return f};c.getSlideFactor=a;this.buttons.push(c);return c},_removeButton:function(a){OpenLayers.Event.stopObservingElement(a);a.map=null;a.getSlideFactor=null;this.div.removeChild(a);OpenLayers.Util.removeItem(this.buttons,a)},removeButtons:function(){for(var a=this.buttons.length-
1;a>=0;--a)this._removeButton(this.buttons[a])},doubleClick:function(a){OpenLayers.Event.stop(a);return!1},buttonDown:function(a){if(OpenLayers.Event.isLeftClick(a)){switch(this.action){case "panup":this.map.pan(0,-this.getSlideFactor("h"));break;case "pandown":this.map.pan(0,this.getSlideFactor("h"));break;case "panleft":this.map.pan(-this.getSlideFactor("w"),0);break;case "panright":this.map.pan(this.getSlideFactor("w"),0);break;case "zoomin":this.map.zoomIn();break;case "zoomout":this.map.zoomOut();
break;case "zoomworld":this.map.zoomToMaxExtent()}OpenLayers.Event.stop(a)}},CLASS_NAME:"Geo.View2D.Control.GeoPanZoom"});Geo.View2D.Control.GeoPanZoom.X=4;Geo.View2D.Control.GeoPanZoom.Y=4;
OpenLayers.Control.GeoSelectFeature=Geo.Class(Geo.View2D.Control,{EVENT_TYPES:["beforefeaturehighlighted","featurehighlighted","featureunhighlighted"],multipleKey:null,toggleKey:null,multiple:!1,clickout:!0,toggle:!1,hover:!1,highlightOnly:!1,handlerSelection:null,handlerSelOptions:null,onBeforeSelect:function(){},onSelect:function(){},onUnselect:function(){},scope:null,geometryTypes:null,layer:null,layers:null,callbacks:null,selectStyle:null,renderIntent:"select",handlers:null,initialize:function(a,
b){this.EVENT_TYPES=OpenLayers.Control.GeoSelectFeature.prototype.EVENT_TYPES.concat(OpenLayers.Control.prototype.EVENT_TYPES);OpenLayers.Control.prototype.initialize.apply(this,[b]);if(this.scope===null)this.scope=this;this.initLayer(a);var c={click:this.clickFeature,clickout:this.clickoutFeature};if(this.hover)c.over=this.overFeature,c.out=this.outFeature;this.callbacks=OpenLayers.Util.extend(c,this.callbacks);this.handlers={feature:new OpenLayers.Handler.Feature(this,this.layer,this.callbacks,
{geometryTypes:this.geometryTypes})};if(this.handlerSelection){this.handlerSelOptions=this.handlerSelOptions||{};if(this.handlerSelection==OpenLayers.Handler.Box){if(!this.handlerSelOptions.boxDivClassName)this.handlerSelOptions.boxDivClassName="olHandlerBoxSelectFeature";this.handlers.handlerSelection=new OpenLayers.Handler.Box(this,{done:this.selectBox},this.handlerSelOptions)}if(this.handlerSelection==OpenLayers.Handler.Polygon||this.handlerSelection==OpenLayers.Handler.RegularPolygon)this.handlers.handlerSelection=
new this.handlerSelection(this,{done:this.selectPolygon},this.handlerSelOptions)}},initLayer:function(a){OpenLayers.Util.isArray(a)?(this.layers=a,this.layer=new OpenLayers.Layer.Vector.RootContainer(this.id+"_container",{layers:a})):this.layer=a},destroy:function(){this.active&&this.layers&&this.map.removeLayer(this.layer);OpenLayers.Control.prototype.destroy.apply(this,arguments);this.layers&&this.layer.destroy()},activate:function(){this.active||(this.layers&&this.map.addLayer(this.layer),this.handlers.feature.activate(),
this.handlerSelection&&this.handlers.handlerSelection&&this.handlers.handlerSelection.activate());return OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){this.active&&(this.handlers.feature.deactivate(),this.handlers.handlerSelection&&this.handlers.handlerSelection.deactivate(),this.layers&&this.map.removeLayer(this.layer));return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},unselectAll:function(a){for(var b=this.layers||[this.layer],c,d,e=0;e<b.length;++e){c=
b[e];for(var f=c.selectedFeatures.length-1;f>=0;--f)d=c.selectedFeatures[f],(!a||a.except!=d)&&this.unselect(d)}},clickFeature:function(a){this.hover||(OpenLayers.Util.indexOf(a.layer.selectedFeatures,a)>-1?this.toggleSelect()?this.unselect(a):this.multipleSelect()||this.unselectAll({except:a}):(this.multipleSelect()||this.unselectAll({except:a}),this.select(a)))},multipleSelect:function(){return this.multiple||this.handlers.feature.evt&&this.handlers.feature.evt[this.multipleKey]},toggleSelect:function(){return this.toggle||
this.handlers.feature.evt&&this.handlers.feature.evt[this.toggleKey]},clickoutFeature:function(){!this.hover&&this.clickout&&this.unselectAll()},overFeature:function(a){var b=a.layer;this.hover&&(this.highlightOnly?this.highlight(a):OpenLayers.Util.indexOf(b.selectedFeatures,a)==-1&&this.select(a))},outFeature:function(a){if(this.hover)if(this.highlightOnly){if(a._lastHighlighter==this.id)if(a._prevHighlighter&&a._prevHighlighter!=this.id){delete a._lastHighlighter;var b=this.map.getControl(a._prevHighlighter);
b&&b.highlight(a)}else this.unhighlight(a)}else this.unselect(a)},highlight:function(a){var b=a.layer;if(this.events.triggerEvent("beforefeaturehighlighted",{feature:a})!==!1)a._prevHighlighter=a._lastHighlighter,a._lastHighlighter=this.id,b.drawFeature(a,this.selectStyle||this.renderIntent),this.events.triggerEvent("featurehighlighted",{feature:a})},unhighlight:function(a){var b=a.layer;if(a._prevHighlighter==void 0)delete a._lastHighlighter;else{if(a._prevHighlighter!=this.id)a._lastHighlighter=
a._prevHighlighter;delete a._prevHighlighter}b.drawFeature(a,a.style||a.layer.style||"default");this.events.triggerEvent("featureunhighlighted",{feature:a})},select:function(a){var b=this.onBeforeSelect.call(this.scope,a),c=a.layer;if(b!==!1&&(b=c.events.triggerEvent("beforefeatureselected",{feature:a}),b!==!1)){c.selectedFeatures.push(a);this.highlight(a);if(!this.handlers.feature.lastFeature)this.handlers.feature.lastFeature=c.selectedFeatures[0];c.events.triggerEvent("featureselected",{feature:a});
this.onSelect.call(this.scope,a)}},unselect:function(a){var b=a.layer;this.unhighlight(a);OpenLayers.Util.removeItem(b.selectedFeatures,a);b.events.triggerEvent("featureunselected",{feature:a});this.onUnselect.call(this.scope,a)},selectBox:function(a){if(a instanceof OpenLayers.Bounds){var b=this.map.getLonLatFromPixel(new OpenLayers.Pixel(a.left,a.bottom)),a=this.map.getLonLatFromPixel(new OpenLayers.Pixel(a.right,a.top)),b=new OpenLayers.Bounds(b.lon,b.lat,a.lon,a.lat);this.multipleSelect()||this.unselectAll();
a=this.multiple;this.multiple=!0;for(var c=this.layers||[this.layer],d,e=0;e<c.length;++e){d=c[e];for(var f=0,g=d.features.length;f<g;++f){var h=d.features[f];h.getVisibility()&&(this.geometryTypes==null||OpenLayers.Util.indexOf(this.geometryTypes,h.geometry.CLASS_NAME)>-1)&&b.toGeometry().intersects(h.geometry)&&OpenLayers.Util.indexOf(d.selectedFeatures,h)==-1&&this.select(h)}}this.multiple=a}},selectPolygon:function(a){if(a instanceof OpenLayers.Geometry){this.multipleSelect()||this.unselectAll();
var b=this.multiple;this.multiple=!0;for(var c=this.layers||[this.layer],d,e=0;e<c.length;++e){d=c[e];for(var f=0,g=d.features.length;f<g;++f){var h=d.features[f];h.getVisibility()&&(this.geometryTypes==null||OpenLayers.Util.indexOf(this.geometryTypes,h.geometry.CLASS_NAME)>-1)&&a.intersects(h.geometry)&&OpenLayers.Util.indexOf(d.selectedFeatures,h)==-1&&this.select(h)}}this.multiple=b}},setMap:function(a){this.handlers.feature.setMap(a);this.handlerSelection&&this.handlers.handlerSelection.setMap(a);
OpenLayers.Control.prototype.setMap.apply(this,arguments)},setLayer:function(a){var b=this.active;this.unselectAll();this.deactivate();if(this.layers)this.layer.destroy(),this.layers=null;this.initLayer(a);this.handlers.feature.layer=this.layer;b&&this.activate()},CLASS_NAME:"Geo.View2D.Control.GeoSelectFeature"});
Geo.View2D.Control.ZoomBar=Geo.Class(Geo.View2D.Control.PanZoom,{zoombarWidth:18,zoomStopHeight:14,slider:null,sliderEvents:null,zoombarDiv:null,divEvents:null,zoomWorldIcon:!1,panIcons:!1,forceFixedZoomLevel:!1,mouseDragStart:null,deltaY:null,zoomStart:null,imgLocation:"",zoomIcon:!1,defaultIcon:!0,zoomWidth:18,zoomHeight:18,sliderWidth:20,sliderHeight:9,zoombarWidth:18,destroy:function(){this._removeZoomBar();this.map.events.un({changebaselayer:this.redraw,scope:this});OpenLayers.Control.PanZoom.prototype.destroy.apply(this,
arguments);delete this.mouseDragStart;delete this.zoomStart},setMap:function(){OpenLayers.Control.PanZoom.prototype.setMap.apply(this,arguments);this.map.events.register("changebaselayer",this,this.redraw)},redraw:function(){this.div!=null&&(this.removeButtons(),this._removeZoomBar());this.draw()},draw:function(a){OpenLayers.Control.prototype.draw.apply(this,arguments);a=this.position.clone();this.buttons=[];var b=new OpenLayers.Size(this.zoomWidth,this.zoomHeight);if(this.zoomIcon){var c=new OpenLayers.Pixel(a.x+
b.w/2,a.y);this._addButton("zoomin","zoom-plus-mini.png",a,b);c=this._addZoomBar(a.add(0,b.h));this._addButton("zoomout","zoom-minus-mini.png",c,b)}else this._addZoomBar(a.add(0,b.h));return this.div},_addButton:function(a,b,c,d){b=OpenLayers.Util.getImagesLocation()+b;this.defaultIcon?c=OpenLayers.Util.createAlphaImageDiv(this.id+"_"+a,c,d,b,"absolute"):(c=OpenLayers.Util.createAlphaImageDiv(this.id+"_"+a,c,d,"","absolute"),c.className=a);c.style.cursor="pointer";this.div.appendChild(c);OpenLayers.Event.observe(c,
"mousedown",OpenLayers.Function.bindAsEventListener(this.buttonDown,c));OpenLayers.Event.observe(c,"dblclick",OpenLayers.Function.bindAsEventListener(this.doubleClick,c));OpenLayers.Event.observe(c,"click",OpenLayers.Function.bindAsEventListener(this.doubleClick,c));c.action=a;c.map=this.map;if(this.slideRatio)var e=this.slideRatio,a=function(a){return this.map.getSize()[a]*e};else var f=this.slideFactor,a=function(){return f};c.getSlideFactor=a;this.buttons.push(c);return c},_addZoomBar:function(a){var b=
this.imgLocation;this.imgLocation==""&&(b=OpenLayers.Util.getImagesLocation());var c=this.id+"_"+this.map.id,d=this.map.getNumZoomLevels()-1-this.map.getZoom();this.defaultIcon?d=OpenLayers.Util.createAlphaImageDiv(c,a.add(-1,d*this.zoomStopHeight),new OpenLayers.Size(20,9),b+"slider.png","absolute"):(d=OpenLayers.Util.createAlphaImageDiv(c,a.add((this.zoomWidth-this.sliderWidth)/2,d*this.zoomStopHeight),new OpenLayers.Size(this.sliderWidth,this.sliderHeight),"","absolute"),d.className="slider");
d.style.cursor="move";this.slider=d;this.sliderEvents=new OpenLayers.Events(this,d,null,!0,{includeXY:!0});this.sliderEvents.on({touchstart:this.zoomBarDown,touchmove:this.zoomBarDrag,touchend:this.zoomBarUp,mousedown:this.zoomBarDown,mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp,dblclick:this.doubleClick,click:this.doubleClick});var e=new OpenLayers.Size;e.h=this.zoomStopHeight*this.map.getNumZoomLevels();e.w=this.zoombarWidth;c=null;OpenLayers.Util.alphaHack()?(c=this.id+"_"+this.map.id,c=OpenLayers.Util.createAlphaImageDiv(c,
a,new OpenLayers.Size(e.w,this.zoomStopHeight),b+"zoombar.png","absolute",null,"crop"),c.style.height=e.h+"px"):this.defaultIcon?c=OpenLayers.Util.createDiv("OpenLayers_Control_PanZoomBar_Zoombar"+this.map.id,a,e,b+"zoombar.png"):(c=OpenLayers.Util.createDiv("OpenLayers_Control_PanZoomBar_Zoombar"+this.map.id,a,e),c.className="zoombar");c.style.cursor="pointer";this.zoombarDiv=c;this.divEvents=new OpenLayers.Events(this,c,null,!0,{includeXY:!0});this.divEvents.on({touchmove:this.passEventToSlider,
mousedown:this.divClick,mousemove:this.passEventToSlider,dblclick:this.doubleClick,click:this.doubleClick});this.div.appendChild(c);this.startTop=parseInt(c.style.top);this.div.appendChild(d);this.div.onmouseover=this._onmouseover;this.div.onmouseout=this._onmouseout;this.map.events.register("zoomend",this,this.moveZoomBar);return a=a.add(0,this.zoomStopHeight*this.map.getNumZoomLevels())},_onmouseover:function(){for(var a=0;a<this.childNodes.length;a++){var b=this.childNodes[a];if(b.className=="zoomin")b.className=
"zoomin_";if(b.className=="zoomout")b.className="zoomout_";if(b.className=="zoombar")b.className="zoombar_";if(b.className=="slider")b.className="slider_"}},_onmouseout:function(){for(var a=0;a<this.childNodes.length;a++){var b=this.childNodes[a];if(b.className=="zoomin_")b.className="zoomin";if(b.className=="zoomout_")b.className="zoomout";if(b.className=="zoombar_")b.className="zoombar";if(b.className=="slider_")b.className="slider"}},_removeZoomBar:function(){this.sliderEvents.un({touchmove:this.zoomBarDrag,
mousedown:this.zoomBarDown,mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp,dblclick:this.doubleClick,click:this.doubleClick});this.sliderEvents.destroy();this.divEvents.un({touchmove:this.passEventToSlider,mousedown:this.divClick,mousemove:this.passEventToSlider,dblclick:this.doubleClick,click:this.doubleClick});this.divEvents.destroy();this.div.removeChild(this.zoombarDiv);this.zoombarDiv=null;this.div.removeChild(this.slider);this.slider=null;this.map.events.unregister("zoomend",this,this.moveZoomBar)},
passEventToSlider:function(a){this.sliderEvents.handleBrowserEvent(a)},divClick:function(a){if(OpenLayers.Event.isLeftClick(a)){var b=a.xy.y/this.zoomStopHeight;if(this.forceFixedZoomLevel||!this.map.fractionalZoom)b=Math.floor(b);b=this.map.getNumZoomLevels()-1-b;b=Math.min(Math.max(b,0),this.map.getNumZoomLevels()-1);this.map.zoomTo(b);OpenLayers.Event.stop(a)}},zoomBarDown:function(a){if(OpenLayers.Event.isLeftClick(a)||OpenLayers.Event.isSingleTouch(a))this.map.events.on({touchmove:this.passEventToSlider,
mousemove:this.passEventToSlider,mouseup:this.passEventToSlider,scope:this}),this.mouseDragStart=a.xy.clone(),this.zoomStart=a.xy.clone(),this.div.style.cursor="move",this.zoombarDiv.offsets=null,OpenLayers.Event.stop(a)},zoomBarDrag:function(a){if(this.mouseDragStart!=null){var b=this.mouseDragStart.y-a.xy.y,c=OpenLayers.Util.pagePosition(this.zoombarDiv);if(a.clientY-c[1]>0&&a.clientY-c[1]<parseInt(this.zoombarDiv.style.height)-2)this.slider.style.top=parseInt(this.slider.style.top)-b+"px",this.mouseDragStart=
a.xy.clone();this.deltaY=this.zoomStart.y-a.xy.y;OpenLayers.Event.stop(a)}},zoomBarUp:function(a){if((OpenLayers.Event.isLeftClick(a)||a.type==="touchend")&&this.mouseDragStart){this.div.style.cursor="";this.map.events.un({touchmove:this.passEventToSlider,mouseup:this.passEventToSlider,mousemove:this.passEventToSlider,scope:this});var b=this.map.zoom;!this.forceFixedZoomLevel&&this.map.fractionalZoom?(b+=this.deltaY/this.zoomStopHeight,b=Math.min(Math.max(b,0),this.map.getNumZoomLevels()-1)):(b+=
this.deltaY/this.zoomStopHeight,b=Math.max(Math.round(b),0));this.map.zoomTo(b);this.zoomStart=this.mouseDragStart=null;this.deltaY=0;OpenLayers.Event.stop(a)}},moveZoomBar:function(){this.slider.style.top=(this.map.getNumZoomLevels()-1-this.map.getZoom())*this.zoomStopHeight+this.startTop+1+"px"},CLASS_NAME:"Geo.View2D.Control.ZoomBar"});
Geo.View2D.Control.GeoNavigationHistory=Geo.Class(Geo.View2D.Control,{type:Geo.View2D.Control.TYPE_TOGGLE,previous:null,previousOptions:null,next:null,nextOptions:null,limit:50,autoActivate:!0,clearOnDeactivate:!1,registry:null,nextStack:null,previousStack:null,listeners:null,restoring:!1,initialize:function(a,b){Geo.View2D.Control.prototype.initialize.apply(this,[a]);this.vectorLayer=b;this.registry=OpenLayers.Util.extend({moveend:this.getState,featureadded:this.getState,featureremoved:this.getState},
this.registry);var c={trigger:OpenLayers.Function.bind(this.previousTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Previous"};OpenLayers.Util.extend(c,this.previousOptions);this.previous=new Geo.View2D.Control.Button(c);c={trigger:OpenLayers.Function.bind(this.nextTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Next"};OpenLayers.Util.extend(c,this.nextOptions);this.next=new Geo.View2D.Control.Button(c);this.clear();this.format=this.format?this.format:new Geo.Format.GML;
this.jsonParser=new OpenLayers.Format.JSON;try{this.previousStack=this.readStack(window.localStorage.getItem("previousStack")),this.nextStack=this.readStack(window.localStorage.getItem("nextStack"))}catch(d){}this.initFlag=!0},onPreviousChange:function(a){a&&!this.previous.active?this.previous.activate():!a&&this.previous.active&&this.previous.deactivate()},onNextChange:function(a){a&&!this.next.active?this.next.activate():!a&&this.next.active&&this.next.deactivate()},destroy:function(){Geo.View2D.Control.prototype.destroy.apply(this);
this.previous.destroy();this.next.destroy();this.deactivate();for(var a in this)this[a]=null},setMap:function(a){this.map=a;this.next.setMap(a);this.previous.setMap(a)},draw:function(){Geo.View2D.Control.prototype.draw.apply(this,arguments);this.next.draw();this.previous.draw()},previousTrigger:function(){var a=this.previousStack.shift(),b=this.previousStack.shift();b!=void 0?(this.nextStack.unshift(a),this.previousStack.unshift(b),this.restoring=!0,this.restore(b),this.restoring=!1,this.onNextChange(this.nextStack[0],
this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)):this.previousStack.unshift(a);try{window.localStorage.setItem("previousStack",this.writeStack(this.previousStack)),window.localStorage.setItem("nextStack",this.writeStack(this.nextStack))}catch(c){}return b},nextTrigger:function(){var a=this.nextStack.shift();if(a!=void 0)this.previousStack.unshift(a),this.restoring=!0,this.restore(a),this.restoring=!1,this.onNextChange(this.nextStack[0],this.nextStack.length),
this.onPreviousChange(this.previousStack[1],this.previousStack.length-1);try{window.localStorage.setItem("previousStack",this.writeStack(this.previousStack)),window.localStorage.setItem("nextStack",this.writeStack(this.nextStack))}catch(b){}return a},clear:function(){this.previousStack=[];this.previous.deactivate();this.nextStack=[];this.next.deactivate()},getState:function(){var a=OpenLayers.Util.extend([],this.vectorLayer.features);return{center:this.map.getCenter(),resolution:this.map.getResolution(),
projection:this.map.getProjectionObject(),units:this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,features:a}},restore:function(a){var b,c;if(this.map.getProjectionObject()==a.projection)c=this.map.getZoomForResolution(a.resolution),b=a.center;else{b=a.center.clone();b.transform(a.projection,this.map.getProjectionObject());c=a.units;var d=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units;c=this.map.getZoomForResolution((c&&d?OpenLayers.INCHES_PER_UNIT[c]/
OpenLayers.INCHES_PER_UNIT[d]:1)*a.resolution)}this.map.setCenter(b,c);a=a.features;this.vectorLayer.removeFeatures(this.vectorLayer.features);a&&a.length&&this.vectorLayer.addFeatures(a)},writeStack:function(a){for(var b=[],c=0;c<a.length;c++){var d=this.format.write(a[c].features);b.push({center:a[c].center,resolution:a[c].resolution,projection:a[c].projection,units:a[c].units,features:d})}return this.preStackJsonStr=this.jsonParser.write(b)},readStack:function(a){var b=[];if(!a)return[];for(var a=
this.jsonParser.read(a),c=0;c<a.length;c++){var d={center:new OpenLayers.LonLat(a[c].center.lon,a[c].center.lat),resolution:a[c].resolution,projection:new OpenLayers.Projection(a[c].projection.projCode),units:a[c].units,features:this.format.read(a[c].features)};b.push(d)}return b},setListeners:function(){this.listeners={};for(var a in this.registry)a=="featureadded"&&this.vectorLayer?this.listeners.featureadded=OpenLayers.Function.bind(function(){if(!this.restoring){this.previousStack.unshift(this.registry.featureadded.apply(this,
arguments));if(this.previousStack.length>1)this.onPreviousChange(this.previousStack[1],this.previousStack.length-1);this.previousStack.length>this.limit+1&&this.previousStack.pop();if(this.nextStack.length>0)this.nextStack=[],this.onNextChange(null,0);try{window.localStorage.setItem("previousStack",this.writeStack(this.previousStack)),window.localStorage.setItem("nextStack",this.writeStack(this.nextStack))}catch(a){}}return!0},this):a=="featureremoved"&&this.vectorLayer?this.listeners.featureremoved=
OpenLayers.Function.bind(function(){if(!this.restoring){if(!this.registry)return!0;this.previousStack.unshift(this.registry.featureremoved.apply(this,arguments));if(this.previousStack.length>1)this.onPreviousChange(this.previousStack[1],this.previousStack.length-1);this.previousStack.length>this.limit+1&&this.previousStack.pop();if(this.nextStack.length>0)this.nextStack=[],this.onNextChange(null,0);try{window.localStorage.setItem("previousStack",this.writeStack(this.previousStack)),window.localStorage.setItem("nextStack",
this.writeStack(this.nextStack))}catch(a){}}return!0},this):a=="moveend"&&(this.listeners.moveend=OpenLayers.Function.bind(function(){if(!this.restoring){if(!window.localStorage){var a=this.registry.moveend.apply(this,arguments);this.previousStack.unshift(a);if(this.previousStack.length>1)this.onPreviousChange(this.previousStack[1],this.previousStack.length-1);this.previousStack.length>this.limit+1&&this.previousStack.pop();if(this.nextStack.length>0)this.nextStack=[],this.onNextChange(null,0)}if(window.localStorage){if(this.initFlag&&
this.previousStack.length>0&&(a=this.previousStack[0],a!=void 0))this.restoring=!0,this.restore(a),this.restoring=!1;this.initFlag||(a=this.registry.moveend.apply(this,arguments),this.previousStack.unshift(a));if(this.previousStack.length>1)this.onPreviousChange(this.previousStack[1],this.previousStack.length-1);this.previousStack.length>this.limit+1&&this.previousStack.pop();if(this.nextStack.length>0&&!this.initFlag)this.nextStack=[],this.onNextChange(null,0);else if(this.initFlag)this.onNextChange(this.nextStack[0],
this.nextStack.length),this.initFlag=!1;try{window.localStorage.setItem("previousStack",this.writeStack(this.previousStack)),window.localStorage.setItem("nextStack",this.writeStack(this.nextStack))}catch(c){}}}return!0},this))},activate:function(){var a=!1;if(this.map&&Geo.View2D.Control.prototype.activate.apply(this)){this.listeners==null&&this.setListeners();for(var b in this.listeners)b=="featureadded"&&this.vectorLayer&&this.vectorLayer.events.register(b,this,this.listeners[b]),b=="featureremoved"&&
this.vectorLayer?this.vectorLayer.events.register(b,this,this.listeners[b]):this.map.events.register(b,this,this.listeners[b]);a=!0;this.previousStack.length==0&&this.initStack()}return a},initStack:function(){this.map.getCenter()&&this.listeners.moveend()},deactivate:function(){var a=!1;if(this.map&&Geo.View2D.Control.prototype.deactivate.apply(this)){for(var b in this.listeners)this.map.events.unregister(b,this,this.listeners[b]);this.clearOnDeactivate&&this.clear();a=!0}return a},clearRecordStack:function(){window.localStorage.removeItem("previousStack");
window.localStorage.removeItem("nextStack")},CLASS_NAME:"Geo.View2D.Control.GeoNavigationHistory"});
Geo.View2D.Control.Measure.AreaMeasure=Geo.Class(OpenLayers.Control.Measure,{result:null,currentPopups:null,persist:!1,initialize:function(a){var b=OpenLayers.Class(OpenLayers.Handler.Polygon,{moveTitleDiv:null,deactivate:function(){if(!OpenLayers.Handler.prototype.deactivate.apply(this,arguments))return!1;this.control.destoryAllResult();if(this.moveTitleDiv)this.moveTitleDiv.style.display="none";this.lastUp&&this.cancel();this.destroyFeature();this.layer.map!=null&&this.layer.destroy(!1);this.layer=
null;return!0},finalize:function(a){OpenLayers.Handler.Path.prototype.finalize.apply(this,arguments);this.layer&&(a||!this.persist)&&this.control.destoryAllResult()},mousemove:function(a){var b=OpenLayers.Handler.Path.prototype.mousemove.apply(this,arguments);this.moveTitleDiv?this.moveTitleDiv.style.display="":(this.moveTitleDiv=document.createElement("div"),this.map.viewPortDiv.appendChild(this.moveTitleDiv));var e="",e=this.lastUp?"\u5355\u51fb\u786e\u5b9a\u8d77\u70b9\uff0c\u53cc\u51fb\u7ed3\u675f\u91cf\u7b97":
"\u5355\u51fb\u786e\u5b9a\u8d77\u70b9";this.moveTitleDiv.innerHTML=e;this.moveTitleDiv.style.position="absolute";this.moveTitleDiv.style.zIndex=this.control.div.style.zIndex;this.moveTitleDiv.style.left=a.xy.x+15+"px";this.moveTitleDiv.style.top=a.xy.y+15+"px";return b},up:function(){var a=OpenLayers.Handler.Path.prototype.up.apply(this,arguments);this.persist&&this.control.destoryResult(this.control.result.length-1);return a}});this.result=[];this.currentPopups=[];OpenLayers.Control.Measure.prototype.initialize.apply(this,
[b,a]);this.events.on({measure:this.handleMeasurementsEnd,measurepartial:this.handleMeasurements})},measurePartial:function(){OpenLayers.Control.Measure.prototype.measurePartial.apply(this,arguments)},addNodePopup:function(a,b){var c=new OpenLayers.Popup("chicken",a,null,"<span class='rightBg'>"+b+"<span>",!1);c.autoSize=!0;c.setBackgroundColor("transparent");this.map.addPopup(c);this.currentPopups.push(c)},destoryResult:function(a){var b=this.result[a];if(b){a=b.feature;b=b.popups;typeof a=="string"&&
(a=this.handler.layer.getFeatureById(a));this.handler.layer.destroyFeatures([a]);for(a=0;a<b.length;a++)this.map.removePopup(b[a])}},destoryAllResult:function(){for(var a=0;a<this.result.length;a++)this.destoryResult(a);this.result=[]},handleMeasurements:function(a){var b=a.measure;a.order==1?b.toFixed(3):b.toFixed(3)},handleMeasurementsEnd:function(a){var b=a.geometry,c=a.units,d=a.measure;if(d){var e="";e+=a.order==1?d.toFixed(3)+" "+c:d.toFixed(3)+" "+c+"<sup>2</sup>";a=b.getCentroid();c=this.handler.polygon;
this.addNodePopup(new OpenLayers.LonLat(a.x+this.map.getResolution()*10,a.y-this.map.getResolution()*10),"\u603b\u9762\u79ef\uff1a"+e+"<a id = '"+b.id+"_a' class='result_close' href='#' style=''> X</a>");var f=this.result.length;document.getElementById(b.id+"_a").onclick=OpenLayers.Function.bind(function(){this.destoryResult(f)},this);this.result.push({feature:c,popups:this.currentPopups});this.currentPopups=[]}}});
Geo.View2D.Control.Measure.DistanceMeasure=Geo.Class(Geo.View2D.Control.Measure,{result:null,currentPopups:null,persist:!1,initialize:function(a){var b=OpenLayers.Class(OpenLayers.Handler.Path,{points:null,moveTitleDiv:null,deactivate:function(){if(!OpenLayers.Handler.prototype.deactivate.apply(this,arguments))return!1;this.control.destoryAllResult();this.control.removerNodePopups();if(this.moveTitleDiv)this.moveTitleDiv.style.display="none";this.lastUp&&this.cancel();this.destroyFeature();this.layer.map!=
null&&this.layer.destroy(!1);this.layer=null;return!0},finalize:function(a){OpenLayers.Handler.Path.prototype.finalize.apply(this,arguments);this.layer&&(a||!this.persist)&&this.control.destoryAllResult()},mousemove:function(a){var b=OpenLayers.Handler.Path.prototype.mousemove.apply(this,arguments);this.moveTitleDiv?this.moveTitleDiv.style.display="":(this.moveTitleDiv=document.createElement("div"),this.map.viewPortDiv.appendChild(this.moveTitleDiv));var e="",e=this.lastUp?"\u5355\u51fb\u786e\u5b9a\u4e2d\u95f4\u70b9\uff0c\u53cc\u51fb\u7ed3\u675f\u91cf\u7b97":
"\u5355\u51fb\u786e\u5b9a\u8d77\u70b9";this.moveTitleDiv.innerHTML=e;this.moveTitleDiv.style.position="absolute";this.moveTitleDiv.style.zIndex=this.control.div.style.zIndex;this.moveTitleDiv.style.left=a.xy.x+15+"px";this.moveTitleDiv.style.top=a.xy.y+15+"px";return b},up:function(){var a=OpenLayers.Handler.Path.prototype.up.apply(this,arguments);this.persist&&this.control.destoryResult(this.control.result.length-1);return a}});this.result=[];this.currentPopups=[];OpenLayers.Control.Measure.prototype.initialize.apply(this,
[b,a]);this.events.on({measure:this.handleMeasurementsEnd,measurepartial:this.handleMeasurements})},measurePartial:function(a,b){b.getLength()==0&&this.addNodePopup(new OpenLayers.LonLat(a.x+this.map.getResolution()*10,a.y-this.map.getResolution()*10),"\u8d77\u70b9");OpenLayers.Control.Measure.prototype.measurePartial.apply(this,arguments)},addNodePopup:function(a,b){var c=new OpenLayers.Popup("chicken",a,null,"<span class='rightBg'>"+b+"<span>",!1);c.autoSize=!0;c.setBackgroundColor("transparent");
this.map.addPopup(c);this.currentPopups.push(c)},removerNodePopups:function(){for(var a=this.currentPopups,b=0;b<a.length;b++)this.map.removePopup(a[b])},destoryResult:function(a){var b=this.result[a];if(b){a=b.feature;b=b.popups;typeof a=="string"&&(a=this.handler.layer.getFeatureById(a));this.handler.layer.destroyFeatures([a]);for(a=0;a<b.length;a++)this.map.removePopup(b[a])}},destoryAllResult:function(){for(var a=0;a<this.result.length;a++)this.destoryResult(a);this.result=[]},handleMeasurements:function(a){var b=
a.geometry,c=a.units,d=a.measure;if(d!=0){var e="";e+=a.order==1?d.toFixed(3)+" "+c:d.toFixed(3)+" "+c+"<sup>2</sup>";a=b.components[b.components.length-1];this.addNodePopup(new OpenLayers.LonLat(a.x+this.map.getResolution()*5,a.y-this.map.getResolution()*5),e)}},handleMeasurementsEnd:function(a){var b=a.geometry,c=a.units,d=a.measure,e="";e+=a.order==1?d.toFixed(3)+" "+c:d.toFixed(3)+" "+c+"<sup>2</sup>";a=b.components[b.components.length-1];c=this.handler.line;this.addNodePopup(new OpenLayers.LonLat(a.x+
this.map.getResolution()*10,a.y-this.map.getResolution()*10),"\u603b\u957f\uff1a"+e+"<a id = '"+b.id+"_a' class='result_close' href='#' style=''> X</a>");var f=this.result.length;document.getElementById(b.id+"_a").onclick=OpenLayers.Function.bind(function(){this.destoryResult(f)},this);this.result.push({feature:c,popups:this.currentPopups});this.currentPopups=[]}});
Geo.View2D.Control.Measure.Angle=Geo.Class(Geo.View2D.Control.Measure,{initialize:function(a){Geo.View2D.Control.Measure.prototype.initialize.apply(this,[Geo.View2D.Handler.Path,a])},measure:function(a,b){var c,d;a.CLASS_NAME.indexOf("LineString")>-1&&(c=this.getAngle(a),d=3);this.events.triggerEvent(b,{measure:c[0],units:c[1],angles:c[2],order:d,geometry:a})},getAngle:function(a){for(var b=0,c=[],d=[],e=a.components.length,e=a.components[e-1].x==a.components[e-2].x&&a.components[e-1].y==a.components[e-
2].y?e-1:e,f=0;f<e;f++)if(f){var g=a.components[f-1].x,h=a.components[f-1].y,l=a.components[f].x,m=a.components[f].y,o=(m-h)/(l-g),j="";m>h&&l>g&&(j=1);m>h&&l<g&&(j=2);m<h&&l<g&&(j=3);m<h&&l>g&&(j=4);d.push({k:o,quadrant:j});if(f>1){b=d[f-2].k;g=d[f-1].k;b=Math.atan((g-b)/(1+g*b))/(2*Math.PI/360);g=d[f-2].quadrant;h=d[f-1].quadrant;switch(h-g<0?h-g+4:h-g){case 0:b=b>0?180-b:180+b;break;case 1:b=b>0?180-b:Math.abs(b);break;case 2:b=Math.abs(b);break;case 3:b=b>0?b:180+b}c.push(b)}}return[b,"\u00b0",
c]}});
Geo.View2D.Control.Measure.AngleMeasure=Geo.Class(Geo.View2D.Control.Measure.Angle,{result:null,currentPopups:null,persist:!1,initialize:function(a){var b=OpenLayers.Class(OpenLayers.Handler.Path,{points:null,moveTitleDiv:null,deactivate:function(){if(!OpenLayers.Handler.prototype.deactivate.apply(this,arguments))return!1;this.control.destoryAllResult();this.control.removerNodePopups();if(this.moveTitleDiv)this.moveTitleDiv.style.display="none";this.lastUp&&this.cancel();this.destroyFeature();this.layer.map!=
null&&this.layer.destroy(!1);this.layer=null;return!0},finalize:function(a){OpenLayers.Handler.Path.prototype.finalize.apply(this,arguments);this.layer&&(a||!this.persist)&&this.control.destoryAllResult()},mousemove:function(a){var b=OpenLayers.Handler.Path.prototype.mousemove.apply(this,arguments);this.moveTitleDiv?this.moveTitleDiv.style.display="":(this.moveTitleDiv=document.createElement("div"),this.map.viewPortDiv.appendChild(this.moveTitleDiv));var e="",e=this.lastUp?"\u5355\u51fb\u786e\u5b9a\u4e2d\u95f4\u70b9\uff0c\u53cc\u51fb\u7ed3\u675f\u91cf\u7b97":
"\u5355\u51fb\u786e\u5b9a\u8d77\u70b9";this.moveTitleDiv.innerHTML=e;this.moveTitleDiv.style.position="absolute";this.moveTitleDiv.style.zIndex=this.control.div.style.zIndex;this.moveTitleDiv.style.left=a.xy.x+15+"px";this.moveTitleDiv.style.top=a.xy.y+15+"px";return b},up:function(){var a=OpenLayers.Handler.Path.prototype.up.apply(this,arguments);this.persist&&this.control.destoryResult(this.control.result.length-1);return a}});this.result=[];this.currentPopups=[];OpenLayers.Control.Measure.prototype.initialize.apply(this,
[b,a]);this.events.on({measure:this.handleMeasurementsEnd,measurepartial:this.handleMeasurements})},measurePartial:function(a,b){b.getLength()==0&&this.addNodePopup(new OpenLayers.LonLat(a.x+this.map.getResolution()*10,a.y-this.map.getResolution()*10),"\u8d77\u70b9");OpenLayers.Control.Measure.prototype.measurePartial.apply(this,arguments)},addNodePopup:function(a,b){var c=new OpenLayers.Popup("chicken",a,null,"<span class='rightBg'>"+b+"<span>",!1);c.autoSize=!0;c.setBackgroundColor("transparent");
this.map.addPopup(c);this.currentPopups.push(c)},removerNodePopups:function(){for(var a=this.currentPopups,b=0;b<a.length;b++)this.map.removePopup(a[b])},destoryResult:function(a){var b=this.result[a];if(b){a=b.feature;b=b.popups;typeof a=="string"&&(a=this.handler.layer.getFeatureById(a));this.handler.layer.destroyFeatures([a]);for(a=0;a<b.length;a++)this.map.removePopup(b[a])}},destoryAllResult:function(){for(var a=0;a<this.result.length;a++)this.destoryResult(a);this.result=[]},handleMeasurements:function(a){var b=
a.geometry,c=a.units,d=a.order,e=a.measure;e!=0&&(a="",d==1?a+=e.toFixed(3)+" "+c:d==2?a+=e.toFixed(3)+" "+c+"<sup>2</sup>":d==3&&(a+=e.toFixed(3)+" "+c),b=b.components[b.components.length-3],this.addNodePopup(new OpenLayers.LonLat(b.x+this.map.getResolution()*5,b.y-this.map.getResolution()*5),a))},handleMeasurementsEnd:function(a){var b=a.geometry,c=a.units,d=a.order,e=a.measure,a="";d==1?a+=e.toFixed(3)+" "+c:d==2?a+=e.toFixed(3)+" "+c+"<sup>2</sup>":d==3&&(a+=e.toFixed(3)+" "+c);c=b.components[b.components.length-
2];d=this.handler.line;this.addNodePopup(new OpenLayers.LonLat(c.x+this.map.getResolution()*10,c.y-this.map.getResolution()*10),""+a+"<a id = '"+b.id+"_a' class='result_close' href='#' style=''> X</a>");var f=this.result.length;document.getElementById(b.id+"_a").onclick=OpenLayers.Function.bind(function(){this.destoryResult(f)},this);this.result.push({feature:d,popups:this.currentPopups});this.currentPopups=[]}});
Geo.View2D.Control.MapContextMenu=Geo.Class(Geo.View2D.Control,{autoActivate:!0,menuDiv:null,contentHTML:null,lastRightClickXY:null,lastRightClickLonLat:null,handlerOptions:null,handleRightClicks:!0,initialize:function(){Geo.View2D.Control.prototype.initialize.apply(this,arguments);this.handlerOptions=OpenLayers.Util.extend({},this.handlerOptions);this.handler=new Geo.View2D.Handler.Click(this,{rightclick:this.showContextMenu,click:this.leftClick},this.handlerOptions);this.handler.mousedown=function(){this.control.hide();
return Geo.View2D.Handler.Click.prototype.mousedown.apply(this,arguments)}},setMap:function(a){Geo.View2D.Control.prototype.setMap.apply(this,[a])},destroy:function(){this.deactivate();Geo.View2D.Control.prototype.destroy.apply(this,arguments)},activate:function(){return Geo.View2D.Control.prototype.activate.apply(this,arguments)?(this.map.viewPortDiv.oncontextmenu=OpenLayers.Function.False,!0):!1},deactivate:function(){return Geo.View2D.Control.prototype.deactivate.apply(this,arguments)?(this.hide(),
this.map.viewPortDiv.oncontextmenu=OpenLayers.Function.True,!0):!1},draw:function(){Geo.View2D.Control.prototype.draw.apply(this,arguments);var a=this.div;a.style.position="absolute";a.style.background="white";a.style.border="1px solid #adbfe4";a.style.zIndex=this.map.Z_INDEX_BASE.Control+this.map.controls.length;a.innerHTML=this.contentHTML?this.contentHTML:"";this.menuDiv=a;this.menuDiv.onmousedown=OpenLayers.Function.bind(function(a){OpenLayers.Event.stop(a||event)},this);this.hide();this.map.viewPortDiv.appendChild(this.menuDiv);
return this.div},leftClick:function(){},showContextMenu:function(a){this.lastRightClickXY=a.xy;this.lastRightClickLonLat=this.map.getLonLatFromPixel(a.xy);var b=this.menuDiv;b.style.left=a.xy.x+"px";b.style.top=a.xy.y+"px";this.show()},show:function(){if(this.menuDiv&&this.menuDiv.style.display=="none")this.menuDiv.style.display=""},hide:function(){if(this.menuDiv&&this.menuDiv.style.display!="none")this.menuDiv.style.display="none"},setContentHTML:function(a){if(a!=null)this.contentHTML=a;if(this.menuDiv!=
null&&this.contentHTML!=null&&this.contentHTML!=this.menuDiv.innerHTML)this.menuDiv.innerHTML=this.contentHTML},addItem:function(a){var b=document.createElement("div");b.style.cssText="padding-bottom: 2px; line-height: 17px; margin: 0px 2px; padding-left: 6px; width:"+a.width+"px; padding-right: 6px; color: #000; font-size: 12px; cursor: pointer; padding-top: 2px;";b.innerHTML="<span>"+a.text+"</span>";b.onclick=OpenLayers.Function.bind(function(){a.callback();this.hide()},this);b.onmouseover=function(){b.style.color=
"#6688cc"};b.onmouseout=function(){b.style.color="#000"};this.menuDiv.appendChild(b);this.setContentHTML(this.menuDiv.innerHTML)},addSeparator:function(){var a=document.createElement("div");a.style.cssText="border-bottom:#adbfe4 1px solid;margin:0px 6px;font-size:0px;padding:1px";this.menuDiv.appendChild(a);this.setContentHTML(this.menuDiv.innerHTML)},CLASS_NAME:"Geo.View2D.Control.MapContextMenu"});
Geo.View2D.Control.TimeSlider=Geo.Class(Geo.View2D.Control,{mouseDragStart:null,tmpNewWidthPX:null,progressBarPX:null,markNum:100,currentMark:0,timerId:null,interval:1E3,onSliderBarMove:function(){},markInfo:null,initialize:function(){OpenLayers.Control.prototype.initialize.apply(this,arguments)},setMap:function(){Geo.View2D.Control.prototype.setMap.apply(this,arguments)},draw:function(){var a=document.getElementById("timeSliderDiv");a.innerHTML=Geo.View2D.Control.TimeSlider.timeSliderDivHTML;this.timeSliderDiv=
a;this.sliderMoveableInfoDIV=document.getElementById("sliderMoveableInfo");var a=document.getElementById("remainingBar"),b=document.getElementById("progressBar"),c=document.getElementById("sliderFocusNode");this.remainingBar=a;this.progressBar=b;this.sliderBar=c;this.sliderEvents=new OpenLayers.Events(this,c,null,!0,{includeXY:!0});this.documentEvents=new OpenLayers.Events(this,document,null,!0,{includeXY:!0});this.sliderEvents.on({mousedown:this.sliderBarDown,mousemove:this.sliderBarDrag,mouseup:this.sliderBarUp});
this.setProgressBarWidth();a=document.getElementById("playButton");b=document.getElementById("prevButton");c=document.getElementById("nextButton");this.playButton=a;this.prevButton=b;this.nextButton=c;this.playButton.onclick=OpenLayers.Function.bind(function(){this.timerId==null?this.play():this.pause()},this);this.prevButton.onclick=OpenLayers.Function.bind(function(){this.timerId==null&&this.previous()},this);this.nextButton.onclick=OpenLayers.Function.bind(function(){this.timerId==null&&this.next()},
this);this._setRuleMarksHTML();this.sliderBar.onmouseover=OpenLayers.Function.bind(function(){this.sliderBar.className="sliderImage sliderImageHover"},this);this.sliderBar.onmouseout=OpenLayers.Function.bind(function(){if(this.mouseDragStart==null)this.sliderBar.className="sliderImage"},this);this.sliderBarContainerTable=document.getElementById("sliderBarContainerTableID");this.sliderBarContainerTable.onmouseover=OpenLayers.Function.bind(function(){this.sliderBarContainerTable.className="timeSliderTable sliderBarContainerTable sliderHover"},
this);this.sliderBarContainerTable.onmouseout=OpenLayers.Function.bind(function(){if(this.mouseDragStart==null)this.sliderBarContainerTable.className="timeSliderTable sliderBarContainerTable"},this);this.sliderBarContainerTr=document.getElementById("sliderBarContainerTrID");this.sliderBarContainerTr.onclick=OpenLayers.Function.bind(this.onCilckSliderBarContainerTr,this);this.sliderBarContainerTr.onmousemove=OpenLayers.Function.bind(this.onMousemoveSliderBarContainerTr,this)},onMousemoveSliderBarContainerTr:function(a){var b=
a||event,a=b.target||b.srcElement;if(a.id!="sliderFocusNode"&&(b=b.offsetX!=void 0?b.offsetX:b.layerX,b<0&&(b=0),a.className!="")){a.className=="sliderBarContainerPanelLeft"&&(b=0);if(a.className=="sliderBarContainerPanelRight")b=this.remainingBar.clientWidth;a=Math.floor(b/this.remainingBar.clientWidth*this.markNum);if(this.markInfo)this.sliderBarContainerTr.title=this.markInfo[a]}},onCilckSliderBarContainerTr:function(a){var b=a||event,a=b.target||b.srcElement;if(a.id!="sliderFocusNode"&&(b=b.offsetX!=
void 0?b.offsetX:b.layerX,b<0&&(b=0),a.className!="")){a.className=="sliderBarContainerPanelLeft"&&(b=0);if(a.className=="sliderBarContainerPanelRight")b=this.remainingBar.clientWidth;this.currentMark=Math.floor(b/this.remainingBar.clientWidth*this.markNum);this.progressBar.style.width=this.currentMark/this.markNum*100+"%";this.tmpNewWidthPX=this.progressBar.clientWidth;this.progressBarPX=null;this.onSliderBarMove();this.setSliderBarTitle()}},sliderBarDown:function(a){if(OpenLayers.Event.isLeftClick(a)||
OpenLayers.Event.isSingleTouch(a)){this.map.events.on({touchmove:this.passEventToSlider,mousemove:this.passEventToSlider,mouseup:this.passEventToSlider,scope:this});this.documentEvents.on({touchmove:this.passEventToSlider,mousemove:this.passEventToSlider,mouseup:this.passEventToSlider,scope:this});var b=0,c=a.offsetX!=void 0?a.offsetX:a.layerX;c>=0&&c<=18&&(b=c-this.sliderBar.clientWidth/2);this.mouseDragStart=a.clientX-b;OpenLayers.Event.stop(a)}},sliderBarDrag:function(a){if(this.mouseDragStart!=
null){var b=a.clientX-this.mouseDragStart;this.tmpNewWidthPX!=null?this.tmpNewWidthPX+=b:this.tmpNewWidthPX=this.progressBar.clientWidth+b;if(!(this.tmpNewWidthPX>=0&&this.tmpNewWidthPX<=this.remainingBar.clientWidth))if(this.tmpNewWidthPX<0)this.tmpNewWidthPX=0;else if(this.tmpNewWidthPX>this.remainingBar.clientWidth)this.tmpNewWidthPX=this.remainingBar.clientWidth;this.currentMark=Math.floor(this.tmpNewWidthPX/this.remainingBar.clientWidth*this.markNum);b=this.currentMark/this.markNum*100;if(this.tmpNewWidthPX>
0&&this.tmpNewWidthPX<this.remainingBar.clientWidth)this.progressBarPX=this.tmpNewWidthPX,this.progressBar.style.width=b+"%",this.mouseDragStart=a.clientX;else if(this.tmpNewWidthPX==0)this.progressBarPX!=null&&(this.mouseDragStart-=this.progressBarPX),this.progressBarPX=0,this.progressBar.style.width="0%";else if(this.tmpNewWidthPX==this.remainingBar.clientWidth){if(this.progressBarPX!=null)this.mouseDragStart=this.mouseDragStart-this.progressBarPX+this.remainingBar.clientWidth;this.progressBarPX=
this.remainingBar.clientWidth;this.progressBar.style.width="100%"}this.setSliderBarTitle()}},sliderBarUp:function(a){if(OpenLayers.Event.isLeftClick(a)||a.type==="touchend"){if((a.target||a.srcElement).id!="sliderFocusNode")this.sliderBar.className="sliderImage",this.sliderBarContainerTable.className="timeSliderTable sliderBarContainerTable";if(this.mouseDragStart)this.map.events.un({touchmove:this.passEventToSlider,mouseup:this.passEventToSlider,mousemove:this.passEventToSlider,scope:this}),this.documentEvents.un({touchmove:this.passEventToSlider,
mouseup:this.passEventToSlider,mousemove:this.passEventToSlider,scope:this}),this.mouseDragStart=null,OpenLayers.Event.stop(a);this.onSliderBarMove()}},passEventToSlider:function(a){this.sliderEvents.handleBrowserEvent(a)},play:function(){if(!(this.interval<=0))this.timerId&&clearInterval(this.timerId),this.playButton.children[0].className="sliderButtonNodeIcon pauseButton sliderInline",this.prevButton.className="sliderButtonNode sliderInline sliderButtonDisabled",this.nextButton.className="sliderButtonNode sliderInline sliderButtonDisabled",
this.timerId=window.setInterval(OpenLayers.Function.bind(function(){this.currentMark>=this.markNum?this.pause():this.setProgressBarWidth(1)},this),this.interval)},pause:function(){clearInterval(this.timerId);this.timerId=null;this.playButton.children[0].className="sliderButtonNodeIcon playButton sliderInline";this.prevButton.className="sliderButtonNode sliderInline";this.nextButton.className="sliderButtonNode sliderInline"},previous:function(){this.setProgressBarWidth(-1)},next:function(){this.setProgressBarWidth(1)},
setCurrentMark:function(a){this.currentMark=a;this.setProgressBarWidth()},setProgressBarWidth:function(a){a||(a=0);var b=this.currentMark+a;if(!(b>this.markNum||b<0))this.currentMark+=a,this.progressBar.style.width=this.currentMark/this.markNum*100+"%",this.tmpNewWidthPX=this.progressBar.clientWidth,this.onSliderBarMove(),this.setSliderBarTitle()},_setRuleMarksHTML:function(){var a="";this.textArr=[];for(var b=0;b<=this.markNum;b+=1){var c=b/this.markNum*100,d="";this.markInfo&&(d=this.markInfo[b]);
a+='<div class="ruleMark" style="left:'+c+'%" title="'+d+'"></div>'}document.getElementById("ruleContainer").innerHTML=a},setSliderBarTitle:function(){if(this.markInfo){this.sliderMoveableInfoDIV.innerHTML=this.markInfo[this.currentMark];var a=this.sliderMoveableInfoDIV.innerHTML.length;this.sliderMoveableInfoDIV.style.width=a*9+"px";this.sliderMoveableInfoDIV.style.left=-(a*9/2-6)+"px";this.sliderMoveableInfoDIV.style.display="block"}else this.sliderMoveableInfoDIV.style.display="none"},setMarkInfo:function(a){this.markInfo=
a},_removeSliderEvents:function(){this.sliderEvents.un({mousedown:this.sliderBarDown,mousemove:this.sliderBarDrag,mouseup:this.sliderBarUp});this.sliderEvents.destroy()},destroy:function(){this._removeSliderEvents();OpenLayers.Control.prototype.destroy.apply(this,arguments);delete this.mouseDragStart},CLASS_NAME:"Geo.View2D.Control.TimeSlider"});Geo.View2D.Control.TimeSlider.timeSliderDivHTML='<table width="100%" class="timeSliderTable" style="margin-left:5px;"><tbody><tr><td align="right"><div id="buttonLeftPanel"><span class="sliderButtonNode sliderInline" id="playButton"><span class="sliderButtonNodeIcon playButton sliderInline"></span></span></div></td><\!-- \u523b\u5ea6\u6761\u5bb9\u5668\u9762\u677f--\><td width="80%" align="center"><table class="timeSliderTable sliderBarContainerTable" id="sliderBarContainerTableID" ><tbody><tr id="sliderBarContainerTrID"><\!-- \u523b\u5ea6\u6761\u5bb9\u5668\u5de6\u4fa7\u5c01\u95ed--\><td><div class="sliderBarContainerPanelLeft"></div></td><td width="100%"><div id="sliderBarContainerPanel"><\!-- \u523b\u5ea6\u6761\u5bb9\u5668--\><div id="sliderBarContainer"><\!-- \u5df2\u64ad\u653e\u7684\u8fdb\u7a0b\u6761 --\><div id="progressBar" class="sliderBarC"><\!-- \u9690\u85cf\u7684 --\><div id="sliderMoveable"><\!-- \u663e\u793a\u5f53\u524d\u65f6\u95f4\u4fe1\u606f\u7684DIV --\><div id="sliderMoveableInfo"></div><\!-- \u6307\u9488 --\><div class="sliderImage" id="sliderFocusNode"></div></div></div><div id="remainingBar" class="sliderBarC"></div></div></div></td><td><div class="sliderBarContainerPanelRight"></div></td></tr><tr><td></td><td width="100%"><div id="ruleContainer"><div class="ruleMark" style="left:0%"></div></div></td><td></td></tr></tbody></table></td><td width=30><span class="sliderButtonNode sliderInline" id="prevButton"><span class="sliderButtonNodeIcon prevButton sliderInline"></span></span></td><td align="left"><div id="buttonRightPanel"><span class="sliderButtonNode sliderInline" id="nextButton"><span class="sliderButtonNodeIcon nextButton sliderInline"></span></span></div></td></tr></tbody></table>';
Geo.View2D.Control.PrintMap=Geo.Class(Geo.View2D.Control,{titleName:"\u5730\u56fe\u6253\u5370",headerName:"\u5730\u56fe",containerWidth:"1024",containerHeight:"768",printImgSrc:"",initialize:function(){OpenLayers.Control.prototype.initialize.apply(this,arguments)},setMap:function(){Geo.View2D.Control.prototype.setMap.apply(this,arguments)},createPrintMap:function(a){var b=map.getSize();if(this.containerWidth>b.w)alert("\u6253\u5370\u5730\u56fe\u5bb9\u5668\u5bbd\u5ea6\u8d85\u8fc7\u4e86\u5730\u56fe\u7684\u5bbd\u5ea6\uff0c\u8bf7\u91cd\u65b0\u8bbe\u7f6e\u6253\u5370\u5730\u56fe\u5bb9\u5668\u5bbd\u5ea6\u3002");
else if(this.containerHeight>b.h)alert("\u6253\u5370\u5730\u56fe\u5bb9\u5668\u9ad8\u5ea6\u8d85\u8fc7\u4e86\u5730\u56fe\u7684\u9ad8\u5ea6\uff0c\u8bf7\u91cd\u65b0\u8bbe\u7f6e\u6253\u5370\u5730\u56fe\u5bb9\u5668\u9ad8\u5ea6\u3002");else{var b=window.open(""),c=document.getElementById(a).innerHTML,d="<!DOCTYPE html><html><head><META HTTP-EQUIV='pragma' CONTENT='no-cache'><META HTTP-EQUIV='Cache-Control' CONTENT='no-cache, must-revalidate'><META HTTP-EQUIV='expires' CONTENT='Wed, 26 Feb 1997 08:21:57 GMT'><meta http-equiv='Content-Type' content='text/html; charset=utf-8' /><meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' /><meta name='apple-mobile-web-app-capable' content='yes' /><title>"+
this.titleName+"</title>",e=parseInt(this.containerHeight)-10,f="",g="";f+='<style type="text/css">';f+=".olImageLoadError{background-color: pink; opacity: 0!important; filter: alpha(opacity=0)!important;}";f=f+".print-container {margin: auto;width:"+this.containerWidth+"px;height:"+this.containerHeight+"px;top: 50px;position: relative;}";f+=".geoD {width: 100%;height: 24px;line-height: 24px;border-bottom: 3px solid #B2B2B2;font-size: 14px;margin-bottom: 6px;}";f=f+"#"+a+"{position: relative;height:"+
e+"px;margin-bottom: 15px;clear: both;}";f+='#geoft {content: ".";height: 77px;display: block;overflow: hidden;clear: both;}';f+=".printMap {margin-bottom: 20px;float: right;}";this.printImgSrc!=void 0&&this.printImgSrc!=""?(f=f+".printMap span {background-position: 0px 0px;cursor: pointer;margin-right: 0px;margin-top: 5px;display: inline-block;width: 69px;height: 29px;background-image: url("+this.printImgSrc+");}",g="<span id='printMap' onclick = 'printDiv()'></span>"):g="<input id='printMap' type='button' value='\u6253\u5370' onclick = 'printDiv()'></input>";
f+="</style>";a="</head><body><div class='print-container'><div class='geoD'><h3>"+this.headerName+"</h3></div><div id='"+a+"' >"+c+"</div><div id='geoft'><div class='printMap'>";a+=g;a+="</div></div></div></body></html>";b.document.write(d+f+"<script type = 'text/javascript'>\nfunction printDiv(){var divObj = document.getElementById('printMap');divObj.style.display = 'none';window.print();divObj.style.display = 'block';}<\/script>"+a);b.document.close()}},destroy:function(){OpenLayers.Control.prototype.destroy.apply(this,
arguments)},CLASS_NAME:"Geo.View2D.Control.PrintMap"});Geo.View2D.MenuItem=Geo.Class({text:null,callback:null,width:100,initialize:function(a){OpenLayers.Util.extend(this,a)},setText:function(a){this.text=a},CLASS_NAME:"Geo.View2D.MenuItem"});
Geo.View2D.TemporalRenderer=Geo.Class({classId:"EVENTID",hash:{},_queue:null,isStop:null,frequence:1E3,trackStyle:null,sourceProjection:null,destProjection:null,latestStyle:null,dateTimes:[],currentTime:null,ispause:null,initialize:function(a){this.id=OpenLayers.Util.createUniqueID("Geo.TemporalRenderer_");OpenLayers.Util.extend(this,a);this._queue={}},setFeatures:function(a){if(Geo.Util.isArray(a))for(var b=0;b<a.length;b++){var c=a[b].attributes[this.classId];Geo.Util.isArray(this.hash[c])||(this.hash[c]=
[]);this.hash[c].push(a[b].clone());this.setDateTimes(a[b].attributes.Date_Time);this.setCurrentTime(this.dateTimes[0]);this.dateTimes=this.getUniqueArray(this.dateTimes)}this.cacheFeatures(this.hash)},getDateTimes:function(){return this.dateTimes},sortNumber:function(a,b){return a-b},getUniqueArray:function(a){var a=a||[],b={};len=a.length;for(var c=0;c<len;c++){var d=a[c];typeof b[d]=="undefined"&&(b[d]=1)}a.length=0;for(c in b)a[a.length]=c;return a},setDateTimes:function(a){this.dateTimes.push(a);
this.dateTimes.sort(this.sortNumber)},setDateTime:function(){},cacheFeatures:function(a){for(var b in a){var c=a[b];this._queue[b]=this._getQueueItem();this.recordFeatures(c,this._queue[b])}},setMap:function(a){if(a&&!this.map)this.map=a,this.vectorLayer=new OpenLayers.Layer.Vector,a.addLayer(this.vectorLayer)},locateTime:function(a){var b=this.hash;this.vectorLayer.removeAllFeatures();for(var c in b){var d=this._queue[c],e=d.dateTimes;if(!(a<e[0]))for(var f=0;f<e.length-1;f++)a>=e[f]&&a<e[f+1]?this.vectorLayer.addFeatures(d.record[e[f]]):
a>=e[e.length-1]&&this.vectorLayer.addFeatures(d.record[e[e.length-1]])}},fallback:function(){if(this.counter>0)this.currentTime=this.dateTimes[this.counter-1],this.locateTime(this.currentTime)},goAlong:function(){if(this.counter<this.dateTimes.length-1)this.currentTime=this.dateTimes[this.counter+1],this.locateTime(this.currentTime)},pause:function(){var a=this.hash,b;for(b in a)window.clearInterval(this._queue[b].interval);window.clearInterval(this.interval)},recordFeatures:function(a,b){for(var c=
0;c<a.length-1;c++){if(c===0){var d=OpenLayers.Util.extend({pointRadius:3},OpenLayers.Feature.Vector.style["default"]);d.pointRadius=4;a[c].style=d;b.record[a[c].attributes.Date_Time]=[a[c]]}else{for(var e=[],f=[],g=0;g<=c;g++)e.push(a[g].geometry.clone()),d=OpenLayers.Util.extend({pointRadius:2},OpenLayers.Feature.Vector.style["default"]),d.pointRadius=4,a[g].style=d,f.push(a[g]);d=new Geo.Feature.Vector(new Geo.Geometry.LineString(e));b.record[a[c].attributes.Date_Time]=f.concat(d)}b.dateTimes.push(a[c].attributes.Date_Time)}},
setCurrentTime:function(a){this.currentTime=a},getCurrentTime:function(){return this.currentTime},drawFeatures:function(a){var b=this.hash,c;for(c in b){a=this._queue[c];this.currentTime=this.getCurrentTime();for(var d=0;d<a.dateTimes.length-1;d++)this.currentTime>=a.dateTimes[d]&&this.currentTime<a.dateTimes[d+1]?this.vectorLayer.addFeatures(a.record[a.dateTimes[d]]):this.currentTime>=a.dateTimes[a.dateTimes.length-1]&&(this.vectorLayer.addFeatures(a.record[a.dateTimes[a.dateTimes.length-1]]),window.clearInterval(a.interval))}},
_getQueueItem:function(){return{counter:0,isStop:!1,record:{},dateTimes:[],interval:null,options:{}}},counter:0,stop:function(){this.isStop=!0;var a=this.hash,b;for(b in a)window.clearInterval(this._queue[b].interval);window.clearInterval(this.interval);this.currentTime=this.dateTimes[0];this.counter=0},start:function(){this.isStop===!0&&this.vectorLayer.removeAllFeatures();this.isStop=!1;Geo.Function.bind(function(){var a=Geo.Function.bind(function(){this.drawFeatures()},this);this._queue.interval=
window.setInterval(a,this.frequence)},this)()},CLASS_NAME:"Geo.View2D.TemporalRenderer"});Geo.View2D.TemporalRenderer.HashStyle=Geo.Class({data:[],initialize:function(){this.id=OpenLayers.Util.createUniqueID("Geo.TemporalRenderer.HashStyle_")},put:function(a,b){this.data[a]=b},get:function(a){return this.data[a]},remove:function(a){this.data[a]=null},isEmpty:function(){return this.data.length==0},size:function(){return this.data.length},CLASS_NAME:"Geo.View2D.TemporalRenderer.HashStyle"});
Geo.View2D.Layer.DynamicMapService=Geo.Class(Geo.View2D.Layer.Grid,{DEFAULT_PARAMS:{format:"png"},isBaseLayer:!0,layers:null,timeExtent:null,layerDefs:null,initialize:function(a,b,c,d){var e=b.indexOf("/",b.length-1);b+=e!=-1?"export":"/export";e=[];c=OpenLayers.Util.upperCaseObject(c);e.push(a,b,c,d);OpenLayers.Layer.Grid.prototype.initialize.apply(this,e);OpenLayers.Util.applyDefaults(this.params,OpenLayers.Util.upperCaseObject(this.DEFAULT_PARAMS));if(this.params.TRANSPARENT&&this.params.TRANSPARENT.toString().toLowerCase()==
"true"){if(d==null||!d.isBaseLayer)this.isBaseLayer=!1;if(this.params.FORMAT=="jpg")this.params.FORMAT=OpenLayers.Util.alphaHack()?"gif":"png"}if(this.params.TIMEEXTENT&&this.params.TIMEEXTENT.startTime instanceof Date&&this.params.TIMEEXTENT.endTime instanceof Date)a=Date.parse(this.params.TIMEEXTENT.startTime),b=Date.parse(this.params.TIMEEXTENT.endTime),this.params.TIME=a+","+b,delete this.params.TIMEEXTENT},destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments)},clone:function(a){a==
null&&(a=new Geo.View2D.Layer.DynamicMapService(this.name,this.url,this.params,this.getOptions()));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){var a=this.adjustBounds(a),b=this.projection.getCode().split(":"),b=b[b.length-1],c=this.getImageSize(),a={BBOX:a.toBBOX(),SIZE:c.w+","+c.h,F:"image",BBOXSR:b,IMAGESR:b};if(this.layerDefs){var b=[],d;for(d in this.layerDefs)this.layerDefs.hasOwnProperty(d)&&this.layerDefs[d]&&(b.push(d),b.push(":"),b.push(this.layerDefs[d]),
b.push(";"));b.length>0&&(a.LAYERDEFS=b.join(""))}return this.getFullRequestString(a)},setLayerFilter:function(a,b){if(!this.layerDefs)this.layerDefs={};b?this.layerDefs[a]=b:delete this.layerDefs[a]},clearLayerFilter:function(a){a?delete this.layerDefs[a]:delete this.layerDefs},mergeNewParams:function(a){a=[OpenLayers.Util.upperCaseObject(a)];return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,a)},CLASS_NAME:"Geo.View2D.Layer.DynamicMapService"});
Geo.View2D.Layer.TileMapService=Geo.Class(Geo.View2D.Layer.XYZ,{url:null,tileOrigin:null,tileSize:new Geo.Size(256,256),useArcGISServer:!0,type:"png",initialize:function(){Geo.View2D.Layer.XYZ.prototype.initialize.apply(this,arguments);if(this.resolutions)this.serverResolutions=this.resolutions;if(this.layerInfo){var a=this.layerInfo,b=new Geo.Bounds(a.fullExtent.xmin,a.fullExtent.ymin,a.fullExtent.xmax,a.fullExtent.ymax);this.projection="EPSG:"+a.spatialReference.wkid;this.sphericalMercator=a.spatialReference.wkid==
102100;this.units=a.units=="esriFeet"?"ft":"m";if(a.tileInfo){this.tileSize=new Geo.Size(a.tileInfo.width||a.tileInfo.cols,a.tileInfo.height||a.tileInfo.rows);this.tileOrigin=new Geo.LonLat(a.tileInfo.origin.x,a.tileInfo.origin.y);var c=new Geo.Geometry.Point(b.left,b.top),b=new Geo.Geometry.Point(b.right,b.bottom);this.useScales?this.scales=[]:this.resolutions=[];this.lods=[];for(var d in a.tileInfo.lods)if(a.tileInfo.lods.hasOwnProperty(d)){var e=a.tileInfo.lods[d];this.useScales?this.scales.push(e.scale):
this.resolutions.push(e.resolution);var f=this.getContainingTileCoords(c,e.resolution);e.startTileCol=f.x;e.startTileRow=f.y;f=this.getContainingTileCoords(b,e.resolution);e.endTileCol=f.x;e.endTileRow=f.y;this.lods.push(e)}this.maxExtent=this.calculateMaxExtentWithLOD(this.lods[0]);this.serverResolutions=this.resolutions;if(this.overrideDPI&&a.tileInfo.dpi)OpenLayers.DOTS_PER_INCH=a.tileInfo.dpi}}},getContainingTileCoords:function(a,b){return new Geo.Pixel(Math.max(Math.floor((a.x-this.tileOrigin.lon)/
(this.tileSize.w*b)),0),Math.max(Math.floor((this.tileOrigin.lat-a.y)/(this.tileSize.h*b)),0))},calculateMaxExtentWithLOD:function(a){var b=this.tileOrigin.lon+a.startTileCol*this.tileSize.w*a.resolution,c=this.tileOrigin.lat-a.startTileRow*this.tileSize.h*a.resolution;return new Geo.Bounds(b,c-(a.endTileRow-a.startTileRow+1)*this.tileSize.h*a.resolution,b+(a.endTileCol-a.startTileCol+1)*this.tileSize.w*a.resolution,c)},calculateMaxExtentWithExtent:function(a,b){var c=new Geo.Geometry.Point(a.left,
a.top),d=new Geo.Geometry.Point(a.right,a.bottom),c=this.getContainingTileCoords(c,b),d=this.getContainingTileCoords(d,b);return this.calculateMaxExtentWithLOD({resolution:b,startTileCol:c.x,startTileRow:c.y,endTileCol:d.x,endTileRow:d.y})},getUpperLeftTileCoord:function(a){return this.getContainingTileCoords(new Geo.Geometry.Point(this.maxExtent.left,this.maxExtent.top),a)},getLowerRightTileCoord:function(a){return this.getContainingTileCoords(new Geo.Geometry.Point(this.maxExtent.right,this.maxExtent.bottom),
a)},getMaxExtentForResolution:function(a){var b=this.getUpperLeftTileCoord(a),c=this.getLowerRightTileCoord(a),d=this.tileOrigin.lon+b.x*this.tileSize.w*a,e=this.tileOrigin.lat-b.y*this.tileSize.h*a;return new Geo.Bounds(d,e-(c.y-b.y+1)*this.tileSize.h*a,d+(c.x-b.x+1)*this.tileSize.w*a,e)},clone:function(a){a==null&&(a=new Geo.View2D.Layer.TileMapService(this.name,this.url,this.options));return Geo.View2D.Layer.XYZ.prototype.clone.apply(this,[a])},getURL:function(a){var a=this.adjustBounds(a),b=this.map.getResolution(),
c=Math.round((a.left-this.tileOrigin.lon)/(b*this.tileSize.w)),a=Math.round((this.tileOrigin.lat-a.top)/(b*this.tileSize.h)),b=this.map.getZoom()+this.zoomOffset,d=Math.pow(2,b);this.wrapDateLine&&(c=(c%d+d)%d);var d=this.url,e=d.indexOf("/",d.length-1);d+=e!=-1?"tile/${z}/${y}/${x}":"/tile/${z}/${y}/${x}";return d=OpenLayers.String.format(d,{x:c,y:a,z:b})},zeroPad:function(a,b,c){for(a=a.toString(c||10);a.length<b;)a="0"+a;return a},CLASS_NAME:"Geo.View2D.Layer.TileMapService"});
Geo.View2D.Layer.GeoMarkers=Geo.Class(Geo.View2D.Layer.Markers,{drawMarker:function(a){var b=this.map.getLayerPxFromLonLat(a.lonlat);b==null?a.display(!1):(a.isDrawn()?a.icon&&a.icon.moveTo(b):this.div.appendChild(a.draw(b)),a.isDrawnTag()?a.tag&&a.tag.moveTo(b):(a=a.drawTag(b))&&this.div.appendChild(a))},CLASS_NAME:"Geo.View2D.Layer.GeoMarkers"});
Geo.View2D.ChartContainer=Geo.Class({events:null,id:"",lonlat:null,div:null,contentSize:null,size:null,contentHTML:null,backgroundColor:"",opacity:"",border:"",contentDiv:null,groupDiv:null,closeDiv:null,autoSize:!1,minSize:null,maxSize:null,displayClass:"olPopup",contentDisplayClass:"olPopupContent",padding:0,disableFirefoxOverflowHack:!1,fixPadding:function(){if(typeof this.padding=="number")this.padding=new OpenLayers.Bounds(this.padding,this.padding,this.padding,this.padding)},panMapIfOutOfView:!1,
keepInMap:!1,closeOnMove:!1,offset:null,map:null,initialize:function(a,b,c,d,e,f){a==null&&(a=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"));this.id=a;this.lonlat=b;this.contentSize=c!=null?c:new OpenLayers.Size(Geo.View2D.ChartContainer.WIDTH,Geo.View2D.ChartContainer.HEIGHT);if(d!=null)this.contentHTML=d;this.backgroundColor=Geo.View2D.ChartContainer.COLOR;this.opacity=Geo.View2D.ChartContainer.OPACITY;this.border=Geo.View2D.ChartContainer.BORDER;this.div=OpenLayers.Util.createDiv(this.id,
null,null,null,null,null,"hidden");this.div.className=this.displayClass;this.groupDiv=OpenLayers.Util.createDiv(this.id+"_GroupDiv",null,null,null,"relative",null,"hidden");a=this.div.id+"_contentDiv";this.contentDiv=OpenLayers.Util.createDiv(a,null,this.contentSize.clone(),null,"relative");this.contentDiv.className=this.contentDisplayClass;this.groupDiv.appendChild(this.contentDiv);this.div.appendChild(this.groupDiv);e&&this.addCloseBox(f);this.registerEvents()},destroy:function(){this.border=this.opacity=
this.backgroundColor=this.contentHTML=this.size=this.lonlat=this.id=null;this.closeOnMove&&this.map&&this.map.events.unregister("movestart",this,this.hide);this.events.destroy();this.events=null;this.closeDiv&&(OpenLayers.Event.stopObservingElement(this.closeDiv),this.groupDiv.removeChild(this.closeDiv));this.closeDiv=null;this.div.removeChild(this.groupDiv);this.groupDiv=null;this.map!=null&&this.map.removePopup(this);this.panMapIfOutOfView=this.padding=this.maxSize=this.minSize=this.autoSize=this.div=
this.map=null},draw:function(a){a==null&&this.lonlat!=null&&this.map!=null&&(a=this.map.getLayerPxFromLonLat(this.lonlat));this.closeOnMove&&this.map.events.register("movestart",this,this.hide);!this.disableFirefoxOverflowHack&&OpenLayers.BROWSER_NAME=="firefox"&&(this.map.events.register("movestart",this,function(){var a=document.defaultView.getComputedStyle(this.contentDiv,null).getPropertyValue("overflow");if(a!="hidden")this.contentDiv._oldOverflow=a,this.contentDiv.style.overflow="hidden"}),
this.map.events.register("moveend",this,function(){var a=this.contentDiv._oldOverflow;if(a)this.contentDiv.style.overflow=a,this.contentDiv._oldOverflow=null}));this.moveTo(a);!this.autoSize&&!this.size&&this.setSize(this.contentSize);this.setBackgroundColor();this.setOpacity();this.setBorder();this.setContentHTML();this.panMapIfOutOfView&&this.panIntoView();return this.div},updatePosition:function(){if(this.lonlat&&this.map){var a=this.map.getLayerPxFromLonLat(this.lonlat);a&&this.moveTo(a)}},moveTo:function(a){if(a!=
null&&this.div!=null)a=a.offset(this.offset),this.div.style.left=a.x+"px",this.div.style.top=a.y+"px"},visible:function(){return OpenLayers.Element.visible(this.div)},toggle:function(){this.visible()?this.hide():this.show()},show:function(){this.div.style.display="";this.panMapIfOutOfView&&this.panIntoView()},hide:function(){this.div.style.display="none"},setSize:function(a){this.size=a.clone();var b=this.getContentDivPadding(),c=b.left+b.right,d=b.top+b.bottom;this.fixPadding();c+=this.padding.left+
this.padding.right;d+=this.padding.top+this.padding.bottom;if(this.closeDiv){var e=parseInt(this.closeDiv.style.width);c+=e+b.right}this.size.w+=c;this.size.h+=d;OpenLayers.BROWSER_NAME=="msie"&&(this.contentSize.w+=b.left+b.right,this.contentSize.h+=b.bottom+b.top);if(this.div!=null)this.div.style.width=this.size.w+"px",this.div.style.height=this.size.h+"px";if(this.contentDiv!=null)this.contentDiv.style.width=a.w+"px",this.contentDiv.style.height=a.h+"px"},updateSize:function(){var a="<div class='"+
this.contentDisplayClass+"'>"+this.contentDiv.innerHTML+"</div>",b=this.map?this.map.layerContainerDiv:document.body,c=OpenLayers.Util.getRenderedDimensions(a,null,{displayClass:this.displayClass,containerElement:b}),d=this.getSafeContentSize(c),e=null;d.equals(c)?e=c:(e=new OpenLayers.Size,e.w=d.w<c.w?d.w:null,e.h=d.h<c.h?d.h:null,e.w&&e.h?e=d:(a=OpenLayers.Util.getRenderedDimensions(a,e,{displayClass:this.contentDisplayClass,containerElement:b}),OpenLayers.Element.getStyle(this.contentDiv,"overflow")!=
"hidden"&&a.equals(d)&&(d=OpenLayers.Util.getScrollbarWidth(),e.w?a.h+=d:a.w+=d),e=this.getSafeContentSize(a)));this.setSize(e)},setBackgroundColor:function(a){if(a!=void 0)this.backgroundColor=a;if(this.div!=null)this.div.style.backgroundColor=this.backgroundColor},setOpacity:function(a){if(a!=void 0)this.opacity=a;if(this.div!=null)this.div.style.opacity=this.opacity},setBorder:function(a){if(a!=void 0)this.border=a;if(this.div!=null)this.div.style.border=this.border},setContentHTML:function(a){if(a!=
null)this.contentHTML=a;if(this.contentDiv!=null&&this.contentHTML!=null&&this.contentHTML!=this.contentDiv.innerHTML)this.contentDiv.innerHTML=this.contentHTML,this.autoSize&&(this.registerImageListeners(),this.updateSize())},registerImageListeners:function(){for(var a=function(){this.popup.updateSize();this.popup.visible()&&this.popup.panMapIfOutOfView&&this.popup.panIntoView();OpenLayers.Event.stopObserving(this.img,"load",this.img._onImageLoad)},b=this.contentDiv.getElementsByTagName("img"),c=
0,d=b.length;c<d;c++){var e=b[c];if(e.width==0||e.height==0)e._onImgLoad=OpenLayers.Function.bind(a,{popup:this,img:e}),OpenLayers.Event.observe(e,"load",e._onImgLoad)}},getSafeContentSize:function(a){var a=a.clone(),b=this.getContentDivPadding(),c=b.left+b.right,d=b.top+b.bottom;this.fixPadding();c+=this.padding.left+this.padding.right;d+=this.padding.top+this.padding.bottom;if(this.closeDiv){var e=parseInt(this.closeDiv.style.width);c+=e+b.right}if(this.minSize)a.w=Math.max(a.w,this.minSize.w-c),
a.h=Math.max(a.h,this.minSize.h-d);if(this.maxSize)a.w=Math.min(a.w,this.maxSize.w-c),a.h=Math.min(a.h,this.maxSize.h-d);if(this.map&&this.map.size){e=b=0;if(this.keepInMap&&!this.panMapIfOutOfView)switch(e=this.map.getPixelFromLonLat(this.lonlat),this.relativePosition){case "tr":b=e.x;e=this.map.size.h-e.y;break;case "tl":b=this.map.size.w-e.x;e=this.map.size.h-e.y;break;case "bl":b=this.map.size.w-e.x;e=e.y;break;case "br":b=e.x;e=e.y;break;default:b=e.x,e=this.map.size.h-e.y}d=this.map.size.h-
this.map.paddingForPopups.top-this.map.paddingForPopups.bottom-d-e;a.w=Math.min(a.w,this.map.size.w-this.map.paddingForPopups.left-this.map.paddingForPopups.right-c-b);a.h=Math.min(a.h,d)}return a},getContentDivPadding:function(){var a=this._contentDivPadding;if(!a){if(this.div.parentNode==null)this.div.style.display="none",document.body.appendChild(this.div);this._contentDivPadding=a=new OpenLayers.Bounds(OpenLayers.Element.getStyle(this.contentDiv,"padding-left"),OpenLayers.Element.getStyle(this.contentDiv,
"padding-bottom"),OpenLayers.Element.getStyle(this.contentDiv,"padding-right"),OpenLayers.Element.getStyle(this.contentDiv,"padding-top"));if(this.div.parentNode==document.body)document.body.removeChild(this.div),this.div.style.display=""}return a},addCloseBox:function(a){this.closeDiv=OpenLayers.Util.createDiv(this.id+"_close",null,new OpenLayers.Size(17,17));this.closeDiv.className="olPopupCloseBox";var b=this.getContentDivPadding();this.closeDiv.style.right=b.right+"px";this.closeDiv.style.top=
b.top+"px";this.groupDiv.appendChild(this.closeDiv);a=a||function(a){this.hide();OpenLayers.Event.stop(a)};OpenLayers.Event.observe(this.closeDiv,"touchend",OpenLayers.Function.bindAsEventListener(a,this));OpenLayers.Event.observe(this.closeDiv,"click",OpenLayers.Function.bindAsEventListener(a,this))},panIntoView:function(){var a=this.map.getSize(),b=this.map.getViewPortPxFromLayerPx(new OpenLayers.Pixel(parseInt(this.div.style.left),parseInt(this.div.style.top))),c=b.clone();if(b.x<this.map.paddingForPopups.left)c.x=
this.map.paddingForPopups.left;else if(b.x+this.size.w>a.w-this.map.paddingForPopups.right)c.x=a.w-this.map.paddingForPopups.right-this.size.w;if(b.y<this.map.paddingForPopups.top)c.y=this.map.paddingForPopups.top;else if(b.y+this.size.h>a.h-this.map.paddingForPopups.bottom)c.y=a.h-this.map.paddingForPopups.bottom-this.size.h;this.map.pan(b.x-c.x,b.y-c.y)},registerEvents:function(){this.events=new OpenLayers.Events(this,this.div,null,!0);this.events.on({mousedown:this.onmousedown,mousemove:this.onmousemove,
mouseup:this.onmouseup,click:this.onclick,mouseout:this.onmouseout,dblclick:this.ondblclick,touchstart:function(a){OpenLayers.Event.stop(a,!0)},scope:this})},onmousedown:function(a){this.mousedown=!0;OpenLayers.Event.stop(a,!0)},onmousemove:function(a){this.mousedown&&OpenLayers.Event.stop(a,!0)},onmouseup:function(a){if(this.mousedown)this.mousedown=!1,OpenLayers.Event.stop(a,!0)},onclick:function(a){OpenLayers.Event.stop(a,!0)},onmouseout:function(){this.mousedown=!1},ondblclick:function(a){OpenLayers.Event.stop(a,
!0)},CLASS_NAME:"OpenLayers.Popup"});Geo.View2D.ChartContainer.WIDTH=200;Geo.View2D.ChartContainer.HEIGHT=200;Geo.View2D.ChartContainer.COLOR="white";Geo.View2D.ChartContainer.OPACITY=1;Geo.View2D.ChartContainer.BORDER="0px";
Geo.View2D.Popup.GeoFrameCloud=Geo.Class(Geo.View2D.Popup.FramedCloud,{shadowSrc:null,isShowShadow:!0,shadowOffset:null,minSize:new Geo.Size(120,10),borderStyle:1,initialize:function(a,b,c,d,e,f,g,h,l){if(h&&typeof h.isShowShadow==="boolean")this.isShowShadow=h.isShowShadow===!1?h.isShowShadow:!0;if(h&&h.shadowOffset instanceof OpenLayers.Pixel)this.shadowOffset=h.shadowOffset;if(typeof h.clickShadow==="function")this.clickShadow=h.clickShadow;if(typeof h.moveoverShadow==="function")this.moveoverShadow=
h.moveoverShadow;this.fixedRelativePosition=!0;this.relativePosition="tr";this.shadowSrc=OpenLayers.Util.getImagesLocation()+"shadow.png";this.borderStyle=l?l:Geo.View2D.Popup.GeoFrameCloud.CORNER;switch(this.borderStyle){case Geo.View2D.Popup.GeoFrameCloud.CORNER:this.imageSrc=OpenLayers.Util.getImageLocation("cloud-popup-relative.png");break;case Geo.View2D.Popup.GeoFrameCloud.SHARP:this.imageSrc=OpenLayers.Util.getImageLocation("cloud-popup-relative-2.png");break;case Geo.View2D.Popup.GeoFrameCloud.VERTICALDIRECTION:this.imageSrc=
OpenLayers.Util.getImageLocation("cloud-popup-relative-3.png")}OpenLayers.Popup.Framed.prototype.initialize.apply(this,arguments);this.contentDiv.className=this.contentDisplayClass;this.div.style.overflow="visible"},createShadow:function(){this.lonlat!=null&&this.map!=null&&(px=this.map.getLayerPxFromLonLat(this.lonlat));this.shadowDiv=OpenLayers.Util.createDiv(this.id+"_shadomDiv_",null,null,null,"absolute",null,"visible",null);this.shadowDiv.style.position="absolute";this.shadowDiv.style.zIndex=
0;this.calculateShadowDivLocation(this.size,this.shadowDiv);this.map.layerContainerDiv.appendChild(this.shadowDiv);this.shadowevents=new OpenLayers.Events(this,this.shadowDiv,null,!0);this.shadowevents.on({click:this.clickShadow,mousemove:this.moveoverShadow,scope:this});this.map.events.register("zoomend",this,this.calculateShadowLocation)},calculateShadowDivLocation:function(a,b){var c=this.id+"_leftTop_shadowdiv_",d=new OpenLayers.Pixel(0,0);this.divSize=new OpenLayers.Size;this.divSize.h=a.h*0.5-
30;this.divSize.w=a.w;var c=OpenLayers.Util.createDiv(c,d,this.divSize,null,"absolute",null,"hidden",null),e=this.id+"_leftTop_shadomImg_",f=new OpenLayers.Pixel(-(0+(320-this.divSize.h-24)),0),d=new OpenLayers.Size(1062,356),e=OpenLayers.Util.createImage(e,f,d,this.shadowSrc,"absolute",null,null,null);c.appendChild(e);b.appendChild(c);this.setrightTopshadowdiv(this.divSize,d,b);this.setleftBottomShadowDiv(this.divSize,d,b);this.setleftBottom23shadowdiv(this.divSize,d,b);this.setrightBottomshadowdiv(this.divSize,
d,b)},setrightTopshadowdiv:function(a,b,c){var d=this.id+"_rightTop_shadowdiv_",e=new OpenLayers.Pixel(a.w,0),f=new OpenLayers.Size;f.h=a.h;f.w=a.h+20+11;d=OpenLayers.Util.createDiv(d,e,f,null,"absolute",null,"hidden",null);a=new OpenLayers.Pixel(-(1062-a.h-20-24-25),1);b=OpenLayers.Util.createImage(this.id+"_rightTop_shadomImg_",a,b,this.shadowSrc,"absolute",null,null,null);d.appendChild(b);c.appendChild(d)},calculateShadowLocation:function(){var a=this.divleftBottomSize,b=this.shadowDiv,c=this.divSize.h+
a.h,d=this.map.getLayerPxFromLonLat(this.lonlat);this.shadowOffset instanceof OpenLayers.Pixel?(b.style.top=d.y-c-10+this.shadowOffset.y+"px",b.style.left=d.x-a.w-5+this.shadowOffset.x+"px"):(b.style.top=d.y-c-10+"px",b.style.left=d.x-a.w-5+"px");this.setShadowzIndex(b)},recalculateShadowLocation:function(a,b,c){var a=this.divSize.h+b.h,d=this.map.getLayerPxFromLonLat(this.lonlat);this.shadowOffset instanceof OpenLayers.Pixel?(c.style.top=d.y-a-10+this.shadowOffset.y+"px",c.style.left=d.x-b.w-5+this.shadowOffset.x+
"px"):(c.style.top=d.y-a-10+"px",c.style.left=d.x-b.w-5+"px");this.setShadowzIndex(c)},setShadowzIndex:function(a){a.style.zIndex=this.map.Z_INDEX_BASE.Popup+this.map.popups.length},setrightBottomshadowdiv:function(a,b,c){var d=this.id+"_rightBottom_shadowdiv_",a=new OpenLayers.Pixel(a.w,a.h),e=new OpenLayers.Size;e.h=40;e.w=45;d=OpenLayers.Util.createDiv(d,a,e,null,"absolute",null,"hidden",null);a=new OpenLayers.Pixel(-703,-290);b=OpenLayers.Util.createImage(this.id+"_rightBottom_shadomImg_",a,b,
this.shadowSrc,"absolute",null,null,null);d.appendChild(b);c.appendChild(d)},setleftBottom23shadowdiv:function(a,b,c){var d=this.id+"_leftBottom2_shadowdiv_",e=new OpenLayers.Pixel(35,a.h),f=new OpenLayers.Size;f.h=70;f.w=70;d=OpenLayers.Util.createDiv(d,e,f,null,"absolute",null,"hidden",null);e=new OpenLayers.Pixel(-440,-290);e=OpenLayers.Util.createImage(this.id+"_leftBottom2_shadomImg_",e,b,this.shadowSrc,"absolute",null,null,null);d.appendChild(e);c.appendChild(d);var d=this.id+"_leftBottom3_shadowdiv_",
e=new OpenLayers.Pixel(35+f.w,a.h),g=new OpenLayers.Size;g.h=35;g.w=a.w-f.w-35;a=OpenLayers.Util.createDiv(d,e,g,null,"absolute",null,"hidden",null);f=new OpenLayers.Pixel(-60,-290);b=OpenLayers.Util.createImage(this.id+"_leftBottom3_shadomImg_",f,b,this.shadowSrc,"absolute",null,null,null);a.appendChild(b);c.appendChild(a)},setleftBottomShadowDiv:function(a,b,c){var d=this.id+"_leftBottom_shadowdiv_",e=new OpenLayers.Pixel(0,a.h);this.divleftBottomSize=new OpenLayers.Size;this.divleftBottomSize.h=
40;this.divleftBottomSize.w=35;d=OpenLayers.Util.createDiv(d,e,this.divleftBottomSize,null,"absolute",null,"hidden",null);e=new OpenLayers.Pixel(-5,-290);b=OpenLayers.Util.createImage(this.id+"_leftBottom_shadomImg_",e,b,this.shadowSrc,"absolute",null,null,null);d.appendChild(b);c.appendChild(d);this.recalculateShadowLocation(a,this.divleftBottomSize,c)},setShadowSize:function(){var a=this.image,b=this.size;a.style.width=b.w+80+"px";a.style.height=b.h/2+"px";a.style.left="0px";a.style.bottom="40px"},
draw:function(){OpenLayers.Popup.Anchored.prototype.draw.apply(this,arguments);this.isShowShadow&&this.createShadow();return this.div},addCloseBox:function(a){this.closeDiv=OpenLayers.Util.createDiv(this.id+"_close",null,new OpenLayers.Size(17,17));this.closeDiv.className="olPopupCloseBox";var b=this.getContentDivPadding();this.closeDiv.style.right=b.right+"px";this.closeDiv.style.top=b.top+"px";this.groupDiv.appendChild(this.closeDiv);a=a||function(a){this.hide();OpenLayers.Event.stop(a)};OpenLayers.Event.observe(this.closeDiv,
"touchend",OpenLayers.Function.bindAsEventListener(a,this));OpenLayers.Event.observe(this.closeDiv,"click",OpenLayers.Function.bindAsEventListener(a,this))},hide:function(){if(this.shadowDiv)this.shadowDiv.style.display="none";OpenLayers.Popup.FramedCloud.prototype.hide.apply(this,arguments)},show:function(){if(this.shadowDiv)this.shadowDiv.style.display="";OpenLayers.Popup.FramedCloud.prototype.show.apply(this,arguments)},clickShadow:function(){},moveoverShadow:function(){},destroy:function(){if(this.shadowDiv&&
this.map)this.shadowevents.unregister({click:this.clickShadow,mousemove:this.moveoverShadow,scope:this}),this.map.events.unregister("zoomend",this,this.calculateShadowLocation),this.map.layerContainerDiv.removeChild(this.shadowDiv),this.shadowDiv=null;OpenLayers.Popup.FramedCloud.prototype.destroy.apply(this,arguments)},updateBlocks:function(){this.blocks||this.createBlocks();if(this.size&&this.relativePosition){for(var a=this.positionBlocks[this.relativePosition],b=0;b<a.blocks.length;b++){var c=
a.blocks[b],d=this.blocks[b],e=c.anchor.left,f=c.anchor.bottom,g=c.anchor.right,h=c.anchor.top,l=isNaN(c.size.w)?this.size.w-(g+e):c.size.w,m=isNaN(c.size.h)?this.size.h-(f+h):c.size.h;d.div.style.width=(l<0?0:l)+"px";d.div.style.height=(m<0?0:m)+"px";d.div.style.left=e!=null?e+"px":"";d.div.style.bottom=f!=null?f+"px":"";d.div.style.right=g!=null?g+"px":"";d.div.style.top=h!=null?h+"px":"";d.image.style.left=c.position.x+"px";d.image.style.top=c.position.y+"px"}switch(this.borderStyle){case Geo.View2D.Popup.GeoFrameCloud.CORNER:this.contentDiv.style.left=
this.padding.left+"px";this.contentDiv.style.top=this.padding.top+"px";break;case Geo.View2D.Popup.GeoFrameCloud.SHARP:this.contentDiv.style.left="0px";this.contentDiv.style.top="0px";break;case Geo.View2D.Popup.GeoFrameCloud.VERTICALDIRECTION:this.contentDiv.style.left="0px",this.contentDiv.style.top="0px"}}},CLASS_NAME:"Geo.View2D.Popup.GeoFrameCloud"});Geo.View2D.Popup.GeoFrameCloud.CORNER=1;Geo.View2D.Popup.GeoFrameCloud.SHARP=2;Geo.View2D.Popup.GeoFrameCloud.VERTICALDIRECTION=3;
Geo.View3D.Map=Geo.Class({id:null,div:null,activexObj:null,layers:null,overLayers:null,controls:null,popups:null,handlers:null,baseLayerGroup:null,_auxStatus:null,zoomRatio:0.05,EVENT_TYPES:["unloadLayerGroup","loadlayergroup"],pyramid:null,events:null,_enumMoveLayerType:{MOVE_TO_TOP:0,MOVE_TO_BOTTOM:1,MOVE_UP:2,MOVE_DOWN:3},_enumScreenElementType:{LATLONGGRID:0,COMPASS:1,ATMOSPHERE:2,COODINFO:3,CROSSHAIR:5},projection:"EPSG:4326",units:"degrees",initialize:function(a){this.div=typeof a=="string"?
document.getElementById(a):a;this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME);this.activexObj=Geo.View3D.Map.getActivex(this.id+"_Activex").obj;this.div.appendChild(this.activexObj);this.setScenario("no server",2);this.events=new OpenLayers.Events(this,this.div,this.EVENT_TYPES,this.fallThrough,{includeXY:!0});this.pyramid=new Geo.Pyramid;this.layers=[];this.overLayers=[];this.handlers=[];this.popups=[];this._auxStatus={latLongGrid:!1,compass:!0,coodInfo:!0,atmosphere:!0,crossHair:!0};a=OpenLayers.Function.bind(function(a){this._mouseEventHandler(a)},
this);this.activexObj.addEventListener?this.activexObj.addEventListener("MouseEvent",a,!1):this.activexObj.attachEvent&&this.activexObj.attachEvent("OnMouseEvent",a);a=OpenLayers.Function.bind(function(a){this.viewExtentChanged(a)},this);this.activexObj.addEventListener?this.activexObj.addEventListener("ViewExtentChanged",a,!1):this.activexObj.attachEvent&&this.activexObj.attachEvent("OnViewExtentChanged",a);a=OpenLayers.Function.bind(function(a,b){var e={};e.keyCode=a;e.keyState=b;this._keyEventHandler(e)},
this);this.activexObj.addEventListener?this.activexObj.addEventListener("KeyEvent",a,!1):this.activexObj.attachEvent&&this.activexObj.attachEvent("OnKeyEvent",a);if(this.controls==null)this.controls=Geo.View3D.Control!=null?[new Geo.View3D.Control.KeyboardDefaults]:[];for(var a=0,b=this.controls.length;a<b;a++)this.addControlToMap(this.controls[a])},zoomTo:function(a){a!=null&&a>=0&&this.setCenter(null,a)},zoomIn:function(){this.zoom(this.zoomRatio)},zoomOut:function(){this.zoom(-this.zoomRatio)},
zoom:function(a){this.activexObj.Camera.Zoom(a?a:0.05)},pan:function(a,b){if(a==null||b==null){var c=OpenLayers.i18n("pixelAddError");OpenLayers.Console.error(c);return null}(c=this.activexObj)&&c.SceneBox.PanByScreen(a,b)},panTo:function(a){if(a){var b=map.getCenter();if(!a.equals(b)){var c=this.activexObj,d=parseFloat(a.lat-b.lat),a=parseFloat(a.lon-b.lon);c&&c.SceneBox.Pan(d,a)}}},setCenter:function(a,b,c){b===void 0&&(b=this.getZoom());this._gotoPosition({lon:a.lon,lat:a.lat,level:b},c||!1)},
flyTo:function(a,b){this._gotoPosition({lon:a.lon,lat:a.lat,alt:b},!0)},zoomToExtent:function(a,b){var c=a.getCenterLonLat(),d=this.getSize(),d=this.pyramid.getLevelForResolution(Math.max(a.getWidth()/d.w,a.getHeight()/d.h));if(d>Geo.View3D.Map.ZOOMTOEXTENT_MINILEVEL)d=Geo.View3D.Map.ZOOMTOEXTENT_MINILEVEL;this.setCenter(c,d,b)},_gotoPosition:function(a,b){var c=this.activexObj;if(c){var d=a.lon,e=a.lat,f=a.level,g=typeof a.alt=="undefined"?Geo.View3D.Map.DEFAULT_ALT:a.alt,g=typeof f!="undefined"?
Geo.View3D.Map.getZfromLevel(f):g;this.getAltitude()>=g&&f!=0&&this.getAltitude()<Geo.View3D.Map.getZfromLevel(f-1)&&(g=this.getAltitude());this.getAltitude()>=g&&f==0&&(g=this.getAltitude());b?c.SceneBox.ParabolaFlyTo(d,e,g):c.SceneBox.PutCameraPosition(d,e,g)}},addLayer:function(a){if(!a)return!1;for(var b=0,c=this.layers.length;b<c;b++)if(this.layers[b]==a)return a=OpenLayers.i18n("layerAlreadyAdded",{layerName:a.name}),OpenLayers.Console.warn(a),!1;this.layers.push(a);a.setMap(this)},addLayers:function(a){Geo.Util.isArray(a)||
(a=[a]);for(var b=0;b<a.length;b++)this.addLayer(a[b])},addOverLayer:function(a){this.addLayer(a);this.overLayers.push(a)},removeLayer:function(a){OpenLayers.Util.removeItem(this.overLayers,a);OpenLayers.Util.removeItem(this.layers,a);a.removeMap();a.map=null},getNumLayers:function(){return this.layers.length},getLayerIndex:function(a){return OpenLayers.Util.indexOf(this.layers,a)},getLayer:function(a){for(var b=null,c=0,d=this.layers.length;c<d;c++){var e=this.layers[c];if(e.id==a){b=e;break}}return b},
raiseLayer:function(a,b){var c=this.getLayerIndex(a),d=Math.abs(b);if(b>0)for(var e=this.layers.length;c<e;c++){if(d==0||e<=c+1)break;this.layers[c+1].displayInLayerSwitcher?d--:b++}else if(b<0)for(;c>=0;c--){if(d==0||c-1<0)break;this.layers[c-1].displayInLayerSwitcher?d--:b-=1}d=this.getLayerIndex(a)+b;this.setLayerIndex(a,d)},resetTopLayer:function(){var a=this.layers.length,b=a-1;for(a-=1;a>=0;a--){var c=this.layers[a];c.isOnTop&&this.setLayerIndex(c,b--)}},resetOverLayer:function(){var a=this.layers.length,
b=a-1;for(a-=1;a>=0;a--){var c=this.layers[a];OpenLayers.Util.indexOf(this.overLayers,c)!=-1&&this.setLayerIndex(c,b--)}},setLayerIndex:function(a,b){var c=this.getLayerIndex(a),d=null,e=null;c==0?e=this.layers[c+1]:c==this.layers.length-1?d=this.layers[c-1]:(d=this.layers[c-1],e=this.layers[c+1]);var f=null,g=null;if(d&&d._layerData)f=d._layerData,Geo.Util.isArray(d._layerData)||(f=[d._layerData]);if(e&&e._layerData)g=e._layerData,Geo.Util.isArray(e._layerData)||(g=[e._layerData]);if(b<0)b=0;else if(b>
this.layers.length)b=this.layers.length;if(c!=b&&(this.layers.splice(c,1),this.layers.splice(b,0,a),c-=b,d=a._layerData,f&&c>0&&(c+=f.length-1),g&&c<0&&(c-=g.length-1),d)){Geo.Util.isArray(d)||(d=[d]);for(f=0;f<Math.abs(c);f++)for(g=0;g<d.length;g++)c<0&&this._moveLayerUp(d[g]),c>0&&(a.isOnTop&&a._markerLayer&&this._moveLayerDown(a._markerLayer),this._moveLayerDown(d[d.length-g-1]))}},loadLayerGroup:function(a){if(this.baseLayerGroup==a)return msg="\u4e0d\u80fd\u91cd\u590d\u52a0\u8f7d\u56fe\u5c42\u7ec4\u5230\u5730\u56fe\u4e2d\uff01",
OpenLayers.Console.warn(msg),!1;this.unloadLayerGroup();a.setMap(this);this.baseLayerGroup=a;this.resetOverLayer();this.resetTopLayer();this.events.triggerEvent("loadlayergroup",{layerGroup:a,map:this})},unloadLayerGroup:function(){var a=this.baseLayerGroup;if(!a)return!1;for(var b=a.layers,c=0;c<b.length;c++)this.removeLayer(b[c]);this.baseLayerGroup=a.map=null;this.events.triggerEvent("unloadLayerGroup",{layerGroup:a,map:this})},addControl:function(a){this.controls.push(a);this.addControlToMap(a)},
addControls:function(a){for(var b=0,c=a.length;b<c;b++)this.addControl(a[b])},addControlToMap:function(a,b){a.setMap(this);a.draw(b);a.autoActivate&&a.activate()},getControl:function(a){for(var b=null,c=0,d=this.controls.length;c<d;c++){var e=this.controls[c];if(e.id==a){b=e;break}}return b},removeControl:function(a){a&&a==this.getControl(a.id)&&(OpenLayers.Util.removeItem(this.controls,a),a.deactivate())},addPopup:function(a,b){if(b)for(var c=this.popups.length-1;c>=0;--c)this.removePopup(this.popups[c]);
a.map=this;this.popups.push(a);a.draw()},removePopup:function(a){if(!a)a=this.popups;Geo.Util.isArray(a)||(a=[a]);for(var b=a.length-1;b>=0;b--)a[b].map&&a[b]._clear(),a[b].map=null,OpenLayers.Util.removeItem(this.popups,a[b])},getAuxStatus:function(a){return a=="all"?this._auxStatus:this._auxStatus[a]},showLatLongGrid:function(a){var b=this.activexObj;if(b)b.ScreenBox.ChangeScreenElementVisible(this._enumScreenElementType.LATLONGGRID,a),this._auxStatus.latLongGrid=a},showCompass:function(a){var b=
this.activexObj;if(b)b.ScreenBox.ChangeScreenElementVisible(this._enumScreenElementType.COMPASS,a),this._auxStatus.compass=a},showCoodInfo:function(a){var b=this.activexObj;if(b)b.ScreenBox.ChangeScreenElementVisible(this._enumScreenElementType.COODINFO,a),this._auxStatus.coodInfo=a},setCoodInfo:function(a){OpenLayers.Util.applyDefaults(a,{screenPosition:0,textAlignment:0,fontColor:255,fontName:"\u5b8b\u4f53",fontBold:!0,fontSize:14});a.fontColor=Geo.Util.ToArgb(a.fontColor,255);var b=this.activexObj.ScreenBox.QueryScreenElement(this._enumScreenElementType.COODINFO);
b.ScreenPosition=a.screenPosition;b.TextAlignment=a.textAlignment;b.FontColor=a.fontColor;b.FontName=a.fontName;b.FontBold=a.fontBold;b.FontSize=a.fontSize},showAtmosphere:function(a){var b=this.activexObj;if(b)b.ScreenBox.ChangeScreenElementVisible(this._enumScreenElementType.ATMOSPHERE,a),this._auxStatus.atmosphere=a},showCrossHair:function(a){var b=this.activexObj;if(b)b.ScreenBox.ChangeScreenElementVisible(this._enumScreenElementType.CROSSHAIR,a),this._auxStatus.crossHair=a},setCompassPosition:function(a){var b=
this.activexObj;if(b)switch(a){case "left":b.ConfigBox.SaveConfigItem(7,12);break;case "right":b.ConfigBox.SaveConfigItem(7,8)}},setExaggeration:function(a){var a=a<0?0:a,b=this.activexObj;if(b)b.Camera.TerrainExaggeration=a>5?5:a},resetNorth:function(){var a=this.activexObj;a&&a.Camera.Rotate(0,0,0.01-a.Camera.Heading)},cameraRotation:function(a,b,c){var d=this.activexObj;d&&d.SceneBox.Rotate(a,b,c)},getZoom:function(){var a=this.getAltitude();return Geo.View3D.Map.getZoomfromAlt(Math.round(a))},
getGeography:function(){return eval(this.activexObj.SceneBox.CameraLookAtScript)},lonlatToScreen:function(a,b,c){a=eval(this.activexObj.AnalysisBox.GeographyToScreenScript(a,b,c,1));return new Geo.Pixel(parseFloat(a[0]),parseFloat(a[1]))},screenToLonlat:function(a,b){var c=eval(this.activexObj.AnalysisBox.ScreenToGeographyScript(a,b,1));return new Geo.LonLat(parseFloat(c[0]),parseFloat(c[1]))},getViewPortPxFromLonLat:function(a){var b=this.activexObj.AnalysisBox,c=this.getGeography(),c=parseFloat(c[2]),
a=eval(b.GeographyToScreenScript(a.lon,a.lat,c,1));return new Geo.Pixel(parseFloat(a[0]),parseFloat(a[1]))},getLonLatFromViewPortPx:function(){var a=eval(this.activexObj.AnalysisBox.ScreenToGeographyScript(pX,pY,1));return new Geo.LonLat(parseFloat(a[0]),parseFloat(a[1]))},getCenter:function(){var a=eval(this.activexObj.SceneBox.CameraLookAtScript);return new Geo.LonLat(parseFloat(a[0]),parseFloat(a[1]))},getAltitude:function(){return this.activexObj.SceneBox.MaxCameraAltitude},setTasService:function(a){var b=
this.activexObj;b&&b.SetTerrainAnalysisService(a)},getExtent:function(){var a=this.getCenter(),b=this.getSize(),c=this.getResolution(),b=new Geo.Size(b.w*c,b.h*c);return new Geo.Bounds(a.lon-b.w/2,a.lat-b.h/2,a.lon+b.w/2,a.lat+b.h/2)},getResolution:function(){return this.pyramid.getResolutionForLevel(this.getZoom())},getResolutionForZoom:function(a){return this.pyramid.getResolutionForLevel(a)},getZoomForResolution:function(a){return this.pyramid.getLevelForResolution(a)},getSize:function(){var a=
this.activexObj;if(a)return new Geo.Size(parseInt(a.offsetWidth),parseInt(a.offsetHeight))},getScale:function(){var a=null,a=this.getResolution();return a=OpenLayers.Util.getScaleFromResolution(a,this.units)},destroy:function(){for(var a=this.layers.length-1;a>=0;a--)this.removeLayer(this.layers[a]);this.activexObj&&this.div.removeChild(this.activexObj);this.activexObj=null},setScenario:function(a){a&&(arguments.length<2?this.activexObj.ConnectServer(a,1):this.activexObj.ConnectServer(arguments[0],
arguments[1]))},_initGeoRaster:function(){this._geoRaster=this.activexObj.CreateGeoRasterObj();this._geoRaster.GeoRasterType=1},viewExtentChanged:function(){},_mouseEventHandler:function(a){if(Geo.View3D.Event.MouseEvent.isMouseDown(a))Geo.View3D.Event.MouseEvent._mouseDownPos={x:a.ScreenX,y:a.ScreenY};for(var b=0;b<this.handlers.length;b++){var c=this.handlers[b];c instanceof Geo.View3D.Handler.KeybordDefaults||c.active&&c.listener(a)}if(Geo.View3D.Event.MouseEvent.isMouseUp(a))Geo.View3D.Event.MouseEvent._mouseDownPos=
null},_keyEventHandler:function(a){for(var b=0;b<this.handlers.length;b++){var c=this.handlers[b];(c instanceof Geo.View3D.Handler.KeybordDefaults||c instanceof Geo.View3D.Handler.Keyboard)&&c.active&&c.listener(a)}},_measureHandler:function(){},_addGlobeTileService:function(a,b,c){var d=this.activexObj,a=d.DataSourceBox.CreateDataLayer(a,b,c);d.LayerBox.UserGroupLayer.AddLayer(a);return a},_removeLayerData:function(a){var b=this.activexObj;b&&a&&b.LayerBox.UserGroupLayer.RemoveLayer(a)},_getPointGeometryArr:function(a){var b=
a.indexOf("(")+1,c=a.indexOf(")");return a.slice(b,c).split(" ")},_i:0,_createUniqueID:function(){var a=this._i;a++;a==1.7976931348623157E308&&(a=0);return this._i=a},_drawGeometry:function(a){var b=this.activexObj;if(b){var c=a.drawBox,d=a.strPoints,e=OpenLayers.Util.extend({},Geo.Feature.Vector.style["default"]),e=OpenLayers.Util.extend(e,a.style);a.feature.style=e;switch(a.type){case 0:if(e.externalGraphic){var c=a.dynamicLayer,d=e.fontColor?this._convertColorValue(e.fontColor):16711680,f=e.fontSize?
e.fontSize:12,g=e.fontFamily?e.fontFamily:"\u5b8b\u4f53",h=e.label?e.label:"";a.strPoints.split(" ");e=b.DrawBox.AddPOIDrawObject(a.feature.id,a.strPoints,"",h,e.externalGraphic,d,f,g);c.AddPOI(e);b.DrawBox.RemoveObject(e)}else d=b.DrawBox.CreateGeometryObject(d,"",1,1),d.Key=a.featureid,d.ZType=0,d.PutViewRange(0,36E6),a=e.fillColor.replace("#",""),a=Geo.Util.ToArgb(a,parseInt(e.strokeOpacity*255)),e=b.DrawBox.CreatePointSymbolObject(e.pointRadius,a),c.AddOrReplaceGeometry(d,e);break;case 1:d=b.DrawBox.CreateGeometryObject(d,
"",2,1);d.Key=a.featureid;d.ZType=0;d.PutViewRange(0,36E6);a=e.strokeColor.replace("#","");a=Geo.Util.ToArgb(a,parseInt(e.strokeOpacity*255));e=b.DrawBox.CreateLineSymbolObject(e.strokeWidth,a);c.AddOrReplaceGeometry(d,e);break;case 2:d=b.DrawBox.CreateGeometryObject(d,"",3,1),d.Key=a.featureid,d.ZType=0,d.PutViewRange(0,36E6),a=e.strokeColor.replace("#",""),a=Geo.Util.ToArgb(a,parseInt(e.strokeOpacity*255)),a=b.DrawBox.CreateLineSymbolObject(e.strokeWidth,a),f=e.fillColor.replace("#",""),e=Geo.Util.ToArgb(f,
parseInt(e.fillOpacity*255)),e=b.DrawBox.CreateFillSymbolObject(e,a),c.AddOrReplaceGeometry(d,e)}}},_delGeometryByName:function(a,b){b.DeleteGeometry(a)},_delBookMark:function(a,b){b.RemovePOI(a)},_removeVectorLayerData:function(a){var b=this.activexObj;b&&b.GetSceneGroup().RemoveLayer(a)},_moveLayerUp:function(a){var b=this.activexObj;b&&b.LayerBox.UserGroupLayer.MoveLayer(a,this._enumMoveLayerType.MOVE_UP)},_moveLayerDown:function(a){var b=this.activexObj;b&&b.LayerBox.UserGroupLayer.MoveLayer(a,
this._enumMoveLayerType.MOVE_DOWN)},_gotoLayer:function(a){var b=this.activexObj;a&&b&&this.zoomToExtent(this._createLayerOperate(this._enumLayerOperateType.layerBounds,a,{}),!0)},_setLayerOpacity:function(a,b){this.activexObj&&this._createLayerOperate(this._enumLayerOperateType.opacity,a,{opacity:b})},_setLayerVisibility:function(a,b){this.activexObj&&this._createLayerOperate(this._enumLayerOperateType.visible,a,{visible:b})},_addWMTSService:function(a,b){var c=this.activexObj;if(c){var d=c.GetLayerBox();
if(null==a||void 0==a)a="";for(var e=d.GetWmtsInfo(a),f=[],g=e.GetCount(),h=0;h<g;h++){var l=e.GetResByIndex(h);if(!b||l.Name==b)l=d.AddOneWmtsLayer(l,""),c.GetCameraWrapper().GoToLayer(l),f.push(l)}return f}},_addWMSService:function(a,b){var c=b.split(",");if(b){var d=this.activexObj;if(d){var e=d.GetOGCBox();if(null==a||void 0==a)a="";for(var f=e.GetWmsLayersInfo(a),g=[],h=0,l=f.GetWmsInfoCount();h<l;h++)for(var m=f.GetWmsInfoByIndex(h),o=0;o<c.length;o++)if(m.Name==c[o]){var j=e.ConSelecedLayers(!1,
200,1,20,!0,255,"image/png",m);j.Name=m.Name;d.GetLayerBox().AddLayerData(j);g.push(j)}return g}}},_addWCSService:function(a){var b=this.activexObj,c=null;if(b){if(null==a||void 0==a)a="";c=b.GetOGCBox().ConnectWCS(a).GetLayerByIndex(0)}return c},_addVectorLayer:function(){var a=this.activexObj,b=a.ObjectFactory.CreateObject(0);a.LayerBox.UserGroupLayer.AddLayer(b);return b},_addDynamicLayer:function(){var a=this.activexObj,b=a.ObjectFactory.CreateObject(1);a.LayerBox.UserGroupLayer.AddLayer(b);return b},
_addCustomLayer:function(a){var b=this.activexObj,a=b.DataSourceBox.CreateLayerFromJson(a);b.LayerBox.UserGroupLayer.AddLayer(a);return a},_convertColorValue:function(a){return new Number("0x00"+a.replace("#",""))},_enumLayerOperateType:{visible:1,opacity:2,object:4,layerBounds:3,wmsLayerinfo:6,wmtsLayerinfo:7},_createLayerOperate:function(a,b,c){b=this.activexObj.LayerBox.CreateLayerOperate(b);switch(a){case this._enumLayerOperateType.visible:b.ChangeLayerProperty(a,c.visible);break;case this._enumLayerOperateType.opacity:b.ChangeLayerProperty(a,
parseInt(c.opacity*255));break;case this._enumLayerOperateType.layerBounds:return a=b.LayerProperty(a),a=eval(a),new Geo.Bounds(a[2],a[1],a[3],a[0])}},unloadDestroy:function(){},isSuspend:function(a){this.activexObj.Suspend=a},setFocusAlways:function(a){this.activexObj.ConfigBox.SaveConfigItem(26,a)},CLASS_NAME:"Geo.View3D.Map"});Geo.View3D.Map.DEFAULT_ALT=25E5;
Geo.View3D.Map.getActivex=function(a){var b="",c=null;try{c=document.createElement("object");c.classid="CLSID:535CEBE1-7D19-4203-AA3B-B1B40167BF86";c.width="100%";c.height="100%";if(a)c.id=a;b=c.Version}catch(d){}return{obj:c,version:b}};Geo.View3D.Map.getActivexVersion=function(){if(Geo.View3D.Map.activexVersion)return Geo.View3D.Map.activexVersion;var a;try{a=new ActiveXObject("GeoSpace3D.ControlVersion.1"),Geo.View3D.Map.activexVersion=a.Version}catch(b){return null}return Geo.View3D.Map.activexVersion};
Geo.View3D.Map.ACTIVEX_DEFAULT_VERSION="1.3.1.55185";Geo.View3D.Map.zoomMaping=[];Geo.View3D.Map.zoomMaping[0]=23E6;Geo.View3D.Map.zoomMaping[1]=15E6;Geo.View3D.Map.zoomMaping[2]=1E7;Geo.View3D.Map.zoomMaping[3]=9E6;Geo.View3D.Map.zoomMaping[4]=5916173;Geo.View3D.Map.zoomMaping[5]=2958087;Geo.View3D.Map.zoomMaping[6]=1479044;Geo.View3D.Map.zoomMaping[7]=739522;Geo.View3D.Map.zoomMaping[8]=369761;Geo.View3D.Map.zoomMaping[9]=184881;Geo.View3D.Map.zoomMaping[10]=92441;
Geo.View3D.Map.zoomMaping[11]=46221;Geo.View3D.Map.zoomMaping[12]=23111;Geo.View3D.Map.zoomMaping[13]=11556;Geo.View3D.Map.zoomMaping[14]=5778;Geo.View3D.Map.zoomMaping[15]=2889;Geo.View3D.Map.zoomMaping[16]=1445;Geo.View3D.Map.zoomMaping[17]=723;Geo.View3D.Map.zoomMaping[18]=362;Geo.View3D.Map.zoomMaping[19]=181;Geo.View3D.Map.zoomMaping[20]=1;
Geo.View3D.Map.getZoomfromAlt=function(a){for(var b=0;b<Geo.View3D.Map.zoomMaping.length;b++){if(a>=Geo.View3D.Map.zoomMaping[0])return b;if(a>=Geo.View3D.Map.zoomMaping[b]&&b!=0&&a<Geo.View3D.Map.zoomMaping[b-1])return b;if(a<Geo.View3D.Map.zoomMaping[Geo.View3D.Map.zoomMaping.length-1])return Geo.View3D.Map.zoomMaping.length-1}};Geo.View3D.Map.getAltfromZoom=function(a){return(a=Geo.View3D.Map.zoomMaping[a])?a:0};Geo.View3D.Map.getZfromLevel=Geo.View3D.Map.getAltfromZoom;
Geo.View3D.Map.activexErrorInfo="";Geo.View3D.Map.ZOOMTOEXTENT_MINILEVEL=17;
Geo.View3D.Layer=Geo.Class({id:null,name:null,opacity:null,map:null,displayInLayerSwitcher:!0,isOnTop:!1,events:null,visibility:!0,EVENT_TYPES:["visibilitychanged"],initialize:function(a,b){this.addOptions(b);this.name=a;if(this.id==null&&(this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"),this.events=new OpenLayers.Events(this,this.div,this.EVENT_TYPES),this.eventListeners instanceof Object))this.events.on(this.eventListeners);this.opacity=1},setMap:function(a){if(this.map==null)this.map=
a,a=this.map.activexObj,this.dataSourceBox=a.DataSourceBox,this.layerBox=a.LayerBox},removeMap:function(){},getVisibility:function(){return this.visibility},setVisibility:function(a){if(a!=this.visibility)this.visibility=a,this.display(a)},display:function(){},setOpacity:function(){},getOptions:function(){var a={},b;for(b in this.options)a[b]=this[b];return a},addOptions:function(a){if(this.options==null)this.options={};OpenLayers.Util.extend(this.options,a);OpenLayers.Util.extend(this,a)},destroy:function(){this.options=
this.layerBox=this.dataSourceBox=this.name=this.map=null;this.events&&(this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy());this.events=this.eventListeners=null},CLASS_NAME:"Geo.View3D.Layer"});
Geo.View3D.BaseLayerGroup=Geo.Class({id:null,layers:null,map:null,initialize:function(a){this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_");OpenLayers.Util.extend(this,a);if(!this.layers)this.layers=[]},setMap:function(a){if(a&&!this.map)this.map=a,this.map.addLayers(this.layers)},CLASS_NAME:"Geo.View3D.BaseLayerGroup"});
Geo.View3D.BaseLayerGroup.getTianDiTuGroup=function(a){if(a={img:[new Geo.View3D.Layer.GlobeTile("\u5168\u7403\u5f71\u50cf\u5e95\u56fe(2-10)","http://tile0.tianditu.com/services/sbsm0210"),new Geo.View3D.Layer.GlobeTile("\u5168\u7403\u5f71\u50cf\u6ce8\u8bb0(2-10)","http://tile0.tianditu.com/services/A0104_ImgAnnoE"),new Geo.View3D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf(14)","http://tile0.tianditu.com/services/eastdawnall"),new Geo.View3D.Layer.GlobeTile("\u5168\u7403\u5f71\u50cf(15-18)","http://tile0.tianditu.com/services/sbsm1518"),
new Geo.View3D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf(13)","http://tile0.tianditu.com/services/e13"),new Geo.View3D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf(12)","http://tile0.tianditu.com/services/e12"),new Geo.View3D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf(11)","http://tile0.tianditu.com/services/e11"),new Geo.View3D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf\u6ce8\u8bb0(11-14)","http://tile0.tianditu.com/services/B0530_eImgAnno"),new Geo.View3D.Layer.GlobeTile("\u5168\u56fd\u5f71\u50cf\u6ce8\u8bb0(15-18)",
"http://tile0.tianditu.com/services/siweiAnno68")],dlg:[new Geo.View3D.Layer.GlobeTile("\u5168\u56fd\u77e2\u91cf(2-10)","http://tile0.tianditu.com/services/A0512_EMap"),new Geo.View3D.Layer.GlobeTile("\u5168\u56fd\u77e2\u91cf\u6ce8\u8bb0(2-10)","http://tile0.tianditu.com/services/AB0512_Anno"),new Geo.View3D.Layer.GlobeTile("\u5168\u56fd\u77e2\u91cf(11-12)","http://tile0.tianditu.com/services/B0627_EMap1112"),new Geo.View3D.Layer.GlobeTile("\u5168\u56fd\u77e2\u91cf(13-18)","http://tile0.tianditu.com/services/siwei0608")]}[a])return new Geo.View3D.BaseLayerGroup({layers:a});
return null};Geo.View3D.LayerGroup=Geo.View3D.BaseLayerGroup;
Geo.View3D.Layer.ArcgisRest=Geo.Class(Geo.View3D.Layer,{id:null,url:null,_layerData:null,initialize:function(a,b,c,d){c=c||{};c.pyramid=c.pyramid?c.pyramid:new Geo.Pyramid;if(d.maxResolution)c.bottomLevel=c.pyramid.getLevelForResolution(d.maxResolution);if(d.minResolution)c.topLevel=c.pyramid.getLevelForResolution(d.minResolution);if(d.maxScale)c.bottomLevel=c.pyramid.getLevelForScale(d.maxScale);if(d.minScale)c.topLevel=c.pyramid.getLevelForScale(d.minScale);a=[a,b,d];this.params=c;Geo.View3D.Layer.GlobeTile.prototype.initialize.apply(this,
a)},setMap:function(a){this._createLayerFromJson(a)},_createLayerFromJson:function(a){var b={request:"GetTile",styles:"",format:"png"},c=this.params.dataType?this.params.dataType:"ImageDataType",d=this.params.opacity>=0?this.params.opacity*100:100,e=this.params.topLevel?this.params.topLevel:0,f=this.params.bottomLevel?this.params.bottomLevel:20,g=this.options.maxExtent?this.options.maxExtent.left:-180,h=this.options.maxExtent?this.options.maxExtent.bottom:-90,l=this.options.maxExtent?this.options.maxExtent.right:
180,m=this.options.maxExtent?this.options.maxExtent.top:90,o=this.url,j=this.params.format?this.params.format:b.format,n=this.params.transparent?this.params.transparent:"TRUE",v=this.params.width?this.params.width:256,u=this.params.height?this.params.height:256,p=(this.options.projection?this.options.projection:"EPSG:4326").split(":"),b=b.spatialReference,b=p.length==2?p[1]:p[0],c='{"DataType":"'+c+'","DataSourceType":"Customer","StartLevel":'+e+',"EndLevel":'+f+',"XMin":'+g+',"YMin":'+h+',"XMax":'+
l+',"YMax":'+m+',"SpatialReference":"'+b+'","RenderTransparency":'+d+',"ServerUrl":"'+o+"?dpi=96&transparent="+n+"&format="+j+"&bbox=${TileXMin}%2C${TileYMin}%2C${TileXMax}%2C${TileYMax}&size="+v+"%2C"+u+"&f=image";c+='"}';Geo.View3D.Layer.prototype.setMap.apply(this,[a]);a=this.dataSourceBox.CreateLayerFromJson(c);this.layerBox.UserGroupLayer.AddLayer(a);this._layerData=a},removeMap:function(){var a=this.map;if(a)a._removeLayerData(this._layerData),this._layerData=null;this.map=null},setVisibility:function(a){if(a!=
this.visibility)this.visibility=a,this.display(a)},display:function(a){if(a!=this._layerData.LayerData.Visible)this._layerData.LayerData.Visible=a},setOpacity:function(a){Geo.View3D.Layer.prototype.setOpacity.apply(a);var b=this.map;if(b)b._setLayerOpacity(this._layerData,a),this.opacity=a},gotoCenter:function(){var a=this.map;a&&a._gotoLayer(this._layerData)},CLASS_NAME:"Geo.View3D.Layer.ArcgisRest"});
Geo.View3D.Layer.GlobeTile=Geo.Class(Geo.View3D.Layer,{id:null,url:null,_LAYER_TYPE_GLOBETILE:6,_layerData:null,_oldLoad:null,initialize:function(a,b,c){if(arguments.length<3)this._oldLoad=!0;else{c=c||{};c.pyramid=c.pyramid?c.pyramid:new Geo.Pyramid;if(c.maxResolution)c.bottomLevel=c.pyramid.getLevelForResolution(c.maxResolution);if(c.minResolution)c.topLevel=c.pyramid.getLevelForResolution(c.minResolution);if(c.maxScale)c.bottomLevel=c.pyramid.getLevelForScale(c.maxScale);if(c.minScale)c.topLevel=
c.pyramid.getLevelForScale(c.minScale);if(typeof c.projection=="string")this.projection=new Geo.Projection(c.projection);if(this.projection&&this.projection.getUnits())this.units=this.projection.getUnits()}Geo.View3D.Layer.prototype.initialize.apply(this,[a,c]);this.url=b},setMap:function(a){this._oldLoad?this._oldSetMap(a):(this._createLayerFromJson(a),this.display(this.visibility))},_oldSetMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);this._layerData=a._addGlobeTileService(this.url,
"",this._LAYER_TYPE_GLOBETILE)},_createLayerFromJson:function(a){var b={version:"2.0.0",request:"GetTile",styles:"",format:"image/png",spatialReference:"4326"},c=this.options.dataType?this.options.dataType:"ImageDataType",d=this.options.opacity>=0?this.options.opacity*100:100,e=this.options.topLevel?this.options.topLevel:0,f=this.options.bottomLevel?this.options.bottomLevel:20,g=this.options.maxExtent?this.options.maxExtent.left:-180,h=this.options.maxExtent?this.options.maxExtent.bottom:-90,l=this.options.maxExtent?
this.options.maxExtent.right:180,m=this.options.maxExtent?this.options.maxExtent.top:90,o=this.url,j=this.options.version?this.options.version:b.version,n=(this.options.projection?this.options.projection:"EPSG:4326").split(":"),b=b.spatialReference,b=n.length==2?n[1]:n[0],c='{"DataType":"'+c+'","DataSourceType":"GeoTile","StartLevel":'+e+',"EndLevel":'+f+',"XMin":'+g+',"YMin":'+h+',"XMax":'+l+',"YMax":'+m+',"SpatialReference":"'+b+'","RenderTransparency":'+d+',"ServerUrl":"'+o+'","Version":"'+j;c+=
'"}';Geo.View3D.Layer.prototype.setMap.apply(this,[a]);a=this.dataSourceBox.CreateLayerFromJson(c);this.layerBox.UserGroupLayer.AddLayer(a);this._layerData=a},removeMap:function(){var a=this.map;a&&a._removeLayerData(this._layerData);this.map=null},setVisibility:function(a){if(a!=this.visibility)this.visibility=a,this.display(a)},display:function(a){this._layerData&&a!=this._layerData.Visible&&this.map._setLayerVisibility(this._layerData,a)},setOpacity:function(a){Geo.View3D.Layer.prototype.setOpacity.apply(a);
var b=this.map;if(b)this._layerData&&b._setLayerOpacity(this._layerData,a),this.opacity=a},gotoCenter:function(){var a=this.map;a&&this._layerData&&a._gotoLayer(this._layerData)},CLASS_NAME:"Geo.View3D.Layer.GlobeTile"});
Geo.View3D.Layer.Shape=Geo.Class(Geo.View3D.Layer,{_LAYER_TYPE_Shape:3,initialize:function(a,b,c){Geo.View3D.Layer.prototype.initialize.apply(this,[a,c]);this.url=b},setMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);this._layerData=this._addShpDate(this.url)},_addShpDate:function(){var a=this.dataSourceBox.CreateDataLayer(this.url,null,0);this.layerBox.UserGroupLayer.AddLayer(a);this._layerData=a},CLASS_NAME:"Geo.View3D.Layer.Shape"});
Geo.View3D.Layer.Terrain=Geo.Class(Geo.View3D.Layer.GlobeTile,{id:null,url:null,_layerData:null,_oldLoad:null,initialize:function(a,b,c){if(arguments.length<3)this._oldLoad=!0;else{c=c||{};c.pyramid=c.pyramid?c.pyramid:new Geo.Pyramid;if(c.maxResolution)c.bottomLevel=c.pyramid.getLevelForResolution(c.maxResolution);if(c.minResolution)c.topLevel=c.pyramid.getLevelForResolution(c.minResolution);if(c.maxScale)c.bottomLevel=c.pyramid.getLevelForScale(c.maxScale);if(c.minScale)c.topLevel=c.pyramid.getLevelForScale(c.minScale);
if(typeof c.projection=="string")this.projection=new Geo.Projection(c.projection);if(this.projection&&this.projection.getUnits())this.units=this.projection.getUnits()}Geo.View3D.Layer.prototype.initialize.apply(this,[a,c]);this.url=b},setMap:function(a){this._oldLoad?this._oldSetMap(a):(this._createLayerFromJson(a),this.display(this.visibility))},_oldSetMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);a=this.dataSourceBox.CreateTerrainDataset(this.url);this.dataSourceBox.AddTerrainDataset(a);
this._layerData=a},_createLayerFromJson:function(a){var b='{"StartLevel":'+(this.options.topLevel?this.options.topLevel:0)+',"EndLevel":'+(this.options.bottomLevel?this.options.bottomLevel:20)+',"DEMDataType":"'+(this.options.demDataType?this.options.demDataType:"int16")+'","XMin":'+(this.options.maxExtent?this.options.maxExtent.left:-180)+',"YMin":'+(this.options.maxExtent?this.options.maxExtent.bottom:-90)+',"XMax":'+(this.options.maxExtent?this.options.maxExtent.right:180)+',"YMax":'+(this.options.maxExtent?
this.options.maxExtent.top:90)+',"ServerUrl":"'+this.url;b+='"}';Geo.View3D.Layer.prototype.setMap.apply(this,[a]);a=this.dataSourceBox.CreateTerrainDatasetFromJson(b);this.dataSourceBox.AddTerrainDataset(a);this._layerData=a},removeMap:function(){this._layerData&&this._removeMap()},_removeMap:function(){if(this._oldLoad){var a=this.map;a&&a.activexObj.Camera.TerrainAccessor.remove(this._layerData);this.map=null}else this.dataSourceBox.RemoveTerrainDataset(this._layerData)},setVisibility:function(a){this.visibility=
a;this.display(a)},display:function(a){this._layerData&&this._display(a)},_display:function(a){this.map.activexObj.ConfigBox.SaveConfigItem(19,a)},CLASS_NAME:"Geo.View3D.Layer.Terrain"});
Geo.View3D.Layer.Vector=Geo.Class(Geo.View3D.Layer,{_geometryLayer:null,_dynamicLayer:null,features:null,selectedFeatures:null,style:null,styleMap:null,EVENT_TYPES:["beforefeatureadded","beforefeaturesadded","featureadded","featuresadded","beforefeatureremoved","beforefeaturesremoved","featureremoved","featuresremoved","beforefeatureselected","featureselected","featureunselected","beforefeaturemodified","featuremodified","afterfeaturemodified","vertexmodified","sketchstarted","sketchmodified","sketchcomplete",
"refresh"],initialize:function(a,b){this.EVENT_TYPES=Geo.View3D.Layer.Vector.prototype.EVENT_TYPES.concat(Geo.View3D.Layer.prototype.EVENT_TYPES);this.features=[];this.selectedFeatures=[];Geo.View3D.Layer.prototype.initialize.apply(this,[a,b])},setMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);this._geometryLayer=a._addVectorLayer();this._dynamicLayer=a._addDynamicLayer();this._layerData=this._geometryLayer},addFeatures:function(a){Geo.Util.isArray(a)||(a=[a]);for(var b=0,c=a.length;b<
c;b++){var d=a[b];if(!d.style&&this.style)d.style=OpenLayers.Util.extend({},this.style);this.features.push(d);this.drawFeature(d)}},drawFeature:function(a){var b=this.map;if(b)b._drawGeometry({vectorLayerObj:this,featureid:a.id,feature:a,dynamicLayer:this._dynamicLayer,drawBox:this._geometryLayer,strPoints:this._getGeometryStr(a.geometry),type:this._getGeometryType(a.geometry),style:a.style}),a.layer=this},removeFeatures:function(a){if(a){Geo.Util.isArray(a)||(a=[a]);for(var b=a.length-1;b>=0;b--){var c=
a[b],d=this.map;d&&(c.style&&c.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"&&c.style.externalGraphic?d._delBookMark(c.id,this._dynamicLayer):d._delGeometryByName(c.id,this._geometryLayer));this.features=OpenLayers.Util.removeItem(this.features,c)}}},destroyFeatures:function(a,b){if(a==void 0)a=this.features;if(a){this.removeFeatures(a,b);for(var c=a.length-1;c>=0;c--)a[c].destroy()}},removeMap:function(a){if(a=this.map)this.destroyFeatures(this.features),this._dynamicLayer=this._geometryLayer=
null;this.map=null},setVisibility:function(a){if(a!=this.visibility)this.visibility=a,this.display(a)},display:function(a){var b=this.map;b&&(b._setLayerVisibility(this._layerData,a),b._setLayerVisibility(this._dynamicLayer,a))},_getGeometryType:function(a){return{"OpenLayers.Geometry.Point":0,"OpenLayers.Geometry.LineString":1,"OpenLayers.Geometry.Polygon":2}[a.CLASS_NAME]},getFeatureBy:function(a,b){for(var c=null,d=0,e=this.features.length;d<e;++d)if(this.features[d][a]==b){c=this.features[d];
break}return c},getFeatureById:function(a){return this.getFeatureBy("id",a)},_getGeometryStr:function(a){String.prototype.replaceAll=function(a,b){return this.replace(RegExp(a,"gm"),b)};var b=a.toString(),c=b.indexOf("(")+1,d=b.indexOf(")");if(a instanceof OpenLayers.Geometry.LineString){b=b.slice(c,d).split(",");for(a=0;a<b.length;a++)b[a]+=" 100000";a=b.join(",");return"LINESTRING("+a+")"}if(a instanceof OpenLayers.Geometry.Polygon){b=b.slice(c+1,d).split(",");for(a=0;a<b.length;a++)b[a]+=" 100000";
a=b.join(",");return"Ring("+a+")"}return b},getDataExtent:function(){var a=null,b=this.features;if(b&&b.length>0)for(var a=new Geo.Bounds,c=null,d=0,e=b.length;d<e;d++)(c=b[d].geometry)&&a.extend(c.getBounds());return a},CLASS_NAME:"Geo.View3D.Layer.Vector"});
Geo.View3D.Layer.WMS=Geo.Class(Geo.View3D.Layer.GlobeTile,{id:null,url:null,_LAYER_TYPE_OGCWMS:2,params:null,_layerData:null,_oldLoad:null,DEFAULT_PARAMS:{service:"WMS",version:"1.1.1",request:"GetMap",styles:"",format:"image/jpeg",spatialReference:"4326"},initialize:function(a,b,c,d){this.url=b;if(arguments.length<4){this._oldLoad=!0;Geo.View3D.Layer.GlobeTile.prototype.initialize.apply(this,[a,b,d]);if(c&&!c.version)c.version="1.3.0";this.params=c}else{c=c||{};c.pyramid=c.pyramid?c.pyramid:new Geo.Pyramid;
if(d.maxResolution)d.bottomLevel=c.pyramid.getLevelForResolution(d.maxResolution);if(d.minResolution)d.topLevel=c.pyramid.getLevelForResolution(d.minResolution);if(c.maxScale)d.bottomLevel=c.pyramid.getLevelForScale(d.maxScale);if(c.minScale)d.topLevel=c.pyramid.getLevelForScale(d.minScale);c.format=c.format?this.DEFAULT_PARAMS.format:"image/jpeg";var e=[a,b,d];this.params=c;Geo.View3D.Layer.GlobeTile.prototype.initialize.apply(this,e);if(this.params.transparent&&this.params.transparent.toString().toLowerCase()==
"true"&&this.params.format=="image/jpeg")this.params.format=OpenLayers.Util.alphaHack()?"image/gif":"image/png"}},setMap:function(a){this._oldLoad?this._oldSetMap(a):(this._createLayerFromJson(a),this.display(this.visibility))},_oldSetMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);a=this.dataSourceBox.CreateDataLayer(this.url,this.params.version,this._LAYER_TYPE_OGCWMS);this.layerBox.UserGroupLayer.AddLayer(a);this._layerData=a},_createLayerFromJson:function(a){var b=this.options.dataType?
this.options.dataType:"ImageDataType",c=this.options.opacity>=0?this.options.opacity*100:100,d=this.options.topLevel?this.options.topLevel:0,e=this.options.bottomLevel?this.options.bottomLevel:20,f=this.options.maxExtent?this.options.maxExtent.left:-180,g=this.options.maxExtent?this.options.maxExtent.bottom:-90,h=this.options.maxExtent?this.options.maxExtent.right:180,l=this.options.maxExtent?this.options.maxExtent.top:90,m=this.url,o=this.params.version?this.params.version:this.DEFAULT_PARAMS.version,
j=encodeURIComponent(this.params.layers?this.params.layers:""),n=encodeURIComponent(this.params.format?this.params.format:this.DEFAULT_PARAMS.format),v=this.params.transparent?this.params.transparent:"TRUE",u=this.options.styles?this.options.styles:this.DEFAULT_PARAMS.styles,p=this.options.tileSize?this.options.tileSize:new Geo.Size(256,256),s=p.w?p.w:256,r=p.h?p.h:256,p=this.options.projection?this.options.projection:"EPSG:4326",t=p.split(":"),ba=this.params.spatialReference?this.params.spatialReference:
this.DEFAULT_PARAMS.spatialReference,ba=t.length==2?t[1]:t[0],b='{"DataType":"'+b+'","DataSourceType":"Customer","StartLevel":'+d+',"EndLevel":'+e+',"XMin":'+f+',"YMin":'+g+',"XMax":'+h+',"YMax":'+l+',"SpatialReference":"'+ba+'","RenderTransparency":'+c+',"ServerUrl":"'+m+"?SERVICE="+this.DEFAULT_PARAMS.service+"&transparent="+v+"&Request=GetMap&VERSION="+o+"&LAYERS="+j+"&STYLES="+u+"&FORMAT="+n+"&WIDTH="+s+"&HEIGHT="+r,c="";parseFloat(o)>=1.3?(b+="&CRS="+p+"",c=p):b+="&SRS="+p+"";b+=c!=""&&parseFloat(o)==
1.3?"&BBox=${TileYMin},${TileXMin},${TileYMax},${TileXMax}":"&BBox=${TileXMin},${TileYMin},${TileXMax},${TileYMax}";b+='"}';Geo.View3D.Layer.prototype.setMap.apply(this,[a]);a=this.dataSourceBox.CreateLayerFromJson(b);this.layerBox.UserGroupLayer.AddLayer(a);this._layerData=a},display:function(a){var b=this.map;this._layerData&&a!=this._layerData.Visible&&b._setLayerVisibility(this._layerData,a)},setOpacity:function(a){Geo.View3D.Layer.prototype.setOpacity.apply(a);var b=this.map;if(b)b._setLayerOpacity(this._layerData,
a),this.opacity=a},gotoCenter:function(){var a=this.map;a&&a._gotoLayer(this._layerData)},removeMap:function(){var a=this.map;a&&a._removeLayerData(this._layerData);this.map=null},CLASS_NAME:"Geo.View3D.Layer.WMS"});
Geo.View3D.Layer.WMTS=Geo.Class(Geo.View3D.Layer.GlobeTile,{layerName:null,_LAYER_TYPE_OGCWMTS:4,_oldLoad:null,initialize:function(a,b,c){if(typeof a=="string")this._oldLoad=!0,Geo.View3D.Layer.GlobeTile.prototype.initialize.apply(this,[a,b,c]),this.url=b,c=c||{},this.layerName=c.layer;else{c=a||{};c.pyramid=c.pyramid?c.pyramid:new Geo.Pyramid;if(c.maxResolution)c.bottomLevel=c.pyramid.getLevelForResolution(c.maxResolution);if(c.minResolution)c.topLevel=c.pyramid.getLevelForResolution(c.minResolution);
if(c.maxScale)c.bottomLevel=c.pyramid.getLevelForScale(c.maxScale);if(c.minScale)c.topLevel=c.pyramid.getLevelForScale(c.minScale);Geo.View3D.Layer.GlobeTile.prototype.initialize.apply(this,[c.name,c.url,c])}},setMap:function(a){this._oldLoad?this._oldSetMap(a):(this._createLayerFromJson(a),this.display(this.visibility))},_oldSetMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);a=this.dataSourceBox.CreateDataLayer(this.url,"",this._LAYER_TYPE_OGCWMTS);this.layerBox.UserGroupLayer.AddLayer(a);
this._layerData=a},_createLayerFromJson:function(a){var b={service:"WMTS",version:"1.0.0",request:"GetTile",styles:"",format:"image/png",spatialReference:"4326",hasTemporal:"false"},c=this.options.dataType?this.options.dataType:"ImageDataType",d=this.options.opacity>=0?this.options.opacity*100:100,e=this.options.topLevel?this.options.topLevel:0,f=this.options.bottomLevel?this.options.bottomLevel:20,g=this.options.tileFullExtent?this.options.tileFullExtent.left:-180,h=this.options.tileFullExtent?this.options.tileFullExtent.bottom:
-90,l=this.options.tileFullExtent?this.options.tileFullExtent.right:180,m=this.options.tileFullExtent?this.options.tileFullExtent.top:90,o=this.url,j=this.options.version?this.options.version:b.version,n=this.options.layer?this.options.layer:"",v=this.options.format?this.options.format:b.format,u=this.options.style?this.options.style:"",p=this.options.matrixSet?this.options.matrixSet:"",s=(this.options.projection?this.options.projection:"EPSG:4326").split(":"),r=b.spatialReference,r=s.length==2?s[1]:
s[0],b=this.options.hasTemporal?this.options.hasTemporal:b.hasTemporal,c='{"DataType":"'+c+'","DataSourceType":"WMTS","StartLevel":'+e+',"EndLevel":'+f+',"XMin":'+g+',"YMin":'+h+',"XMax":'+l+',"YMax":'+m+',"SpatialReference":"'+r+'","RenderTransparency":'+d+',"HasTemporal":"'+b+'","ServerUrl":"'+o+'","Version":"'+j+'","Layers":"'+n+'","Styles":"'+u+'","ImageFormat":"'+v+'","TileMatrixSet":"'+p;c+='"}';Geo.View3D.Layer.prototype.setMap.apply(this,[a]);n=this.dataSourceBox.CreateLayerFromJson(c);this.layerBox.UserGroupLayer.AddLayer(n);
this.layerBox.EnableTemporal=b;this._layerData=n},changeTemporal:function(a){this.layerBox.ChangeTemporal(a)},removeMap:function(){var a=this.map;a&&a._removeLayerData(this._layerData);this.map=null},display:function(a){var b=this.map;this._layerData&&a!=this._layerData.Visible&&b._setLayerVisibility(this._layerData,a)},gotoCenter:function(){var a=this.map;a&&this._layerData&&a._gotoLayer(this._layerData)},setOpacity:function(a){Geo.View3D.Layer.prototype.setOpacity.apply(a);var b=this.map;if(b&&
this._layerData)b._setLayerOpacity(this._layerData,a),this.opacity=a},showHistory:function(a,b,c){var d=this.map;if(d){d=d.activexObj.SceneBox.TemporalRuler;if(b)d.LocationX=b;if(c)d.LocationY=c;d.Visible=a}},CLASS_NAME:"Geo.View3D.Layer.WMTS"});
Geo.View3D.Layer.WTFS=Geo.Class(Geo.View3D.Layer.GlobeTile,{id:null,url:null,_LAYER_TYPE_GLOBETILE:6,_layerData:null,_oldLoad:null,initialize:function(a,b,c){if(arguments.length<3)this._oldLoad=!0;else{c=c||{};c.pyramid=c.pyramid?c.pyramid:new Geo.Pyramid;if(c.maxResolution)c.bottomLevel=c.pyramid.getLevelForResolution(c.maxResolution);if(c.minResolution)c.topLevel=c.pyramid.getLevelForResolution(c.minResolution);if(c.maxScale)c.bottomLevel=c.pyramid.getLevelForScale(c.maxScale);if(c.minScale)c.topLevel=
c.pyramid.getLevelForScale(c.minScale);if(typeof c.projection=="string")this.projection=new Geo.Projection(c.projection);if(this.projection&&this.projection.getUnits())this.units=this.projection.getUnits()}Geo.View3D.Layer.prototype.initialize.apply(this,[a,c]);this.url=b},setMap:function(a){this._oldLoad?this._oldSetMap(a):(this._createLayerFromJson(a),this.display(this.visibility))},_oldSetMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);this._layerData=a._addGlobeTileService(this.url,
"",this._LAYER_TYPE_GLOBETILE)},_createLayerFromJson:function(a){var b={version:"1.1.1",request:"GetTile",styles:"",format:"image/png",spatialReference:"4326"},c=this.options.opacity>=0?this.options.opacity*100:100,d=this.options.topLevel?this.options.topLevel:0,e=this.options.bottomLevel?this.options.bottomLevel:20,f=this.options.maxExtent?this.options.maxExtent.left:-180,g=this.options.maxExtent?this.options.maxExtent.bottom:-90,h=this.options.maxExtent?this.options.maxExtent.right:180,l=this.options.maxExtent?
this.options.maxExtent.top:90,m=this.url,o=this.options.version?this.options.version:b.version,j=(this.options.projection?this.options.projection:"EPSG:4326").split(":"),b=b.spatialReference,b=j.length==2?j[1]:j[0],c='{"DataType":"POIDataType","DataSourceType":"GeoTile","StartLevel":'+d+',"EndLevel":'+e+',"XMin":'+f+',"YMin":'+g+',"XMax":'+h+',"YMax":'+l+',"SpatialReference":"'+b+'","RenderTransparency":'+c+',"ServerUrl":"'+m+'","Version":"'+o;c+='"}';Geo.View3D.Layer.prototype.setMap.apply(this,
[a]);a=this.dataSourceBox.CreateLayerFromJson(c);this.layerBox.UserGroupLayer.AddLayer(a);this._layerData=a},CLASS_NAME:"Geo.View3D.Layer.WTFS"});
Geo.View3D.Layer.Solid=Geo.Class(Geo.View3D.Layer,{geometry:null,height:null,faceColor:null,_localDataBox:null,_layerData:null,initialize:function(a,b,c,d){this.faceColor={Color:-13660459,Size:200};this.geometry=b;this.height=c;Geo.View3D.Layer.prototype.initialize.apply(this,[a,d])},_getSolidSymbol:function(){this._localDataBox=this._drawBox.CreateSymbolObject(1);this._localDataBox.Color=this.faceColor.Color;this._localDataBox.Box=this._drawBox.CreateGeometryObject("","",5,1);this._localDataBox.Size=
this.faceColor.Size;return this._localDataBox},setMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);this._drawBox=this.map.activexObj.DrawBox;this._layerData=this._createBoxLayer(this.geometry,this.height)},removeMap:function(){this.map&&this._clearBoxLayer();this.map=null},setHeight:function(a){if(this._localDataBox&&a)this._localDataBox.Box.Width=a},setFaceColor:function(a){this.faceColor=OpenLayers.Util.extend(this.faceColor,a);if(this.faceColor.top)this._localDataBox.Color=Geo.Util.ToArgb(this.faceColor.top,
255);else if(this.faceColor.bottom)this._localDataBox.Color=Geo.Util.ToArgb(this.faceColor.bottom,255);else if(this.faceColor.round)this._localDataBox.Color=Geo.Util.ToArgb(this.faceColor.round,255)},_createBoxLayer:function(a,b){var c=a.getBounds().getCenterLonLat(),d=(new Geo.Geometry.Point(c.lon,c.lat)).toString(),e=d.indexOf("(")+1,f=d.indexOf(")");this._layerData=this._drawBox.CreateGeometryObject("POINT("+d.slice(e,f)+" "+b+")","",1,1);this._drawBox.AddDrawObject(this._layerData,this._getSolidSymbol());
this.map.activexObj.SceneBox.ParabolaFlyTo(c.lon,c.lat,1E3);return this._layerData},_clearBoxLayer:function(){this._drawBox.RemoveObject(this._layerData);this._layerData=null},_getPointsThreeDegreeSpaceSplitStr:function(a,b){for(var c=a.components[0].components,d=[],e=0;e<c.length;e++)d.push(c[e].x),d.push(c[e].y),d.push(b);return d.join(" ")},CLASS_NAME:"Geo.View3D.Layer.Solid"});
Geo.View3D.Layer.WCS=Geo.Class(Geo.View3D.Layer.GlobeTile,{setMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);this._layerData=a._addWCSService(this.url);this.display(this.visibility)},CLASS_NAME:"Geo.View3D.Layer.WCS"});
Geo.View3D.Layer.Grid=Geo.Class(Geo.View3D.Layer,{id:null,topLevel:0,buttomLevel:0,maxExtent:null,dataType:"ImageDataType",url:null,pyramid:null,spatialReference:"4326",dataSourceType:"Customer",height:300,_layerData:null,initialize:function(a,b,c){Geo.View3D.Layer.prototype.initialize.apply(this,[a,c]);this.url=b;c=c||{};this.topLevel=c.topLevel?c.topLevel:this.topLevel;this.buttomLevel=c.buttomLevel?c.buttomLevel:this.buttomLevel;this.maxExtent=c.maxExtent?c.maxExtent:new Geo.Bounds(-180,-90,180,
90);this.dataType=c.dataType?c.dataType:this.dataType;this.pyramid=c.pyramid?c.pyramid:"";this.spatialReference=c.spatialReference?c.spatialReference:this.spatialReference;this.dataSourceType=c.dataSourceType?c.dataSourceType:this.dataSourceType;this.height=c.height?c.height:this.height},setMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);this._layerData=this.map.activexObj.DataSourceBox.CreateLayerFromJson('{"DataType":"'+this.dataType+'","DataSourceType":"'+this.dataSourceType+
'","StartLevel":'+this.topLevel+',"EndLevel":'+this.buttomLevel+',"XMin":'+this.maxExtent.left+',"YMin":'+this.maxExtent.bottom+',"XMax":'+this.maxExtent.right+',"YMax":'+this.maxExtent.top+',"SpatialReference":"'+this.spatialReference+'","ServerUrl":"'+this.url+'"}');this.map.activexObj.LayerBox.UserGroupLayer.AddLayer(this._layerData);this.display(this.visibility)},removeMap:function(){var a=this.map;if(a)a._removeLayerData(this._layerData),this._layerData=null;this.map=null},setVisibility:function(a){if(a!=
this.visibility)this.visibility=a,this.display(a)},display:function(a){this._layerData&&a!=this._layerData.Visible&&this.map._setLayerVisibility(this._layerData,a)},setOpacity:function(a){Geo.View3D.Layer.prototype.setOpacity.apply(a);var b=this.map;if(b)b._setLayerOpacity(this._layerData,a),this.opacity=a},gotoCenter:function(){var a=this.map;a&&a._gotoLayer(this._layerData)},CLASS_NAME:"Geo.View3D.Layer.Grid"});
Geo.View3D.Layer.Model=Geo.Class(Geo.View3D.Layer.Grid,{_oldLoad:null,enumLayerPropertyName:{layerName:0,layerVisible:1,layerTransparency:2,layerFullEnvelope:3,wmslayerInfo:4,wmtslayerInfo:5,EnableSelection:6,lodDistanceFactor:7,stereoModelColor:8,modelHeightOffset:9},initialize:function(a,b,c){c=c||{};if(typeof c.layerType=="undefined")this._oldLoad=!0,Geo.View3D.Layer.GlobeTile.prototype.initialize.apply(this,[a,b,c]);else{c.pyramid=c.pyramid?c.pyramid:new Geo.Pyramid;if(c.maxResolution)c.bottomLevel=
c.pyramid.getLevelForResolution(c.maxResolution);if(c.minResolution)c.topLevel=c.pyramid.getLevelForResolution(c.minResolution);if(c.maxScale)c.bottomLevel=c.pyramid.getLevelForScale(c.maxScale);if(c.minScale)c.topLevel=c.pyramid.getLevelForScale(c.minScale);if(typeof c.projection=="string")this.projection=new Geo.Projection(c.projection);if(this.projection&&this.projection.getUnits())this.units=this.projection.getUnits();Geo.View3D.Layer.prototype.initialize.apply(this,[a,c])}this.url=b},setMap:function(a){this._oldLoad?
this._oldSetMap(a):(this._createLayerFromJson(a),this.display(this.visibility))},_oldSetMap:function(a){Geo.View3D.Layer.prototype.setMap.apply(this,[a]);this._layerData=a._addGlobeTileService(this.url,"",this._LAYER_TYPE_GLOBETILE)},_createLayerFromJson:function(a){var b={version:"5.0",request:"GetTile",styles:"",format:"image/png",spatialReference:"4326"},c=this.options.opacity>=0?this.options.opacity*100:100,d=this.options.topLevel?this.options.topLevel:0,e=this.options.bottomLevel?this.options.bottomLevel:
20,f=this.options.maxExtent?this.options.maxExtent.left:-180,g=this.options.maxExtent?this.options.maxExtent.bottom:-90,h=this.options.maxExtent?this.options.maxExtent.right:180,l=this.options.maxExtent?this.options.maxExtent.top:90,m=this.url,o=this.options.version?this.options.version:b.version,j=(this.options.projection?this.options.projection:"EPSG:4326").split(":"),b=b.spatialReference,b=j.length==2?j[1]:j[0],c='{"Layer" : "ModelLayer","LayerDataType" : "Model","LayerName" : "JIYUDOUBLE","DataSet" : "CommonTileDataSet","SpatialReference" : "'+
b+'","Render" : "LODModelRender","TileSource" : "TMSTileSource","Priority" : 1,"UriRules" : "GeoTileUriRules","RenderTransparency" : '+c+',"DataSetStartLevel" : '+d+',"DataSetEndLevel" : '+e+',"Pyramid" : "","XMin" : '+f+',"YMin" : '+g+',"XMax" : '+h+',"YMax" : '+l+',"Uris" : [{"ServerUrl" : "'+m+'","StartLevel" : '+d+',"EndLevel" : '+e+',"Version" : "'+o+'","TimeStamp" : "","XMin" : '+f+',"YMin" : '+g+',"XMax" : '+h+',"YMax" : '+l+',"Layers" : null,"Styles" : null,"ImageFormat" : null,"TileMatrixSet" : null,"CRS" : null,"RelativeLevel" : false,"Pyramid" : null,"HasTemporal" : false}]}';
Geo.View3D.Layer.prototype.setMap.apply(this,[a]);a=this.dataSourceBox.CreateLayerFromJson(c);this.layerBox.UserGroupLayer.AddLayer(a);this._layerData=a},modelHeightOffset:function(a){map.activexObj.LayerBox.CreateLayerOperate(this._layerData).ChangeLayerProperty(this.enumLayerPropertyName.modelHeightOffset,a)},lodDistanceFactor:function(a){var b=map.activexObj.LayerBox.CreateLayerOperate(this._layerData);switch(a){case 0:b.ChangeLayerProperty(this.enumLayerPropertyName.lodDistanceFactor,0.6);break;
case 1:b.ChangeLayerProperty(this.enumLayerPropertyName.lodDistanceFactor,1);break;case 2:b.ChangeLayerProperty(this.enumLayerPropertyName.lodDistanceFactor,1.5)}},CLASS_NAME:"Geo.View3D.Layer.Model"});
Geo.View3D.Event.KeyEvent={KEY_SPACE:32,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PLUS:187,KEY_MINUS:189,KEY_NUM_PLUS:107,KEY_NUM_MINUS:109,isKeyDown:function(a){if(a.EventType===6)return!0},isKeyUp:function(a){if(a.EventType===7)return!0},isKeyboardDown:function(a){if(a.keyState===0)return!0},isKeyboardUp:function(a){if(a.keyState===1)return!0},CLASS_NAME:"Geo.View3D.Event.KeyEvent"};
Geo.View3D.Event.MouseEvent={isMousemove:function(a){if(a.MouseButton===0&&a.MouseState===3)return!0},isMouseDown:function(a){if(a.MouseButton===1&&a.MouseState===0)return!0},isLeftClick:function(a){if(a.MouseButton!==1||a.MouseState!==1)return!1;if(Geo.View3D.Event.MouseEvent._mouseDownPos){var b=Math.abs(Geo.View3D.Event.MouseEvent._mouseDownPos.y-a.ScreenY),c=Geo.View3D.Event.MouseEvent.pixelTolerance;if(Math.abs(Geo.View3D.Event.MouseEvent._mouseDownPos.x-a.ScreenX)>c||b>c)return!1}return!0},
isMouseUp:function(a){if(a.MouseButton===1&&a.MouseState===1)return!0},isMouseDownMove:function(a){if(a.MouseButton===1&&a.MouseState===3)return!0},isMouseLeftDoubleClick:function(a){if(a.MouseButton===1&&a.MouseState===4)return!0},isMouseRightDown:function(a){if(a.MouseButton===2&&a.MouseState===0)return!0},isRightClick:function(a){if(a.MouseButton===2&&a.MouseState===1)return!0},isMouseRightUp:function(a){if(a.MouseButton===2&&a.MouseState===1)return!0},isMouseRightDownMove:function(a){if(a.MouseButton===
2&&a.MouseState===3)return!0},isMouseRightDoubleClick:function(a){if(a.MouseButton===2&&a.MouseState===4)return!0},isMouseWheel:function(a){if(a.MouseButton===0&&a.MouseState===5)return!0},isMouseOut:function(a){if(a.MouseButton===0&&a.MouseState===6)return!0},isMouseOver:function(a){if(a.MouseButton===0&&a.MouseState===7)return!0},isMouseRightUp:function(a){if(a.MouseButton===2&&a.MouseState===1)return!0},getMouseScreen:function(a){return{x:a.ScreenX,y:a.ScreenY}},getMouseLocation:function(a){return{lon:a.X,
lat:a.Y,alt:a.Altitude}},isMoveStart:function(a){if(a.MouseButton===1&&a.MouseState===0)return!0},isMove:function(a){if(a.MouseButton===1&&a.MouseState===3)return!0},isMoveEnd:function(a){if(a.MouseButton===1&&a.MouseState===1)return!0},isZoomEnd:function(a){if(a.MouseButton===0&&a.MouseState===5)return!0},KEY_SPACE:32,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PLUS:187,KEY_MINUS:189,CLASS_NAME:"Geo.View3D.Event.MouseEvent"};
Geo.View3D.Handler=Geo.Class({id:null,active:!1,control:null,map:null,initialize:function(a,b,c){OpenLayers.Util.extend(this,c);this.control=a;this.callbacks=b;(a=this.map||a.map)&&this.setMap(a);this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},setMap:function(a){if(a)this.map=a,this.map.handlers.push(this)},callback:function(a,b){a&&this.callbacks[a]&&this.callbacks[a].apply(this.control,b)},listener:function(){},activate:function(){if(this.active)return!1;return this.active=!0},deactivate:function(){if(!this.active)return!1;
this.active=!1;return!0},destroy:function(){this.deactivate();this.map&&OpenLayers.Util.removeItem(this.map.handlers,this);this.control=this.map=null},CLASS_NAME:"Geo.View3D.Handler"});
Geo.View3D.Handler.Box=Geo.Class(Geo.View3D.Handler,{bbox:null,initialize:function(){Geo.View3D.Handler.prototype.initialize.apply(this,arguments)},listener:function(a){if(a.MouseState==0||Geo.View3D.Event.MouseEvent.isRightClick(a))this.bbox=a.Longitude+","+a.Latitude;else{if(a.MouseState==2)this.bbox=this.bbox+","+a.Longitude+","+a.Latitude;a=this.bbox.split(",");this.callback("emitMouseHandler",[a[0]+","+a[3]+","+a[2]+","+a[1]])}},activate:function(){if(!Geo.View3D.Handler.prototype.activate.apply(this,
arguments))return!1;this.map.activexObj.CurrentOpState=2;return!0},deactivate:function(){if(!Geo.View3D.Handler.prototype.deactivate.apply(this,arguments))return!1;this.map.activexObj.CurrentOpState=0;return!0},CLASS_NAME:"Geo.View3D.Handler.Box"});
Geo.View3D.Handler.KeybordDefaults=Geo.Class(Geo.View3D.Handler,{listener:function(a){if(a.keyCode==Geo.View3D.Event.KeyEvent.KEY_SPACE)this.onKeySpace(a);if(a.keyCode==Geo.View3D.Event.KeyEvent.KEY_LEFT)this.onKeyLeft(a);if(a.keyCode==Geo.View3D.Event.KeyEvent.KEY_UP)this.onKeyUp(a);if(a.keyCode==Geo.View3D.Event.KeyEvent.KEY_RIGHT)this.onKeyRight(a);if(a.keyCode==Geo.View3D.Event.KeyEvent.KEY_DOWN)this.onKeyDown(a);if(a.keyCode==Geo.View3D.Event.KeyEvent.KEY_PLUS)this.onKeyPlus(a);if(a.keyCode==
Geo.View3D.Event.KeyEvent.KEY_MINUS)this.onKeyMinus(a);if(a.keyCode==Geo.View3D.Event.KeyEvent.KEY_NUM_PLUS)this.onKeyPlus(a);if(a.keyCode==Geo.View3D.Event.KeyEvent.KEY_NUM_MINUS)this.onKeyMinus(a)},onKeySpace:function(){},onKeyLeft:function(){},onKeyUp:function(){},onKeyRight:function(){},onKeyDown:function(){},onKeyPlus:function(){},onKeyMinus:function(){},CLASS_NAME:"Geo.View3D.Handler.KeybordDefaults"});
Geo.View3D.Handler.Mouse=Geo.Class(Geo.View3D.Handler,{initialize:function(){Geo.View3D.Handler.prototype.initialize.apply(this,arguments)},listener:function(a){Geo.View3D.Event.MouseEvent.isLeftClick(a)&&this.callback("click",[a]);Geo.View3D.Event.MouseEvent.isMousemove(a)&&this.callback("mouseMove",[a]);Geo.View3D.Event.MouseEvent.isMouseOut(a)&&this.callback("mouseOut",[a]);Geo.View3D.Event.MouseEvent.isMouseOver(a)&&this.callback("mouseOver",[a]);Geo.View3D.Event.MouseEvent.isRightClick(a)&&this.callback("rightClick",
[a]);Geo.View3D.Event.MouseEvent.isMouseLeftDoubleClick(a)&&this.callback("dblclick",[a]);Geo.View3D.Event.MouseEvent.isMouseUp(a)&&this.callback("mouseUp",[a]);Geo.View3D.Event.MouseEvent.isMouseDown(a)&&this.callback("mouseDown",[a]);Geo.View3D.Event.MouseEvent.isMouseWheel(a)&&this.callback("mouseWheel",[a]);Geo.View3D.Event.MouseEvent.isMouseRightUp(a)&&this.callback("mouseRightUp",[a]);Geo.View3D.Event.MouseEvent.isMoveStart(a)&&this.callback("movestart",[a]);Geo.View3D.Event.MouseEvent.isMove(a)&&
this.callback("move",[a]);Geo.View3D.Event.MouseEvent.isMoveEnd(a)&&this.callback("moveend",[a]);Geo.View3D.Event.MouseEvent.isZoomEnd(a)&&this.callback("zoomend",[a])},CLASS_NAME:"Geo.View3D.Handler.Mouse"});
Geo.View3D.Handler.ModelChoose=Geo.Class(Geo.View3D.Handler,{initialize:function(){Geo.View3D.Handler.prototype.initialize.apply(this,arguments)},listener:function(a){var b=!1;if(this.map&&this.map.activexObj&&a.MouseButton==1&&a.MouseState==1){for(var b=null,c=this.map.layers,d=0;d<c.length;d++)c[d]instanceof Geo.View3D.Layer.Model&&(b=c[d]);if(null!=b&&void 0!=b)this.map.activexObj.LayerBox.CreateLayerOperate(b._layerData).ChangeLayerProperty(6,!0),this.map.activexObj.SelectionBox.EnableSelection=
!0;this.map.activexObj.SelectionBox.SelectByScreenPoint(a.ScreenX,a.ScreenY);this.callback("chooseModel",[a,!0])}},activate:function(){if(!Geo.View3D.Handler.prototype.activate.apply(this,arguments))return!1;return!0},deactivate:function(){if(!Geo.View3D.Handler.prototype.deactivate.apply(this,arguments))return!1;return!0},CLASS_NAME:"Geo.View3D.Handler.ModelChoose"});
Geo.View3D.Handler.Point=Geo.Class(Geo.View3D.Handler,{point:null,layer:null,persist:!1,layerOptions:null,initialize:function(a,b){if(!b||!b.layerOptions||!b.layerOptions.styleMap)this.style=OpenLayers.Util.extend(Geo.Feature.Vector.style["default"],{});Geo.View3D.Handler.prototype.initialize.apply(this,arguments)},listener:function(a){if(!Geo.View3D.Event.KeyEvent.isKeyDown(a)&&!Geo.View3D.Event.KeyEvent.isKeyUp(a)&&!Geo.View3D.Event.MouseEvent.isMousemove(a)){var b=a.X,c=a.Y;Geo.View3D.Event.MouseEvent.isMouseDown(a)&&
this.createFeature(new Geo.LonLat(b,c));Geo.View3D.Event.MouseEvent.isMouseUp(a)&&(this.persist&&this.layer.destroyFeatures(),this.callback("done",[this.point.geometry.clone()]))}},activate:function(){if(!Geo.View3D.Handler.prototype.activate.apply(this,arguments))return!1;var a=OpenLayers.Util.extend({displayInLayerSwitcher:!1,isOnTop:!0},this.layerOptions);this.layer=new Geo.View3D.Layer.Vector(this.CLASS_NAME,a);this.map.addLayer(this.layer);return!0},createFeature:function(a){this.point=new Geo.Feature.Vector(new Geo.Geometry.Point(a.lon,
a.lat));this.point.geometry.clearBounds();this.layer.addFeatures([this.point],{silent:!0})},deactivate:function(){if(!Geo.View3D.Handler.prototype.deactivate.apply(this,arguments))return!1;this.destroyFeature();this.layer.map!=null&&this.layer.destroy(!1);this.layer=null;return!0},destroyFeature:function(){this.layer&&this.layer.destroyFeatures();this.point=null},_setGeoRaster:function(){this.map._geoRaster.GeoRasterType=1;this.map.activexObj.SetPickedState(!0)},CLASS_NAME:"Geo.View3D.Handler.Point"});
Geo.View3D.Handler.Path=Geo.Class(Geo.View3D.Handler,{point:null,line:null,layer:null,persist:!1,layerOptions:null,_isDone:!1,initialize:function(a,b){if(!b||!b.layerOptions||!b.layerOptions.styleMap)this.style=OpenLayers.Util.extend(Geo.Feature.Vector.style["default"],{});Geo.View3D.Handler.prototype.initialize.apply(this,arguments)},listener:function(a){if(!Geo.View3D.Event.KeyEvent.isKeyDown(a)&&!Geo.View3D.Event.KeyEvent.isKeyUp(a)&&!Geo.View3D.Event.MouseEvent.isMousemove(a)){if(Geo.View3D.Event.MouseEvent.isLeftClick(a)){if(this._isDone)this.line=
null,this._isDone=!1;this.addPoint(new Geo.LonLat(a.X,a.Y));this.callback("point",[this.point.geometry,this.line.geometry])}Geo.View3D.Event.MouseEvent.isMouseLeftDoubleClick(a)&&this.handleDouble()}},activate:function(){if(!Geo.View3D.Handler.prototype.activate.apply(this,arguments))return!1;var a=OpenLayers.Util.extend({displayInLayerSwitcher:!1,isOnTop:!0},this.layerOptions);this.layer=new Geo.View3D.Layer.Vector(this.CLASS_NAME,a);this.map.addLayer(this.layer);return!0},addPoint:function(a){this.point=
new Geo.Feature.Vector(new Geo.Geometry.Point(a.lon,a.lat));this.point.geometry.clearBounds();this.line?(a=this.line.geometry.components,a.push(this.point.geometry),a=new Geo.Geometry.LineString(a)):a=new Geo.Geometry.LineString([this.point.geometry]);this.layer.removeFeatures(this.line);this.line=new Geo.Feature.Vector(a);this.layer.addFeatures([this.line],{silent:!0})},createFeature:function(a){this.point=new Geo.Feature.Vector(new Geo.Geometry.Point(a.lon,a.lat));this.point.geometry.clearBounds();
this.layer.addFeatures([this.point],{silent:!0})},deactivate:function(){if(!Geo.View3D.Handler.prototype.deactivate.apply(this,arguments))return!1;this.destroyFeature();this.layer.map!=null&&this.layer.destroy(!1);this.layer=null;return!0},destroyFeature:function(){this.layer&&this.layer.destroyFeatures();this.line=this.point=null},_setGeoRaster:function(){this.map._geoRaster.GeoRasterType=1;this.map.activexObj.SetPickedState(!0)},handleDouble:function(){if(this.timerId)window.clearTimeout(this.timerId),
this.timerId=null;this.timerId=window.setTimeout(OpenLayers.Function.bind(function(){this.timerId=null;this.finishGeometry()},this),300)},finishGeometry:function(){this._isDone=!0;this.persist&&this.layer.destroyFeatures();this.line&&this.callback("done",[this.line.geometry.clone()])},CLASS_NAME:"Geo.View3D.Handler.Path"});
Geo.View3D.Handler.Polygon=Geo.Class(Geo.View3D.Handler,{_points:[],point:null,polygon:null,layer:null,persist:!1,checkSelfCross:!0,_isDone:!1,layerOptions:null,initialize:function(a,b){if(!b||!b.layerOptions||!b.layerOptions.styleMap)this.style=OpenLayers.Util.extend(Geo.Feature.Vector.style["default"],{});Geo.View3D.Handler.prototype.initialize.apply(this,arguments)},listener:function(a){if(!Geo.View3D.Event.KeyEvent.isKeyDown(a)&&!Geo.View3D.Event.KeyEvent.isKeyUp(a)&&!Geo.View3D.Event.MouseEvent.isMousemove(a)){if(Geo.View3D.Event.MouseEvent.isLeftClick(a)){if(this._isDone)this.polygon=
null,this._isDone=!1;var b=a.X,c=a.Y;this._points.push(new Geo.Geometry.Point(b,c));var d=new Geo.Geometry.LinearRing(this._points);new Geo.Geometry.Polygon([d]);this.addPoint(new Geo.LonLat(b,c));this.callback("point",[this.point.geometry,this.polygon.geometry])}Geo.View3D.Event.MouseEvent.isMouseLeftDoubleClick(a)&&this.handleDouble()}},activate:function(){if(!Geo.View3D.Handler.prototype.activate.apply(this,arguments))return!1;var a=OpenLayers.Util.extend({displayInLayerSwitcher:!1,isOnTop:!0},
this.layerOptions);this.layer=new Geo.View3D.Layer.Vector(this.CLASS_NAME,a);this.map.addLayer(this.layer);return!0},addPoint:function(a){this.point=new Geo.Feature.Vector(new Geo.Geometry.Point(a.lon,a.lat));this.point.geometry.clearBounds();this.polygon?(a=this.polygon.geometry.components[0].components,a.push(this.point.geometry),a=new Geo.Geometry.LinearRing(a)):a=new Geo.Geometry.LinearRing([this.point.geometry]);a=new Geo.Geometry.Polygon([a]);this.layer.removeFeatures(this.polygon);this.polygon=
new Geo.Feature.Vector(a);this.layer.addFeatures([this.polygon],{silent:!0})},createFeature:function(a){this.point=new Geo.Feature.Vector(new Geo.Geometry.Point(a.lon,a.lat));this.point.geometry.clearBounds();this.layer.addFeatures([this.point],{silent:!0})},deactivate:function(){if(!Geo.View3D.Handler.prototype.deactivate.apply(this,arguments))return!1;this.destroyFeature();this.layer.map!=null&&this.layer.destroy(!1);this.layer=null;return!0},destroyFeature:function(){this.layer&&this.layer.destroyFeatures();
this.polygon=this.point=null},_setGeoRaster:function(){this.map._geoRaster.GeoRasterType=1;this.map.activexObj.SetPickedState(!0)},_checkSelfCross:function(a){return this.map.activexObj.SetTerrainAnalysisParam(this._getPointsSpaceSplitStr(a),0,-1)},_getPointsSpaceSplitStr:function(a){for(var a=a.components[0].components,b=[],c=0;c<a.length;c++)b.push(a[c].x),b.push(a[c].y);return b.join(" ")},handleDouble:function(){if(this.timerId)window.clearTimeout(this.timerId),this.timerId=null;this.timerId=
window.setTimeout(OpenLayers.Function.bind(function(){this.timerId=null;this.finishGeometry()},this),300)},finishGeometry:function(){this._isDone=!0;this._points=[];this.persist&&this.layer.destroyFeatures();this.polygon&&this.callback("done",[this.polygon.geometry.clone()])},CLASS_NAME:"Geo.View3D.Handler.Polygon"});
Geo.View3D.Handler.Feature=Geo.Class(Geo.View3D.Handler,{_feature:null,_isEnableLayerSelect:!1,initialize:function(a){Geo.View3D.Handler.prototype.initialize.apply(this,arguments);this.control=a},listener:function(a){var b=this.control;this._enableLayerSelect();var c=this._getFeatureIdFromScreen(a.ScreenX,a.ScreenY),d=b._getFeatureFromId(c);if(b.hover&&Geo.View3D.Event.MouseEvent.isMousemove(a)){if(c&&this._feature!==c)b.select(d),this._feature=c;if(!c&&this._feature)b.unselect(d),this._feature=null}if(Geo.View3D.Event.MouseEvent.isLeftClick(a)&&
c)b.select(d),this._feature=c;if(b.moveMapPopupClose==!0&&Geo.View3D.Event.MouseEvent.isMouseDownMove(a)&&!c&&this._feature)b.unselect(d),this._feature=null;if(b.moveMapPopupClose==!1&&Geo.View3D.Event.MouseEvent.isLeftClick(a)&&!c&&this._feature)b.unselect(d),this._feature=null},_enableLayerSelect:function(){if(!this._isEnableLayerSelect){var a=this.control,b=a.map.activexObj,a=a.layer;b.SelectionBox.EnableSelection=!0;b.LayerBox.CreateLayerOperate(a._dynamicLayer).ChangeLayerProperty(6,!0);b.LayerBox.CreateLayerOperate(a._layerData).ChangeLayerProperty(6,
!0);this._isEnableLayerSelect=!0}},_getFeatureIdFromScreen:function(a,b){var c=!1,d=this.control.map.activexObj;d.SelectionBox.SelectByScreenPoint(a,b);if(d.SelectionBox.Count==0)return c;(d=d.SelectionBox.QuerySelectedObject(0))&&(c=null==d.POIID||void 0==d.POIID?d.Key:d.POIGUID);return c},CLASS_NAME:"Geo.View3D.Handler.Feature"});
Geo.View3D.Handler.Keyboard=Geo.Class(Geo.View3D.Handler,{initialize:function(){Geo.View3D.Handler.prototype.initialize.apply(this,arguments)},listener:function(a){Geo.View3D.Event.KeyEvent.isKeyboardDown(a)&&this.callback("keyboardDown",[a]);Geo.View3D.Event.KeyEvent.isKeyboardUp(a)&&this.callback("keyboardUp",[a])},CLASS_NAME:"Geo.View3D.Handler.Keyboard"});
Geo.View3D.Control=Geo.Class({id:null,autoActivate:!1,active:!1,handler:null,eventListeners:null,events:null,EVENT_TYPES:["activate","deactivate"],map:null,initialize:function(a){OpenLayers.Util.extend(this,a);this.events=new OpenLayers.Events(this,null,this.EVENT_TYPES);if(this.eventListeners instanceof Object)this.events.on(this.eventListeners);if(this.id==null)this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},setMap:function(a){this.map=a;this.handler&&this.handler.setMap(a)},draw:function(){},
listener:function(){},activate:function(){if(this.active)return!1;this.handler&&this.handler.activate();this.active=!0;this.events.triggerEvent("activate");return!0},deactivate:function(){if(this.active)return this.handler&&this.handler.deactivate(),this.active=!1,this.events.triggerEvent("deactivate"),!0;return!1},destroy:function(){if(this.events)this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy(),this.events=null;this.eventListeners=null;if(this.handler)this.handler.destroy(),
this.handler=null;if(this.handlers){for(var a in this.handlers)this.handlers.hasOwnProperty(a)&&typeof this.handlers[a].destroy=="function"&&this.handlers[a].destroy();this.handlers=null}if(this.map)this.map.removeControl(this),this.map=null},CLASS_NAME:"Geo.View3D.Control"});
Geo.View3D.Control.KeyboardDefaults=Geo.Class(Geo.View3D.Control,{autoActivate:!0,delta:0,initialize:function(){Geo.View3D.Control.prototype.initialize.apply(this,arguments);this.handler=new Geo.View3D.Handler.KeybordDefaults(this,null,{onKeySpace:OpenLayers.Function.bind(this.resetNorth,this),onKeyLeft:OpenLayers.Function.bind(this.panLeft,this),onKeyUp:OpenLayers.Function.bind(this.panUp,this),onKeyRight:OpenLayers.Function.bind(this.panRight,this),onKeyDown:OpenLayers.Function.bind(this.panDown,
this),onKeyPlus:OpenLayers.Function.bind(this.zoomIn,this),onKeyMinus:OpenLayers.Function.bind(this.zoomOut,this)})},resetNorth:function(){this.map&&this.map.resetNorth()},panLeft:function(){this.pan("left")},panUp:function(){this.pan("up")},panRight:function(){this.pan("right")},panDown:function(){this.pan("down")},pan:function(a){var b=this.delta,c=this.map.activexObj.Camera;switch(a){case "left":c.Pan(-b,0);break;case "up":c.Pan(0,b);break;case "right":c.Pan(b,0);break;case "down":c.Pan(0,-b)}},
zoomIn:function(){var a=this.map;a&&a.zoomIn()},zoomOut:function(){var a=this.map;a&&a.zoomOut()},CLASS_NAME:"Geo.View3D.Control.KeyboardDefaults"});
Geo.View3D.Control.Measure=Geo.Class(Geo.View3D.Control,{serviceUrl:null,layerLevel:null,layerName:null,failFn:null,_terrainAnalysisService:null,handlerType:null,handlerOptions:null,_points:null,_result:null,callbacks:null,initialize:function(a,b){Geo.View3D.Control.prototype.initialize.apply(this,[b]);this.serviceUrl=a;this._terrainAnalysisService=new Geo.Service.TAS(this.id+"_service",a);this.callbacks=OpenLayers.Util.extend({done:this._onComplete,point:this._onAddPoint},this.callbacks);this.handlerOptions=
this.handlerOptions||{};if(this.handlerType)this.handler=new this.handlerType(this,this.callbacks,this.handlerOptions)},_isComplete:!1,onAddPoint:function(){},onComplete:function(){},_onComplete:function(){},_onAddPoint:function(){},_measureHandler:function(){},setMeasureService:function(a){if(a&&this._terrainAnalysisService)this._terrainAnalysisService.url=a},_getMeasureResult:function(a,b,c){var d={pointCount:this._terrainAnalysisService._countCoord(b.coordinates),layerLevel:this.layerLevel,layerName:this.layerName,
subjoin:0},b=OpenLayers.Util.applyDefaults(b,d);if(d=this._terrainAnalysisService)d[a](b,c,this.failFn)},activate:function(){if(Geo.View3D.Control.prototype.activate.apply(this,arguments))this.map._measureHandler=OpenLayers.Function.bind(this._measureHandler,this),this.setMeasureService(this.serviceUrl);return!0},_getPointsThreeDegreeSpaceSplitStr:function(a,b){for(var c=a.components[0].components,d=[],e=0;e<c.length;e++)d.push(c[e].x),d.push(c[e].y),d.push(b);return d.join(" ")},_getPointsSpaceSplitStr:function(a){for(var a=
a.components[0].components,b=[],c=0;c<a.length;c++)b.push(a[c].x),b.push(a[c].y);return b.join(" ")},_setMeasureParams:function(a,b,c){var d=this.map.activexObj;a!==void 0&&d.SetTerrainAnalysisParam(b,c,a)},_clearBoxLayer:function(){var a=this.map.activexObj,b=a.GetSceneGroup().GetLayerByName(this.id+"_boxLayer");b!=null&&a.GetSceneGroup().RemoveLayer(b)},_createBoxLayer:function(a){var b=this.map.activexObj.CreateAddLocalDataObj(),a=this._getPointsThreeDegreeSpaceSplitStr(a,0),c=this.id+"_boxLayer";
b.AddPolyGon(c,a).name=c;b.setPolyGonHeight(c,this.height);b.SetBoxFaceColor(c,2147483647,2147483647,2147483647)},CLASS_NAME:"Geo.View3D.Control.Measure"});
Geo.View3D.Control.DrawPath=Geo.Class(Geo.View3D.Control,{type:Geo.View2D.Control.TYPE_TOOL,handlerOptions:null,callbacks:null,initialize:function(a){Geo.View3D.Control.prototype.initialize.apply(this,[a]);this.callbacks=OpenLayers.Util.extend({done:this.done},this.callbacks);this.handlerOptions=this.handlerOptions||{};this.handler=new Geo.View3D.Handler.Path(this,this.callbacks,this.handlerOptions)},done:function(){}});
Geo.View3D.Control.DrawPoint=Geo.Class(Geo.View3D.Control,{type:Geo.View2D.Control.TYPE_TOOL,handlerOptions:null,callbacks:null,initialize:function(a){Geo.View3D.Control.prototype.initialize.apply(this,[a]);this.callbacks=OpenLayers.Util.extend({done:this.done},this.callbacks);this.handlerOptions=this.handlerOptions||{};this.handler=new Geo.View3D.Handler.Point(this,this.callbacks,this.handlerOptions)},done:function(){}});
Geo.View3D.Control.DrawPolygon=Geo.Class(Geo.View3D.Control,{type:Geo.View2D.Control.TYPE_TOOL,handlerOptions:null,callbacks:null,initialize:function(a){Geo.View3D.Control.prototype.initialize.apply(this,[a]);this.callbacks=OpenLayers.Util.extend({done:this.done},this.callbacks);this.handlerOptions=this.handlerOptions||{};this.handler=new Geo.View3D.Handler.Polygon(this,this.callbacks,this.handlerOptions)},done:function(){}});
Geo.View3D.Control.DrawFeature=Geo.Class(Geo.View3D.Control,{layer:null,callbacks:null,EVENT_TYPES:["featureadded"],featureAdded:function(){},handlerOptions:null,initialize:function(a,b,c){this.EVENT_TYPES=Geo.View3D.Control.DrawFeature.prototype.EVENT_TYPES.concat(Geo.View3D.Control.prototype.EVENT_TYPES);Geo.View3D.Control.prototype.initialize.apply(this,[c]);this.callbacks=OpenLayers.Util.extend({done:this.drawFeature},this.callbacks);this.layer=a;this.handlerOptions=this.handlerOptions||{};if(a=
this.layer.styleMap&&this.layer.styleMap.styles.temporary)this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new Geo.StyleMap({"default":a})});this.handler=new b(this,this.callbacks,this.handlerOptions)},drawFeature:function(a){a=new Geo.Feature.Vector(a);this.layer.addFeatures([a]);this.featureAdded(a);this.events.triggerEvent("featureadded",{feature:a})},CLASS_NAME:"Geo.View3D.Control.DrawFeature"});
Geo.View3D.Control.SelectFeature=Geo.Class(Geo.View3D.Control,{clickout:!0,multiple:!1,EVENT_TYPES:["beforefeaturehighlighted","featurehighlighted","featureunhighlighted"],hover:!1,moveMapPopupClose:!1,layer:null,scope:null,onBeforeSelect:function(){},onSelect:function(){},onUnselect:function(){},initialize:function(a,b){this.EVENT_TYPES=Geo.View3D.Control.SelectFeature.prototype.EVENT_TYPES.concat(Geo.View3D.Control.prototype.EVENT_TYPES);Geo.View3D.Control.prototype.initialize.apply(this,[b]);this.handler=
new Geo.View3D.Handler.Feature(this);this.layer=a},highlight:function(){},unhighlight:function(){},onSelect:function(){},destroy:function(){},setMap:function(){Geo.View3D.Control.prototype.setMap.apply(this,arguments)},select:function(a){if(!(null==a||void 0==a)){var b=this.onBeforeSelect.call(this.scope,a),c=a.layer;if(b!==!1&&(b=c.events.triggerEvent("beforefeatureselected",{feature:a}),b!==!1))this.multiple?c.selectedFeatures.push(a):c.selectedFeatures=[a],this.highlight(a),c.events.triggerEvent("featureselected",
{feature:a}),this.onSelect.call(this.scope,a)}},_getFeatureFromId:function(a){for(var b=this.layer.features,c=0;c<b.length;c++){var d=b[c];if(d.id===a)return d}},unselect:function(a){if(!(null==a||void 0==a)){var b=a.layer;this.unhighlight(a);OpenLayers.Util.removeItem(b.selectedFeatures,a);this.onUnselect.call(this.scope,a)}},unselectAll:function(){for(var a=this.layer.selectedFeatures.length-1;a>=0;--a);},CLASS_NAME:"Geo.View3D.Control.SelectFeature"});
Geo.View3D.Control.Attribution=Geo.Class(Geo.View3D.Control,{separator:",",style:{startX:10,startY:10,endX:300,endY:300,fontSize:20,fontFamily:"\u96c5\u9ed1",opacity:255,colorR:255,colorG:255,colorB:0},initialize:function(){Geo.View3D.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.deactivate();this.removeTextElement();Geo.View3D.Control.prototype.destroy.apply(this,arguments)},setMap:function(){Geo.View3D.Control.prototype.setMap.apply(this,arguments)},draw:function(){Geo.View3D.Control.prototype.draw.apply(this,
arguments);this.map.events.on({loadlayergroup:this.updateAttribution,scope:this});this.updateAttribution()},removeTextElement:function(){var a=null;if(this.map)(a=this.map.activexObj)&&a.ScreenBox.RemoveTextElement(this.id)},updateAttribution:function(){if(this.map&&this.map.activexObj){var a=this.map.activexObj,b=[];if(this.map.layers){for(var c=0,d=this.map.layers.length;c<d;c++){var e=this.map.layers[c];e.attribution&&e.getVisibility()&&OpenLayers.Util.indexOf(b,e.attribution)===-1&&b.push(e.attribution)}b=
b.join(this.separator);a.ScreenBox.AppendTextElement(this.id,b,this.style.fontFamily,this.style.fontSize,this.style.colorR+","+this.style.colorG+","+this.style.colorB,this.style.startX,this.style.startY,this.style.endX,this.style.endY)}}},CLASS_NAME:"Geo.View3D.Control.Attribution"});
Geo.View3D.Control.Box=Geo.Class(Geo.View3D.Control,{handlerOptions:null,callbacks:null,initialize:function(a){Geo.View3D.Control.prototype.initialize.apply(this,[a]);this.callbacks=OpenLayers.Util.extend({emitMouseHandler:this.emitMouseHandler},this.callbacks);this.handlerOptions=this.handlerOptions||{};this.handler=new Geo.View3D.Handler.Box(this,this.callbacks,this.handlerOptions)},emitMouseHandler:function(){},CLASS_NAME:"Geo.View3D.Control.Box"});
Geo.View3D.Control.ModelChoose=Geo.Class(Geo.View3D.Control,{handlerOptions:null,callbacks:{},initialize:function(a){Geo.View3D.Control.prototype.initialize.apply(this,[a]);this.callbacks=OpenLayers.Util.extend({chooseModel:this.chooseModel},this.callbacks);this.handlerOptions=this.handlerOptions||{};this.handler=new Geo.View3D.Handler.ModelChoose(this,this.callbacks,this.handlerOptions)},chooseModel:function(){},CLASS_NAME:"Geo.View3D.Control.ModelChoose"});
Geo.View3D.Control.Mouse=Geo.Class(Geo.View3D.Control,{handlerOptions:null,callbacks:null,initialize:function(a){Geo.View3D.Control.prototype.initialize.apply(this,[a]);this.callbacks=OpenLayers.Util.extend({click:this.onClick,rightClick:this.onRightClick,mouseMove:this.onMouseMove,dblclick:this.onDblclick,mouseUp:this.onMouseUp,mouseRightUp:this.onMouseRightUp,mouseDown:this.onMouseDown,mouseWheel:this.onMouseWheel,mouseOut:this.onMouseOut,mouseOver:this.onMouseOver,movestart:this.onMoveStart,move:this.onMove,
moveend:this.onMoveEnd,zoomend:this.onZoomEnd},this.callbacks);this.handlerOptions=this.handlerOptions||{};this.handler=new Geo.View3D.Handler.Mouse(this,this.callbacks,this.handlerOptions)},onDblclick:function(){},onClick:function(){},onRightClick:function(){},onMouseMove:function(){},onMouseUp:function(){},onMouseDown:function(){},onMouseWheel:function(){},onMouseOut:function(){},onMouseOver:function(){},onMouseRightUp:function(){},onMoveStart:function(){},onMove:function(){},onMoveEnd:function(){},
onZoomEnd:function(){},CLASS_NAME:"Geo.View3D.Control.Mouse"});
Geo.View3D.Control.Analysis=Geo.Class(Geo.View3D.Control,{keyEventHandlers:[],trackerIds:[],elementsKeys:[],analysisResult:[],m_surfaceArea_result:null,m_aspectAnalysis_Result:null,m_slopeAnalysis_Result:null,m_cutFillAnalysis_result:null,m_nosSourceFlood_Result:null,m_sectionPlane_Result:null,m_oObserverPoints_Result:null,m_lineOfSight_Result:null,m_mulitiPointLineOfSight_Result:null,m_viewshedAnalysis_Result:null,m_surfaceArea3D_result:null,m_movePoint:null,m_pTracker:null,enumTrackerType:{eTrackerEmpty:0,
eTrackerPolyline:1,eTrackerPolygon:2,eTrackerCircleSurface:3,eTrackerCircleLine:4,eTrackerVerticalLine:5,eTrackerPolyline3D:6,eScreenEnvelopeTracker:7,eScreenPolylineTracker:8,eTrackerPolygon3D:9},enumAnalysisType:{measureLength:0,surfaceArea:1,elevationAnalysis:2,aspectAnalysis:3,slopeAnalysis:4,cutFillAnalysis:5,noSourceFloodAnalysis:6,spatialLength:7,spatialArea:8,opserverPoints:9,lineOfSight:10,multiPointLineOfSight:11,viewshedAnalysis:12},cutFillAnalysisHeight:100,floodAnalysisHeight:100,autoActivate:!0,
viewshedAnalysisVerticalFOVAngle:45,viewshedAnalysisHorizontalFOVAngle:45,viewshedAnalysisViewDistance:100,viewshedAnalysisHeadingAngle:0,viewshedAnalysisTiltAngle:-15,viewshedAnalysisResultPresentatio:1,initialize:function(){Geo.View3D.Control.prototype.initialize.apply(this,arguments)},measureLengthAnalysis:function(){var a=OpenLayers.Util.createUniqueID(),b=this.map.activexObj;if(b)b.DrawBox.StartTracker(a,this.enumTrackerType.eTrackerPolyline),this.lengthHandler=OpenLayers.Function.bind(function(a){this._lengthHandler(a)},
this),b.addEventListener?b.addEventListener("GeometryTracked",this.lengthHandler,!1):b.attachEvent&&b.attachEvent("OnGeometryTracked",this.lengthHandler),this.keyEventHandlers.push(this.lengthHandler),this.trackerIds.push(a)},_lengthHandler:function(a){var b=this.map.activexObj;this.onComplete(this.enumAnalysisType.measureLength,b.AnalysisBox.SectionPlane(a,1E3).InterpolationTotalLength);b.removeEventListener?b.removeEventListener("GeometryTracked",this.lengthHandler,!1):b.detachEvent&&b.detachEvent("OnGeometryTracked",
this.lengthHandler)},onComplete:function(){},surfaceAreaAnalysis:function(){var a=OpenLayers.Util.createUniqueID(),b=this.map.activexObj;if(b)b.DrawBox.StartTracker(a,this.enumTrackerType.eTrackerPolygon),this.surfaceAreaHandler=OpenLayers.Function.bind(function(a){this._surfaceAreaHandler(a)},this),this.surfaceAreaFinishedHandler=OpenLayers.Function.bind(function(a){this._surfaceAreaFinishedHandler(a)},this),b.addEventListener?b.addEventListener("TrackerFinished",this.surfaceAreaHandler,!1):b.attachEvent&&
b.attachEvent("OnTrackerFinished",this.surfaceAreaHandler),b.addEventListener?b.addEventListener("AnalysisFinished",this.surfaceAreaFinishedHandler,!1):b.attachEvent&&b.attachEvent("OnAnalysisFinished",this.surfaceAreaFinishedHandler),this.trackerIds.push(a),this.keyEventHandlers.push(this.surfaceAreaHandler),this.keyEventHandlers.push(this.surfaceAreaFinishedHandler)},_surfaceAreaHandler:function(a){var b=this.map.activexObj;b.removeEventListener?b.removeEventListener("TrackerFinished",this.surfaceAreaHandler,
!1):b.detachEvent&&b.detachEvent("OnTrackerFinished",this.surfaceAreaHandler);b=this.map.activexObj;this.m_surfaceArea_result=b.AnalysisBox.AreaAsynchronous(a.Result,10);b.ScreenBox.AppendElement(this.m_surfaceArea_result.ProgressElement);this.m_surfaceArea_result.DoAnalysis();this.elementsKeys.push(this.m_surfaceArea_result.ProgressElement.Key)},_surfaceAreaFinishedHandler:function(){var a=this.map.activexObj;a.removeEventListener?a.removeEventListener("AnalysisFinished",this.surfaceAreaFinishedHandler,
!1):a.detachEvent&&a.detachEvent("OnAnalysisFinished",this.surfaceAreaFinishedHandler);this.onComplete(this.enumAnalysisType.surfaceArea,this.m_surfaceArea_result.Area)},measureHeightAnalysis:function(){var a=OpenLayers.Util.createUniqueID(),b=this.map.activexObj;b&&(b.DrawBox.StartTracker(a,this.enumTrackerType.eTrackerVerticalLine),this.trackerIds.push(a))},queryElevationAnalysis:function(){var a=this.map.activexObj;if(a)this.queryElevationHandler=OpenLayers.Function.bind(function(a){this._queryElevationHandler(a)},
this),a.addEventListener?a.addEventListener("MouseEvent",this.queryElevationHandler,!1):a.attachEvent&&a.attachEvent("OnMouseEvent",this.queryElevationHandler),this.keyEventHandlers.push(this.queryElevationHandler)},removeElevationAnalysis:function(){var a=this.map.activexObj;a&&this.queryElevationHandler&&(a.removeEventListener?a.removeEventListener("MouseEvent",this.queryElevationHandler,!1):a.detachEvent&&a.detachEvent("OnMouseEvent",this.queryElevationHandler))},_queryElevationHandler:function(a){if(a.MouseButton===
1&&a.MouseState===0){var b={longitude:null,latitude:null,altitude:null,slope:null,aspect:null};b.longitude=a.X.toFixed(2);b.latitude=a.Y.toFixed(2);b.altitude=a.Altitude.toFixed(2);this.onComplete(this.enumAnalysisType.elevationAnalysis,b)}},aspectAnalysis:function(){var a=this.map.activexObj;if(a){var b=OpenLayers.Util.createUniqueID();a.DrawBox.StartTracker(b,this.enumTrackerType.eTrackerPolygon);this.aspectTrackedHandler=OpenLayers.Function.bind(function(a){this._aspectTrackedHandler(a)},this);
this.aspectFinishedHandler=OpenLayers.Function.bind(function(a){this._aspectFinishedHandler(a)},this);a.addEventListener?a.addEventListener("GeometryTracked",this.aspectTrackedHandler,!1):a.attachEvent&&a.attachEvent("OnGeometryTracked",this.aspectTrackedHandler);a.addEventListener?a.addEventListener("AnalysisFinished",this.aspectFinishedHandler,!1):a.attachEvent&&a.attachEvent("OnAnalysisFinished",this.aspectFinishedHandler);this.trackerIds.push(b);this.keyEventHandlers.push(this.aspectTrackedHandler);
this.keyEventHandlers.push(this.aspectFinishedHandler)}},_aspectTrackedHandler:function(a){var b=this.map.activexObj;b.removeEventListener?b.removeEventListener("GeometryTracked",this.aspectTrackedHandler,!1):b.detachEvent&&b.detachEvent("OnGeometryTracked",this.aspectTrackedHandler);this.m_aspectAnalysis_Result=b.AnalysisBox.RangeAspect(a,10);b.ScreenBox.AppendElement(this.m_aspectAnalysis_Result.ProgressDisplayElement);this.elementsKeys.push(this.m_aspectAnalysis_Result.ProgressDisplayElement.Key);
this.m_aspectAnalysis_Result.DoAnalysis(null)},_aspectFinishedHandler:function(){var a=this.map.activexObj;a.removeEventListener?a.removeEventListener("AnalysisFinished",this.aspectFinishedHandler,!1):a.detachEvent&&a.detachEvent("OnAnalysisFinished",this.aspectFinishedHandler);a.ScreenBox.RemoveElement(this.m_aspectAnalysis_Result.ProgressDisplayElement);a.ScreenBox.AppendElement(this.m_aspectAnalysis_Result.ResultDisplayElement);this.elementsKeys.push(this.m_aspectAnalysis_Result.ResultDisplayElement.Key);
this.onComplete(this.enumAnalysisType.aspectAnalysis,"")},slopeAnalysis:function(){var a=this.map.activexObj;if(a){var b=OpenLayers.Util.createUniqueID();a.DrawBox.StartTracker(b,this.enumTrackerType.eTrackerPolygon);this.slopeTrackedHandler=OpenLayers.Function.bind(function(a){this._slopeTrackedHandler(a)},this);this.slopeFinishedHandler=OpenLayers.Function.bind(function(a){this._slopeFinishedHandler(a)},this);a.addEventListener?a.addEventListener("GeometryTracked",this.slopeTrackedHandler,!1):a.attachEvent&&
a.attachEvent("OnGeometryTracked",this.slopeTrackedHandler);a.addEventListener?a.addEventListener("AnalysisFinished",this.slopeFinishedHandler,!1):a.attachEvent&&a.attachEvent("OnAnalysisFinished",this.slopeFinishedHandler);this.trackerIds.push(b);this.keyEventHandlers.push(this.slopeTrackedHandler);this.keyEventHandlers.push(this.slopeFinishedHandler)}},_slopeTrackedHandler:function(a){var b=this.map.activexObj;b.removeEventListener?b.removeEventListener("GeometryTracked",this.slopeTrackedHandler,
!1):b.detachEvent&&b.detachEvent("OnGeometryTracked",this.slopeTrackedHandler);this.m_slopeAnalysis_Result=b.AnalysisBox.RangeSlope(a,10);b.ScreenBox.AppendElement(this.m_slopeAnalysis_Result.ProgressDisplayElement);this.elementsKeys.push(this.m_slopeAnalysis_Result.ProgressDisplayElement.Key);this.m_slopeAnalysis_Result.DoAnalysis(null)},_slopeFinishedHandler:function(){var a=this.map.activexObj;a.removeEventListener?a.removeEventListener("AnalysisFinished",this.slopeFinishedHandler,!1):a.detachEvent&&
a.detachEvent("OnAnalysisFinished",this.slopeFinishedHandler);a.ScreenBox.RemoveElement(this.m_slopeAnalysis_Result.ProgressDisplayElement);a.ScreenBox.AppendElement(this.m_slopeAnalysis_Result.ResultDisplayElement);this.elementsKeys.push(this.m_slopeAnalysis_Result.ResultDisplayElement.Key);this.onComplete(this.enumAnalysisType.slopeAnalysis,"")},cutFillAnalysis:function(){var a=this.map.activexObj;if(a){var b=OpenLayers.Util.createUniqueID();a.DrawBox.StartTracker(b,this.enumTrackerType.eTrackerPolygon);
this.cutFillTrackedHandler=OpenLayers.Function.bind(function(a){this._cutFillTrackedHandler(a)},this);a.addEventListener?a.addEventListener("GeometryTracked",this.cutFillTrackedHandler,!1):a.attachEvent&&a.attachEvent("OnGeometryTracked",this.cutFillTrackedHandler);this.trackerIds.push(b);this.keyEventHandlers.push(this.cutFillTrackedHandler)}},_cutFillTrackedHandler:function(a){var b=this.map.activexObj;b.removeEventListener?b.removeEventListener("GeometryTracked",this.cutFillTrackedHandler,!1):
b.detachEvent&&b.detachEvent("OnGeometryTracked",this.cutFillTrackedHandler);this.m_cutFillAnalysis_result=b.AnalysisBox.CutFill(a);b.ScreenBox.AppendElement(this.m_cutFillAnalysis_result.ResultDisplayElement);this.elementsKeys.push(this.m_cutFillAnalysis_result.ResultDisplayElement.Key);this.m_cutFillAnalysis_result.CutFillTo(this.cutFillAnalysisHeight);this.onComplete(this.enumAnalysisType.cutFillAnalysis,this.m_cutFillAnalysis_result)},nosSourceFloodAnalysis:function(){var a=this.map.activexObj;
if(a){var b=OpenLayers.Util.createUniqueID();a.DrawBox.StartTracker(b,this.enumTrackerType.eTrackerPolygon);this.nosSourceFloodTrackedHandler=OpenLayers.Function.bind(function(a){this._nosSourceFloodTrackedHandler(a)},this);a.addEventListener?a.addEventListener("GeometryTracked",this.nosSourceFloodTrackedHandler,!1):a.attachEvent&&a.attachEvent("OnGeometryTracked",this.nosSourceFloodTrackedHandler);this.trackerIds.push(b);this.keyEventHandlers.push(this.nosSourceFloodTrackedHandler)}},_nosSourceFloodTrackedHandler:function(a){var b=
this.map.activexObj;b.removeEventListener?b.removeEventListener("GeometryTracked",this.nosSourceFloodTrackedHandler,!1):b.detachEvent&&b.detachEvent("OnGeometryTracked",this.nosSourceFloodTrackedHandler);this.m_nosSourceFlood_Result=b.AnalysisBox.NoSourceFlood(a);b.ScreenBox.AppendElement(this.m_nosSourceFlood_Result.ResultDisplayElement);this.elementsKeys.push(this.m_nosSourceFlood_Result.ResultDisplayElement.Key);this.m_nosSourceFlood_Result.FloodTo(this.floodAnalysisHeight);this.onComplete(this.enumAnalysisType.noSourceFloodAnalysis,
this.m_nosSourceFlood_Result)},sectionPlaneAnalysis:function(){var a=this.map.activexObj;if(a){var b=OpenLayers.Util.createUniqueID();a.DrawBox.StartTracker(b,this.enumTrackerType.eTrackerPolyline);this.sectionPlaneTrackedHandler=OpenLayers.Function.bind(function(a){this._sectionPlaneTrackedHandler(a)},this);a.addEventListener?a.addEventListener("GeometryTracked",this.sectionPlaneTrackedHandler,!1):a.attachEvent&&a.attachEvent("OnGeometryTracked",this.sectionPlaneTrackedHandler);this.trackerIds.push(b);
this.keyEventHandlers.push(this.sectionPlaneTrackedHandler)}},_sectionPlaneTrackedHandler:function(a){b.removeEventListener?b.removeEventListener("GeometryTracked",this.sectionPlaneTrackedHandler,!1):b.detachEvent&&b.detachEvent("OnGeometryTracked",this.sectionPlaneTrackedHandler);var b=this.map.activexObj;this.m_sectionPlane_Result=b.AnalysisBox.SectionPlane(a,50);this.m_sectionPlane_Result.InterpolationGeometry.ExportToData(1,"");alert([])},spatialLengthAnalysis:function(){var a=OpenLayers.Util.createUniqueID(),
b=this.map.activexObj;if(b)b.DrawBox.StartTracker(a,this.enumTrackerType.eTrackerPolyline3D),this.length3DHandler=OpenLayers.Function.bind(function(a){this._length3DHandler(a)},this),b.addEventListener?b.addEventListener("GeometryTracked",this.length3DHandler,!1):b.attachEvent&&b.attachEvent("OnGeometryTracked",this.length3DHandler),this.keyEventHandlers.push(this.length3DHandler),this.trackerIds.push(a)},_length3DHandler:function(a){var b=this.map.activexObj;this.onComplete(this.enumAnalysisType.spatialLength,
b.AnalysisBox.Length(a,2));b.removeEventListener?b.removeEventListener("GeometryTracked",this.length3DHandler,!1):b.detachEvent&&b.detachEvent("OnGeometryTracked",this.length3DHandler)},spatialAreaAnalysis:function(){var a=OpenLayers.Util.createUniqueID(),b=this.map.activexObj;if(b)b.DrawBox.StartTracker(a,this.enumTrackerType.eTrackerPolygon3D),this.surfaceArea3DHandler=OpenLayers.Function.bind(function(a){this._surfaceArea3DHandler(a)},this),this.surfaceArea3DFinishedHandler=OpenLayers.Function.bind(function(a){this._surfaceArea3DFinishedHandler(a)},
this),b.addEventListener?b.addEventListener("TrackerFinished",this.surfaceArea3DHandler,!1):b.attachEvent&&b.attachEvent("OnTrackerFinished",this.surfaceArea3DHandler),b.addEventListener?b.addEventListener("AnalysisFinished",this.surfaceArea3DFinishedHandler,!1):b.attachEvent&&b.attachEvent("OnAnalysisFinished",this.surfaceArea3DFinishedHandler),this.trackerIds.push(a),this.keyEventHandlers.push(this.surfaceArea3DHandler),this.keyEventHandlers.push(this.surfaceArea3DFinishedHandler)},_surfaceArea3DHandler:function(a){var b=
this.map.activexObj;b.removeEventListener?b.removeEventListener("TrackerFinished",this.surfaceArea3DHandler,!1):b.detachEvent&&b.detachEvent("OnTrackerFinished",this.surfaceArea3DHandler);b=this.map.activexObj;this.m_surfaceArea3D_result=b.AnalysisBox.AreaAsynchronous(a.Result,10);b.ScreenBox.AppendElement(this.m_surfaceArea3D_result.ProgressElement);this.m_surfaceArea3D_result.DoAnalysis();this.elementsKeys.push(this.m_surfaceArea3D_result.ProgressElement.Key)},_surfaceArea3DFinishedHandler:function(){var a=
this.map.activexObj;a.removeEventListener?a.removeEventListener("AnalysisFinished",this.surfaceArea3DFinishedHandler,!1):a.detachEvent&&a.detachEvent("OnAnalysisFinished",this.surfaceArea3DFinishedHandler);this.onComplete(this.enumAnalysisType.spatialArea,this.m_surfaceArea3D_result)},observerPointsRangeAnalysis:function(){var a=this.map.activexObj;this.observerPointsGeometryTrackeredHandler=OpenLayers.Function.bind(function(a){this._observerPointsGeometryTrackeredHandler(a)},this);a.addEventListener?
a.addEventListener("GeometryTracked",this.observerPointsGeometryTrackeredHandler,!1):a.attachEvent&&a.attachEvent("OnGeometryTracked",this.observerPointsGeometryTrackeredHandler);if(a){var b=OpenLayers.Util.createUniqueID();a.DrawBox.StartTracker(b,this.enumTrackerType.eTrackerPolygon);this.trackerIds.push(b)}},_observerPointsGeometryTrackeredHandler:function(a){var b=this.map.activexObj;b.removeEventListener?b.removeEventListener("GeometryTracked",this.observerPointsGeometryTrackeredHandler,!1):
b.detachEvent&&b.detachEvent("OnGeometryTracked",this.observerPointsGeometryTrackeredHandler);this.m_Range=a;a=OpenLayers.Util.createUniqueID();m_pTracker=b.DrawBox.StartTracker(a,this.enumTrackerType.eTrackerVerticalLine);this.trackerIds.push(a);this.observerPointsTrackerFinishedHandler=OpenLayers.Function.bind(function(a){this._observerPointsTrackerFinishedHandler(a)},this);b.addEventListener?b.addEventListener("TrackerFinished",this.observerPointsTrackerFinishedHandler,!1):b.attachEvent&&b.attachEvent("OnTrackerFinished",
this.observerPointsTrackerFinishedHandler)},_observerPointsTrackerFinishedHandler:function(a){var b=this.map.activexObj;if(typeof a.Location!="undefined")this.observerPointsAnalysisFinishedHandler=OpenLayers.Function.bind(function(a){this._observerPointsAnalysisFinishedHandler(a)},this),b.addEventListener?b.addEventListener("AnalysisFinished",this.observerPointsAnalysisFinishedHandler,!1):b.attachEvent&&b.attachEvent("OnAnalysisFinished",this.observerPointsAnalysisFinishedHandler),a=a.Location,a.Z+=
m_pTracker.Length,this.m_oObserverPoints_Result=b.AnalysisBox.ObserverPointsInRange(this.m_Range,a),b.ScreenBox.AppendElement(this.m_oObserverPoints_Result.ShowProcessElement),this.elementsKeys.push(this.m_oObserverPoints_Result.ShowProcessElement.Key),this.m_oObserverPoints_Result.StartAnalysisProcess(),b.removeEventListener?b.removeEventListener("TrackerFinished",this.observerPointsTrackerFinishedHandler,!1):b.detachEvent&&b.detachEvent("OnTrackerFinished",this.observerPointsTrackerFinishedHandler)},
_observerPointsAnalysisFinishedHandler:function(){var a=this.map.activexObj;a.removeEventListener?a.removeEventListener("AnalysisFinished",this.observerPointsAnalysisFinishedHandler,!1):a.attachEvent&&a.detachEvent("OnAnalysisFinished",this.observerPointsAnalysisFinishedHandler);this.onComplete(this.enumAnalysisType.opserverPoints,this.m_oObserverPoints_Result)},lineOfSightAnalysis:function(){var a=this.map.activexObj;this.LineOfSightClickCount=0;this.LineOfSightEndTracker=this.LineOfSightStartTracker=
this.LineOfSightMovePoint=null;this.lineOfSightMouseEventHandler=OpenLayers.Function.bind(function(a){this._lineOfSightMouseEventHandler(a)},this);a.addEventListener?a.addEventListener("MouseEvent",this.lineOfSightMouseEventHandler,!1):a.attachEvent&&a.attachEvent("OnMouseEvent",this.lineOfSightMouseEventHandler)},_lineOfSightMouseEventHandler:function(a){var b=this.map.activexObj;switch(a.MouseState){case 3:if(this.LineOfSightMovePoint==null)this.LineOfSightMovePoint=b.ObjectFactory.CreateObject(100);
this.LineOfSightMovePoint.PutCoords(a.X,a.Y,a.Altitude);if(null!=this.m_lineOfSight_Result)null==this.LineOfSightEndTracker?this.m_lineOfSight_Result.EndPoint=this.LineOfSightMovePoint:this.m_lineOfSight_Result.EndPointHeight=this.LineOfSightEndTracker.Length;break;case 1:if(a.MouseButton!=1)break;b=b.ObjectFactory.CreateObject(100);b.PutCoords(a.X,a.Y,a.Altitude);this.LineOfSightMouseDown(b)}},LineOfSightMouseDown:function(a){var b=this.map.activexObj;switch(this.LineOfSightClickCount){case 0:var c=
OpenLayers.Util.createUniqueID();this.LineOfSightStartTracker=b.DrawBox.StartTracker(c,5);this.LineOfSightStartTracker.Location=a;this.trackerIds.push(c);break;case 1:this.m_lineOfSight_Result=b.AnalysisBox.StartLineOfSight();this.m_lineOfSight_Result.EnableTracker=!1;b.ScreenBox.AppendElement(this.m_lineOfSight_Result);this.elementsKeys.push(this.m_lineOfSight_Result);this.m_lineOfSight_Result.StartPoint=this.LineOfSightStartTracker.Location;this.m_lineOfSight_Result.StartPointHeight=this.LineOfSightStartTracker.Length;
break;case 2:c=OpenLayers.Util.createUniqueID();this.LineOfSightEndTracker=b.DrawBox.StartTracker(c,5);this.LineOfSightEndTracker.Location=a;this.trackerIds.push(c);this.m_lineOfSight_Result.EndPoint=a;break;case 3:this.m_lineOfSight_Result.EndPointHeight=this.LineOfSightEndTracker.Length,b.removeEventListener?b.removeEventListener("MouseEvent",this.lineOfSightMouseEventHandler,!1):b.detachEvent&&b.detachEvent("OnMouseEvent",this.lineOfSightMouseEventHandler)}this.LineOfSightClickCount++},mulitiPointLineOfSightAnalysis:function(){var a=
this.map.activexObj;if(a)this.m_movePoint=null,this.m_nClickCount=0,this.mulitiPointLineOfSightMouseEventHandler=OpenLayers.Function.bind(function(a){this._mulitiPointLineOfSightMouseEventHandler(a)},this),a.addEventListener?a.addEventListener("MouseEvent",this.mulitiPointLineOfSightMouseEventHandler,!1):a.attachEvent&&a.attachEvent("OnMouseEvent",this.mulitiPointLineOfSightMouseEventHandler)},_mulitiPointLineOfSightMouseEventHandler:function(a){var b=this.map.activexObj;switch(a.MouseState){case 3:if(this.m_movePoint==
null)this.m_movePoint=b.ObjectFactory.CreateObject(100);this.m_movePoint.PutCoords(a.X,a.Y,a.Altitude);if(null!=this.m_mulitiPointLineOfSight_Result&&this.m_nClickCount>1)this.m_mulitiPointLineOfSight_Result.EndPoint=this.m_movePoint;break;case 1:if(a.MouseButton!=1)break;b=b.ObjectFactory.CreateObject(100);b.PutCoords(a.X,a.Y,a.Altitude);if(this.m_nClickCount==2)this.m_mulitiPointLineOfSight_Result.EndPoint=b,this.m_nClickCount=1;this.MouseDown(b);break;case 4:b.removeEventListener?b.removeEventListener("MouseEvent",
this.mulitiPointLineOfSightMouseEventHandler,!1):b.detachEvent&&b.detachEvent("OnMouseEvent",this.mulitiPointLineOfSightMouseEventHandler)}},MouseDown:function(a){var b=this.map.activexObj;switch(this.m_nClickCount){case 0:var c=OpenLayers.Util.createUniqueID();this.pTracker=b.DrawBox.StartTracker(c,5);this.pTracker.Location=a;this.trackerIds.push(c);break;case 1:this.m_mulitiPointLineOfSight_Result=b.AnalysisBox.StartLineOfSight3D();this.m_mulitiPointLineOfSight_Result.EnableTracker=!1;b.ScreenBox.AppendElement(this.m_mulitiPointLineOfSight_Result);
this.elementsKeys.push(this.m_mulitiPointLineOfSight_Result);this.m_mulitiPointLineOfSight_Result.StartPoint=this.pTracker.Location;this.m_mulitiPointLineOfSight_Result.StartPointHeight=this.pTracker.Length;break;default:b.removeEventListener?b.removeEventListener("MouseEvent",this.mulitiPointLineOfSightMouseEventHandler,!1):b.detachEvent&&b.detachEvent("OnMouseEvent",this.mulitiPointLineOfSightMouseEventHandler)}this.m_nClickCount++},viewshedAnalysis:function(){var a=this.map.activexObj;if(a){this.viewshedTrackerFinishedHandler=
OpenLayers.Function.bind(function(a,b){this._viewshedTrackerFinishedHandler(a,b)},this);a.addEventListener?a.addEventListener("TrackerFinished",this.viewshedTrackerFinishedHandler,!1):a.attachEvent&&a.attachEvent("OnTrackerFinished",this.viewshedTrackerFinishedHandler);var b=OpenLayers.Util.createUniqueID();a.DrawBox.StartTracker(b,this.enumTrackerType.eTrackerVerticalLine);this.trackerIds.push(b)}},_viewshedTrackerFinishedHandler:function(a){var b=this.map.activexObj;b.removeEventListener?b.removeEventListener("TrackerFinished",
this.viewshedTrackerFinishedHandler,!1):b.detachEvent&&b.detachEvent("OnTrackerFinished",this.viewshedTrackerFinishedHandler);var c=a.Location,a=a.Length;this.viewshedAnalysisFinishedHandler=OpenLayers.Function.bind(function(a,b){this._viewshedAnalysisFinishedHandler(a,b)},this);b.addEventListener?b.addEventListener("AnalysisFinished",this.viewshedAnalysisFinishedHandler,!1):b.attachEvent&&b.attachEvent("OnAnalysisFinished",this.viewshedAnalysisFinishedHandler);this.m_viewshedAnalysis_Result=b.AnalysisBox.StartObserverCamera3D();
b.ScreenBox.AppendElement(this.m_viewshedAnalysis_Result);this.elementsKeys.push(this.m_viewshedAnalysis_Result);this.m_viewshedAnalysis_Result.VerticalFOVAngle=this.viewshedAnalysisVerticalFOVAngle;this.m_viewshedAnalysis_Result.HorizontalFOVAngle=this.viewshedAnalysisHorizontalFOVAngle;this.m_viewshedAnalysis_Result.ViewDistance=this.viewshedAnalysisViewDistance;c.Z+=a;this.m_viewshedAnalysis_Result.Location=c;this.m_viewshedAnalysis_Result.HeadingAngle=this.viewshedAnalysisHeadingAngle*0.3;this.m_viewshedAnalysis_Result.TiltAngle=
this.viewshedAnalysisTiltAngle*0.3;this.m_viewshedAnalysis_Result.ResultPresentation=this.viewshedAnalysisResultPresentatio==0?0:1;this.m_viewshedAnalysis_Result.VerticalLineCount=this.viewshedAnalysisVerticalFOVAngle;this.m_viewshedAnalysis_Result.HorizontalLineCount=this.viewshedAnalysisHorizontalFOVAngle;this.m_viewshedAnalysis_Result.DoAnalysis()},_viewshedAnalysisFinishedHandler:function(){var a=this.map.activexObj;a.removeEventListener?a.removeEventListener("AnalysisFinished",this.viewshedAnalysisFinishedHandler,
!1):a.detachEvent&&a.detachEvent("OnAnalysisFinished",this.viewshedAnalysisFinishedHandler);this.onComplete(this.enumAnalysisType.viewshedAnalysis,null)},clearAnalysisResult:function(){var a=this.map.activexObj;if(a){for(var b=0,c=this.trackerIds.length;b<c;b++)a.DrawBox.RemoveTracker(this.trackerIds[b]);b=0;for(c=this.elementsKeys.length;b<c;b++)a.ScreenBox.RemoveElement(this.elementsKeys[b]);b=0;for(c=this.keyEventHandlers.length;b<c;b++)a.removeEventListener?a.removeEventListener("GeometryTracked",
this.keyEventHandlers[b],!1):a.detachEvent&&a.detachEvent("OnGeometryTracked",this.keyEventHandlers[b]),a.removeEventListener?a.removeEventListener("AnalysisFinished",this.keyEventHandlers[b],!1):a.detachEvent&&a.detachEvent("OnAnalysisFinished",this.keyEventHandlers[b]),a.removeEventListener?a.removeEventListener("TrackerFinished",this.keyEventHandlers[b],!1):a.detachEvent&&a.detachEvent("OnTrackerFinished",this.keyEventHandlers[b]),a.removeEventListener?a.removeEventListener("MouseEvent",this.keyEventHandlers[b],
!1):a.detachEvent&&a.detachEvent("OnMouseEvent",this.keyEventHandlers[b])}},activate:function(){if(Geo.View3D.Control.prototype.activate.apply(this,arguments))return!0;return!1},deactivate:function(){this.clearAnalysisResult();this.keyEventHandlers=[];this.trackerIds=[];this.elementsKeys=[];this.analysisResult=[];this.m_lineOfSight_Result=this.m_oObserverPoints_Result=this.m_sectionPlane_Result=this.m_nosSourceFlood_Result=this.m_cutFillAnalysis_result=this.m_slopeAnalysis_Result=this.m_aspectAnalysis_Result=
this.m_surfaceArea3D_result=this.m_surfaceArea_result=null;if(Geo.View3D.Control.prototype.deactivate.apply(this,arguments))return!0;return!1},destroy:function(){this.deactivate();Geo.View3D.Control.prototype.destroy.apply(this,arguments)},setMap:function(){Geo.View3D.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"Geo.View3D.Control.Analysis"});
Geo.View3D.Control.Keyboard=Geo.Class(Geo.View3D.Control,{handlerOptions:null,callbacks:null,initialize:function(a){Geo.View3D.Control.prototype.initialize.apply(this,[a]);this.callbacks=OpenLayers.Util.extend({keyboardDown:this.onKeyboardDown,keyboardUp:this.onKeyboardUp},this.callbacks);this.handlerOptions=this.handlerOptions||{};this.handler=new Geo.View3D.Handler.Keyboard(this,this.callbacks,this.handlerOptions)},onKeyboardDown:function(){},onKeyboardUp:function(){},CLASS_NAME:"Geo.View3D.Control.Keyboard"});
Geo.View3D.Fly=Geo.Class({layer:null,layerOptions:null,map:null,drawPathControl:null,drawPointControl:null,defaultFlyParams:{height:0,speed:0,tilt:0,heading:0},model:null,points:null,pathVisible:!0,pathFlyMode:0,eventListeners:null,EVENT_TYPES:["OnFlyFinished"],events:null,modelPath:"C:\\airplane\\airplane.x",modelScale:0.3,modelDisToScreen:5,initialize:function(a){Geo.View3D.Control.prototype.initialize.apply(this,arguments);a=OpenLayers.Util.extend({displayInLayerSwitcher:!1,isOnTop:!0},this.layerOptions);
this.events=new OpenLayers.Events(this,null,this.EVENT_TYPES);if(this.eventListeners instanceof Object)this.events.on(this.eventListeners);this.layer=new Geo.View3D.Layer.Vector(this.CLASS_NAME+"_layer",a);this.drawPathControl=new Geo.View3D.Control.DrawFeature(this.layer,Geo.View3D.Handler.Path,{featureAdded:OpenLayers.Function.bind(function(a){this.controlFly(Geo.View3D.FLY_STOP);this.setPathFlyMode(this.pathFlyMode);this.addFeatureToPoints(a);this.drawPathControl.deactivate()},this),handlerOptions:{layerOptions:{style:{fillOpacity:0.8,
strokeWidth:5,pointRadius:20}}}});this.drawPointControl=new Geo.View3D.Control.DrawFeature(this.layer,Geo.View3D.Handler.Point,{featureAdded:OpenLayers.Function.bind(function(a){a&&(this.controlFly(Geo.View3D.FLY_STOP),this.setFlyFreePath(new Geo.LonLat(a.geometry.x,a.geometry.y)),this.controlFly(Geo.View3D.FLY_START),this.drawPointControl.deactivate())},this)});this.points=[];this.model={path:"",visible:!1}},showFlyModel:function(){var a=this.map.activexObj.ScreenBox.QueryScreenElement(5);a.ModelVisible?
a.ModelVisible=!1:(a.ModelPath=this.modelPath,a.ModelVisible=!0,a.ModelScale=this.modelScale,a.ModelYaw=0,a.ModelPitch=90,a.ModelRoll=180,a.ModelDisToScreen=this.modelDisToScreen)},initFlySet:function(a,b,c,d){this.defaultFlyParams.height=a;this.defaultFlyParams.speed=b;this.defaultFlyParams.tilt=c;this.defaultFlyParams.heading=d},onFlyFinished:function(){},setMap:function(a){if(!this.map)this.map=a,this._onFlyFinished=OpenLayers.Function.bind(function(a){this.onFlyFinished(a)},this),this.map.activexObj.addEventListener?
this.map.activexObj.addEventListener("FlyFinished",this._onFlyFinished,!1):this.map.activexObj.attachEvent&&this.map.activexObj.attachEvent("OnFlyFinished",this._onFlyFinished),this._initFlyOption(),a.addLayers([this.layer]),a.addControls([this.drawPathControl,this.drawPointControl])},removeMap:function(){this.map&&(this.map.activexObj.removeEventListener?this.map.activexObj.removeEventListener("FlyFinished",this._onFlyFinished,!1):this.map.activexObj.detachEvent&&this.map.activexObj.detachEvent("OnFlyFinished",
this._onFlyFinished),this.layer&&this.map.removeLayer(this.layer),this.drawPathControl&&this.map.removeControl(this.drawPathControl),this.drawPointControl&&this.map.removeControl(this.drawPointControl));this.map=null},destroy:function(){this.removeMap();this.events&&(this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy());this.events=this.eventListeners=null},setPathVisible:function(a){this.drawPathControl.deactivate();this.layer.setVisibility(a);this.pathVisible=a},clearFlyPath:function(){this.controlFly(Geo.View3D.FLY_STOP);
this.layer.removeFeatures(this.layer.features);this.points=[];this._clearAllFlyPoint();this.drawPathControl.deactivate()},activate:function(){Geo.View3D.Control.prototype.activate.apply(this,arguments);this._initFlyOption()},onComplete:function(){},onAddPoint:function(){},addPoints:function(){},addFeatureToPoints:function(a){this.points=[];for(var a=a.geometry.components,b=0;b<a.length;b++)this.points.push({longitude:a[b].x,latitude:a[b].y});this.setFlyPath()},setTilt:function(a){a=a<=0?1:a;this._camera.Tilt=
a>=90?89:a},setHeading:function(a){this._flyBox.ChangeAutoAdjustAttitude(0,!1);this._camera.Heading=a},setFlyPath:function(){this._clearAllFlyPoint();for(var a=0;a<this.points.length-1;a++){var b=OpenLayers.Util.extend({},this.points[a]),c=OpenLayers.Util.extend({},this.points[a+1]),d=this._flyBox.CreateFlySegment(0);d.SetStartCoord(b.longitude,b.latitude,2E3);d.SetEndCoord(c.longitude,c.latitude,2E3);this._flyBox.AddFlySegment(d)}},getFlyPath:function(){return this.points},setFlyCirclePath:function(a,
b,c){this._clearAllFlyPoint();var d=this._flyBox.CreateFlySegment(1),a=a?a:new Geo.LonLat(116.374153890879,41.1),b=b?b:new Geo.LonLat(116.374153890879,39.9056146840283);d.SetStartCoord(a.lon,a.lat,2E3);d.SetCentre(b.lon,b.lat,0);d.FlyAngle=c?c:360;this._flyBox.AddFlySegment(d)},setFlyFreePath:function(a){this._clearAllFlyPoint();var b=this._flyBox.CreateFlySegment(2),a=a?a:new Geo.LonLat(116.374153890879,41.001);b.SetStartCoord(a.lon,a.lat,1E3);this._flyBox.AddFlySegment(b)},controlFly:function(a){switch(a){case Geo.View3D.FLY_START:this.points!=
""&&this.setFlyPath();this._startFly();break;case Geo.View3D.FLY_PASUE:this._flyPause();break;case Geo.View3D.FLY_CONTINUE:this._flyContinue();break;case Geo.View3D.FLY_STOP:this._flyStop()}},setFlyCameraHeight:function(a){this._flyBox.RelativeHeight=a},setFlySpeed:function(a){this._flyBox.FlySpeed=a},setFlyMode:function(){},setPathFlyMode:function(a){if(a==0)this.pathFlyMode=0,this._flyBox.FlyHeightStyle=2;if(a==1)this.pathFlyMode=1,this._flyBox.FlyHeightStyle=3},saveFlyPathToFile:function(){},loadFlyPathFromFile:function(){},
getGeometryFromFlyPoints:function(){if(this._flyRoute){for(var a=[],b=0;b<this._flyRoute.GetCount();b++){var c=this._flyMotionWrapper.GetPoint(this._flyRoute,b),c=new Geo.Geometry.Point(c.XVal,c.YVal);a.push(c)}return new Geo.Geometry.LineString(a)}return null},setModelPath:function(){},setModelVisible:function(){},setCameraMode:function(a){this._camera.CameraMode=a},getCameraMode:function(){return this._camera.CameraMode},_getFlySpeed:function(a){return a*14},_flyRoute:null,_flyMotion:null,_camera:null,
_initFlyOption:function(){var a=this.map.activexObj;if(a)this._flyBox=a.FlyBox,this._camera=a.Camera},_startFly:function(){this._flyBox&&this._flyBox.StartFly(0)},_flyPause:function(){this._flyBox&&this._flyBox.PauseFly()},_flyContinue:function(){this._flyBox&&this._flyBox.ResumeFly()},_flyStop:function(){this._flyBox&&(this._flyBox.StopFly(),this._flyBox.ClearFlySegment())},_clearAllFlyPoint:function(){this._flyBox&&this._flyBox.ClearFlySegment()},CLASS_NAME:"Geo.View3D.Fly"});
Geo.View3D.FLY_START=1;Geo.View3D.FLY_PASUE=2;Geo.View3D.FLY_CONTINUE=3;Geo.View3D.FLY_STOP=4;Geo.View3D.Fly_MODE_ROUND=1;Geo.View3D.Fly_MODE_PATH=0;
Geo.View3D.Popup=Geo.Class({id:"",lonlat:null,size:null,contentHTML:null,map:null,contentType:1,_closeBoxCallback:null,z:0,setPositionZ:function(a){z=a},initialize:function(a,b,c,d,e,f){a==null&&(a=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"));this.id=a;this.lonlat=b;this.contentSize=c!=null?c:new Geo.Size(Geo.View3D.Popup.WIDTH,Geo.View3D.Popup.HEIGHT);if(d!=null)this.contentHTML=d;this._closeBox=new Boolean(e);this._closeBoxCallback=f},_closeBoxHandler:function(a){var b=this._closeBoxCallback;
b&&(a==0&&b(),this.map&&this.map.activexObj&&this._removeCloseBoxHandler())},_addCloseBoxHandler:function(){var a=this.map.activexObj;this._closeBoxHandler=OpenLayers.Function.bind(this._closeBoxHandler,this);a.addEventListener?a.addEventListener("BubbleWindowEvent",this._closeBoxHandler,!1):a.attachEvent&&a.attachEvent("OnBubbleWindowEvent",this._closeBoxHandler)},_removeCloseBoxHandler:function(){var a=this.map.activexObj;a.removeEventListener?a.removeEventListener("BubbleWindowEvent",this._closeBoxHandler,
!1):a.detachEvent&&a.detachEvent("OnBubbleWindowEvent",this._closeBoxHandler)},draw:function(){this._draw()},_setContentType:function(){this.map.activexObj.SceneGroup.SetBubbleContentType(this.contentType)},_draw:function(){var a=this.map;if(a&&a.activexObj){var b=this.lonlat,c=this.contentSize,d=a.activexObj.SceneGroup,a=a.lonlatToScreen(b.lon,b.lat,this.z);d.BubbleWindow.Visible=!0;d.BubbleWindow.SetMinMaxSize(200,250,900,900);d.BubbleWindow.PinMap(b.lon,b.lat,this.z);this._setContentType();d.BubbleWindow.Height=
c.h;d.BubbleWindow.Width=c.w;d.BubbleWindow.Content=this.contentHTML;d.BubbleWindow.ScreenX=a.x+100;d.BubbleWindow.ScreenY=a.y+100;this._addCloseBoxHandler()}},_clear:function(){var a=this.map;a&&a.activexObj&&(a.activexObj.SceneGroup.DeleteBubbleWindow(),this._removeCloseBoxHandler())},CLASS_NAME:"Geo.View3D.Popup"});Geo.View3D.Popup.WIDTH=270;Geo.View3D.Popup.HEIGHT=152;Geo.View3D.Popup.COLOR="white";Geo.View3D.Popup.OPACITY=1;Geo.View3D.Popup.BORDER="0px";Geo.View3D.Popup.CONTENT_TYPE_TEXT=0;
Geo.View3D.Popup.CONTENT_TYPE_HTML=1;Geo.View3D.Popup.CONTENT_TYPE_URL=2;Geo.View3D.Popup.FramedCloud=Geo.Class(Geo.View3D.Popup,{initialize:function(a,b,c,d,e,f,g){Geo.View3D.Popup.prototype.initialize.apply(this,[a,b,c,d,f,g])},CLASS_NAME:"Geo.View3D.Popup.FramedCloud"});
Geo.View3D.FeatureManager=Geo.Class({id:null,map:null,_typeMapping:null,featureSortField:"featureSort",orderNumberField:"orderNumber",vectorLayer:null,selectControl:null,maxFeaturesPerPage:15,initialize:function(a){this._typeMapping={};this.registerResultType("default");OpenLayers.Util.extend(this,a)},setMap:function(a){if(a&&!this.map)this.map=a,this.vectorLayer=new Geo.View3D.Layer.Vector("GeoGlobeFeatureManagerVector",{isOnTop:!0,displayInLayerSwitcher:!1}),this.map.addLayer(this.vectorLayer),
this._initSelectControl()},registerFeatureSort:function(a,b){this._typeMapping[a]=OpenLayers.Util.extend({features:[],currentPage:0,maxFeaturesPerPage:this.maxFeaturesPerPage,onTurnToPage:this.onTurnToPage,onFeatureSelect:Geo.View3D.FeatureManager.showFramedCloud,onFeatureUnselect:Geo.View3D.FeatureManager.closeFramedCloud,onFeatureOver:Geo.View3D.FeatureManager.showTopic,onFeatureOut:Geo.View3D.FeatureManager.closeTopic},b)},registerResultType:function(a,b){this.registerFeatureSort(a,b)},addFeatures:function(a,
b,c){b=b||"default";Geo.Util.isArray(a)||(a=[a]);if(this._typeMapping[b]){var a=this._addTypeMarker(a,b),d=this._typeMapping[b].style;d&&this._addStyleForFeatures(a,d);c?this._typeMapping[b].features.concat(a):(this.clearResultFromMap(b),this._typeMapping[b].features=a);this._typeMapping[b].currentPage=0}},onTurnToPage:function(){},turnToPageN:function(a,b){var b=b||"default",c=this._typeMapping[b],d=this.getTotalPageNumber(b),a=a<=0?1:a,a=a>d?d:a,d=this._pagingFeatures({maxPerPage:c.maxFeaturesPerPage,
pageNum:a,resultArr:c.features});this.addOrderForFeatures(d);if(a!==c.currentPage)this.clearResultFromMap(b),this.drawFeaturesToMap(d),c.currentPage=a;c.onTurnToPage(d);return d},turnToFirst:function(a,b){return this.turnToPageN(1,a||"default",b)},turnToNext:function(a,b){a=a||"default";return this.turnToPageN(this._typeMapping[a].currentPage+1,a,b)},turnToPre:function(a,b){a=a||"default";return this.turnToPageN(this._typeMapping[a].currentPage-1,a,b)},turnToLast:function(a,b){a=a||"default";this.turnToPageN(this.getTotalPageNumber(a),
a,b)},getPageInfo:function(a){a=this._typeMapping[a||"default"];return Math.ceil(a.features.length/a.maxFeaturesPerPage)},getTotalPageNumber:function(a){a=this._typeMapping[a||"default"];return Math.ceil(a.features.length/a.maxFeaturesPerPage)},getFeatures:function(a){return this._typeMapping[a||"default"].features},drawFeaturesToMap:function(a){var b,c,d;b=this.map;c=this.vectorLayer;if(typeof a=="string"){var e=a||"default";this._typeMapping[e]&&b&&(d=this.getFeatures(e))}a instanceof Array&&(d=
a);c.addFeatures(d);c.map.zoomToExtent(c.getDataExtent())},selectFeatureById:function(a){this.selectControl.unselectAll();this.selectControl.select(a)},clearFeatureFromMap:function(a){var a=a||"default",b=this._typeMapping[a],c=this.vectorLayer,a=a=="allType"?this.vectorLayer.features:b?b.features:[];c&&(this.selectControl.unselectAll(),c.removeFeatures(a))},clearResultFromMap:function(a){this.clearFeatureFromMap(a)},addOrderForFeatures:function(a){for(var b=0;b<a.length;b++)a[b].attributes[this.orderNumberField]=
b;return a},_addStyleForFeatures:function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(!d.style)d.style=b}},_addTypeMarker:function(a,b){for(var c=0;c<a.length;c++)a[c].attributes[this.featureSortField]=b;return a},_pagingFeatures:function(a){for(var b=a.maxPerPage,c=a.pageNum,a=a.resultArr.slice((c-1)*b,c*b-1+1),b=0;b<a.length;b++)a[b].attributes[this.orderNumberField]=b;return a},_dispatchEvent:function(a,b,c){a._typeMapping[b.attributes[a.featureSortField]][c](b)},_initSelectControl:function(){if(this.map&&
!this.selectControl)this.selectControl=new Geo.View3D.Control.SelectFeature(this.vectorLayer,{onSelect:OpenLayers.Function.bind(function(a){this._dispatchEvent(this,a,"onFeatureSelect")},this),onUnselect:OpenLayers.Function.bind(function(a){this._dispatchEvent(this,a,"onFeatureUnselect")},this),callbacks:{over:OpenLayers.Function.bind(function(a){this._dispatchEvent(this,a,"onFeatureOver")},this),out:OpenLayers.Function.bind(function(a){this._dispatchEvent(this,a,"onFeatureOut")},this)}}),this.map.addControl(this.selectControl)}});
Geo.View3D.FeatureManager.defaultStyleMap=new Geo.StyleMap({"default":new Geo.Style({externalGraphic:OpenLayers.Util.getImagesLocation()+"marker.png",graphicWidth:21,graphicHeight:25,graphicXOffset:-10,graphicYOffset:-12}),select:new Geo.Style({externalGraphic:OpenLayers.Util.getImagesLocation()+"marker-blue.png",graphicWidth:21,graphicHeight:25,graphicXOffset:-10,graphicYOffset:-12})});
Geo.View3D.FeatureManager.showFramedCloud=function(a,b){var c=a.layer,d=c?c.map:null;if(c&&d){var e;if(b){c={};for(e in a.attributes)c[e]=a.attributes[e];e=OpenLayers.String.format(b,c)}else e=function(){var b="",c;for(c in a.attributes)b+=c+":"+a.attributes[c]+"<br>";return b}();c=a.geometry.getBounds().getCenterLonLat();d&&d.flyTo(c,4E3);e=new Geo.View3D.Popup.FramedCloud("featureInfo",c,null,e,null,!0,Geo.View3D.FeatureManager.onPopupClose);a.popup=e;d.addPopup(e)}};
Geo.View3D.FeatureManager.closeFramedCloud=function(){};Geo.View3D.FeatureManager.onPopupClose=function(){};Geo.View3D.FeatureManager.showTopic=function(){};Geo.View3D.FeatureManager.closeTopic=function(){};
Geo.View3D.Control.Measure.PointInfo=Geo.Class(Geo.View3D.Control.Measure,{handlerType:Geo.View3D.Handler.Point,initialize:function(){Geo.View3D.Control.Measure.prototype.initialize.apply(this,arguments)},onAddPoint:function(){},onComplete:function(){},_onComplete:function(a){var b=parseFloat(a.x),a=parseFloat(a.y),c=this.map.activexObj.AnalysisBox.QueryAltitude(b,a);this.onComplete({longitude:b,latitude:a,altitude:c,slope:null,aspect:null})},_onAddPoint:function(){},CLASS_NAME:"Geo.View3D.Control.Measure.PointInfo"});
Geo.View3D.Control.Measure.Distance=Geo.Class(Geo.View3D.Control.Measure,{handlerType:Geo.View3D.Handler.Path,isRealTime:!1,initialize:function(){Geo.View3D.Control.Measure.prototype.initialize.apply(this,arguments)},onAddPoint:function(){},onComplete:function(){},_onComplete:function(a){this._points.join(",");var b={distance:null,surfDistance:null};b.distance=a.getGeodesicLength();this.onComplete(b)},_onAddPoint:function(a,b){var c=b.components;this._points=[];for(var d=0;d<c.length;d++)this._points.push(c[d].x),
this._points.push(c[d].y);if(!(c.length<=1)&&this.isRealTime){c=this._points.join(",");d={};d.coordinates=c;var e={surfDistance:null};this._getMeasureResult("surfaceDistance",d,OpenLayers.Function.bind(function(a){e.surfDistance=a.Result.Value;this.onAddPoint(e)},this))}},CLASS_NAME:"Geo.View3D.Control.Measure.PointInfo"});
Geo.View3D.Control.Measure.Area=Geo.Class(Geo.View3D.Control.Measure,{handlerType:Geo.View3D.Handler.Polygon,isRealTime:!1,initialize:function(){Geo.View3D.Control.Measure.prototype.initialize.apply(this,arguments)},onAddPoint:function(){},onComplete:function(){},_onComplete:function(a){this._points.join(",");var b={area:null,surfaceArea:null};b.area=a.getGeodesicArea();this.onComplete(b)},_onAddPoint:function(a,b){var c=b.components[0].components;this._points=[];for(var d=0;d<c.length;d++)this._points.push(c[d].x),
this._points.push(c[d].y);if(!(c.length<=2)&&this.isRealTime){c=this._points.join(",");d={};d.coordinates=c;var e={surfaceArea:null};this._getMeasureResult("surfaceArea",d,OpenLayers.Function.bind(function(a){e.surfaceArea=a.Result.Value;this.onAddPoint(e)},this))}},CLASS_NAME:"Geo.View3D.Control.Measure.Area"});
Geo.View3D.Control.Measure.Volume=Geo.Class(Geo.View3D.Control.Measure,{handlerType:Geo.View3D.Handler.Polygon,height:200,initialize:function(){Geo.View3D.Control.Measure.prototype.initialize.apply(this,arguments)},onAddPoint:function(){},onComplete:function(){},_onComplete:function(a){this._points.join(",");this.onComplete({height:this.height,geometry:a,volume:null})},_onAddPoint:function(a,b){var c=b.components[0].components;this._points=[];for(var d=0;d<c.length;d++)this._points.push(c[d].x),this._points.push(c[d].y);
if(!(c.length<=2)&&this.isRealTime){c=this._points.join(",");d={};d.coordinates=c;d.subjoin=this.height;var e={height:this.height,geometry:b,volume:null};this._getMeasureResult("volume",d,OpenLayers.Function.bind(function(a){a=a.Result.Value.split(" ");e.volume=a[0];e.excavate=a[1];e.fill=a[2];this.onAddPoint(e)},this))}},CLASS_NAME:"Geo.View3D.Control.Measure.Volume"});
Geo.View3D.Control.Measure.Excavate=Geo.Class(Geo.View3D.Control.Measure,{handlerType:Geo.View3D.Handler.Polygon,height:200,lowHeight:0,highHeight:200,initialize:function(){Geo.View3D.Control.Measure.prototype.initialize.apply(this,arguments)},onAddPoint:function(){},onComplete:function(){},_onComplete:function(a){this._points.join(",");var b={height:this.height,geometry:a,excavate:null,fill:null,volume:null},a=a.toString().replace("POLYGON","Ring"),a=a.replace("((","("),a=a.replace("))",")"),a=this.map.activexObj.AnalysisBox.CutFill(this.map.activexObj.DrawBox.CreateGeometryObject(a,
"",3,1),this.lowHeight,this.height);b.excavate=a.CutVolume;b.fill=a.FillVolume;b.volume=0;this.onComplete(b)},_onAddPoint:function(a,b){var c=b.components[0].components;this._points=[];for(var d=0;d<c.length;d++)this._points.push(c[d].x),this._points.push(c[d].y);if(!(c.length<=2)&&this.isRealTime){c=this._points.join(",");d={};d.coordinates=c;d.subjoin=this.height;var e={height:this.height,geometry:b,excavate:null,fill:null,volume:null};this._getMeasureResult("volume",d,OpenLayers.Function.bind(function(a){a=
a.Result.Value.split(" ");e.volume=a[0];e.excavate=a[1];e.fill=a[2];this.onAddPoint(e)},this))}},deactivate:function(){Geo.View3D.Control.prototype.deactivate.apply(this,arguments);return!0},CLASS_NAME:"Geo.View3D.Control.Measure.Excavate"});
Geo.View3D.Control.Measure.Flood=Geo.Class(Geo.View3D.Control.Measure,{handlerType:Geo.View3D.Handler.Polygon,height:2E3,solidOptions:null,solid:null,initialize:function(){Geo.View3D.Control.Measure.prototype.initialize.apply(this,arguments)},_measureHandler:function(a){this._result=a={height:this.height,volume:a.Volume,inundatedArea:a.InundatedArea,floodArea:a.FloodArea,floodVolume:a.FloodVolume};this.onAddPoint(a)},onAddPoint:function(){},onComplete:function(){},_onComplete:function(){this._points.join(",");
this.onComplete({height:this.height,inundatedArea:null,floodArea:null,floodVolume:null})},_onAddPoint:function(a,b){var c=b.components[0].components;this._points=[];for(var d=0;d<c.length;d++)this._points.push(c[d].x),this._points.push(c[d].y);if(!(c.length<=2)&&this.isRealTime){c={};c.coordinates=pointsString;c.subjoin=this.height;var e={height:this.height,inundatedArea:null,floodArea:null,floodVolume:null};this._getMeasureResult("floodAnalysis",c,OpenLayers.Function.bind(function(a){a=a.Result.Value.split(" ");
e.inundatedArea=a[0];e.floodArea=a[1];e.floodVolume=a[2];this.onComplete(e)},this))}},_drawSolid:function(a){this.solid&&this._clearSolid();this.solid=new Geo.View3D.Layer.Solid(this.id+"_solid",a,this.height,this.solidOptions);this.map.addLayer(this.solid)},_clearSolid:function(){this.solid&&this.map&&this.map.removeLayer(this.solid)},deactivate:function(){Geo.View3D.Control.prototype.deactivate.apply(this,arguments)&&this._clearSolid();return!0},CLASS_NAME:"Geo.View3D.Control.Measure.Flood"});
Geo.View3D.Control.Measure.Profile=Geo.Class(Geo.View3D.Control.Measure,{handlerType:Geo.View3D.Handler.Path,initialize:function(a,b){Geo.View3D.Control.prototype.initialize.apply(this,[b]);this.serviceUrl=a;this._terrainAnalysisService=new Geo.Service.TAS(this.id+"_service",a);this.callbacks=OpenLayers.Util.extend({point:this._onAddPoint},this.callbacks);this.handlerOptions=this.handlerOptions||{};if(this.handlerType)this.handler=new this.handlerType(this,this.callbacks,this.handlerOptions)},onAddPoint:function(){},
onComplete:function(){},_onComplete:function(){this._points.join(",");this.onComplete({heightArray:null})},_onAddPoint:function(a,b){var c=b.components;this._points=[];for(var d=0;d<c.length;d++)this._points.push(c[d].x),this._points.push(c[d].y);c.length==2&&(this._onComplete(),this.handler.deactivate(),this.handler.activate())},CLASS_NAME:"Geo.View3D.Control.Measure.Profile"});
Geo.View3D.Control.Measure.TwoPointThrough=Geo.Class(Geo.View3D.Control.Measure,{handlerType:Geo.View3D.Handler.Path,initialize:function(){Geo.View3D.Control.Measure.prototype.initialize.apply(this,arguments)},onAddPoint:function(){},onComplete:function(){},_onComplete:function(){this._points.join(",");this.onComplete({from:null,to:null,isVisible:null,firstUnseenHeight:null,heightArray:null})},_onAddPoint:function(a,b){var c=b.components;this._points=[];for(var d=0;d<c.length;d++)this._points.push(c[d].x),
this._points.push(c[d].y);c.length==2&&(this._onComplete(),this.handler.deactivate(),this.handler.activate())},getVisible:function(a){for(var a=a.split(" "),b=a.length,c=!0,d=null,e=0;e<b;e++){var f=Number(a[0])+(a[b-1]-a[0])/(b-1)*e;e>0&&e<b-1&&c&&a[e]>=f&&(c=!1,d=f)}return{firstUnseenHeight:d,isVisible:c}},CLASS_NAME:"Geo.View3D.Control.Measure.TwoPointThrough"});
Geo.View3D.Control.ModelChoose=Geo.Class(Geo.View3D.Control,{handlerOptions:null,callbacks:{},initialize:function(a){Geo.View3D.Control.prototype.initialize.apply(this,[a]);this.callbacks=OpenLayers.Util.extend({chooseModel:this.chooseModel},this.callbacks);this.handlerOptions=this.handlerOptions||{};this.handler=new Geo.View3D.Handler.ModelChoose(this,this.callbacks,this.handlerOptions)},chooseModel:function(){},CLASS_NAME:"Geo.View3D.Control.ModelChoose"});
Geo.View3D.Control.DrawBox=Geo.Class(Geo.View3D.Control,{initialize:function(a){Geo.View3D.Control.prototype.initialize.apply(this,[a])},createScreenPictureElement:function(a,b,c,d,e){var f=this.map.activexObj;try{if(f){var g=this.createPictureTextureSource(c);return f.ElementBox.CreateScreenPictureElement(a,b,g,d,e)}}catch(h){}return null},createTextElement:function(a,b,c,d,e){var f=this.map.activexObj;try{if(f)return f.ElementBox.CreateTextElement(a,b,c,d,e)}catch(g){}return null},createButtonWidgetElement:function(a,
b,c,d,e,f,g){var h=this.map.activexObj;try{if(h)return c=this.createPictureTextureSource(c),d=this.createPictureTextureSource(d),e=this.createPictureTextureSource(e),h.ElementBox.CreateButtonWidgetElement(a,b,c,d,e,f,g)}catch(l){}return null},createScreenGeometryElement:function(a,b,c,d,e){var f=this.map.activexObj;try{if(f)return f.ElementBox.CreateScreenGeometryElement(a,b,c,d,e)}catch(g){}return null},createBillBoardElement3D:function(a,b,c,d){var e=this.map.activexObj;try{if(e){var f=this.createPictureTextureSource(d);
return e.ElementBox.CreateBillBoardElement3D(a,b,c,f)}}catch(g){}return null},createPOIElement3D:function(a,b,c,d,e,f){var g=this.map.activexObj;try{if(g)return g.ElementBox.CreatePOIElement3D(a,b,c,d,e,f)}catch(h){}return null},createGeoPictureElement3D:function(a,b,c,d,e){var f=this.map.activexObj;try{if(f){var g=this.createPictureTextureSource(e);return f.ElementBox.CreateGeoPictureElement3D(a,b,c,d,g)}}catch(h){}return null},createMeshElement3D:function(a,b,c,d,e,f){var g=this.map.activexObj;
try{if(g)return g.ElementBox.CreateMeshElement3D(a,b,c,d,e,f)}catch(h){}return null},createMaterial3D:function(a,b,c,d,e){var f=this.map.activexObj;try{if(f)return f.ElementBox.CreateMaterial3D(a,b,c,d,e)}catch(g){}return null},createPictureTextureSource:function(a){var b=this.map.activexObj;try{if(b)return b.ElementBox.CreatePictureTextureSource(a)}catch(c){}return null},createCuboidMesh:function(a,b,c,d){var e=this.map.activexObj;try{if(e)return e.ElementBox.CreateCuboidMesh(a,b,c,d)}catch(f){}return null},
createFireElement3D:function(a,b,c,d,e,f){var g=this.map.activexObj;try{if(g)return g.ElementBox.CreateFireElement3D(a,b,c,d,e,f)}catch(h){}return null},createSmokeElement3D:function(a,b,c,d,e,f){var g=this.map.activexObj;try{if(g)return g.ElementBox.CreateSmokeElement3D(a,b,c,d,e,f)}catch(h){}return null},createSpringElement3D:function(a,b,c,d,e,f,g,h){var l=this.map.activexObj;try{if(l)return l.ElementBox.CreateSpringElement3D(a,b,c,d,e,f,g,h)}catch(m){}return null},createRainElement3D:function(a,
b,c,d,e,f){var g=this.map.activexObj;try{if(g)return g.ElementBox.CreateRainElement3D(a,b,c,d,e,f)}catch(h){}return null},setSkyBoxVisible:function(a){var b=this.map.activexObj;if(b)b.ScreenBox.ChangeScreenElementVisible(2,!a),b.ElementBox.SkyBox.Visible=a},setSunVisible:function(a){var b=this.map.activexObj;if(b){b.ConfigBox.SaveConfigItem(22,a);if(!a)b.Camera.CameraMode=1;b.ElementBox.Sun.Visible=a}},removeBoxs:function(){var a=map.activexObj;if(a)for(var a=a.ElementBox,b=a.ElementCount-1;b>=0;b--)a.RemoveElementAt(b)},
CLASS_NAME:"Geo.View3D.Control.DrawBox"});
Geo.CombineView=Geo.Class({id:null,div:null,map2D:null,map2DOptions:null,map3D:null,map3DOptions:null,mapFlash:null,mapFlashOptions:null,currentView:null,viewList:null,defaultView:"2D",defaultLayout:"single",currentLayout:null,center:null,zoom:null,ayncType:"all",layoutList:["single","vertical","horizontal"],EVENT_TYPES:["viewswitch","addlayer","loadlayergroup"],events:null,eventListeners:null,initialize:function(a,b){this.id=OpenLayers.Util.createUniqueID("Geo.CombineView_");this.div=OpenLayers.Util.getElement(a);
this.viewList={"2D":{title:"\u4e8c\u7ef4\u89c6\u56fe",getMapObj:OpenLayers.Function.bind(function(){return this.map2D},this),initFn:OpenLayers.Function.bind(this.initMap2D,this),getInitOptions:OpenLayers.Function.bind(function(){return this.map2DOptions},this)},"3D":{title:"\u4e09\u7ef4\u89c6\u56fe",getMapObj:OpenLayers.Function.bind(function(){return this.map3D},this),initFn:OpenLayers.Function.bind(this.initMap3D,this),getInitOptions:OpenLayers.Function.bind(function(){return this.map3DOptions},
this)},flash:{title:"flash\u89c6\u56fe",getMapObj:OpenLayers.Function.bind(function(){return this.mapFlash},this),initFn:OpenLayers.Function.bind(this.initMapFlash,this),getInitOptions:OpenLayers.Function.bind(function(){return this.mapFlashOptions},this)}};OpenLayers.Util.extend(this,b);this.initLayout();this.currentView=this.defaultView;var c=this.viewList[this.currentView].initFn,d=this.viewList[this.currentView].getInitOptions();c(d);this.events=new OpenLayers.Events(this,this.div,this.EVENT_TYPES,
this.fallThrough,{includeXY:!0});if(this.eventListeners instanceof Object)this.events.on(this.eventListeners)},initMap2D:function(a){if(!this.map2D){var b=document.createElement("div");b.style.height="100%";b.style.width="100%";b.id=this.id+"_map2D";this.div.appendChild(b);this.map2D=new Geo.View2D.Map(b,a);this.map2D.events.on({move:function(){this.center=this.map2D.getCenter();this.zoom=this.map2D.getZoom()},scope:this})}return!0},initMap3D:function(a){if(!this.map3D){var b=document.createElement("div");
b.style.height="100%";b.style.width="100%";b.id=this.id+"_map3D";this.div.appendChild(b);this.map3D=new Geo.View3D.Map(b,a)}return!0},initMapFlash:function(a){if(!this.mapFlash){var b=document.createElement("div");b.style.height="100%";b.style.width="100%";b.id=this.id+"_mapFlash";this.div.appendChild(b);this.mapFlash=new Geo.ViewFl.Map(b,a)}return!0},initLayout:function(){},switchView:function(a){if(a!=this.currentView){if(!a||!this.viewList[a])a=this.getNextView(this.currentView);this.viewList[a].mapObj||
this.viewList[a].initFn();var b=this.viewList[this.currentView].getMapObj();b.div.style.display="none";var c=this.viewList[a].getMapObj();a=="3D"?c.activexObj.Suspend=!1:b.activexObj.Suspend=!0;c.div.style.display="";this.syncView();this.currentView=a;this.events.triggerEvent("viewswitch",{view:a})}},zoomIn:function(){this.getCurrentMapObj().zoomIn()},zoomOut:function(){this.getCurrentMapObj().zoomOut()},setCenter:function(a,b){this.center=a;this.zoom=b;this.getCurrentMapObj().setCenter(a,b)},addLayer:function(a){this.getCurrentMapObj().addLayer(a)},
addLayers:function(a){Geo.Util.isArray(a)||(a=[a]);for(var b=0;b<a.length;b++)this.addLayer(a[b])},loadLayerGroup:function(a){this.getCurrentMapObj().loadLayerGroup(a)},unloadLayerGroup:function(){this.getCurrentMapObj().unloadLayerGroup()},getCurrentMapObj:function(){var a=this.viewList[this.currentView].getMapObj();if(!a)return null;return a},syncView:function(){var a=this.viewList,b=this.currentView,c=a[b].getMapObj(),d;for(d in a)if(b!=d){var e=a[d].getMapObj();if(!e)break;var f=c.getResolution(),
f=e.getZoomForResolution(f),g=c.getCenter();e.setCenter(g,f)}},getNextView:function(a){var b=null,c=null,d=!0,e=!1,f;for(f in this.viewList){d&&(b=f,d=!1);if(e){c=f;break}f===a&&(e=!0)}if(!c)return b;return c},CLASS_NAME:"Geo.CombineView"});
Geo.LayerManager=Geo.Class({map:null,autoUpdateList:!0,isAllLayers:!1,template:{wrapper:"<ul>${layerItemTemplate}</ul>",item:"<li><input type='checkbox' ${visibility} onchange='lm.toggleLayerVisibility(${layerid})' />${layerName}</li>",noLayer:"<li>\u5f53\u524d\u6ca1\u6709\u56fe\u5c42</li>"},ascending:!0,initialize:function(a){OpenLayers.Util.extend(this,a)},setMap:function(a){this.map=a;this._updateLayerList()},getCurrentMapObj:function(){var a=this.map;a.CLASS_NAME=="Geo.CombineView"&&(a=a.getCurrentMapObj());
return a},updateLayerList:function(){},_updateLayerList:function(){var a=this.getLayers();this.map&&this.autoUpdateList&&this.updateLayerList(a)},getLayers:function(){var a=[],b=this.getCurrentMapObj();if(!b)return a;b=b.layers;if(!this.isAllLayers)for(var c=0;c<b.length;c++){var d=b[c];d.displayInLayerSwitcher&&a.push(d)}this.ascending||a.reverse();return a},setOpacity:function(a,b){var c=this.getCurrentMapObj().getLayer(a);c&&c.setOpacity(b);this._updateLayerList()},raisLayer:function(a,b){var c=
this.getCurrentMapObj(),d=c.getLayer(a);d&&c.raiseLayer(d,b);this._updateLayerList()},raisLayerToTop:function(a){var b=this.getCurrentMapObj(),c=b.getLayer(a);if(c)b=b.layers,c=OpenLayers.Util.indexOf(b,c),this.raisLayer(a,b.length-c)},raisLayerToBottom:function(a){var b=this.getCurrentMapObj(),c=b.getLayer(a);c&&(b=0-OpenLayers.Util.indexOf(b.layers,c),this.raisLayer(a,b))},toggleLayerVisibility:function(a){a=this.getCurrentMapObj().getLayer(a);a.setVisibility(!a.getVisibility())},gotoLayer:function(a){var b=
this.getCurrentMapObj(),c=b.getLayer(a);if(c.gotoCenter)c.gotoCenter();else{if(c instanceof Geo.View2D.Layer.WMTS)a=c.tileFullExtent;else if(c instanceof OpenLayers.Layer.Vector){a=(a=c.getDataExtent())?a:c.maxExtent?c.maxExtent:b.maxExtent;b.zoomToExtent(a);return}else if(c instanceof Geo.View2D.Layer.WMS){a=c.maxExtent?c.maxExtent:b.maxExtent;b.zoomToExtent(a);return}else if(c instanceof Geo.View2D.Layer.DynamicMapService){a=c.maxExtent?c.maxExtent:b.maxExtent;b.zoomToExtent(a);return}else if(c instanceof
Geo.View2D.Layer.TileMapService){a=c.maxExtent?c.maxExtent:b.maxExtent;b.zoomToExtent(a);return}else a=c.maxExtent?c.maxExtent:b.maxExtent;this.getCurrentMapObj().CLASS_NAME=="Geo.ViewFl.Map"?(a=c.maxExtent?c.maxExtent:c.getExtent(),c=c.getResolution()):c=c.maxResolution?c.maxResolution:b.maxResolution;c=b.getZoomForResolution(c,!0);b.setCenter(a.getCenterLonLat(),c)}},removeLayer:function(a){var b=this.getCurrentMapObj();(a=b.getLayer(a))&&b.removeLayer(a);this._updateLayerList()},addLayer:function(a,
b){var c=this.getCurrentMapObj(),d=c.CLASS_NAME,a=a.toUpperCase(),d=Geo.LayerManager.supportService[d][a],e=null;if(d)return e=d(b),c.addOverLayer(e),this._updateLayerList(),!0;return!1},CLASS_NAME:"Geo.LayerManager"});
Geo.LayerManager.supportService={"Geo.View2D.Map":{OGC_WMS:function(a){var b=a.name,c=a.url,d=a.params,e=a.options,f=a.params.layers;if(a.isSeparate){f.split(",");for(var a=[],f=0,g=arrLayers.length;f<g;f++)OpenLayers.Util.extend(d,{layers:arrLayers[f]}),a.push(new OpenLayers.Layer.WMS(b,c,d,e));return a}return new OpenLayers.Layer.WMS(b,c,d,e)},GEO_TILE:function(a){return new Geo.View2D.Layer.GlobeTile(a.name,a.url,a.options)},OGC_WMTS:function(a){return new OpenLayers.Layer.WMTS(a)},GEO_CWMS:function(a){return new Geo.View2D.Layer.CWMS(a.name,
a.url,a.options)},ARCGIS_REST:function(a){return new Geo.View2D.Layer.ArcGIS93Rest(a.name,a.url,a.options)},OGC_WFS:function(a){var b=a.name,c=a.url,d=a.version,a=a.options,e=[];e.push(new OpenLayers.Strategy.BBOX);if(a.keyWord){var f=new Geo.Filter.Comparison({type:Geo.Filter.Comparison.LIKE,property:a.featurePropertyName,value:"/*"+a.keyWord+"/*"}),f=new OpenLayers.Strategy.Filter({filter:f});e.push(f)}return new Geo.View2D.Layer.Vector(b,{strategies:e,protocol:new OpenLayers.Protocol.WFS({maxFeatures:a.maxFeatures,
geometryName:a.geometry,url:c,version:d,featureType:a.featureType})})}},"Geo.View3D.Map":{OGC_WMS:function(a){var b=a.name,c=a.url,d=a.params,e=a.options,f=a.params.layers;if(a.isSeparate){f.split(",");for(var a=[],f=0,g=arrLayers.length;f<g;f++)OpenLayers.Util.extend(d,{layers:arrLayers[f]}),a.push(new Geo.View3D.Layer.WMS(b,c,d,e));return a}return new Geo.View3D.Layer.WMS(b,c,d,e)},GEO_TILE:function(a){return new Geo.View3D.Layer.GlobeTile(a.name,a.url,a.options)},GEO_TERRAIN:function(a){return new Geo.View3D.Layer.Terrain(a.name,
a.url,a.options)},GEO_MODEL:function(a){return new Geo.View3D.Layer.Model(a.name,a.url,a.options)},OGC_WMTS:function(a){return new Geo.View3D.Layer.WMTS(a.name,a.url,a)},GEO_WTFS:function(a){return new Geo.View3D.Layer.WTFS(a.name,a.url,a.options)},ARCGIS_REST:function(a){return new Geo.View3D.Layer.ArcgisRest(a.name,a.url,a.options)},OGC_WFS:function(a){return new Geo.View3D.Layer.WFS(a.name,a.url,a.options)}},"Geo.ViewFl.Map":{OGC_WMS:function(a){var b=a.name,c=a.url,d=a.params,e=a.options,f=a.params.layers;
if(a.isSeparate){f.split(",");for(var a=[],f=0,g=arrLayers.length;f<g;f++)OpenLayers.Util.extend(d,{layers:arrLayers[f]}),a.push(new Geo.ViewFl.Layer.WMS(b,c,d,e));return a}return new Geo.ViewFl.Layer.WMS(b,c,d,e)},GEO_TILE:function(a){return new Geo.ViewFl.Layer.GlobeTile(a.name,a.url,a.options)},OGC_WMTS:function(a){return new Geo.ViewFl.Layer.WMTS(a.name,a.url,a)}}};
Geo.Analysis.BufferAnalysis=Geo.Class({url:null,type:1,accuracy:32,initialize:function(a,b){this.url=a;OpenLayers.Util.extend(this,b)},_buildPostXML:function(a,b){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><wps:Execute service="WPS" version="1.0.0" xmlns:gml="http://www.opengis.net/gml" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 ../wpsExecute_request.xsd"><ows:Identifier>Buffer</ows:Identifier><wps:DataInputs><wps:Input><ows:Identifier>InputPolygon</ows:Identifier><wps:Data><wps:ComplexData schema="http://foo.bar/MyComplexValueSchema.xsd" mimeType="text/xml" encoding="UTF-8">'+
(new OpenLayers.Format.GML).write(a)+"</wps:ComplexData></wps:Data></wps:Input><wps:Input><ows:Identifier>BufferDistance</ows:Identifier><wps:Data><wps:LiteralData>"+b+"</wps:LiteralData></wps:Data></wps:Input><wps:Input><ows:Identifier>BufferType</ows:Identifier><wps:Data><wps:LiteralData>"+this.type+"</wps:LiteralData></wps:Data></wps:Input><wps:Input><ows:Identifier>BufferAccuracy</ows:Identifier><wps:Data><wps:LiteralData>"+this.accuracy+"</wps:LiteralData></wps:Data></wps:Input></wps:DataInputs><wps:ResponseForm><wps:RawDataOutput><ows:Identifier>BufferedPolygon</ows:Identifier></wps:RawDataOutput></wps:ResponseForm></wps:Execute>"},
_getFeaturesCenter:function(a){return this._getFeaturesExtent(a).getCenterLonLat()},_getFeaturesExtent:function(a){Geo.Util.isArray(a)||(a=[a]);var b=null;if(a&&a.length>0)for(var b=new Geo.Bounds,c=null,d=0,e=a.length;d<e;d++)(c=a[d].geometry)&&b.extend(c.getBounds());return b},startAnalysis:function(a,b,c){var d=["m","km","degree"],e=this._getFeaturesCenter(a);if(!c||OpenLayers.Util.indexOf(d,c)==-1)c="m";switch(c){case "km":b*=1E3;case "m":b=this._meterToDegree(b,e)}a=this._buildPostXML(a,b);new OpenLayers.Request.POST({url:this.url,
data:a,scope:this,success:function(a){""==a.responseText||null==a.responseText?this.failFn():this.successFn(this._parserResult(a))},failure:this.failFn})},_meterToDegree:function(a,b){return a*(8.99E-6/Math.cos(OpenLayers.Util.rad(b.lat)))},successFn:function(){},failFn:function(){alert("\u7f13\u51b2\u5206\u6790\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u68c0\u6d4b\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002")},_parserResult:function(a){var b=null,b=new OpenLayers.Format.XML;if(!a.responseXML)a.responseXML=
b.read(a.responseText);return b=(new OpenLayers.Format.GML).read(a.responseXML)},CLASS_NAME:"Geo.Analysis.BufferAnalysis"});Geo.Analysis.BufferAnalysis.CAP_ROUND=1;Geo.Analysis.BufferAnalysis.CAP_BUTT=2;Geo.Analysis.BufferAnalysis.CAP_SQUARE=3;
Geo.Analysis.SuperposeAnalysis=Geo.Class({url:null,type:"Intersection",_requestStringTemplate:'<wps:Execute service="WPS" version="1.0.0" xmlns:gml="http://www.opengis.net/gml" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:wfs="http://www.opengis.net/wfs" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 ../wpsExecute_request.xsd"><ows:Identifier>${type}</ows:Identifier><wps:DataInputs><wps:Input><ows:Identifier>InputPolygon</ows:Identifier><wps:Data><wps:ComplexData schema="http://foo.bar/MyComplexValueSchema.xsd" mimeType="text/xml" encoding="UTF-8">${dataInputs}</wps:ComplexData></wps:Data></wps:Input></wps:DataInputs><wps:ResponseForm><wps:RawDataOutput><ows:Identifier>BufferedPolygon</ows:Identifier></wps:RawDataOutput></wps:ResponseForm></wps:Execute>',sourceFeatures:null,
targetFeatures:null,initialize:function(a,b){this.url=a;this.sourceFeatures=[];this.targetFeatures=[];OpenLayers.Util.extend(this,b)},_buildRequestString:function(){var a=new OpenLayers.Format.GML,b=a.write(this.sourceFeatures),a=a.write(this.targetFeatures);return OpenLayers.String.format(this._requestStringTemplate,{type:this.type,dataInputs:b+a})},startAnalysis:function(){if(this._checkSet())return!1;var a=this._buildRequestString();new OpenLayers.Request.POST({url:this.url,data:a,scope:this,success:function(a){""==
a.responseText||null==a.responseText?this.failFn():this.successFn(this._parserResult(a))},failure:this.failFn})},_checkSet:function(){if(!this.url)return!1;if(!this.sourceFeatures||!this.sourceFeatures.length)return!1;if(!this.targetFeatures||!this.targetFeatures.length)return!1},successFn:function(){},failFn:function(){alert("\u53e0\u7f6e\u5206\u6790\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u68c0\u6d4b\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002")},_parserResult:function(a){var b=[],c=new OpenLayers.Format.XML;
if(!a.responseXML)a.responseXML=c.read(a.responseText);var d=c.lookupNamespaceURI(a.responseXML,"gml"),a=c.getElementsByTagNameNS(a.responseXML,d,"FeatureCollection");a.length>0&&(b=c.write(a[0]),b=(new OpenLayers.Format.GML).read(b));return b},CLASS_NAME:"Geo.Analysis.SuperposeAnalysis"});
Geo.Query.WFSQuery=Geo.Class({url:null,version:"1.0.0",featureNS:null,isReverse:!1,featurePrefix:"",featureType:"",maxFeatures:10,filter:null,geometryName:"the_geom",protocol:null,format:null,formatOptions:null,isSeparate:!1,srsName:"EPSG:4326",sortBy:null,initialize:function(a,b,c){this.url=a;this.featureType=b;a=null;if(c)c.isReverse===!0?(this.isReverse=c.isReverse,a=!c.isReverse):c.isReverse===!1?(this.isReverse=c.isReverse,a=!c.isReverse):a=!this.isReverse,c.format?(c.format instanceof OpenLayers.Format.GML.v2||
c.format instanceof OpenLayers.Format.GML.v3)&&c.format.setFeatureType_(b):this.format=new OpenLayers.Format.GML({xy:a});OpenLayers.Util.extend(this,c)},query:function(a,b,c){this.protocol=new OpenLayers.Protocol.WFS({readFormat:this.format,formatOptions:this.formatOptions,propertyNames:this.propertyNames,maxFeatures:this.maxFeatures,featurePrefix:this.featurePrefix,featureNS:this.featureNS,url:this.url,version:this.version,geometryName:this.geometryName,featureType:this.featureType,srsName:this.srsName});
var a=a||this.filter,d=b||this.successFn,e=c||this.failFn,b=OpenLayers.Function.bind(function(a){if(a.success()){var b=a.features;this.isSeparate&&(b=this._separateFeatures(b));(a=this._read_trueName(a))&&(b.trueNames=a);d(b)}else e()},this);this.response=this.protocol.read({sortBy:this.sortBy,filter:a,callback:b})},_read_trueName:function(a){var b=[];if(a.priv&&a.priv.responseText){if(null==this.format)return null;a=this.format.getXMLDoc().getElementsByTagName("trueName");if(a==null||a.length==0)return null;
for(var c=0;c<a.length;c++)b.push(a[c].text)}return b},getBufferRegion:function(a,b,c){var d=this._getFeaturesCenter(a);switch(c){case "km":b*=1E3;case "m":b=this._meterToDegree(b,d)}return Geo.Geometry.Polygon.createRegularPolygon(a,b,40,360)},_getFeaturesCenter:function(a){return this._getFeaturesExtent(a).getCenterLonLat()},_getFeaturesExtent:function(a){Geo.Util.isArray(a)||(a=[a]);var b=null;if(a&&a.length>0)for(var b=new Geo.Bounds,c=null,d=0,e=a.length;d<e;d++)(c=a[d].geometry)&&b.extend(c.getBounds());
return b},_meterToDegree:function(a,b){return a*(8.99E-6/Math.cos(OpenLayers.Util.rad(b.lat)))},pointQuery:function(a,b,c,d,e){this.query(new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN,property:this.geometryName,distance:b||0,distanceUnits:c||"degree",value:a}),d,e)},pathQuery:function(a,b,c,d,e){this.query(new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN,property:this.geometryName,distance:b||0,distanceUnits:c||"degree",value:a}),d,e)},polygonQuery:function(a,
b,c,d){this.query(new OpenLayers.Filter.Spatial({type:b?OpenLayers.Filter.Spatial.CONTAINS:OpenLayers.Filter.Spatial.INTERSECTS,property:this.geometryName,value:a}),c,d)},bboxQuery:function(a,b,c){this.query(new Geo.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,property:this.geometryName,value:a}),b,c)},attributeQuery:function(a,b,c,d,e,f){this.query(new OpenLayers.Filter.Comparison({type:a,property:b,value:c,matchCase:d&&d.matchCase,lowerBoundary:d?d.lowerBoundary:null,upperBoundary:d?d.upperBoundary:
null}),e,f)},successFn:function(){},failFn:function(){alert("\u5bf9\u4e0d\u8d77,\u67e5\u8be2\u5931\u8d25,\u8bf7\u67e5\u8be2\u670d\u52a1\u662f\u5426\u6b63\u5e38\u3002")},_separateFeatures:function(a){for(var b={},c=0;c<a.length;c++){var d=a[c],e;e=d.gml?d.gml.featureType:d.type;b[e]||(b[e]=[]);b[e].push(d)}return b},CLASS_NAME:"Geo.Query.WFSQuery"});
Geo.Query.WFSQuery.reverseGeometryXY=function(a){var b={Point:function(a){var b=a.x,e=a.y,a=a.clone(a);a.x=e;a.y=b;return a},LineString:function(a,b){for(var e=a.clone(a),f=0;f<e.components.length;f++){var g=b.Point(e.components[f]);e.components[f]=g}return e},Polygon:function(a,b){for(var e=a.clone(a),f=0;f<e.components.length;f++)for(var g=0;g<e.components[f].components.length-1;g++){var h=b.Point(e.components[f].components[g]);e.components[f].components[g]=h}return e}};return b[{"OpenLayers.Geometry.Point":"Point",
"OpenLayers.Geometry.MultiPoint":"MultiPoint","OpenLayers.Geometry.LineString":"LineString","OpenLayers.Geometry.MultiLineString":"MultiLineString","OpenLayers.Geometry.Polygon":"Polygon","OpenLayers.Geometry.MultiPolygon":"MultiPolygon","OpenLayers.Geometry.Collection":"GeometryCollection"}[a.CLASS_NAME]](a,b)};OpenLayers.Format.Filter.v1.prototype.writers.ogc.SortBy=function(a){for(var b=this.createElementNSPlus("ogc:SortBy"),c=0,d=a.length;c<d;c++)this.writeNode("ogc:SortProperty",a[c],b);return b};
OpenLayers.Format.WFST.v1.prototype.writers.wfs.GetFeature=function(a){var b=this.createElementNSPlus("wfs:GetFeature",{attributes:{service:"WFS",version:this.version,outputFormat:a&&a.outputFormat,resultType:a&&a.resultType,startPosition:a&&a.startPosition,maxFeatures:a&&a.maxFeatures,"xsi:schemaLocation":this.schemaLocationAttr(a)}});if(typeof this.featureType=="string")this.writeNode("Query",a,b);else for(var c=0,d=this.featureType.length;c<d;c++)a.featureType=this.featureType[c],this.writeNode("Query",
a,b);return b};OpenLayers.Format.Filter.v1.prototype.writers.ogc.SortProperty=function(a){var b=this.createElementNSPlus("ogc:SortProperty");this.writeNode("ogc:PropertyName",a,b);this.writeNode("ogc:SortOrder",a.order=="DESC"?"DESC":"ASC",b);return b};OpenLayers.Format.Filter.v1.prototype.writers.ogc.SortOrder=function(a){return this.createElementNSPlus("ogc:SortOrder",{value:a})};
OpenLayers.Protocol.WFS.v1.prototype.parseResponse=function(a,b){var c=a.responseXML;if(!c||!c.documentElement)c=a.responseText;if(!c||c.length<=0)return null;var d=null;try{d=this.readFormat!==null?this.readFormat.read(c):this.format.read(c,b)}catch(e){alert("\u7a0b\u5e8f\u8fd0\u884c\u5f02\u5e38\uff1a"+e.name+"\uff0c"+e.message)}if(!this.featureNS)c=this.readFormat||this.format,this.featureNS=c.featureNS,c.autoConfig=!1,this.geometryName||this.setGeometryName(c.geometryName);return d};
OpenLayers.Format.WFST.v1_0_0.prototype.writers={wfs:OpenLayers.Util.applyDefaults({Query:function(a){var a=OpenLayers.Util.extend({featureNS:this.featureNS,featurePrefix:this.featurePrefix,featureType:this.featureType,srsName:this.srsName,srsNameInQuery:this.srsNameInQuery},a),b=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(a.featureNS?a.featurePrefix+":":"")+a.featureType}});a.srsNameInQuery&&a.srsName&&b.setAttribute("srsName",a.srsName);a.featureNS&&b.setAttribute("xmlns:"+a.featurePrefix,
a.featureNS);if(a.propertyNames)for(var c=0,d=a.propertyNames.length;c<d;c++)this.writeNode("ogc:PropertyName",{property:a.propertyNames[c]},b);a.filter&&(this.setFilterProperty(a.filter),this.writeNode("ogc:Filter",a.filter,b));a.sortBy&&this.writeNode("ogc:SortBy",a.sortBy,b);return b}},OpenLayers.Format.WFST.v1.prototype.writers.wfs),gml:OpenLayers.Format.GML.v2.prototype.writers.gml,feature:OpenLayers.Format.GML.v2.prototype.writers.feature,ogc:OpenLayers.Format.Filter.v1_0_0.prototype.writers.ogc};
Geo.Query.WFSQuery.prototype.sortBy=null;OpenLayers.Format.GML.Base.prototype.setFeatureType_=function(a){this.featureType_=a};
OpenLayers.Format.GML.Base.prototype.readers.feature["*"]=function(a,b){var c,d=a.localName||a.nodeName.split(":").pop();if(b.features)if(!this.singleFeatureType&&OpenLayers.Util.indexOf(this.featureType,d)!==-1)c="_typeName";else if(d===this.featureType)c="_typeName";else{if(OpenLayers.Util.isArray(this.featureType_))for(var e=0;e<this.featureType_.length;e++)if(this.featureType_[e]===d){c="_typeName";break}}else a.childNodes.length==0||a.childNodes.length==1&&a.firstChild.nodeType==3?this.extractAttributes&&
(c="_attribute"):c="_geometry";c&&this.readers.feature[c].apply(this,[a,b])};OpenLayers.Format.WFSHits=OpenLayers.Class(OpenLayers.Format.XML,{wfsns:"http://www.opengis.net/wfs",featureCollection:"FeatureCollection",read:function(a){typeof a=="string"&&(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));return{numberOfFeatures:parseInt(a.documentElement.getAttribute("numberOfFeatures"))}}});Geo.Query.WFSQuery.prototype.resultType="Results";Geo.Query.WFSQuery.prototype.startPosition=null;
Geo.Query.WFSQuery.prototype.queryTotalNumber=function(a,b,c){var d=new OpenLayers.Format.WFSHits;this.protocol=new OpenLayers.Protocol.WFS({readFormat:d,propertyNames:this.propertyNames,resultType:"hits",maxFeatures:this.maxFeatures,featurePrefix:this.featurePrefix,featureNS:this.featureNS,url:this.url,version:this.version,geometryName:this.geometryName,featureType:this.featureType});var a=a||this.filter,e=b||this.successFn,f=c||this.failFn,b=OpenLayers.Function.bind(function(a){a.success()?e(a.features):
f()},this);this.response=this.protocol.read({filter:a,callback:b})};
Geo.Query.WFSQuery.prototype.queryPage=function(a,b,c,d){var e=d&&d.perPageNumber||15;this.protocol=new OpenLayers.Protocol.WFS({readFormat:this.format,multi:!0,formatOptions:this.formatOptions,propertyNames:this.propertyNames,maxFeatures:e,startPosition:((d&&d.pageNumber||1)-1)*e+1,featurePrefix:this.featurePrefix,url:this.url,featureNS:this.featureNS,version:this.version,geometryName:this.geometryName,featureType:this.featureType,srsName:this.srsName});var a=a||this.filter,f=b||this.successFn,g=
c||this.failFn,b=OpenLayers.Function.bind(function(a){if(a.success()){var b=a.features;this.isSeparate&&(b=this._separateFeatures(b));a=this._read_trueName(a);b.trueNames=a;f(b)}else g()},this);this.response=this.protocol.read({sortBy:this.sortBy,filter:a,callback:b})};
Geo.Query.CatalogQuery=Geo.Class({url:null,failFn:function(){alert("\u5bf9\u4e0d\u8d77\uff0c\u67e5\u8be2\u8bf7\u6c42\u5931\u8d25\uff01\u8bf7\u68c0\u67e5\u8d44\u6e90\u76ee\u5f55\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002\n\u5f53\u524d\u670d\u52a1\u5730\u5740\u4e3a\uff1a"+this.url)},initialize:function(a,b){this.url=a;OpenLayers.Util.extend(this,b)},_soapTemplate:'<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xsi:schemaLocation="http://www.opengis.net/ows" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><soapenv:Body>${soapBody}</soapenv:Body></soapenv:Envelope>',
_getRecordsTemplate:'<csw:GetRecords service="CSW" version="2.0.2" outputFormat="text/xml" resultType="results" ${outputSchema} xmlns:csw="http://www.opengis.net/cat/csw" xmlns:ogc="http://www.opengis.net/ogc" ${customNamespaces}> <csw:Query typeNames="${typeNames}"><csw:ElementSetName>full</csw:ElementSetName>${constraint}</csw:Query></csw:GetRecords>',_constraintTemplate:'<csw:Constraint version="2.0.0">${filter}</csw:Constraint>',getResTreeNode:function(a,b,c,d){a&&(a=0);b=new Geo.Filter.Comparison({type:Geo.Filter.Comparison.EQUAL_TO,
property:"/geoglobe:ResourceType/geoglobe:kind",value:"CATALOG"});a=new Geo.Filter.Comparison({type:Geo.Filter.Comparison.EQUAL_TO,property:"/geoglobe:ResourceType/geoglobe:parentId",value:a});a=this._makerFilterString(new Geo.Filter.Logical({type:Geo.Filter.Logical.AND,filters:[b,a]}));a=OpenLayers.String.format(this._getRecordsTemplate,{customNamespaces:'xmlns:geoglobe="http://www.geostar.com.cn/geoglobe"',constraint:a,outputSchema:'outputSchema="geoglobe:ResourceType"',typeNames:"geoglobe:ResourceType"});
a=this._wrapToSoapRequest(a);if(!(d instanceof Function))d=this.failFn;b=OpenLayers.Function.bind(function(a){a=this._getBodyFromSoapResponse(a.responseText);OpenLayers.Function.bind(c,this)(a)},this);new OpenLayers.Ajax.Request(this.url,{contentType:"application/xml",method:"post",postBody:a,onSuccess:b,onFailure:d})},searchServices:function(){},queryMetaData:function(a,b,c,d){a=this._makerFilterString(a);a=OpenLayers.String.format(this._getRecordsTemplate,{customNamespaces:' xmlns:smmd="http://data.sbsm.gov.cn/smmd/2007"',
constraint:a,outputSchema:' outputSchema="smmd:Metadata"',typeNames:"smmd:Metadata"});a=this._wrapToSoapRequest(a);if(!(d instanceof Function))d=this.failFn;b=OpenLayers.Function.bind(function(a){a=this._getBodyFromSoapResponse(a.responseText);OpenLayers.Function.bind(c,this)(a)},this);new OpenLayers.Ajax.Request(this.url,{contentType:"application/xml",method:"post",postBody:a,onSuccess:b,onFailure:d})},_wrapToSoapRequest:function(a){return OpenLayers.String.format(this._soapTemplate,{soapBody:a})},
_getBodyFromSoapResponse:function(a){typeof a=="string"&&(a=Geo.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)a=a.documentElement;if(a.nodeName=="SOAP-ENV:Envelope")return a.childNodes[0].childNodes[0];return a},_makerFilterString:function(a){a||(a=new Geo.Filter.Comparison({type:Geo.Filter.Comparison.LIKE,property:"/smmd:Metadata/smmd:mdFileID",value:"*"}));a=(new Geo.Format.Filter).write(a).xml;return constraintString=OpenLayers.String.format(this._constraintTemplate,{filter:a})},
CLASS_NAME:"Geo.Query.CatalogQuery"});
Geo.Format.CSWGetRecords.v2_0_0=Geo.Class(Geo.Format.CSWGetRecords.v2_0_2,{namespaces:{xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",csw:"http://www.opengis.net/cat/csw",dc:"http://purl.org/dc/elements/1.1/",dct:"http://purl.org/dc/terms/",ows:"http://www.opengis.net/ows",geoglobe:"http://www.geostar.com.cn/geoglobe",smmd:"http://data.sbsm.gov.cn/smmd/2007"},version:"2.0.0",schemaLocation:"http://www.opengis.net/cat/csw http://schemas.opengis.net/csw/CSW-discovery.xsd",readers:{csw:{GetRecordsResponse:function(a,
b){b.records=[];this.readChildNodes(a,b);var c=this.getAttributeNS(a,"","version");if(c!="")b.version=c},RequestId:function(a,b){b.RequestId=this.getChildValue(a)},SearchStatus:function(a,b){b.SearchStatus={};var c=this.getAttributeNS(a,"","timestamp");if(c!="")b.SearchStatus.timestamp=c},SearchResults:function(a,b){this.readChildNodes(a,b);for(var c=a.attributes,d={},e=0,f=c.length;e<f;++e)d[c[e].name]=c[e].name=="numberOfRecordsMatched"||c[e].name=="numberOfRecordsReturned"||c[e].name=="nextRecord"?
parseInt(c[e].nodeValue):c[e].nodeValue;b.SearchResults=d}},dc:{"*":function(a,b){var c=a.localName||a.nodeName.split(":").pop();Geo.Util.isArray(b[c])||(b[c]=[]);for(var d={},e=a.attributes,f=0,g=e.length;f<g;++f)d[e[f].name]=e[f].nodeValue;d.value=this.getChildValue(a);b[c].push(d)}},dct:{"*":function(a,b){var c=a.localName||a.nodeName.split(":").pop();Geo.Util.isArray(b[c])||(b[c]=[]);b[c].push(this.getChildValue(a))}},ows:{WGS84BoundingBox:function(a,b){if(!Geo.Util.isArray(b.BoundingBox))b.BoundingBox=
[];for(var c=this.getChildValue(this.getElementsByTagNameNS(a,this.namespaces.ows,"LowerCorner")[0]).split(" ",2),d=this.getChildValue(this.getElementsByTagNameNS(a,this.namespaces.ows,"UpperCorner")[0]).split(" ",2),c={value:[parseFloat(c[0]),parseFloat(c[1]),parseFloat(d[0]),parseFloat(d[1])]},d=a.attributes,e=0,f=d.length;e<f;++e)c[d[e].name]=d[e].nodeValue;b.BoundingBox.push(c)},BoundingBox:function(a,b){this.readers.ows.WGS84BoundingBox.apply(this,[a,b])}},geoglobe:{ResourceType:function(a,b){var c=
{type:"ResourceType"};this.readChildNodes(a,c);b.records.push(c)},"*":function(a,b){var c=a.localName||a.nodeName.split(":").pop();b[c]=this.getChildValue(a)}},smmd:{Metadata:function(a,b){var c={type:"Metadata"};this.readChildNodes(a,c);b.records.push(c)},"*":function(a,b){var c=a.localName||a.nodeName.split(":").pop();b[c]=this.getChildValue(a)}}},CLASS_NAME:"OpenLayers.Format.CSWGetRecords.v2_0_0"});
Geo.Query.ModelQuery=Geo.Class({maxFeatures:10,format:null,modelLayer:null,map:null,enumLayerPropertyName:{layerName:0,layerVisible:1,layerTransparency:2,layerFullEnvelope:3,wmslayerInfo:4,wmtslayerInfo:5,EnableSelection:6},initialize:function(a,b){this.modelLayer=a;this.format=new Geo.Util.Format.XML2JSON;OpenLayers.Util.extend(this,b)},query:function(a,b){if(this.modelLayer!=null){var c=this.modelLayer.map.activexObj;c.SelectionBox.EnableSelection=!0;c.LayerBox.CreateLayerOperate(this.modelLayer._layerData).ChangeLayerProperty(this.enumLayerPropertyName.EnableSelection,
!0);var d=a||this.successFn,e=b||this.failFn;this.queryHandler=OpenLayers.Function.bind(function(a){this._queryHandler(a,d,e)},this);c.addEventListener?c.addEventListener("MouseEvent",this.queryHandler,!1):c.attachEvent&&c.attachEvent("OnMouseEvent",this.queryHandler)}},_queryHandler:function(a,b,c){var d=this.modelLayer.map.activexObj;if(a.MouseButton===1&&a.MouseState===0)if(d.SelectionBox.SelectByScreenPoint(a.ScreenX,a.ScreenY),a){if(a=d.SelectionBox.QuerySelectedID(0),d.SelectionBox.Count!=0&&
(d=this.format.read(d.ObjectFactory.CreateObjectFromParameter("eGMDLAttributeOperater","").QueryAttributeFromServerID(this.modelLayer.url,a))))if(d=d.Feature){var a=d.Y?d.Y:"",c=d.Z?d.Z:"",e=d.GEOSTAR_MIN_X?d.GEOSTAR_MIN_X:"",f=d.GEOSTAR_MIN_Y?d.GEOSTAR_MIN_Y:"",g=d.GEOSTAR_MAX_X?d.GEOSTAR_MAX_X:"",h=d.GEOSTAR_MAX_X?d.GEOSTAR_MAX_X:"",l=d.NAME?d.NAME:"",m={longitude:null,latitude:null,altitude:null,name:null,bounds:null};m.longitude=d.X?d.X:"";m.latitude=a;m.altitude=c;m.name=l;m.bounds=new Geo.Bounds(e,
f,g,h);b(m)}}else c()},removeQuery:function(){var a=this.modelLayer.map.activexObj;a.removeEventListener?a.removeEventListener("MouseEvent",this.queryHandler,!1):a.detachEvent&&a.detachEvent("OnMouseEvent",this.queryHandler)},CLASS_NAME:"Geo.Query.ModelQuery"});
Geo.Query.MapServiceQuery=Geo.Class({url:null,initialize:function(a,b){this.url=a.indexOf("/",a.length-1)!=-1?a+"query":a+"/query";var c=new Geo.Util.Format.MapServiceQuery;this.jsonp=new OpenLayers.Protocol.Script({format:c});OpenLayers.Util.extend(this,b)},query:function(a,b){var c=this._getParamsFromQueryParameter(a);OpenLayers.Util.applyDefaults(c,{f:"json",pretty:!0});this.jsonp.createRequest(this.url,c,OpenLayers.Function.bind(function(a){var c=c||this.failFn;if(a.error)c(a.error);else{var c=
this.jsonp.format.read(a),f=new Geo.Query.MapServiceQueryResult;f.features=c;f.displayFieldName=a.displayFieldName;f.fieldAliases=a.fieldAliases;f.geometryType=a.geometryType;f.spatialReference=a.spatialReference;b(f)}},this))},queryForIds:function(a,b){var c=this._getParamsFromQueryParameter(a);OpenLayers.Util.applyDefaults(c,{f:"json",returnIdsOnly:!0,pretty:!0});this.jsonp.createRequest(this.url,c,OpenLayers.Function.bind(function(a){b({objectIdFieldName:a.objectIdFieldName,objectIds:a.objectIds})},
this))},_getParamsFromQueryParameter:function(a){var b={},c;for(c in a)a[c]!==null&&(b[c]=a[c]);if(b.geometry instanceof Geo.Geometry||b.geometry instanceof Geo.Bounds)b.geometryType=b.serviceType=="ArcgisRest"?"esri"+this._getGeometryType(b.geometry):this._getGeometryType(b.geometry),b.geometry=this._getGeometryRepresentation(b.geometry);if(b.timeExtent&&b.timeExtent.startTime instanceof Date&&b.timeExtent.endTime instanceof Date)a=Date.parse(b.timeExtent.startTime),c=Date.parse(b.timeExtent.endTime),
b.time=a+","+c,delete b.timeExtent;if(b.spatialRel&&b.serviceType=="ArcgisRest")b.spatialRel="esri"+b.spatialRel;delete b.serviceType;return b},_getGeometryType:function(a){var b="";switch(a.CLASS_NAME){case "OpenLayers.Bounds":b="GeometryEnvelope";break;case "OpenLayers.Geometry.Point":b="GeometryPoint";break;case "OpenLayers.Geometry.MultiLineString":b="GeometryPolyline";break;case "OpenLayers.Geometry.Polygon":b="GeometryPolygon"}return b},_getGeometryRepresentation:function(a){var b="";switch(a.CLASS_NAME){case "OpenLayers.Bounds":b=
a.toBBOX();break;case "OpenLayers.Geometry.Point":b=a.x+","+a.y;break;case "OpenLayers.Geometry.Polygon":a=this.extract.geometry.apply(this,[a]);a={rings:a.coordinates};b=OpenLayers.Format.JSON.prototype.write.apply(this.jsonp.format,[a]);break;case "OpenLayers.Geometry.MultiLineString":a=this.extract.geometry.apply(this,[a]),a={paths:a.coordinates},b=OpenLayers.Format.JSON.prototype.write.apply(this.jsonp.format,[a])}return b},extract:{geometry:function(a){if(a==null)return null;var b=a.CLASS_NAME.split(".")[2],
a=this.extract[b.toLowerCase()].apply(this,[a]);return{type:b,coordinates:a}},point:function(a){return[a.x,a.y]},multipoint:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},linestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},multilinestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,
[a.components[c]]));return b},polygon:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b}},_geometryType:{points:function(a){var b=[];if(OpenLayers.Util.isArray(a))for(var c=0,d=a.length;c<d;c++){var e=new OpenLayers.Geometry.Point(a[c][0],a[c][1]);b.push(e)}return b},paths:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],
a[c][f][1]));e=new OpenLayers.Geometry.LineString(e);b.push(e)}c=new OpenLayers.Geometry.MultiLineString(b)}return c},rings:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],a[c][f][1]));e=new OpenLayers.Geometry.LinearRing(e);b.push(e)}c=new OpenLayers.Geometry.Polygon(b)}return c}},failFn:function(){alert("\u5bf9\u4e0d\u8d77,\u67e5\u8be2\u5931\u8d25,\u8bf7\u67e5\u8be2\u670d\u52a1\u662f\u5426\u6b63\u5e38\u3002")},
CLASS_NAME:"Geo.Query.MapServiceQuery"});Geo.Query.MapServiceQueryParameters=Geo.Class({serviceType:"MapserviceRest",geometry:null,objectIds:null,orderByFields:null,outFields:null,inSR:null,outSR:null,maxAllowableOffset:null,returnGeometry:null,spatialRel:null,timeExtent:null,where:null,text:null,initialize:function(a){OpenLayers.Util.extend(this,a)}});
Geo.Query.MapServiceQueryResult=Geo.Class({displayFieldName:null,features:null,fieldAliases:null,geometryType:null,spatialReference:null,initialize:function(a){OpenLayers.Util.extend(this,a)}});
Geo.Query.MapServiceIdentify=Geo.Class({url:null,initialize:function(a,b){this.url=a+"/identify";this.format=new OpenLayers.Format.JSON;this.jsonp=new OpenLayers.Protocol.Script({format:this.format});OpenLayers.Util.extend(this,b)},query:function(a,b,c){a=this._getParamsFromQueryParameter(a);OpenLayers.Util.applyDefaults(a,{f:"json"});this.jsonp.createRequest(this.url,a,OpenLayers.Function.bind(function(a){a.error?c&&c(a.error):(a=this._getResult(a),b(a))},this))},_getResult:function(a){var b=[];
if(a.results)for(var c=0,d=a.results.length;c<d;c++){var e=this._getGeometry(a.results[c].geometry),f=this._getAttribute(a.results[c].attributes),e=new OpenLayers.Feature.Vector(e,f),f=new Geo.Query.MapServiceIdentifyResult;f.layerId=a.results[c].layerId;f.layerName=a.results[c].layerName;f.displayFieldName=a.results[c].displayFieldName;f.feature=e;f.geometryType=a.results[c].geometryType;b.push(f)}return b},_getParamsFromQueryParameter:function(a){var b={},c;for(c in a)a[c]!==null&&(b[c]=a[c]);if(b.geometry instanceof
Geo.Geometry||b.geometry instanceof Geo.Bounds)b.geometry=this._getGeometryRepresentation(b.geometry);if(b.spatialRel&&b.serviceType=="ArcgisRest")b.spatialRel="esri"+b.spatialRel;if(b.geometryType&&b.serviceType=="ArcgisRest")b.geometryType="esri"+this._getGeometryType(b.geometry);delete b.serviceType;return b},_getGeometryType:function(a){var b="";switch(a.CLASS_NAME){case "OpenLayers.Bounds":b="GeometryEnvelope";break;case "OpenLayers.Geometry.Point":b="GeometryPoint";break;case "OpenLayers.Geometry.MultiLineString":b=
"GeometryPolyline";break;case "OpenLayers.Geometry.Polygon":b="GeometryPolygon"}return b},_getGeometryRepresentation:function(a){var b="";switch(a.CLASS_NAME){case "OpenLayers.Bounds":b=a.toBBOX();break;case "OpenLayers.Geometry.Point":b=a.x+","+a.y;break;case "OpenLayers.Geometry.Polygon":a=this.extract.geometry.apply(this,[a]);a={rings:a.coordinates};b=this.format.write(a);break;case "OpenLayers.Geometry.MultiLineString":a=this.extract.geometry.apply(this,[a]),a={paths:a.coordinates},b=this.format.write(a)}return b},
extract:{geometry:function(a){if(a==null)return null;var b=a.CLASS_NAME.split(".")[2],a=this.extract[b.toLowerCase()].apply(this,[a]);return{type:b,coordinates:a}},point:function(a){return[a.x,a.y]},multipoint:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},linestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},multilinestring:function(a){for(var b=
[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b},polygon:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b}},_getJson:function(a){return this.format.read(a.responseText)},_getGeometry:function(a){for(var b in a){if("spatialReference"==b)break;return a=a.hasOwnProperty("x")&&a.hasOwnProperty("y")?new OpenLayers.Geometry.Point(a.x,a.y):a.hasOwnProperty("xmin")&&
a.hasOwnProperty("ymin")&&a.hasOwnProperty("xmax")&&a.hasOwnProperty("ymax")?(new OpenLayers.Bounds(a.xmin,a.ymin,a.xmax,a.ymax)).toGeometry():this._geometryType[b](a[b])}},_getAttribute:function(a){var b={};a&&!Geo.Util.isArray(a)&&(a=[a]);if(Geo.Util.isArray(a))for(var c=0;c<a.length;c++)OpenLayers.Util.applyDefaults(b,a[c]);return b},_geometryType:{points:function(a){var b=[];if(OpenLayers.Util.isArray(a))for(var c=0,d=a.length;c<d;c++){var e=new OpenLayers.Geometry.Point(a[c][0],a[c][1]);b.push(e)}return b},
paths:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],a[c][f][1]));e=new OpenLayers.Geometry.LineString(e);b.push(e)}c=new OpenLayers.Geometry.MultiLineString(b)}return c},rings:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],a[c][f][1]));e=new OpenLayers.Geometry.LinearRing(e);
b.push(e)}c=new OpenLayers.Geometry.Polygon(b)}return c}},CLASS_NAME:"Geo.Query.MapServiceIdentify"});Geo.Query.MapServiceIdentifyParameters=Geo.Class({geometry:null,geometryType:"",layers:"",imageDisplay:"",returnGeometry:!0,layerDefs:"",initialize:function(){},CLASS_NAME:"Geo.Query.MapServiceIdentifyParameters"});Geo.Query.MapServiceIdentifyResult=Geo.Class({layerId:null,layerName:"",displayFieldName:"",feature:null,geometryType:"",initialize:function(){},CLASS_NAME:"Geo.Query.MapServiceIdentifyResult"});
Geo.Query.MapServiceDataFeatures=Geo.Class({url:null,initialize:function(a,b){this.url=a;this.format=new OpenLayers.Format.JSON;this.jsonp=new OpenLayers.Protocol.Script({format:this.format});OpenLayers.Util.extend(this,b)},query:function(a,b,c){if(a.layerOrTableId&&a.featureId)this.accessUrl=this.url+"/"+a.layerOrTableId+"/"+a.featureId,OpenLayers.Util.applyDefaults(a,{f:"json"}),this.jsonp.createRequest(this.accessUrl,a,OpenLayers.Function.bind(function(a){if(a.error)c&&c(a.error);else{var e=null,
f=new Geo.Query.MapServiceDataFeaturesResult;a.feature.geometry&&(e=this._getFeatures(a));f.feature=e;b(f)}},this))},_getParamsFromQueryParameter:function(a){var b={},c;for(c in a)a[c]!==null&&(b[c]=a[c]);if(b.geometry instanceof Geo.Geometry||b.geometry instanceof Geo.Bounds)b.geometry=this._getGeometryRepresentation(b.geometry);if(b.spatialRel&&b.serviceType=="ArcgisRest")b.spatialRel="esri"+b.spatialRel;if(b.geometryType&&b.serviceType=="ArcgisRest")b.geometryType="esri"+this._getGeometryType(b.geometry);
delete b.serviceType;return b},_getGeometryType:function(a){var b="";switch(a.CLASS_NAME){case "OpenLayers.Bounds":b="GeometryEnvelope";break;case "OpenLayers.Geometry.Point":b="GeometryPoint";break;case "OpenLayers.Geometry.MultiLineString":b="GeometryPolyline";break;case "OpenLayers.Geometry.Polygon":b="GeometryPolygon"}return b},_getGeometryRepresentation:function(a){var b="";switch(a.CLASS_NAME){case "OpenLayers.Bounds":b=a.toBBOX();break;case "OpenLayers.Geometry.Point":b=a.x+","+a.y;break;case "OpenLayers.Geometry.Polygon":a=
this.extract.geometry.apply(this,[a]);a={rings:a.coordinates};b=this.format.write(a);break;case "OpenLayers.Geometry.MultiLineString":a=this.extract.geometry.apply(this,[a]),a={paths:a.coordinates},b=this.format.write(a)}return b},extract:{geometry:function(a){if(a==null)return null;var b=a.CLASS_NAME.split(".")[2],a=this.extract[b.toLowerCase()].apply(this,[a]);return{type:b,coordinates:a}},point:function(a){return[a.x,a.y]},multipoint:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,
[a.components[c]]));return b},linestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},multilinestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b},polygon:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b}},_getJson:function(a){return this.format.read(a.responseText)},
_getFeatures:function(a){var b=null;a.feature&&(b=this._getGeometry(a.feature.geometry),a=this._getAttribute(a.feature.attributes),b=new OpenLayers.Feature.Vector(b,a));return b},_getGeometry:function(a){for(var b in a){if("spatialReference"==b)break;return a=a.hasOwnProperty("x")&&a.hasOwnProperty("y")?new OpenLayers.Geometry.Point(a.x,a.y):a.hasOwnProperty("xmin")&&a.hasOwnProperty("ymin")&&a.hasOwnProperty("xmax")&&a.hasOwnProperty("ymax")?(new OpenLayers.Bounds(a.xmin,a.ymin,a.xmax,a.ymax)).toGeometry():
this._geometryType[b](a[b])}},_getAttribute:function(a){var b={};a&&!Geo.Util.isArray(a)&&(a=[a]);if(Geo.Util.isArray(a))for(var c=0;c<a.length;c++)OpenLayers.Util.applyDefaults(b,a[c]);return b},_geometryType:{points:function(a){var b=[];if(OpenLayers.Util.isArray(a))for(var c=0,d=a.length;c<d;c++){var e=new OpenLayers.Geometry.Point(a[c][0],a[c][1]);b.push(e)}return b},paths:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],
a[c][f][1]));e=new OpenLayers.Geometry.LineString(e);b.push(e)}c=new OpenLayers.Geometry.MultiLineString(b)}return c},rings:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],a[c][f][1]));e=new OpenLayers.Geometry.LinearRing(e);b.push(e)}c=new OpenLayers.Geometry.Polygon(b)}return c}},CLASS_NAME:"Geo.Query.MapServiceDataFeatures"});
Geo.Query.MapServiceDataFeaturesParameters=Geo.Class({layerOrTableId:0,featureId:0,initialize:function(){},CLASS_NAME:"Geo.Query.MapServiceDataFeaturesParameters"});Geo.Query.MapServiceDataFeaturesResult=Geo.Class({feature:null,initialize:function(){},CLASS_NAME:"Geo.Query.MapServiceDataFeaturesResult"});
Geo.Query.MapServiceFind=Geo.Class({url:null,initialize:function(a,b){this.url=a+"/find";this.format=new OpenLayers.Format.JSON;this.jsonp=new OpenLayers.Protocol.Script({format:this.format});OpenLayers.Util.extend(this,b)},query:function(a,b,c){a=this._getParamsFromQueryParameter(a);OpenLayers.Util.applyDefaults(a,{f:"json",pretty:!0});this.jsonp.createRequest(this.url,a,OpenLayers.Function.bind(function(a){a.error?c&&c(a.error):(a=this._getResult(a),b(a))},this))},_getResult:function(a){var b=[];
if(a.results)for(var c=0,d=a.results.length;c<d;c++){var e=this._getGeometry(a.results[c].geometry),f=this._getAttribute(a.results[c].attributes),e=new OpenLayers.Feature.Vector(e,f),f=new Geo.Query.MapServiceIdentifyResult;f.layerId=a.results[c].layerId;f.layerName=a.results[c].layerName;f.displayFieldName=a.results[c].displayFieldName;f.feature=e;f.geometryType=a.results[c].geometryType;f.foundFieldName=a.results[c].foundFieldName;b.push(f)}return b},_getParamsFromQueryParameter:function(a){var b=
{},c;for(c in a)a[c]!==null&&(b[c]=a[c]);if(b.geometry instanceof Geo.Geometry||b.geometry instanceof Geo.Bounds)b.geometry=this._getGeometryRepresentation(b.geometry);if(b.spatialRel&&b.serviceType=="ArcgisRest")b.spatialRel="esri"+b.spatialRel;if(b.geometryType&&b.serviceType=="ArcgisRest")b.geometryType="esri"+this._getGeometryType(b.geometry);delete b.serviceType;return b},_getGeometryType:function(a){var b="";switch(a.CLASS_NAME){case "OpenLayers.Bounds":b="GeometryEnvelope";break;case "OpenLayers.Geometry.Point":b=
"GeometryPoint";break;case "OpenLayers.Geometry.MultiLineString":b="GeometryPolyline";break;case "OpenLayers.Geometry.Polygon":b="GeometryPolygon"}return b},_getGeometryRepresentation:function(a){var b="";switch(a.CLASS_NAME){case "OpenLayers.Bounds":b=a.toBBOX();break;case "OpenLayers.Geometry.Point":b=a.x+","+a.y;break;case "OpenLayers.Geometry.Polygon":a=this.extract.geometry.apply(this,[a]);a={rings:a.coordinates};b=this.format.write(a);break;case "OpenLayers.Geometry.MultiLineString":a=this.extract.geometry.apply(this,
[a]),a={paths:a.coordinates},b=this.format.write(a)}return b},extract:{geometry:function(a){if(a==null)return null;var b=a.CLASS_NAME.split(".")[2],a=this.extract[b.toLowerCase()].apply(this,[a]);return{type:b,coordinates:a}},point:function(a){return[a.x,a.y]},multipoint:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},linestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,
[a.components[c]]));return b},multilinestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b},polygon:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b}},_getGeometry:function(a){for(var b in a){if("spatialReference"==b)break;return a=a.hasOwnProperty("x")&&a.hasOwnProperty("y")?new OpenLayers.Geometry.Point(a.x,a.y):a.hasOwnProperty("xmin")&&
a.hasOwnProperty("ymin")&&a.hasOwnProperty("xmax")&&a.hasOwnProperty("ymax")?(new OpenLayers.Bounds(a.xmin,a.ymin,a.xmax,a.ymax)).toGeometry():this._geometryType[b](a[b])}},_getAttribute:function(a){var b={};a&&!Geo.Util.isArray(a)&&(a=[a]);if(Geo.Util.isArray(a))for(var c=0;c<a.length;c++)OpenLayers.Util.applyDefaults(b,a[c]);return b},_geometryType:{points:function(a){var b=[];if(OpenLayers.Util.isArray(a))for(var c=0,d=a.length;c<d;c++){var e=new OpenLayers.Geometry.Point(a[c][0],a[c][1]);b.push(e)}return b},
paths:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],a[c][f][1]));e=new OpenLayers.Geometry.LineString(e);b.push(e)}c=new OpenLayers.Geometry.MultiLineString(b)}return c},rings:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],a[c][f][1]));e=new OpenLayers.Geometry.LinearRing(e);
b.push(e)}c=new OpenLayers.Geometry.Polygon(b)}return c}},CLASS_NAME:"Geo.Query.MapServiceFind"});Geo.Query.MapServiceFindParameters=Geo.Class({searchText:"",contains:!0,searchFields:"",layers:"",returnGeometry:!0,initialize:function(){},CLASS_NAME:"Geo.Query.MapServiceFindParameters"});Geo.Query.MapServiceFindResult=Geo.Class({layerId:null,layerName:"",displayFieldName:"",feature:null,geometryType:"",foundFieldName:"",initialize:function(){},CLASS_NAME:"Geo.Query.MapServiceFindResult"});
Geo.Query.GeoCodingQuery=function(a,b){var b=OpenLayers.Util.applyDefaults(b,Geo.Query.GeoCodingQuery.DEFAULTS),c=Geo.Query.GeoCodingQuery["v"+b.version.replace(/\./g,"_")];if(!c)throw"\u4e0d\u652f\u6301\u7684\u5730\u5740\u5339\u914d\u670d\u52a1\u7248\u672c: "+b.version;return new c(a,b)};Geo.Query.GeoCodingQuery.DEFAULTS={version:"1.0.0"};
Geo.Query.GeoCodingQuery.v1=Geo.Class({version:"1.0.0",url:null,initialize:function(a,b){this.url=a;OpenLayers.Util.extend(this,b);this.format=new Geo.Format.JSON},getCommonParams:function(a){var b={request:"GetCategory",service:"GeoCoding",version:this.version,output:"json"};OpenLayers.Util.extend(b,a);return b},getCategoryByName:function(a,b,c){var d=this.getCommonParams();if(typeof a==="string"&&a.length!==0)d.categoryName=a;c=c||this.failFn;OpenLayers.Function.bind(this._requestCategory,this)(d,
b,c)},getCategoryByCode:function(a,b,c){var d=this.getCommonParams();if(typeof a==="number")d.categoryCode=a;OpenLayers.Function.bind(this._requestCategory,this)(d,b,c)},getAllCategory:function(a,b){var c=this.getCommonParams();OpenLayers.Function.bind(this._requestCategory,this)(c,a,b)},_requestCategory:function(a,b,c){c=c||this.failFn;OpenLayers.loadURL(this.url,a,this,function(a){try{var c=this.format.read(a.responseText)}catch(f){b(a.responseText);return}b(c)},c)},_analysis_GeoCodeResult:function(a){var b=
{status:a.status};switch(a.status){case "OK":if(a=a.results)b.results=this._analysis_GeoCodeResult_results(a)}return b},_analysis_GeoCodeResult_results:function(a){var b=[];if(Geo.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){var e={};e.requestKeyWord=a[c].requestKeyWord;if(a[c].errorCorrectionTips)e.errorCorrectionTips=a[c].errorCorrectionTips;e.count=a[c].count;if(a[c].result)e.result=this._analysis_GeoCodeResult_results_result(a[c].result);b.push(e)}return b}},_analysis_GeoCodeResult_results_result:function(a){for(var b=
[],c=0,d=a.length;c<d;c++){var e={};e.resultType=a[c].resultType;e.precise=a[c].precise;e.isBrief=a[c].isBrief;e.score=a[c].score;if(e.isBrief==!1)e.addressComponent=this._analysis_GeoCodeResult_results_result_address(a[c].addressComponent,e.resultType);e.poiArray=this._analysispoiArray(a[c].poiArray);if(a[c].location)e.location=a[c].location;if(e.precise==0)e.referenceAddressArray=a[c].referenceAddressArray;b.push(e)}return b},_analysis_GeoCodeResult_results_result_address:function(a,b){var c={country:a.country};
if(a.province)c.province=a.province;if(a.city)c.city=a.city;if(a.district)c.district=a.district;if(a.town)c.town=a.town;if(a.street){c.street={name:a.street.name};var d=null;if(b==="street"){if(a.street.geometry)var e=a.street.geometry;if(e.paths)d=this._getGeometry(e),c.street.geometry=d;else if(e.rings)d=this._getGeometry(e),c.street.geometry=d;else if(e.x&&e.y)d=this._getGeometry(e),c.street.geometry=d}}if(a.streetNumber)c.streetNumber=a.streetNumber;if(a.buildingNumber)c.buildingNumber=a.buildingNumber;
if(b==="adminArea"){d=null;if(a.geometry)if(d=a.geometry,d.rings)d=this._getGeometry(d),c.geometry=d;else if(d.paths)d=this._getGeometry(d),c.geometry=d;else if(typeof d.x==="number"&&typeof d.y==="number")c.geometry=this._getGeometry(d);if(a.subordinate)c.subordinate=a.subordinate;if(a.zipCode)c.zipCode=a.zipCode;if(a.callingCode)c.callingCode=a.callingCode}return c},_analysispoiArray:function(a){for(var b=[],c=0,d=a.length;c<d;c++){var e={},f;for(f in a[c])e[f]=a[c][f];b.push(e)}return b},_analysisLocation:function(){},
_getGeometry:function(a){for(var b in a){if("spatialReference"==b)break;return a=a.hasOwnProperty("x")&&a.hasOwnProperty("y")?new OpenLayers.Geometry.Point(a.x,a.y):a.hasOwnProperty("xmin")&&a.hasOwnProperty("ymin")&&a.hasOwnProperty("xmax")&&a.hasOwnProperty("ymax")?(new OpenLayers.Bounds(a.xmin,a.ymin,a.xmax,a.ymax)).toGeometry():this._geometryType[b](a[b])}},_geometryType:{points:function(a){var b=[];if(OpenLayers.Util.isArray(a))for(var c=0,d=a.length;c<d;c++){var e=new OpenLayers.Geometry.Point(a[c][0],
a[c][1]);b.push(e)}return b},paths:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],a[c][f][1]));e=new OpenLayers.Geometry.LineString(e);b.push(e)}c=new OpenLayers.Geometry.MultiLineString(b)}return c},rings:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new OpenLayers.Geometry.Point(a[c][f][0],
a[c][f][1]));e=new OpenLayers.Geometry.LinearRing(e);b.push(e)}c=new OpenLayers.Geometry.Polygon(b)}return c}},failFn:function(a){typeof a=="string"&&alert(a);alert("\u5bf9\u4e0d\u8d77\uff0c\u67e5\u8be2\u8bf7\u6c42\u5931\u8d25\uff01\u8bf7\u68c0\u67e5\u5730\u5740\u5339\u914d\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002\n\u5f53\u524d\u670d\u52a1\u5730\u5740\u4e3a\uff1a"+this.url)},CLASS_NAME:"Geo.Query.GeoCodingQuery.v1"});
Geo.Query.GeoCodingQuery.v1_0_0=Geo.Class(Geo.Query.GeoCodingQuery.v1,{addressesToLocations:function(a,b){var c=this.getCommonParams({request:"GeoCoder"});if(typeof a.address==="string")c.address=a.address;else if(Geo.Util.isArray(a.address)){for(var d="",e=0;e<a.address.length;e++)d+=a.address[e]+",";d=d.substr(0,d.length-1);c.address=d}else if(a.address==void 0||a.address==null)throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01";if(typeof a.categoryCode==="number")c.categoryCode=a.categoryCode;if(a.extent instanceof
Geo.Bounds)c.bbox=a.extent.toBBOX(null,!0);if(typeof a.fuzzyMatch==="boolean")c.fuzzyMatch=a.fuzzyMatch;if(typeof a.resultType==="string")c.resultType=a.resultType;if(typeof a.maxCount==="number")c.maxCount=a.maxCount;if(typeof a.startPosition==="number")c.startPosition=a.startPosition;OpenLayers.loadURL(this.url,c,this,function(a){try{var c=this._analysis_GeoCodeResult(this.format.read(a.responseText))}catch(d){b(a.responseText);return}b(c)},this.failFn)},locationToAddresses:function(a,b){var c=
this.getCommonParams({request:"GeoCoder"});if(a.lonlat instanceof Geo.LonLat)c.latlng=a.lonlat.lat+","+a.lonlat.lon;else throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01\u8bf7\u586b\u5199\u6b63\u786e\u7684\u6570\u636e\u7c7b\u578b\uff01";if(typeof a.tolerance==="number")c.tolerance=a.tolerance;if(typeof a.unit==="number")c.unit=a.unit;if(typeof a.resultType==="string")c.resultType=a.resultType;if(typeof a.maxCount==="number")c.maxCount=a.maxCount;if(typeof a.startPosition==="number")c.startPosition=
a.startPosition;OpenLayers.loadURL(this.url,c,this,function(a){try{var c=this._analysis_GeoCodeResult(this.format.read(a.responseText))}catch(f){b(a.responseText);return}b(c)},this.failFn)},CLASS_NAME:"Geo.Query.GeoCodingQuery.v1_0_0"});
Geo.Query.GeoCodingQuery.v1_1_0=Geo.Class(Geo.Query.GeoCodingQuery.v1,{method:"get",initialize:function(a,b){OpenLayers.Util.extend(this,b);this.filterFormat=new OpenLayers.Format.Filter;Geo.Query.GeoCodingQuery.v1.prototype.initialize.apply(this,arguments)},addressesToLocations:function(a,b,c){var d=this.getCommonParams({request:"GeoCoder"});d.reverseMatch=!1;if(typeof a.address==="string")d.keyword=a.address;if(typeof a.categoryCode==="number")d.categoryCode=a.categoryCode;if((a.address==void 0||
a.address==null)&&(a.categoryCode==void 0||a.categoryCode==null))throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01";if(a.extent instanceof Geo.Bounds)d.bbox=a.extent.toBBOX(null,!0);if(a.filter instanceof Geo.Filter){var e=this.filterFormat.write(a.filter),e=OpenLayers.Format.XML.prototype.write.apply(this.filterFormat,[e]);d.filter=e}if(typeof a.resultType==="string")d.resultType=a.resultType;if(typeof a.maxCount==="number")d.maxCount=a.maxCount;if(typeof a.startPosition==="number")d.startPosition=
a.startPosition;if(typeof a.semanticAnalysis==="boolean")d.semanticAnalysis=a.semanticAnalysis;this._setGeoCoderCommonProperty(d,a);this._getCodingRequest(d,b,c)},_getCodingRequest:function(a,b){if(this.method=="get")OpenLayers.loadURL(this.url,a,this,function(a){try{var c=this._analysis_GeoCodeResult(this.format.read(a.responseText))}catch(f){b(a.responseText);return}b(c)},this.failFn);else{var c=OpenLayers.Util.getParameterString(a);OpenLayers.Request.POST({url:this.url,data:c,success:function(a){try{var c=
this._analysis_GeoCodeResult(this.format.read(a.responseText))}catch(f){b(a.responseText);return}b(c)},failure:this.failFn,scope:this})}},_setGeoCoderCommonProperty:function(a,b){if(typeof b.sortFields==="string")a.sortFields=b.sortFields;if(typeof b.scoreFilter==="string")a.scoreFilter=b.scoreFilter},locationToAddresses:function(a,b,c){var d=this.getCommonParams({request:"GeoCoder"});d.reverseMatch=!0;if(a.lonlat instanceof Geo.LonLat)d.keyword=a.lonlat.lat+","+a.lonlat.lon;else throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01\u8bf7\u586b\u5199\u6b63\u786e\u7684\u6570\u636e\u7c7b\u578b\uff01";
if(typeof a.tolerance==="number")d.tolerance=a.tolerance;if(typeof a.unit==="string")d.unit=a.unit;if(typeof a.resultType==="string")d.resultType=a.resultType;if(typeof a.maxCount==="number")d.maxCount=a.maxCount;if(typeof a.startPosition==="number")d.startPosition=a.startPosition;this._setGeoCoderCommonProperty(d,a);this._getCodingRequest(d,b,c)},batchAddressesToLocations:function(a,b){var c=this.getCommonParams({request:"BatchGeoCoder",service:"GeoCoding"});c.reverseMatch=!1;if(Geo.Util.isArray(a.address)){for(var d=
"",e=0;e<a.address.length;e++)d+=a.address[e]+",";d=d.substr(0,d.length-1);c.keywords=d}else if(a.address==void 0||a.address==null)throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01";if(typeof a.singleKeywordResultCount==="number")c.singleKeywordResultCount=a.singleKeywordResultCount;if(a.filter instanceof Geo.Filter)d=this.filterFormat.write(a.filter),d=OpenLayers.Format.XML.prototype.write.apply(this.filterFormat,[d]),c.filter=d;this._setGeoCoderCommonProperty(c,a);OpenLayers.loadURL(this.url,c,
this,function(a){try{var c=this._analysis_GeoCodeResult(this.format.read(a.responseText))}catch(d){b(a.responseText);return}b(c)},this.failFn)},batchLocationToAddresses:function(a,b){var c=this.getCommonParams({request:"BatchGeoCoder",service:"GeoCoding"});c.reverseMatch=!0;if(a.lonlats instanceof Geo.LonLat)a.lonlats=[a.lonlats];else if(!OpenLayers.Util.isArray(a.lonlats))throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01\u8bf7\u586b\u5199\u6b63\u786e\u7684\u6570\u636e\u7c7b\u578b\uff01";if(Geo.Util.isArray(a.lonlats)){for(var d=
"",e=0;e<a.lonlats.length;e++)d+=a.lonlats[e].lat+","+a.lonlats[e].lon+";";d=d.substr(0,d.length-1);c.keywords=d}if(typeof a.tolerance==="number")c.tolerance=a.tolerance;if(typeof a.unit==="string")c.unit=a.unit;if(typeof a.singleKeywordResultCount==="number")c.singleKeywordResultCount=a.singleKeywordResultCount;this._setGeoCoderCommonProperty(c,a);OpenLayers.loadURL(this.url,c,this,function(a){try{var c=this._analysis_GeoCodeResult(this.format.read(a.responseText))}catch(d){b(a.responseText);return}b(c)},
this.failFn)},CLASS_NAME:"Geo.Query.GeoCodingQuery.v1_1_0"});Geo.Strategy.AttributeCluster=Geo.Class(Geo.Strategy.Cluster,{attributes:[],shouldCluster:function(a,b){for(var c=!1,d=0;d<this.attributes.length;d++)if(c=this.attributes[d],c=a.cluster[0].attributes[c]===b.attributes[c],!c)break;d=Geo.Strategy.Cluster.prototype;return c&&d.shouldCluster.apply(this,arguments)},CLASS_NAME:"OpenLayers.Strategy.AttributeCluster"});
Geo.Strategy.GeoTextXYZ=OpenLayers.Class(OpenLayers.Strategy,{bounds:null,resolution:null,ratio:1,zoom:0,resFactor:null,response:null,activate:function(){var a=OpenLayers.Strategy.prototype.activate.call(this);a&&(this.layer.events.on({moveend:this.update,refresh:this.update,scope:this}),this.layer.map.events.on({zoomend:function(){this.zoom=this.layer.map.getZoom();this.layer.removeFeatures()},scope:this}),this.update());return a},deactivate:function(){var a=OpenLayers.Strategy.prototype.deactivate.call(this);
a&&(this.layer.events.un({moveend:this.update,scope:this}),this.layer.map.events.un({zoomend:function(){this.layer.removeFeatures();this.start()},scope:this}));return a},update:function(a){var b=!1;this.layer.map.getZoom()!==this.zoom&&(b=!0);this.timerId1=window.setTimeout(OpenLayers.Function.bind(function(){var c=this.getMapBounds();if(c!==null&&(a&&a.force||this.layer.visibility&&this.layer.calculateInRange()&&this.invalidBounds(c)&&!b))this.calculateBounds(c),this.resolution=this.layer.map.getResolution(),
this.triggerRead(a);else if(a&&a.force||this.layer.visibility&&this.layer.calculateInRange()&&b===!0)this.layer.formatFeatures.cleanCommonFeatures(),this.layer.display(!1),this.calculateBounds(c),this.resolution=this.layer.map.getResolution(),this.triggerRead(a)},this),1)},getMapBounds:function(){if(this.layer.map===null)return null;var a=this.layer.map.getExtent();a&&!this.layer.projection.equals(this.layer.map.getProjectionObject())&&(a=a.clone().transform(this.layer.map.getProjectionObject(),this.layer.projection));
return a},invalidBounds:function(a){a||(a=this.getMapBounds());a=!this.bounds||!this.bounds.containsBounds(a);!a&&this.resFactor&&(a=this.resolution/this.layer.map.getResolution(),a=a>=this.resFactor||a<=1/this.resFactor);return a},calculateBounds:function(a){a||(a=this.getMapBounds());var b=a.getCenterLonLat(),c=a.getWidth()*this.ratio,a=a.getHeight()*this.ratio;this.bounds=new OpenLayers.Bounds(b.lon-c/2,b.lat-a/2,b.lon+c/2,b.lat+a/2)},triggerRead:function(a){this.response&&!(a&&a.noAbort===!0)&&
this.layer.events.triggerEvent("loadend");a=this.layer;a.events.triggerEvent("loadstart",{filter:{}});var b=a.map.getExtent(),c=b.getWidth()*this.ratio,d=b.getHeight()*this.ratio,b=b.getCenterLonLat(),b=new OpenLayers.Bounds(b.lon-c/2,b.lat-d/2,b.lon+c/2,b.lat+d/2),d=new Geo.LonLat(b.left,b.top),c=a.pyramid,b=new Geo.LonLat(b.right,b.bottom),a=c.getLevelForResolution(a.map.getResolution()),d=c.getTileIndex(d,a),c=c.getTileIndex(b,a);this.getTextDateForGridIndex(d,c,a)},getTextDateForGridIndex:function(a,
b,c){this.queue=[];if(c>=10){this.layer.textCounter=(b.col-a.col+1)*(b.row-a.row+1);for(var d=a.col;d<=b.col;d++)for(var e=a.row;e<=b.row;e++)this.readText(c+","+d+"-"+d+","+e+"-"+e)}},readText:function(a){this.response=this.layer.read({lxyArray:a,callback:this.merge,scope:this})},merge:function(a){if(!a.error)this.layer.display(!0),this.layer.update(a.features),this.response=null,this.layer.events.triggerEvent("loadend",{response:a})},CLASS_NAME:"Geo.Strategy.GeoTextXYZ"});
Geo.Service=Geo.Class({name:null,url:null,version:null,userid:"test@liferay.com",initialize:function(a,b,c){this.name=a;this.url=b;OpenLayers.Util.extend(this,c)},getCapabilities:function(){},isExist:function(){},failFn:function(a){alert("\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+this.url+"\n\u64cd\u4f5c\u7c7b\u578b\uff1a"+a)},_parseToXML:function(a){var b=
a.responseXML;if(!b||!b.documentElement)b=a.responseText;return(new OpenLayers.Format.XML).read(b)},_checkIsError:function(a){if((new OpenLayers.Format.XML).read(a).selectNodes("ServiceExceptionReport").length>0)return this._parseToJSON(a);return null},_isException:function(a){if(a&&a.ServiceExceptionReport)return!0;return!1},_parseToJSON:function(a){return(new Geo.Util.Format.XML2JSON).read(a)},CLASS_NAME:"Geo.Service"});
Geo.Service.GlobeTile=Geo.Class(Geo.Service,{initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url+"/GetCapabilities";b||(b=function(){this.failFn("GetCapabilities")});OpenLayers.loadURL(c,null,this,function(b){a(b)},b)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url+"/GetCapabilities",scope:this,async:!1,success:function(){a=!0}});return a},CLASS_NAME:"Geo.Service"});
Geo.Service.Bus=Geo.Class(Geo.Service,{initialize:function(a,b,c){this.name=a;this.url=b;OpenLayers.Util.extend(this,c)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities"};b||(b=function(){this.failFn(d.REQUEST)});OpenLayers.loadURL(c,d,this,function(b){a(b)},b)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url,scope:this,async:!1,success:function(){a=!0}});return a},queryStation:function(a,b,c){var d={REQUEST:"QueryStation"};if(!a.networkName)throw"Error!Not network name for bus query.";
d.NETWORKNAME=a.networkName;if(a.stationId!==null&&a.stationId!==void 0)d.STATIONID=a.stationId;if(a.stationName!==null&&a.stationName!==void 0)d.STATIONNAME=a.stationName;if(a.lineId!==null&&a.lineId!==void 0)d.LINEID=a.lineId;if(a.lineName!==null&&a.lineName!==void 0)d.LINENAME=a.lineName;if(a.coordinate!==null&&a.coordinate!==void 0)d.COORDINATE=a.coordinate;if(a.bbox!==null&&a.bbox!==void 0)d.BOX=a.bbox;OpenLayers.Request.GET({url:this.url,params:d,scope:this,success:function(a){a=this._parserFeatures(a.responseText);
b(a)},failure:c})},queryLine:function(a,b,c){var d={REQUEST:"QueryLine"};if(!a.networkName)throw"Error!Not network name for bus query.";d.NETWORKNAME=a.networkName;if(a.lineName!==null&&a.lineName!==void 0)d.LINENAME=a.lineName;if(a.lineId!==null&&a.lineId!==void 0)d.LINEID=a.lineId;if(a.stationName!==null&&a.stationName!==void 0)d.STATIONNAME=a.stationName;if(a.stationId!==null&&a.stationId!==void 0)d.STATIONID=a.stationId;if(a.coordinate!==null&&a.coordinate!==void 0)d.COORDINATE=a.coordinate;if(a.bbox!==
null&&a.bbox!==void 0)d.BOX=a.bbox;OpenLayers.Request.GET({url:this.url,params:d,scope:this,success:function(a){a=this._parserFeatures(a.responseText);b(a)},failure:c})},queryChange:function(a,b,c){var d={REQUEST:"QueryChange"};if(!a.networkName)throw"Error!Not network name for bus query.";d.NETWORKNAME=a.networkName;if(a.startStationId!==null&&a.startStationId!==void 0)d.STARTSTATIONID=a.startStationId;if(a.endStationId!==null&&a.endStationId!==void 0)d.ENDSTATIONID=a.endStationId;if(a.orderType!==
null&&a.orderType!==void 0)d.ORDERTYPE=a.orderType;if(a.startCoordinate!==null&&a.startCoordinate!==void 0)d.STARTCOORDINATE=a.startCoordinate;if(a.endCoordinate!==null&&a.endCoordinate!==void 0)d.ENDCOORDINATE=a.endCoordinate;if(a.maxDepth!==null&&a.maxDepth!==void 0)d.MAXDEPTH=a.maxDepth;if(a.maxCost!==null&&a.maxCost!==void 0)d.MAXCOST=a.maxCost;if(a.maxSolutions!==null&&a.maxSolutions!==void 0)d.MAXSOLUTIONS=a.maxSolutions;if(a.ChangeCount!==null&&a.ChangeCount!==void 0)d.CHANGECOUNT=a.ChangeCount;
OpenLayers.Request.GET({url:this.url,params:d,scope:this,success:function(a){for(var c=[],a=(a.responseXML.documentElement?a.responseXML:format.read(a.responseText)).selectNodes("/Features/FeatureCollection"),d=new OpenLayers.Format.XML,h=0;h<a.length;h++){var l=a[h],m=this._getAttibutionOfNode(l,["cost","price","walkingDistance","transferTimes"]),o=this._parserFeatures(d.write(a[h]));o.attributes=m;l=l.selectNodes("featureMember");for(m=0;m<l.length;m++){var j=l[m].selectNodes("Road");o[m].isOnFoot=
j[0].getAttribute("isOnFoot")}c.push(o)}b(c)},failure:c})},_getAttibutionOfNode:function(a,b){var c={};if(a.tagName)for(var d=0;d<b.length;d++)c[b[d]]=a.getAttribute(b[d]);return c},_getGeometryType:function(){return"polygon"},_pagingToString:function(a,b){b=b||this.maxPerPage;return"<numPerPage>"+b+"</numPerPage><curPage>"+(a||1)+"</curPage>"},_orderByToString:function(a){return a?"<orderBy><PropertyName>"+a+"</PropertyName></orderBy>":""},_geometryToString:function(){return'<geometry><Polygon><outerBoundaryIs><LinearRing><coordinates decimal="." cs="," ts=" ">20,30 21,41 52,42 53,33 20,30</coordinates></LinearRing></outerBoundaryIs></Polygon></geometry>'},
_stringToGeometry:function(){return Geo.Geometry.Polygon.createRegularPolygon(new Geo.Geometry.Point(Math.random()*360-160,Math.random()*90-70),Math.round(Math.random()*20),Math.round(Math.random()*10))},_parserFeatures:function(a){var b=new OpenLayers.Format.GML;b.gmlns="*";return b.read(a)},_parserResponseText:function(a,b){if(b)var c=RegExp("</"+b+">",["g"]),a=a.replace(RegExp("<"+b+">",["g"]),"<featureMember><"+b+">"),a=a.replace(c,"</"+b+"></featureMember>");a=a.replace(/<gml:LineString>/g,"<gml:LineString><gml:coordinates>");
a=a.replace(/<\/gml:LineString>/g,"</gml:coordinates></gml:LineString>");a=a.replace(/<gml:Point>/g,"<gml:Point><gml:coordinates>");return a=a.replace(/<\/gml:Point>/g,"</gml:coordinates></gml:Point>")},_parserFeaturesNew:function(a,b){var c=new OpenLayers.Format.GML;c.gmlns="*";if(b)c.featureName=b;return c.read(a)},_parserSuccessResult:function(a){return(new Geo.Util.Format.XML2JSON).read(a)},_parseToXML:function(a){var b=a.responseXML;if(!b||!b.documentElement)b=a.responseText;return(new OpenLayers.Format.XML).read(b)},
_parseToJSON:function(a){return(new Geo.Util.Format.XML2JSON).read(a)},queryTransferScheme:function(a,b,c){var d={request:"QueryTransferScheme",SERVICE:"BUS",VERSION:"1.0.0"},e={networkName:!0,transferMode:!0,startInput:!0,endInput:!0},f;for(f in e)if(!(f in a))throw Error("\u7f3a\u5c11\u5fc5\u9009\u5c5e\u6027\uff1a'"+f+"'\u3002");d.networkName=a.networkName;if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.transferMode!==
null&&a.transferMode!==void 0)d.TRANSFERMODE=a.transferMode;if(a.startInput!==null&&a.startInput!==void 0)d.STARTINPUT=a.startInput;if(a.endInput!==null&&a.endInput!==void 0)d.ENDINPUT=a.endInput;if(a.inputMode!==null&&a.inputMode!==void 0)d.INPUTMODEL=a.inputMode;if(a.ExistGoTime!==null&&a.ExistGoTime!==void 0)d.EXISTGOTIME=a.ExistGoTime;if(a.StartTime!==null&&a.StartTime!==void 0)d.STARTTIME=a.StartTime;if(a.MaxSearchDistance!==null&&a.MaxSearchDistance!==void 0)d.MAXSEARCHDISTANCE=a.MaxSearchDistance;
if(a.PrioritySubset!==null&&a.PrioritySubset!==void 0)d.PRIORITYSUBSET=a.PrioritySubset;if(a.ExistAbsolutePriority!==null&&a.ExistAbsolutePriority!==void 0)d.EXISTABSOLUTEPRIORITY=a.ExistAbsolutePriority;if(a.LagSubset!==null&&a.LagSubset!==void 0)d.LAGSUBSET=a.LagSubset;if(a.OutputPage!==null&&a.OutputPage!==void 0)d.OUTPUTPAGE=a.OutputPage;if(a.PageSize!==null&&a.PageSize!==void 0)d.PAGESIZE=a.PageSize;if(a.ChangeCount!==null&&a.ChangeCount!==void 0)d.CHANGECOUNT=a.ChangeCount;OpenLayers.Request.GET({url:this.url,
params:d,scope:this,success:OpenLayers.Function.bind(function(a){var c=a.responseXML,d={startPoint:[],transferScheme:[],endPoint:[]};if(!c)return b(d),d;var a=new OpenLayers.Format.XML,e=c.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage");if(e&&e.length>0)return b(d),d;c=c.selectNodes("/QueryTransferSchemeResponse");a=this._parseToJSON(a.write(c[0]));d=a.QueryTransferSchemeResponse.StartPoint;OpenLayers.Util.isArray(d)||(d=[d]);c=a.QueryTransferSchemeResponse.EndPoint;OpenLayers.Util.isArray(c)||
(c=[c]);a=a.QueryTransferSchemeResponse.TransferScheme;d=this._getPointGeometryByGMLPointStr(d[0].Geometry.gml_Point);d=new Geo.Feature.Vector(d);c=this._getPointGeometryByGMLPointStr(c[0].Geometry.gml_Point);c=new Geo.Feature.Vector(c);a=this._parserTransferScheme(a);d={startPoint:d,transferScheme:a,endPoint:c};b(d)},this),failure:c})},_parserTransferScheme:function(a){OpenLayers.Util.isArray(a)||(a=[a]);for(var b=[],c=0;c<a.length;c++){var d=a[c],e=this._parserSectionInfo(d.SectionInfo),d=this._parserSectionRouting(d.SectionRouting);
b.push({Cost:a[c].Cost,SectionInfo:e,SectionRouting:d,TotalDistance:a[c].TotalDistance,TransferCount:a[c].TransferCount})}return b},_parserSectionInfo:function(a){OpenLayers.Util.isArray(a)||(a=[a]);for(var b=[],c=0;c<a.length;c++){var d=this._getPointFeatureByObj(a[c].FromStation);if(a[c].FromStation.PassagewayRouting){var e=this._getPointFeatureByObj(a[c].FromStation.PassagewayRouting);if(e.SectionRouting)e.attributes.SectionRouting=e.data.SectionRouting=this._parserSectionRouting(e.SectionRouting);
d.attributes.PassagewayRouting=d.data.PassagewayRouting=e}var f=this._getPointFeatureByObj(a[c].ToStation);if(a[c].ToStation.PassagewayRouting){e=this._getPointFeatureByObj(a[c].ToStation.PassagewayRouting);if(e.SectionRouting)e.attributes.SectionRouting=e.data.SectionRouting=this._parserSectionRouting(e.SectionRouting);f.attributes.PassagewayRouting=f.data.PassagewayRouting=e}var e=this._parserSectionLines(a[c].SectionLines.SectionLine),g=this._parserSectionRouting(a[c].SectionRouting);b.push({FromStation:d,
SectionLine:e,ToStation:f,SectionRouting:g})}return b},_parserSectionLines:function(a){OpenLayers.Util.isArray(a)||(a=[a]);for(var b=[],c=0;c<a.length;c++){var d=new Geo.Feature.Vector(null,a[c]);b.push(d)}return b},_parserSectionRouting:function(a){OpenLayers.Util.isArray(a)||(a=[a]);for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return b},_getPointGeometryByGMLPointStr:function(a){a=a.split(",");return new Geo.Geometry.Point(parseFloat(a[0]),parseFloat(a[1]))},_getPointFeatureByObj:function(a){var b=
null;a.Geometry&&a.Geometry.gml_Point&&(b=this._getPointGeometryByGMLPointStr(a.Geometry.gml_Point));return new Geo.Feature.Vector(b,a)},_getLineGeometryByGMLLineStr:function(a){if(!a)return null;for(var a=a.split(" "),b=[],c=0,d=a.length;c<d;c++){var e=this._getPointGeometryByGMLPointStr(a[c]);b.push(e)}return new OpenLayers.Geometry.LineString(b)},queryTransferGeometry:function(a,b,c){var d={request:"QueryTransferGeometry",SERVICE:"BUS",VERSION:"1.0.0"};if(!a.networkName)throw"Error!Not network name for bus query.";
if(a.parameterInfo===null||a.parameterInfo===void 0||a.parameterInfo==="")throw"Error!Not parameterInfo for bus query.";d.networkName=a.networkName;d.PARAMETERINFO="";for(var e=0;e<a.parameterInfo.length;e++)d.PARAMETERINFO+=a.parameterInfo[e].toString(),e!=a.parameterInfo.length-1&&(d.PARAMETERINFO+="_");if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;OpenLayers.Request.GET({url:this.url,params:d,scope:this,success:OpenLayers.Function.bind(function(a){a=
this._parseQueryTransferGeometryResult(a);b(a)},this),failure:c})},_parseQueryTransferGeometryResult:function(a){resXML=a.responseXML;a=[];if(!resXML)return a;var b=new OpenLayers.Format.XML,c=resXML.selectNodes("/QueryTransferGeometryResponse");if(c&&c.length<=0)return a;if(b=this._parseToJSON(b.write(c[0])).QueryTransferGeometryResponse.SectionGeometry){OpenLayers.Util.isArray(b)||(b=[b]);for(c=0;c<b.length;c++){var d=this._getLineGeometryByGMLLineStr(b[c].Geometry.gml_LineString),d=new Geo.Feature.Vector(d,
{ID:b[c].ID});a.push(d)}}return a},queryKeyWord:function(a,b,c){var d={REQUEST:"QueryKeyWord",SERVICE:"BUS",VERSION:"1.0.0",SEARCHTYPE:2};if(!a.networkName)throw"Error!Not network name for bus query.";if(a.keyWord===null||a.keyWord===void 0||a.keyWord==="")throw"Error!Not keyWord for bus query.";d.NETWORKNAME=a.networkName;d.KEYWORD=a.keyWord;if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.searchType!==null&&a.searchType!==
void 0)d.SEARCHTYPE=a.searchType;if(a.keyWordType!==null&&a.keyWordType!==void 0)d.KEYWORDTYPE=a.keyWordType;OpenLayers.Request.GET({url:this.url,params:d,scope:this,success:OpenLayers.Function.bind(function(c){c=this._parserQueryKeyWordResult(c,a.keyWordType);b(c)},this),failure:c})},_parserQueryKeyWordResult:function(a,b){var c=a.responseXML,d=[];if(!c)return d;var e=new OpenLayers.Format.XML,f=c.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage");if(f&&f.length>0)return d;c=c.selectNodes("/QueryKeyWordResponse");
e=this._parseToJSON(e.write(c[0]));if(b===1){(f=e.QueryKeyWordResponse.Stations.Station)&&!Geo.Util.isArray(f)&&(f=[f]);for(e=0;e<f.length;e++)c=this._getPointFeatureByObj(f[e]),d.push(c)}else if(b===2){(f=e.QueryKeyWordResponse.Passageways.Passageway)&&!Geo.Util.isArray(f)&&(f=[f]);for(e=0;e<f.length;e++)c=this._getPointFeatureByObj(f[e]),d.push(c)}else{(c=e.QueryKeyWordResponse.Lines.Line)&&!Geo.Util.isArray(c)&&(c=[c]);for(e=0;e<c.length;e++)f=new Geo.Feature.Vector(null,c[e]),d.push(f)}return d},
queryStationInfo:function(a,b,c){var d={REQUEST:"QueryStationInfo",SERVICE:"BUS",VERSION:"1.0.0"};if(!a.networkName)throw"Error!Not network name for bus query.";if(a.stationId===null||a.stationId===void 0||a.stationId==="")throw"Error!Not stationId for bus query.";d.NETWORKNAME=a.networkName;if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.stationId!==null&&a.stationId!==void 0)d.STATIONID=a.stationId;OpenLayers.Request.GET({url:this.url,
params:d,scope:this,success:function(a){if(resXML=a.responseXML){for(var c=new OpenLayers.Format.XML,a=this._parserQueryStationInfoNode("Lines",c,resXML),c=this._parserQueryStationInfoNode("Passageways",c,resXML),d=[],h=0;h<c.length;h++){var l=this._getPointFeatureByObj(c[h]);d.push(l)}a={lines:a,passageways:d}}else a={lines:[],passageways:[]};b(a)},failure:c})},_parserQueryStationInfoNode:function(a,b,c){switch(a){case "Lines":c=c.selectNodes("/QueryStationInfoResponse/StationInfo/Lines");a=[];if(c.length>
0)b=b.write(c[0]),b=this._parseToJSON(b),a=b.Lines.Line,Geo.Util.isArray(a)||(a=[a]);return a;case "Passageways":c=c.selectNodes("/QueryStationInfoResponse");a=[];if(c.length>0&&(b=b.write(c[0]),b=this._parseToJSON(b),b=b.QueryStationInfoResponse.StationInfo.Passageways))a=b.Passageway,Geo.Util.isArray(a)||(a=[a]);return a;default:return[]}},queryLineInfo:function(a,b,c){var d={REQUEST:"QueryLineInfo",SERVICE:"BUS",VERSION:"1.0.0"};if(!a.networkName)throw"Error!Not network name for bus query.";if(a.lineId===
null||a.lineId===void 0||a.lineId==="")throw"Error!Not lineId for bus query.";d.NETWORKNAME=a.networkName;if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.lineId!==null&&a.lineId!==void 0)d.LINEID=a.lineId;if(a.startNodeNumber!==null&&a.startNodeNumber!==void 0)d.STARTNODENUMBER=a.startNodeNumber;if(a.endNodeNumber!==null&&a.endNodeNumber!==void 0)d.ENDNODENUMBER=a.endNodeNumber;OpenLayers.Request.GET({url:this.url,params:d,
scope:this,success:function(a){var c=[],d=null;if(a.responseXML){d=a.responseXML;if((a=d.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage"))&&a.length>0){b(c);return}c=this._parserQueryLineInfoNode("Line",new OpenLayers.Format.XML,d);d=[];for(a=0;a<c.length;a++){for(var h=[],l=0;l<c[a].VIAStations.Station.length;l++){var m=this._getPointFeatureByObj(c[a].VIAStations.Station[l]);h.push(m)}c[a].Stations=h;h=this._getLineGeometryByGMLLineStr(c[a].Geometry.gml_LineString);h=new Geo.Feature.Vector(h,
c[a]);d.push(h)}c=d}b(c)},failure:c})},_parserQueryLineInfoNode:function(a,b,c){switch(a){case "Line":return a=c.selectNodes("/QueryLineInfoResponse"),b=this._parseToJSON(b.write(a[0])).QueryLineInfoResponse.Line,a=[],a=b&&!Geo.Util.isArray(b)?[b]:b;default:return[]}},queryPassagewayInfo:function(a,b){var c={REQUEST:"QueryPassagewayInfo",SERVICE:"BUS",VERSION:"1.0.0"};if(!a.networkName)throw"Error!Not network name for bus query.";if(a.passagewayId===null||a.passagewayId===void 0||a.passagewayId===
"")throw"Error!Not passagewayId for bus query.";c.NETWORKNAME=a.networkName;if(a.service!==null&&a.service!==void 0)c.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)c.VERSION=a.version;if(a.passagewayId!==null&&a.passagewayId!==void 0)c.PASSAGEWAYID=a.passagewayId;OpenLayers.Request.GET({url:this.url,params:c,scope:this,success:function(a){var c=a.responseXML,f=[];if(!c)return b(f),f;new OpenLayers.Format.XML;if((c=c.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage"))&&c.length>
0)return b(f),f;f=this._parserFeaturesNew(this._parserResponseText(a.responseText),"Stations");b(f)}})},CLASS_NAME:"Geo.Service.Bus"});
(function(){if(document.implementation.hasFeature("XPath","3.0"))XMLDocument.prototype.selectNodes=function(a,b){b||(b=this);for(var c=this.evaluate(a,b,function(a){return{csw:"http://www.opengis.net/cat/csw",smmd:"http://data.sbsm.gov.cn/smmd/2007",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",geoglobe:"http://www.geostar.com.cn/geoglobe"}[a]||null},XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),d=[],e=0;e<c.snapshotLength;e++)d[e]=c.snapshotItem(e);return d},Element.prototype.selectNodes=
function(a){if(this.ownerDocument.selectNodes)return this.ownerDocument.selectNodes(a,this);else throw"For XML Elements Only";};if(document.implementation.hasFeature("XPath","3.0"))XMLDocument.prototype.selectSingleNode=function(a,b){b||(b=this);var c=this.selectNodes(a,b);return c.length>0?c[0]:null},Element.prototype.selectSingleNode=function(a){if(this.ownerDocument.selectSingleNode)return this.ownerDocument.selectSingleNode(a,this);else throw"For XML Elements Only";}})();
Geo.Service.Plot=Geo.Class(Geo.Service,{maxPerPage:100,initialize:function(a,b,c){this.name=a;this.url=b;OpenLayers.Util.extend(this,c)},getCapabilities:function(a,b){OpenLayers.loadURL(this.url,{REQUEST:"GetCapabilities"},this,function(b){b=this._parseToXML(b);a(b)},b)},addClasses:function(a,b,c){var d={REQUEST:"AddClasses",userid:this.userid},e=this.url,a=OpenLayers.String.format("<AddClasses><Feature><name>${className}</name><parentid>${parentId}</parentid><description>${description}</description><pictureurl>${pictureUrl}</pictureurl></Feature></AddClasses>",
{className:a.className,parentId:a.parentId,description:a.description,pictureUrl:a.pictureUrl});OpenLayers.Request.POST({url:e,params:d,scope:this,data:a,success:function(a){a=this._parseToJSON(a.responseText);b(a)},failure:c})},deleteClasses:function(a,b,c){var d={REQUEST:"DeleteClasses",userid:this.userid},a=OpenLayers.String.format("<FeatureCollection><Feature><id>${classId}</id></Feature></FeatureCollection>",{classId:a.classId}),e=this.url+"?"+OpenLayers.Util.getParameterString(d);OpenLayers.Request.POST({url:e,
params:d,scope:this,data:a,success:function(a){a=this._parseToJSON(a.responseText);b(a)},failure:c})},updateClasses:function(a,b,c){var d={REQUEST:"UpdateClasses",userid:this.userid},e=a.name,f=a.description,g=a.pictureUrl,a=OpenLayers.String.format("<FeatureCollection><Feature><id>${classId}</id>${name}${description}${pictureUrl}</Feature></FeatureCollection>",{classId:a.classId,name:function(){return e===null||e===void 0?"":"<name>"+e+"</name>"},description:function(){return f===null||f===void 0?
"":"<description>"+f+"</description>"},pictureUrl:function(){return g===null||g===void 0?"":"<pictureurl>"+g+"</pictureurl>"}});OpenLayers.Request.POST({url:this.url,params:d,scope:this,data:a,success:function(a){a=this._parseToJSON(a.responseText);b(a)},failure:c})},queryClasses:function(a,b,c){var d={REQUEST:"QueryClasses",userid:this.userid},e=this.url,f=this._filterToString(a.filter),f=OpenLayers.String.format("<FeatureCollection><Query>${pagingInfo}${filter}${orderBy}</Query></FeatureCollection>",
{pagingInfo:OpenLayers.Function.bind(function(){return this._pagingToString(a.maxPerPage,a.currentPage)},this),filter:f,orderBy:OpenLayers.Function.bind(function(){if(a.orderBy===void 0)return"";return this._orderByToString(a.orderBy.property,a.orderBy.type)},this)});OpenLayers.Request.POST({url:e,params:d,scope:this,data:f,success:function(a){a=this._parseToJSON(a.responseText);b(a)},failure:c})},publishFeatures:function(a,b,c){var d={REQUEST:"PublishFeatures",userid:this.userid},e=this.url,a=OpenLayers.String.format("<FeatureCollection><Feature><BOOKMARKID>${bookmarkId}</BOOKMARKID><TYPE>${type}</TYPE></Feature></FeatureCollection>",
{bookmarkId:a.bookmarkId,type:a.type});OpenLayers.Request.POST({url:e,params:d,scope:this,data:a,success:function(a){a=this._parseToJSON(a.responseText);b(a)},failure:c})},approvalFeatures:function(a,b,c){var d={REQUEST:"ApprovalFeatures",userid:this.userid,passresult:"pass"},e=this.url,a=OpenLayers.String.format("<FeatureCollection><Feature><BOOKMARKID>${bookmarkId}</BOOKMARKID><TYPE>${type}</TYPE></Feature></FeatureCollection>",{bookmarkId:a.bookmarkId,type:a.type});OpenLayers.Request.POST({url:e,
params:d,scope:this,data:a,success:function(a){a=this._parseToJSON(a.responseText);b(a)},failure:c})},addFeatures:function(a,b,c){if(a.sortType===null&&a.sortType===void 0)throw"Error!Not sortType of class.";var d=Geo.Math.uuid();a.bookmarkId=d;this.updateFeatures(a,b,c)},updateFeatures:function(a,b,c){var d=OpenLayers.String.format("<Feature>${featureId}${sortId}${sortType}${bookmarkId}${type}${iconpath}${brief}${linecolor}${linewidth}${fillcolor}${opacity}${title}${status}${height}${pitching}${geometry}</Feature>",
{featureId:function(){return a.featureId===null||a.featureId===void 0?"":"<FEATUREID>"+a.featureId+"</FEATUREID>"},sortId:function(){return a.sortId===null||a.sortId===void 0?"":"<SORTID>"+a.sortId+"</SORTID>"},sortType:function(){return a.sortType===null||a.sortType===void 0?"":"<SORTTYPE>"+a.sortType+"</SORTTYPE>"},bookmarkId:function(){return a.bookmarkId===null||a.bookmarkId===void 0?"":"<BOOKMARKID>"+a.bookmarkId+"</BOOKMARKID>"},title:function(){return a.title===null||a.title===void 0?"":"<TITLE>"+
a.title+"</TITLE>"},status:function(){return a.status===null||a.status===void 0?"":"<STATUS>"+a.status+"</STATUS>"},height:function(){return a.height===null||a.height===void 0?"":"<HEIGHT>"+a.height+"</HEIGHT>"},pitching:function(){return a.pitching===null||a.pitching===void 0?"":"<PITCHING>"+a.pitching+"</PITCHING>"},brief:OpenLayers.Function.bind(function(){return a.brief===null||a.brief===void 0?"":"<BRIEF>"+a.brief+"</BRIEF>"},this),type:OpenLayers.Function.bind(function(){return a.type===null||
a.type===void 0?"":"<TYPE>"+a.type+"</TYPE>"},this),linecolor:OpenLayers.Function.bind(function(){return a.linecolor===null||a.linecolor===void 0?"":"<LINECOLOR>"+a.linecolor+"</LINECOLOR>"},this),iconpath:OpenLayers.Function.bind(function(){return a.iconpath===null||a.iconpath===void 0?"":"<ICONPATH>"+a.iconpath+"</ICONPATH>"},this),linewidth:OpenLayers.Function.bind(function(){return a.linewidth===null||a.linewidth===void 0?"":"<LINEWIDTH>"+a.linewidth+"</LINEWIDTH>"},this),fillcolor:OpenLayers.Function.bind(function(){return a.fillcolor===
null||a.fillcolor===void 0?"":"<FILLCOLOR>"+a.fillcolor+"</FILLCOLOR>"},this),opacity:OpenLayers.Function.bind(function(){return a.opacity===null||a.opacity===void 0?"":"<OPACITY>"+a.opacity+"</OPACITY>"},this),geometry:OpenLayers.Function.bind(function(){return a.geometry===null||a.geometry===void 0?"":this._geometryToString(a.geometry)},this)});OpenLayers.Request.POST({url:this.url,params:{REQUEST:"UpdateFeatures",userid:this.userid},scope:this,data:"<FeatureCollection>"+d+"</FeatureCollection>",
success:function(a){a=this._parseToJSON(a.responseText);b(a)},failure:c})},deleteFeatures:function(a,b,c){var d={REQUEST:"DeleteFeatures",userid:this.userid},e=this.url,a=OpenLayers.String.format("<FeatureCollection><Feature><BOOKMARKID>${bookmarkId}</BOOKMARKID><TYPE>${type}</TYPE></Feature></FeatureCollection>",{bookmarkId:a.bookmarkId,type:a.type});OpenLayers.Request.POST({url:e,params:d,scope:this,data:a,success:function(a){a=this._parseToJSON(a.responseText);b(a)},failure:c})},queryFeatures:function(a,
b,c){var d={REQUEST:"QueryFeatures",userid:this.userid},e=this.url,f=OpenLayers.String.format("<FeatureCollection><Query>${pagingInfo}<requestType>${requestType}</requestType>${orderBy}${filter}</Query></FeatureCollection>",{pagingInfo:OpenLayers.Function.bind(function(){return this._pagingToString(a.maxPerPage,a.currentPage)},this),classcode:a.classcode,filter:OpenLayers.Function.bind(function(){return this._filterToString(a.filters)},this),orderBy:OpenLayers.Function.bind(function(){if(a.orderBy===
void 0)return"";return this._orderByToString(a.orderBy.property,a.orderBy.type)},this),requestType:a.requestType});OpenLayers.Request.POST({url:e,params:d,scope:this,data:f,success:function(a){a=this._parserFeatures(a.responseText);b(a)},failure:c})},_getGeometryType:function(a){return{"OpenLayers.Geometry.Point":"point","OpenLayers.Geometry.LineString":"line","OpenLayers.Geometry.Polygon":"polygon"}[a.CLASS_NAME]},_filterToString:function(a){if(!a)return"";var b="";Geo.Util.isArray(a)||(a=[a]);for(var c=
0;c<a.length;c++)b+="<Filter><"+a[c].type+"><PropertyName>"+a[c].propertyName+"</PropertyName><Literal>"+a[c].propertyValue+"</Literal></"+a[c].type+">",b+="</Filter>";return b},_pagingToString:function(a,b){b=b||this.maxPerPage;return"<numPerPage>"+b+"</numPerPage><curPage>"+(a||1)+"</curPage>"},_orderByToString:function(a,b){var c;return a?"<orderBy><PropertyName>"+a+"</PropertyName><OrderType>"+b+"</OrderType></orderBy>":""},_geometryToString:function(a){return"<geometry>"+(new OpenLayers.Format.GML).buildGeometryNode(a).xml+
"</geometry>"},_parserGetcapabilities:function(a){return a},_parserFeatures:function(a){var b=new OpenLayers.Format.GML;b.gmlns="*";b.featureName="featureMember";return b.read(a)},_parserSuccessResult:function(a){return(new Geo.Util.Format.XML2JSON).read(a)},_parseToXML:function(a){return(new OpenLayers.Format.XML).read(a.responseText)},_parseToJSON:function(a){return(new Geo.Util.Format.XML2JSON).read(a)},CLASS_NAME:"Geo.Service.Plot"});
Geo.Service.ShortestPath=Geo.Class(Geo.Service,{initialize:function(a,b,c){this.name=a;this.url=b;OpenLayers.Util.extend(this,c)},getCapabilities:function(a,b){OpenLayers.loadURL(this.url,{REQUEST:"GetCapabilities"},this,a,b)},shortestPath:function(a,b,c){OpenLayers.loadURL(this.url,{REQUEST:"ShortestPath",STARTCOORD:a.start,ENDCOORD:a.end,NETWORKNAME:a.network},this,function(a){a=this._parseShortestPath(a);b(a)},c)},_parseShortestPath:function(a){var b=new OpenLayers.Format.XML;if(!a.responseXML)a.responseXML=
b.read(a.responseText);b=new OpenLayers.Format.GML;b.gmlns="*";return b.read(a.responseXML)},_parseCapabilities:function(){},findRoute:function(a,b,c){var d={REQUEST:"FindRoute",SERVICE:"ROUTE",VERSION:"1.0.0"},e={data:!0,orig:!0,dest:!0},f;for(f in e)if(!(f in config))throw Error("Missing property '"+f+"'");d.DATA=a.data;d.ORIG=a.orig;d.DEST=a.dest;if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.radius!==null&&a.radius!==
void 0)d.RADIUS=a.radius;if(a.queryType!==null&&a.queryType!==void 0)d.QUERYTYPE=a.queryType;if(a.midpos!==null&&a.midpos!==void 0)d.MIDPOS=a.midpos;if(a.avoidPos!==null&&a.avoidPos!==void 0)d.AVOIDPOS=a.avoidPos;if(a.filterRoute!==null&&a.filterRoute!==void 0)d.FILTERROUTE=a.filterRoute;if(a.resultCount!==null&&a.resultCount!==void 0)d.RESULTCOUNT=a.resultCount;OpenLayers.Request.GET({url:this.url,params:d,scope:this,success:function(a){a=this._parseFindRouteResult(a);b(a)},failure:c})},_parseToJSON:function(a){return(new Geo.Util.Format.XML2JSON).read(a.responseText)},
_parseFindRouteResult:function(a){a=this._parseToJSON(a);this._parserFeatures(a);return{Route:a.Routes.Route}},_parserFeatures:function(a){var b=a.Routes.Route;if(b){if(!Geo.Util.isArray(b))b=[b],a.Routes.Route=b;for(var a=0,c=b.length;a<c;a++){var d=b[a].Item,e=[];if(d){Geo.Util.isArray(d)||(d=[d]);for(var f=0,g=d.length;f<g;f++){var h=this._getFeatureForFindRoute(d[f]);e.push(h)}}b[a].Item=e}}},_getFeatureForFindRoute:function(a){if(!a||!a.Geometry)throw"FindRoute\u67e5\u8be2\u4e2d\uff0c\u67e5\u8be2\u7ed3\u679c\u7f3a\u5c11item\u6216Geometry";
var b=a.Geometry;b.gml_Point?b=this._geometryForFindRoute.point(b.gml_Point):b.gml_LineString&&(b=this._geometryForFindRoute.line(b.gml_LineString));return new Geo.Feature.Vector(b,a)},_geometryForFindRoute:{point:function(a){a=a.split(",");return new Geo.Geometry.Point(parseFloat(a[0]),parseFloat(a[1]))},line:function(a){if(a){for(var a=a.split(" "),b=[],c=0,d=a.length;c<d;c++){var e=_geometryForFindRoute.point(a[c]);b.push(e)}return new OpenLayers.Geometry.LineString(b)}else return null}},getRouteInfo:function(a,
b,c){var d={REQUEST:"GetRouteInfo",SERVICE:"ROUTE",VERSION:"1.0.0"};if(!a.data||!a.id)throw"Error!Not data and id for bus query.";d.DATA=a.data;d.ID=a.id;OpenLayers.Request.GET({url:this.url,params:d,scope:this,success:function(a){a=this._parserFeaturesForRouteInfo(a);b(a)},failure:c})},_parserFeaturesForRouteInfo:function(a){return this._getFeaturesForRouteInfo(this._parseToJSON(a))},_getFeaturesForRouteInfo:function(a){var b=a.RouteInfo.Route;if(b){if(!Geo.Util.isArray(b))b=[b],a.RouteInfo.Route=
b;for(var c=[],d=0,e=b.length;d<e;d++){var f=this._getFeatureForFindRoute(b[d]);c.push(f)}a.RouteInfo.Route=c}return{Route:a.RouteInfo.Route}},CLASS_NAME:"Geo.Service.ShortestPath"});
Geo.Service.Route=Geo.Class(Geo.Service,{initialize:function(a,b,c){this.name=a;this.url=b;OpenLayers.Util.extend(this,c)},getCapabilities:function(a,b){OpenLayers.loadURL(this.url,{REQUEST:"GetCapabilities"},this,a,b)},findRoute:function(a,b,c){var d={REQUEST:"FindRoute",SERVICE:"ROUTE",VERSION:"1.0.0"},e={data:!0,orig:!0,dest:!0},f;for(f in e)if(!(f in a))throw Error("Missing property '"+f+"'");d.DATA=a.data;d.ORIG=a.orig;d.DEST=a.dest;if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;
if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.radius!==null&&a.radius!==void 0)d.RADIUS=a.radius;if(a.queryType!==null&&a.queryType!==void 0)d.QUERYTYPE=a.queryType;if(a.midpos!==null&&a.midpos!==void 0)d.MIDPOS=a.midpos;if(a.avoidPos!==null&&a.avoidPos!==void 0)d.AVOIDPOS=a.avoidPos;if(a.filterRoute!==null&&a.filterRoute!==void 0)d.FILTERROUTE=a.filterRoute;if(a.resultCount!==null&&a.resultCount!==void 0)d.RESULTCOUNT=a.resultCount;OpenLayers.Request.GET({url:this.url,params:d,
scope:this,success:function(a){a=this._parseFindRouteResult(a);b(a)},failure:c})},_parseToJSON:function(a){return(new Geo.Util.Format.XML2JSON).read(a.responseXML.xml)},_parseFindRouteResult:function(a){return{Route:this._parserFeatures(this._parseToJSON(a))}},_parserFeatures:function(a){if(!a.Routes)return{};var b=a.Routes.Route;if(b){if(!Geo.Util.isArray(b))b=[b],a.Routes.Route=b;for(var a=0,c=b.length;a<c;a++){var d=b[a].Item,e=[];if(d){Geo.Util.isArray(d)||(d=[d]);for(var f=0,g=d.length;f<g;f++){var h=
this._getFeatureForFindRoute(d[f]);e.push(h)}}b[a].Item=e}}return b},_getFeatureForFindRoute:function(a){if(!a||!a.Geometry)throw"FindRoute\u67e5\u8be2\u4e2d\uff0c\u67e5\u8be2\u7ed3\u679c\u7f3a\u5c11item\u6216Geometry";var b=a.Geometry;b.gml_Point?b=this._geometryForFindRoute.point(b.gml_Point):b.gml_LineString&&(b=this._geometryForFindRoute.line(b.gml_LineString));return new Geo.Feature.Vector(b,a)},_geometryForFindRoute:{point:function(a){a=a.split(",");return new Geo.Geometry.Point(parseFloat(a[0]),
parseFloat(a[1]))},line:function(a){if(a){for(var a=a.split(" "),b=[],c=0,d=a.length;c<d;c++){var e=Geo.Service.Route.prototype._geometryForFindRoute.point(a[c]);b.push(e)}return new OpenLayers.Geometry.LineString(b)}else return null}},getRouteInfo:function(a,b,c){var d={REQUEST:"GetRouteInfo",SERVICE:"ROUTE",VERSION:"1.0.0"};if(!a.data||!a.id)throw"Error!Not data and id for bus query.";d.DATA=a.data;d.ID=a.id;OpenLayers.Request.GET({url:this.url,params:d,scope:this,success:function(a){a=this._parserFeaturesForRouteInfo(a);
b(a)},failure:c})},_parserFeaturesForRouteInfo:function(a){return this._getFeaturesForRouteInfo(this._parseToJSON(a))},_getFeaturesForRouteInfo:function(a){a=a.RouteInfo;if(!a||!a.Route)return a={Route:{}};var b=a.Route;if(b){if(!Geo.Util.isArray(b))b=[b],a.Route=b;for(var c=[],d=0,e=b.length;d<e;d++){var f=this._getFeatureForFindRoute(b[d]);c.push(f)}a.Route=c}return a={Route:a.Route}},CLASS_NAME:"Geo.Service.Route"});
Geo.Service.TAS=Geo.Class(Geo.Service,{initialize:function(a,b,c){this.name=a;this.url=b;OpenLayers.Util.extend(this,c)},getCapabilities:function(a,b){OpenLayers.loadURL(this.url,{REQUEST:"GetCapabilities",VERSION:"1.0.0",SERVICE:"TAS"},null,a,b)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",VERSION:"1.0.0",SERVICE:"TAS"},scope:this,async:!1,success:function(){a=!0}});return a},pointAltitude:function(a,b,c){this._sendRequest("PointAltitude",a,
b,c)},pointSlope:function(a,b,c){this._sendRequest("PointSlope",a,b,c)},pointAspect:function(a,b,c){this._sendRequest("PointAspect",a,b,c)},surfaceArea:function(a,b,c){this._sendRequest("SurfaceArea",a,b,c)},volume:function(a,b,c){this._sendRequest("Volume",a,b,c)},surfaceDistance:function(a,b,c){this._sendRequest("SurfaceDistance",a,b,c)},profileAnalysis:function(a,b,c){this._sendRequest("ProfileAnalysis",a,b,c)},contourAnalysis:function(a,b,c){this._sendRequest("ContourAnalysis",a,b,c)},topPoint:function(a,
b,c){this._sendRequest("TopPoint",a,b,c)},singlePointVisiable:function(a,b,c){this._sendRequest("SinglePointVisiable",a,b,c)},floodAnalysis:function(a,b,c){this._sendRequest("FloodAnalysis",a,b,c)},topLowPoint:function(a,b,c){this._sendRequest("TopLowPoint",a,b,c)},getMetaData:function(a,b,c){this._sendRequest("GetMetaData",options,b,c)},_sendRequest:function(a,b,c,d){var e=this.url,f=b.layerLevel,g=b.layerName,h=b.pointCount,l=this._convertRadian(b.coordinates);OpenLayers.loadURL(e,{REQUEST:a,LAYERLEVEL:f,
LAYERNAME:g,POINTCOUNT:h,COORDINATES:l,SUBJOIN:b.subjoin||0},this,function(a){a=this._parseResult(a);c(a)},d)},_convertRadian:function(a){for(var a=a.split(","),b=0;b<a.length;b++)a[b]=a[b]*3.1415926/180;return a.join(",")},_countCoord:function(a){return a.split(",").length/2},_parseResult:function(a){var b=this._checkIsError(a.responseText);if(!b)return(new Geo.Util.Format.XML2JSON).read(a.responseText);return b},CLASS_NAME:"Geo.Service.TAS"});
Geo.Service.WPS=Geo.Class(Geo.Service,{initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url+"/GetCapabilities";b||(b=function(){this.failFn("GetCapabilities")});OpenLayers.loadURL(c,null,this,function(b){a(b)},b)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url+"/GetCapabilities",scope:this,async:!1,success:function(){a=!0}});return a},describeProcess:function(a,b,c){var a=OpenLayers.String.format('<DescribeProcess xmlns="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 ../wpsDescribeProcess_request.xsd" service="WPS" version="1.0.0" language="en-CA"><ows:Identifier>${process}</ows:Identifier></DescribeProcess>',
{process:a}),d=this.url+"/DescribeProcess";c||(c=function(){this.failFn("DescribeProcess")});new OpenLayers.Request.POST({url:d,data:a,scope:this,success:b,failure:c})},execute:function(a,b,c){var d=this.url+"/Execute";c||(c=function(){this.failFn("Execute")});new OpenLayers.Request.POST({url:d,data:a,scope:this,success:b,failure:c})},CLASS_NAME:"Geo.Service.WPS"});
Geo.Service.WFS=Geo.Class(Geo.Service,{initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"WFS",VERSION:"1.0.0"};b||(b=function(){this.failFn(d.REQUEST)});OpenLayers.loadURL(c,d,this,function(b){a(b)},b)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"WFS"},scope:this,async:!1,success:function(){a=!0}});return a},describeFeatureType:function(a,
b,c){var d=this.url;OpenLayers.Util.applyDefaults(a,{service:"WFS",version:"1.0.0",request:"DescribeFeatureType"});c||(c=function(){this.failFn(a.REQUEST)});OpenLayers.loadURL(d,a,this,function(a){b(a)},c)},getFeature:function(a,b,c){var d=this.url;OpenLayers.Util.applyDefaults(a,{service:"WFS",version:"1.0.0",request:"GetFeature"});c||(c=function(){this.failFn(a.REQUEST)});OpenLayers.loadURL(d,a,this,function(a){b(a)},c)},CLASS_NAME:"Geo.Service.WFS"});
Geo.Service.WFST=Geo.Class(Geo.Service,{xy:!0,initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"WFS",VERSION:"1.0.0"};b||(b=function(){this.failFn(d.REQUEST)});OpenLayers.loadURL(c,d,this,function(b){a(b)},b)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"WFS"},scope:this,async:!1,success:function(){a=!0}});return a},describeFeatureType:function(a,
b,c){var d=this.url;OpenLayers.Util.applyDefaults(a,{SERVICE:"WFS",VERSION:"1.0.0",REQUEST:"DescribeFeatureType"});c||(c=function(){this.failFn(a.REQUEST)});OpenLayers.loadURL(d,a,this,function(a){b(a)},c)},getFeature:function(a,b,c){var d=this.url;OpenLayers.Util.applyDefaults(a,{SERVICE:"WFS",VERSION:"1.0.0",REQUEST:"GetFeature"});c||(c=function(){this.failFn(a.REQUEST)});OpenLayers.loadURL(d,a,this,function(a){b(a)},c)},lockFeature:function(a,b,c){OpenLayers.Util.applyDefaults(a,{service:"WFS",
version:"1.0.0",request:"LockFeature",expiry:1,lockAction:"ALL"});var d=this._parserFilterToString(a.filter),d=OpenLayers.String.format('<?xml version="1.0" encoding="UTF-8"?><LockFeature version="${version}" service="${service}" lockAction="${lockAction}" expiry="${expiry}" xmlns:wfs=" http://www.opengis.net/wfs" xmlns:gml=" http://www.opengis.net/gml" xmlns:myns=" http://www.someserver.com/myns" xmlns:ogc=" http://www.opengis.net/ogc" xmlns:xsi=" http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs ../wfs/1.1.0/WFS.xsd"><Lock typeName="${typeName}">${filterXMLString}</Lock></LockFeature>',
{version:a.version,service:a.service,lockAction:a.lockAction,expiry:a.expiry,typeName:a.typeName,filterXMLString:d});c||(c=function(){this.failFn(a.request)});new OpenLayers.Request.POST({url:this.url,data:d,scope:this,success:b,failure:c})},transaction:function(a,b,c,d,e,f){var g=this.url;OpenLayers.Util.applyDefaults(a,{service:"WFS",version:"1.0.0",request:"Transaction",releaseAction:"ALL"});var h=a.lockId,l="";h&&(l+="<LockId>"+h+"</LockId>");h="";b&&(h+=this._getInsertString(b));c&&(h+=this._getUpdateString(c));
d&&(h+=this._getDeleteString(d));b=OpenLayers.String.format('<?xml version="1.0" encoding="UTF-8"?><wfs:Transaction releaseAction="${releaseAction}" handle="Transaction 01" version="${version}" service="${service}" xmlns="http://www.someserver.com/myns" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc" xmlns:wfs="http://www.opengis.net/wfs" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">${lockIdString}${transactionString}</wfs:Transaction>',{releaseAction:a.releaseAction,
version:a.version,service:a.service,lockIdString:l,transactionString:h});f||(f=function(){this.failFn(a.request)});new OpenLayers.Request.POST({url:g,data:b,scope:this,success:e,failure:f})},_getInsertString:function(a){for(var b=a.features,a=a.typeName,c="",d=0;d<b.length;d++)c+='<wfs:Insert handle="Insert '+d+'">'+this._getInsertFeatureString(b[d],a)+"</wfs:Insert>";return c},_getInsertFeatureString:function(a,b){var c="",d;for(d in a.data)d!="OID"&&(c+=OpenLayers.String.format("<${tag}><![CDATA[${value}]]\></${tag}>",
{value:a.data[d]?a.data[d]:"",tag:d}));c+=OpenLayers.String.format("<GEOMETRY>${geometry}</GEOMETRY>",{geometry:this._getGeometryStringByFeature(a)});return c=OpenLayers.String.format("<${typeName}>${content}</${typeName}>",{typeName:b,content:c})},_getUpdateString:function(a){var b=a.filter,c=a.typeName,a=this._getUpdatePropertyString(a.feature),b=this._parserFilterToString(b);return'<wfs:Update typeName="'+c+'" handle="Update 1">'+a+b+"</wfs:Update>"},_getUpdatePropertyString:function(a){var b=
"",c;for(c in a.data)c!="OID"&&(b+="<wfs:Property><wfs:Name><![CDATA["+c+"]]\></wfs:Name><wfs:Value><![CDATA["+(a.data[c]?a.data[c]:"")+"]]\></wfs:Value></wfs:Property>");b+="<wfs:Property><wfs:Name>Geometry</wfs:Name><wfs:Value>"+this._getGeometryStringByFeature(a)+"</wfs:Value></wfs:Property>";return b},_getGeometryStringByFeature:function(a){var b=new OpenLayers.Format.GML({xy:this.xy});b.buildCoordinatesNode=OpenLayers.Function.bind(function(a){var b=this.createElementNS(this.gmlns,"gml:coordinates");
b.setAttribute("decimal",".");b.setAttribute("cs",",");b.setAttribute("ts"," ");var e=[];if(a instanceof OpenLayers.Bounds)this.xy?(e.push(a.left+","+a.bottom),e.push(a.right+","+a.top)):(e.push(a.bottom+","+a.left),e.push(a.top+","+a.right));else for(var a=a.components?a.components:[a],f=0;f<a.length;f++)this.xy?e.push(a[f].x+","+a[f].y):e.push(a[f].y+","+a[f].x);e=this.createTextNode(e.join(" "));b.appendChild(e);return b},b);a=b.buildGeometryNode(a.geometry);return(new OpenLayers.Format.XML).write(a)},
_getDeleteString:function(a){var b=a.typeName,a=this._parserFilterToString(a.filter),c="";c+='<wfs:Delete typeName="'+b+'" handle="Delete 1">';c+=a;c+="</wfs:Delete>";return c},_parserFilterToString:function(a){var b="";a&&(a=(new Geo.Format.Filter.v1).write(a),b=(new OpenLayers.Format.XML).write(a));return b},CLASS_NAME:"Geo.Service.WFST"});
Geo.Service.WMS=Geo.Class(Geo.Service,{initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"WMS"};b||(b=function(){this.failFn(d.REQUEST)});OpenLayers.loadURL(c,d,this,function(b){a(b)},b)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"WMS"},scope:this,async:!1,success:function(){a=!0}});return a},getMap:function(a){var b=this.url;
OpenLayers.Util.applyDefaults(a,{service:"WMS",version:"1.1.1",request:"GetMap",styles:"",srs:"EPSG:4326",exceptions:"application/vnd.ogc.se_inimage",format:"image/jpeg"});a=OpenLayers.Util.getParameterString(a);return OpenLayers.Util.urlAppend(b,a)},CLASS_NAME:"Geo.Service.WMS"});
Geo.Service.WMTS=Geo.Class(Geo.Service,{initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"WMTS"};b||(b=function(){this.failFn(d.REQUEST)});OpenLayers.loadURL(c,d,this,function(b){a(b)},b)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"WMTS"},scope:this,async:!1,success:function(){a=!0}});return a},getTile:function(a){var b=this.url;
OpenLayers.Util.applyDefaults(a,{service:"WMTS",version:"1.0.0",request:"GetTile",format:"image/png"});a=OpenLayers.Util.getParameterString(a);return OpenLayers.Util.urlAppend(b,a)},getCapabilitiesForRest:function(a,b){var c=this.url;c.match(/\/$/)||(c+="/");c+="1.0.0/WMTSCapabilities.xml";b||(b=function(){this.failFn("GetCapabilities")});OpenLayers.loadURL(c,null,this,function(b){a(b)},b)},getTileForRest:function(a){var b=a.layer,c=a.style,d=a.tileMatrixSet,e=a.tileMatrix,f=a.tileRow,g=a.tileCol,
h=null,a=a.format?a.format:"image/png",l={"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"};h||(h=l[a]||a.split("/").pop());b=b+"/"+c+"/"+d+"/"+e+"/"+f+"/"+g+"."+h;c=this.url;c.match(/\/$/)||(c+="/");c+=b;return c},CLASS_NAME:"Geo.Service.WMTS"});
Geo.Service.GeoWMTS=Geo.Class(Geo.Service.WMTS,{initialize:function(){Geo.Service.WMTS.prototype.initialize.apply(this,arguments)},getVersions:function(a,b,c,d){var e=this.url;OpenLayers.Util.applyDefaults(b,{content:"full",service:"WMTS",version:"1.0.0",request:"GetVersions"});d||(d=function(){this.failFn(b.request)});OpenLayers.loadURL(e,{request:b.request,layer:a.layer,tileMatrixSet:a.tileMatrixSet,tileMatrix:a.tileMatrix,tileBox:a.tileBox,content:b.content,service:b.service,version:b.version},
this,function(a){c(a)},d)},getVersionInfo:function(a,b,c,d){var e=this.url;OpenLayers.Util.applyDefaults(b,{content:"brief",service:"WMTS",version:"1.0.0",request:"GetVersionInfo"});OpenLayers.loadURL(e,{layer:a.layer,versionNames:a.versionNames,tileMatrixSet:a.tileMatrixSet,content:b.content,service:b.service,version:b.version,request:b.request},this,function(a){c(a)},d)},CLASS_NAME:"Geo.Service.GeoWMTS"});
Geo.Service.WCS=Geo.Class(Geo.Service,{initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"WCS"};b||(b=function(){this.failFn(d.REQUEST)});OpenLayers.loadURL(c,d,this,function(b){a(b)},b)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"WCS"},scope:this,async:!1,success:function(){a=!0}});return a},describeCoverage:function(a,b,c){var d=
this.url;OpenLayers.Util.applyDefaults(a,{SERVICE:"WCS",VERSION:"1.0.0",REQUEST:"DescribeCoverage"});c||(c=function(){this.failFn(a.REQUEST)});OpenLayers.loadURL(d,a,this,function(a){b(a)},c)},getCoverage:function(a,b,c){var d=this.url;OpenLayers.Util.applyDefaults(a,{SERVICE:"WCS",VERSION:"1.1.2",REQUEST:"GetCoverage"});c||(c=function(){this.failFn(a.REQUEST)});OpenLayers.loadURL(d,a,this,function(a){b(a)},c)},CLASS_NAME:"Geo.Service.WCS"});
Geo.Service.CSW=Geo.Class(Geo.Service,{initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c;c=OpenLayers.String.format(this._soapTemplate,{soapBody:'<csw:GetCapabilities service="CSW" xmlns:csw="http://www.opengis.net/cat/csw" xmlns:ows="http://www.opengis.net/ows"><ows:AcceptVersions><ows:Version>2.0.2</ows:Version></ows:AcceptVersions><ows:AcceptFormats><ows:OutputFormat>text/xml</ows:OutputFormat></ows:AcceptFormats></csw:GetCapabilities>'});
b||(b=function(a){this.failFn(a)});new OpenLayers.Request.POST({url:this.url,data:c,scope:this,success:a,failure:b})},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"CSW"},scope:this,async:!1,success:function(){a=!0}});return a},getRecords:function(a,b,c){a=OpenLayers.String.format(this._getRecordsTemplate,{});c||(c=function(a){this.failFn(a)});new OpenLayers.Request.POST({url:this.url,data:a,scope:this,success:b,failure:c})},_getRecordsTemplate:'<?xml version="1.0" encoding="UTF-8"?><csw:GetRecords service="CSW" version="2.0.2" xmlns:csw="http://www.opengis.net/cat/csw" xmlns:ogc="http://www.opengis.net/ogc" xmlns:smmd="http://data.sbsm.gov.cn/smmd/2007" outputFormat="text/xml" resultType="results" outputSchema="smmd:Metadata" startPosition="1" maxRecords="10"><csw:Query typeNames="smmd:Metadata"> <csw:ElementSetName>full</csw:ElementSetName> <csw:Constraint version="2.0.0"><ogc:Filter> <ogc:PropertyIsLike wildCard="*" singleChar="_" escape="\\"><ogc:PropertyName>/smmd:Metadata/smmd:mdFileID</ogc:PropertyName><ogc:Literal>*</ogc:Literal></ogc:PropertyIsLike></ogc:Filter></csw:Constraint></csw:Query></csw:GetRecords>',
_soapTemplate:'<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xsi:schemaLocation="http://www.opengis.net/ows" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><soapenv:Body>${soapBody}</soapenv:Body></soapenv:Envelope>',getRecordById:function(a,b,c){a={request:a.request?a.request:"getRecordById",id:a.id?a.id:"",service:a.service?a.service:"CSW",version:a.version?a.version:"2.0.2",outputFormat:a.outputFormat?a.outputFormat:"Application/xml",outputSchema:a.outputSchema?
a.outputSchema:"http://opengis.net/cat/csw/2.0.2",elementSetName:a.elementSetName?a.elementSetName:"summary"};a=OpenLayers.String.format('<csw:GetRecordById service="${service}" xmlns:csw="http://www.opengis.net/cat/csw" version="${version}"><csw:Id>${id}</csw:Id><csw:ElementSetName typeNames="smmd:Metadata">${elementSetName}</csw:ElementSetName></csw:GetRecordById >',{id:a.id,service:a.service,version:a.version,elementSetName:a.elementSetName});c||(c=function(a){this.failFn(a)});new OpenLayers.Request.POST({url:this.url,
data:a,scope:this,success:b,failure:c})},describeRecord:function(a,b,c){a={request:a.request?a.request:"describeRecord",service:a.service?a.service:"CSW",version:a.version?a.version:"2.0.2",nameSpace:a.nameSpace?a.nameSpace:"",typeName:a.typeName?a.typeName:"smmd:Metadata",outputSchema:a.outputSchema?a.outputSchema:"application/xml",schemaLanguage:a.schemaLanguage?a.schemaLanguage:"XMLSCHEMA"};a=OpenLayers.String.format('<csw:DescribeRecord service="${service}" xmlns:csw="http://www.opengis.net/cat/csw" version="${version}"><csw:TypeName>${typeName}</csw:TypeName></csw:DescribeRecord >',
{service:a.service,version:a.version,typeName:a.typeName});c||(c=function(a){this.failFn(a)});new OpenLayers.Request.POST({url:this.url,data:a,scope:this,success:b,failure:c})},getDomain:function(a,b,c){var d={request:a.request?a.request:"describeRecord",service:a.service?a.service:"CSW",version:a.version?a.version:"2.0.2",propertyName:a.propertyName?a.propertyName:"",parameterName:a.parameterName?a.parameterName:""},e='<csw:GetDomain service="${service}" xmlns:csw="http://www.opengis.net/cat/csw" version="${version}">';
a.propertyName&&(e+="<csw:PropertyName>${propertyName}</csw:PropertyName>");a.parameterName&&(e+="<csw:ParameterName>${parameterName}</csw:ParameterName>");e+="</csw:GetDomain >";a=OpenLayers.String.format(e,{service:d.service,version:d.version,propertyName:d.propertyName,parameterName:d.parameterName});c||(c=function(a){this.failFn(a)});new OpenLayers.Request.POST({url:this.url,data:a,scope:this,success:b,failure:c})},transaction:function(a,b,c){var a={request:a.request?a.request:"transaction",service:a.service?
a.service:"CSW",version:a.version?a.version:"2.0.2",transaction:a.transaction?a.transaction:"",transactionType:a.transactionType?a.transactionType:"",requestId:a.requestId?a.requestId:0,verboseResponse:a.verboseResponse?a.verboseResponse:!1,md_metaData:a.md_metaData?a.md_metaData:"",typeName:a.typeName?a.typeName:"",constraintLanguage:a.constraintLanguage?a.constraintLanguage:"",constraint_Language_version:a.constraint_Language_version?a.constraint_Language_version:"",constraint:a.constraint?a.constraint:
"",handle:a.handle?a.handle:0},d="",e="";switch(a.transactionType){case "Insert":d+='<csw:Transaction xmlns:csw="http://www.opengis.net/cat/csw" version="${version}" service="${service}"><csw:Insert xmlns:smmd="http://data.sbsm.gov.cn/smmd/2007" xmlns:wrs="http://www.opengis.net/cat/wrs/1.0" xmlns:gco="http://www.isotc211.org/2005/gco" xmlns:gmd="http://www.isotc211.org/2005/gmd" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:srv="http://www.isotc211.org/2005/srv" xmlns:gml="http://www.opengis.net/gml" xmlns:gmx="http://www.isotc211.org/2005/gmx" xmlns:rim="urn:oasis:names:tc:ebxml-regrep:xsd:rim:3.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">${md_metaData}</csw:Insert></csw:Transaction>';
e=OpenLayers.String.format(d,{service:a.service,version:a.version,md_metaData:a.md_metaData});break;case "Update":d+='<csw:Transaction service="${service}" version="${version}" xmlns:csw="http://www.opengis.net/cat/csw"><csw:Update xmlns:srv="http://www.isotc211.org/2005/srv" xmlns:gml="http://www.opengis.net/gml" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:gmd="http://www.isotc211.org/2005/gmd" xmlns:rim="urn:oasis:names:tc:ebxml-regrep:xsd:rim:3.0" xmlns:wrs="http://www.opengis.net/cat/wrs/1.0" xmlns:gco="http://www.isotc211.org/2005/gco" xmlns:gmx="http://www.isotc211.org/2005/gmx" xmlns:ogc="http://www.opengis.net/ogc" xmlns:smmd="http://data.sbsm.gov.cn/smmd/2007">${md_metaData}${constraint}</csw:Update></csw:Transaction>';
e=OpenLayers.String.format(d,{service:a.service,version:a.version,md_metaData:a.md_metaData,constraint:a.constraint});break;case "Delete":d+='<csw:Transaction service="${service}" version="${version}" xmlns:smmd="http://data.sbsm.gov.cn/smmd/2007" xmlns:csw="http://www.opengis.net/cat/csw" xmlns:ogc="http://www.opengis.net/ogc"><csw:Delete typeName="${typeName}">${constraint}</csw:Delete></csw:Transaction>',e=OpenLayers.String.format(d,{service:a.service,version:a.version,typeName:a.typeName,constraint:a.constraint})}c||
(c=function(a){this.failFn(a)});new OpenLayers.Request.POST({url:this.url,data:e,scope:this,success:b,failure:c})},harvest:function(a,b,c){var d={request:a.request?a.request:"harvest",service:a.service?a.service:"CSW",version:a.version?a.version:"2.0.2",nameSpace:a.nameSpace?a.nameSpace:"",source:a.source?a.source:"",resourceType:a.resourceType?a.resourceType:"",resourceFormat:a.resourceFormat?a.resourceFormat:"",responseHandler:a.responseHandler?a.responseHandler:"",harvestInterval:a.harvestInterval?
a.harvestInterval:""},e='<csw:Harvest service="${service}" xmlns:csw="http://www.opengis.net/cat/csw" version="${version}">';e+="<csw:Source>${source}</csw:Source>";e+="<csw:ResourceType>${resourceType}</csw:ResourceType>";a.harvestInterval&&(e+="<csw:HarvestInterval>${harvestInterval}</csw:HarvestInterval>");a.responseHandler&&(e+="<csw:ResponseHandler>${responseHandler}</csw:ResponseHandler>");e+="</csw:Harvest>";a=OpenLayers.String.format(e,{service:d.service,version:d.version,source:d.source,
resourceType:d.resourceType,harvestInterval:d.harvestInterval,responseHandler:d.responseHandler});c||(c=function(a){this.failFn(a)});new OpenLayers.Request.POST({url:this.url,data:a,scope:this,success:b,failure:c})},CLASS_NAME:"Geo.Service.CSW"});
Geo.Service.CWMS=Geo.Class(Geo.Service,{initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments);this.format=new OpenLayers.Format.JSON},getCapabilities:function(a,b){b||(b=function(){this.failFn("GetCapabilities")});OpenLayers.loadURL(this.url,null,this,function(b){b=this.format.read(b.responseText);a(b)},b)},getLayerInfo:function(a,b,c){a=this.url.indexOf("/",this.url.length-1)!=-1?this.url+a:this.url+"/"+a;c||(c=function(){this.failFn("GetLayerInfo")});OpenLayers.loadURL(a,
null,this,function(a){a=this.format.read(a.responseText);b(a)},c)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url,params:null,scope:this,async:!1,success:function(){a=!0}});return a},getMap:function(a){a=encodeURIComponent(a.layerId)+"/"+encodeURIComponent(a.mapStyleId)+"/"+encodeURIComponent(a.srid)+"/"+a.sourceDate.getYear()+a.sourceDate.getMonth()+a.sourceDate.getDate()+"/L"+a.level+"/"+a.col+encodeURIComponent(",")+a.row+"."+a.formatSuffix;return this.url.indexOf("/",this.url.length-
1)!=-1?this.url+a:this.url+"/"+a},CLASS_NAME:"Geo.Service.CWMS"});
Geo.Service.MapService=Geo.Class(Geo.Service,{initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments);this.format=new OpenLayers.Format.JSON;this.jsonp=new OpenLayers.Protocol.Script({format:this.format})},getCapabilities:function(a,b){var c=this.url,d={f:"json"};b||(b=function(){this.failFn(d.REQUEST)});this.jsonp.createRequest(c,d,OpenLayers.Function.bind(function(b){a(b)},this))},_getJson:function(a){return this.format.read(a.responseText)},isExist:function(){var a=!1;OpenLayers.Request.GET({url:this.url,
params:{f:"json"},scope:this,async:!1,success:function(){a=!0}});return a},CLASS_NAME:"Geo.Service.MapService"});
Geo.Service.GeoCoding=Geo.Class(Geo.Service,{version:"1.0.0",initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments);this.format=new OpenLayers.Format.JSON},getCapabilities:function(a,b){b||(b=function(){this.failFn("GetCapabilities")});OpenLayers.loadURL(this.url,{request:"GetCapabilities",output:"json",version:this.version,service:"GeoCoding"},this,function(b){var d=this.format.read(b.responseText);a({result:b,json:d})},b)},CLASS_NAME:"Geo.Service.GeoCoding"});
Geo.Service.GeoRoute=Geo.Class(Geo.Service,{_format:null,initialize:function(a,b,c){this.name=a;this.url=b;this._format=new Geo.Util.Format.GeoRoute;OpenLayers.Util.extend(this,c)},getCapabilities:function(a,b){OpenLayers.loadURL(this.url,{REQUEST:"GetCapabilities"},this,a,b)},findRoute:function(a,b,c){var d={REQUEST:"FindRoute",SERVICE:"ROUTE",VERSION:"1.0.0"},e={data:!0,orig:!0,dest:!0},f;for(f in e)if(!(f in a))throw Error("Missing property '"+f+"'");d.DATA=a.data;d.ORIG=a.orig;d.DEST=a.dest;if(a.service!==
null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.radius!==null&&a.radius!==void 0)d.RADIUS=a.radius;if(a.queryType!==null&&a.queryType!==void 0)d.QUERYTYPE=a.queryType;if(a.midpos!==null&&a.midpos!==void 0)d.MIDPOS=a.midpos;if(a.avoidPos!==null&&a.avoidPos!==void 0)d.AVOIDPOS=a.avoidPos;if(a.filterRoute!==null&&a.filterRoute!==void 0)d.FILTERROUTE=a.filterRoute;if(a.resultCount!==null&&a.resultCount!==void 0)d.RESULTCOUNT=a.resultCount;
OpenLayers.Request.GET({url:this.url,params:d,scope:this,success:function(a){a=this._format.read(a.responseText);typeof a.exceptionInfo!=="string"&&(a=new Geo.Service.GeoRoutesResult(a));b(a)},failure:c})},getRouteInfo:function(a,b,c){var d={REQUEST:"GetRouteInfo",SERVICE:"ROUTE",VERSION:"1.0.0"};if(!a.data||!a.id)throw"Error!Not data and id for bus query.";d.DATA=a.data;d.ID=a.id;OpenLayers.Request.GET({url:this.url,params:d,scope:this,success:function(a){a=this._format.read(a.responseText);typeof a.exceptionInfo!==
"string"&&(a=new Geo.Service.GeoRouteInfoResult(a));b(a)},failure:c})},CLASS_NAME:"Geo.Service.GeoRoute"});
Geo.Util.Format.GeoRoute=new Geo.Class(Geo.Format.XML,{initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){var b={},c=[];typeof a=="string"&&(a=Geo.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9){var c=[],d=Geo.Format.XML.prototype.getChildEl.apply(this,[a]).nodeName;if("ServiceExceptionReport"===d)return c=a.getElementsByTagName("ogc:ServiceException")[0],b=Geo.Format.XML.prototype.getChildValue.apply(this,[c]),c=c.getAttribute("code"),
{exceptionInfo:b,exceptionCode:c};for(var a=a.getElementsByTagName(d)[0].childNodes,e=0;e<a.length;e++){var f=a[e],g=f.nodeName;this._resultPaser[d][g]&&this._resultPaser[d][g].apply(this,[f,c])}}d=d.toLowerCase();"routeinfo"===d?b.items=c:b[d]=c;return b},_resultPaser:{RouteInfo:{Item:function(a,b){var c=a.childNodes,d=a.getAttribute("id"),e={};d&&(e={id:d});for(d=0;d<c.length;d++){var a=c[d],f=a.nodeName;this._resultPaser.RouteInfo[f]&&this._resultPaser.RouteInfo[f].apply(this,[a,e])}b.push(e)},
Name:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]);if(c)b.name=c},Toll:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]);b.toll=c},Level:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]);b.level=c},Length:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]);b.length=c},Geometry:function(a,b){var c=a.getElementsByTagName("gml:LineString")[0];if(c&&(c=Geo.Format.XML.prototype.getChildValue.apply(this,
[c]),typeof c==="string"&&c.length>0)){for(var c=c.split(" "),d=[],e=0,f=c.length;e<f;e++){var g=c[e].split(",");d.push(new Geo.Geometry.Point(new Number(g[0]),new Number(g[1])))}c=new Geo.Geometry.LineString(d);b.geometry=c}},Directions:function(a,b){b.directions=[];for(var c=a.childNodes,d=0;d<c.length;d++){var a=c[d],e=a.nodeName;if(this._resultPaser.RouteInfo[e])this._resultPaser.RouteInfo[e](a,b.directions)}},Direction:function(a,b){var c={},d=Geo.Format.XML.prototype.getChildValue.apply(this,
[a]);c.direction=d;c.nextID=a.getAttribute("nextID");c.nextItem=a.getAttribute("nextItem");b.push(c)}},Routes:{Route:function(a,b){for(var c=a.childNodes,d={},e=0;e<c.length;e++){var a=c[e],f=a.nodeName;this._resultPaser.Routes[f]&&this._resultPaser.Routes[f].apply(this,[a,d])}b.push(d)},Item:function(a,b){if(!Geo.Util.isArray(b.items))b.items=[];var c=a.childNodes,d=a.getAttribute("id"),e={};d&&(e={id:d});for(d=0;d<c.length;d++){var a=c[d],f=a.nodeName;this._resultPaser.Routes[f]&&this._resultPaser.Routes[f].apply(this,
[a,e])}b.items.push(e)},Distance:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]);b.distance=c},Name:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]);if(c)b.name=c},Length:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]);b.length=c},Direction:function(a,b){var c={},d=Geo.Format.XML.prototype.getChildValue.apply(this,[a]);c.direction=d;c.nextID=a.getAttribute("nextID");c.nextItem=a.getAttribute("nextItem");b.direction=c},
Geometry:function(a,b){var c=a.getElementsByTagName("gml:LineString")[0];if(c&&(c=Geo.Format.XML.prototype.getChildValue.apply(this,[c]),typeof c==="string"&&c.length>0)){for(var c=c.split(" "),d=[],e=0,f=c.length;e<f;e++){var g=c[e].split(",");d.push(new Geo.Geometry.Point(new Number(g[0]),new Number(g[1])))}c=new Geo.Geometry.LineString(d);b.geometry=c}},Duration:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]);b.duration=c},BoundingBox:function(a,b){for(var c=a.childNodes,
d=0;d<c.length;d++){var a=c[d],e=a.nodeName;this._resultPaser.Routes[e]&&this._resultPaser.Routes[e].apply(this,[a,b])}},LowerCorner:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]).replace(/^\s*|\s*$/g,""),c=c.replace(/\s*,\s*/g,","),c=c.split(",");b.left=c[0];b.bottom=c[1]},UpperCorner:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]).replace(/^\s*|\s*$/g,""),c=c.replace(/\s*,\s*/g,","),c=c.split(",");b.right=c[0];b.top=c[1];b.bounds=new OpenLayers.Bounds(b.left,
b.bottom,b.right,b.top);delete b.left;delete b.bottom;delete b.right;delete b.top},Count:function(a,b){var c=Geo.Format.XML.prototype.getChildValue.apply(this,[a]);b.count=c}}}});Geo.Service.GeoRouteInfoResult=Geo.Class({data:null,items:null,initialize:function(a){this.items=[];if(a&&a.items){this.data=a;var b=a.items}if(Geo.Util.isArray(b))for(var a=0,c=b.length;a<c;a++){var d=new Geo.Service.GeoRouteInfoItem,e;for(e in b[a])d[e]=b[a][e];this.items.push(d)}},CLASS_NAME:"Geo.Service.GeoRouteInfoResult"});
Geo.Service.GeoRouteInfoItem=Geo.Class({id:null,name:null,toll:null,length:null,geometry:null,level:null,directions:null,initialize:function(){},CLASS_NAME:"Geo.Service.GeoRouteInfoItem"});Geo.Service.GeoRoutesResult=Geo.Class({data:null,routes:null,initialize:function(a){this.routes=[];var b=null;if(a&&a.routes)this.data=a,b=a.routes;if(Geo.Util.isArray(b))for(var a=0,c=b.length;a<c;a++){var d=new Geo.Service.GeoRouteResult,e;for(e in b[a])d[e]=b[a][e];this.routes.push(d)}},CLASS_NAME:"Geo.Service.GeoRoutesResult"});
Geo.Service.GeoRouteResult=Geo.Class({bounds:null,count:null,distance:null,duration:null,geometry:null,items:null,initialize:function(){},CLASS_NAME:"Geo.Service.GeoRouteResult"});
Geo.Service.GeoText=Geo.Class(Geo.Service,{data:null,version:"1.0.0",initialize:function(){Geo.Service.prototype.initialize.apply(this,arguments);this.format=new OpenLayers.Format.JSON;this.jsonp=new OpenLayers.Protocol.Script({format:this.format})},getCapabilities:function(a,b){b||(b=function(){this.failFn("Root\u63a5\u53e3")});var c={f:"json",service:"TEXT",version:"1.0.0"};c.version=this.version;OpenLayers.Request.GET({url:this.url,params:c,scope:this,async:!1,success:function(b){this.data=b=OpenLayers.Format.JSON.prototype.read.apply(this,
[b.responseText]);a(b)}})},getTextStyleByTextRendition:function(a){var b={},c={},b=a.FontName,d=a.Color.Value,e=a.Color.Transparent,f=a.IsBold?"bold":"normal";if(a.FontStyle==="Normal")c.fontStyle="normal";else if(a.FontStyle==="RightItalic")c.fontStyle="italic";var g=a.OffsetX,h=a.OffsetY,a=parseInt(a.Width*4)+"px",b={fontFamily:b,fontColor:d,fontOpacity:e,fontWeight:f,labelXOffset:g,labelYOffset:h,fontSize:a};OpenLayers.Util.extend(b,c);return b},getTextStyleByLabelRenditionID:function(a){for(var b=
this.data.rendition,c=0,d=b.length;c<d;c++)if(b[c].renditionID===a){a=this.getTextStyleByTextRendition(b[c].TextRendition);b=this.getMaxCharactersPerLine(b[c]);if(typeof b==="number")a.maxCharactersPerLine=b;return a}},getMaxCharactersPerLine:function(a){var b=null;if(a.WrapStyle&&a.WrapStyle.MaxCharactersPerLine)b=a.WrapStyle.MaxCharactersPerLine.enable;return b},getTextStylesByLayerIds:function(a,b){var c={},d=a.layers;typeof b==="number"&&(b=[b]);if(!Geo.Util.isArray(b))return c;for(var e=0;e<
b.length;e++)for(var f=0,g=d.length;f<g;f++)b[e]===d[f].id&&(c[d[f].dataTableName]=d[f].labelRenditionID);var d={},h;for(h in c)e=this.getTextStyleByLabelRenditionID(c[h]),d[h]=e;return d},CLASS_NAME:"Geo.Service.GeoText"});
Geo.Service.Thematic=Geo.Class(Geo.Service,{initialize:function(a,b,c){this.name=a;this.url=b;this.format=new OpenLayers.Format.JSON;this.jsonp=new OpenLayers.Protocol.Script({format:this.format});OpenLayers.Util.extend(this,c)},getCapabilities:function(a,b){var c=this.url;b||(b=function(){this.failFn()});this.jsonp.createRequest(c,{f:"json"},OpenLayers.Function.bind(function(b){a(b)},this))},getLegend:function(a){if(a.url.indexOf("/",a.url.length-1)!=-1)a.url=a.url.substr(0,a.url.length-1);var b;
b=Geo.String.format("${url}/legend/${layerID}/${chartID}.${format}",{url:a.url,layerID:a.layerID,chartID:a.chartID,format:a.format||"png"});typeof a.colorSchemaID==="string"&&(b+="?colorSchemaID="+a.colorSchemaID);return b},CLASS_NAME:"Geo.Service.Thematic"});Geo.Request.setProxyHost=function(a){OpenLayers.ProxyHost=a};Geo.Request.getProxyHost=function(){return OpenLayers.ProxyHost};
